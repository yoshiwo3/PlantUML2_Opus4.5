# プランモード指示書ガイド

**作成日**: 2025-12-10
**更新日**: 2025-12-11
**バージョン**: 3.5

---

## 概要

Claude Codeで**詳細で実行可能なプラン**を自動生成させるための指示書。

**特徴:**
- ユーザーが事前に記入する項目はない
- Claudeが必要な情報をヒアリング（1ターン1質問方式）
- **状態管理**: 各回答をplan.mdに逐次記録（ステートレス対策）
- タスク規模に応じたプランテンプレート（S/M/L）
- プランは`plan.md`としてEvidence内に保存

---

## ファイル一覧

| ファイル | 内容 |
|---------|------|
| `planning_instruction_template.md` | **汎用テンプレート v3.5** |
| `example_instruction_business_flow.md` | 業務フロー図作成の実例 |
| `instructions/` | カスタム指示書保管 |

---

## クイックスタート

### 使用例

#### パターン1: 最小限（フルヒアリング）

```
docs/guides/plan_mode/planning_instruction_template.md を読んで、プランニングを開始して
```
→ Claudeが必須質問（Q1-Q3）をすべてヒアリング

#### パターン2: 効率的【推奨】

```
docs/guides/plan_mode/planning_instruction_template.md を読んで、プランニングを開始して

業務フロー図 3.10（学習コンテンツフロー）を作成したい。
対象はUC 5-11, 5-12で、Phase 2。
```
→ Q1-Q3をスキップし、Phase 2（情報収集）へ直行

#### パターン3: フル指定

```
docs/guides/plan_mode/planning_instruction_template.md を読んで、プランニングを開始して

Q1: 業務フロー図 3.10
Q2: UC 5-11, 5-12
Q3: Phase 2
```
→ 即座に情報収集を開始

---

## 核心原則（v3.5で追加）

### 原則1: ステートレス対策（状態管理）

Claudeはステートレスであり、ターン間で内部状態を保持できない。
そのため、**すべての収集情報をplan.mdに逐次記録**する。

```markdown
# プラン（作成中）

## 収集済み情報

| 項目 | 値 | 取得状態 |
|------|-----|:--------:|
| Q1カテゴリ | 図表（PlantUML） | ✅ |
| Q1詳細 | 業務フロー図 | ✅ |
| Q1a | 3.10 | ✅ |
| Q2方式 | （未回答） | ⏳ |
```

### 原則2: 1ターン1質問

**ターン**とは、AIの1回の出力からユーザーの次の入力までの単位。

| 状況 | AIの動作 | 禁止事項 |
|------|---------|---------|
| 質問を出力した | **ターン終了**（追加出力なし） | 続けて別の質問を出力 |
| 回答を受け取った | plan.mdに記録→次の質問→ターン終了 | 2つ以上の質問を連続出力 |

### 原則3: テキスト質問の出力形式

```
**[質問ID: Q1a]**

どのフロー番号ですか？

（入力例: 3.1, 3.10, 新規）
```

---

## Claudeの動作フロー

```
Phase 0: 初期判定（必須）
    │  ※既存plan.mdの有無も確認
    │
    ├─ Q1-Q3すべて明示 → Phase 2へ（スキップ）
    │
    └─ Q1-Q3不足あり → Phase 1へ
           │
           ▼
Phase 1: ヒアリング【1ターン1質問方式】
    │  ※各回答をplan.mdに逐次記録
    │
    │  Step 1: Q1（タスク種別）- 2段階選択
    │      ├─ Q1カテゴリ選択（AskUserQuestion）
    │      ├─ Q1詳細選択（AskUserQuestion）
    │      └─ Q1a深掘り（テキスト質問）
    │
    │  Step 2: Q2（スコープ）
    │      ├─ Q2スコープ指定方式（AskUserQuestion）
    │      ├─ Q2a深掘り（テキスト質問）
    │      └─ Q2b追加確認（テキスト質問）※必須
    │
    │  Step 3: Q3（優先度）
    │      ├─ Q3優先度選択（AskUserQuestion）
    │      └─ Q3a深掘り（テキスト質問）※条件付き
    │
    │  Step 4: Q4-Q5（特殊タスクのみ）
    │
    ▼
Phase 2: 情報収集（必須）
    │  - 共通参照ドキュメント読み込み（Read tool）
    │  - タスク種別の追加ドキュメント読み込み
    │  - PlantUML図表の場合: 開発憲法 + Context7で仕様確認
    │  - 制約・ルール確認（C1-C6、P1-P8）
    │
    ▼
Phase 3: プラン作成（必須）
    │  3-1. タスク規模判定（S/M/L）- 客観的基準
    │  3-2. 設計決定の確認（AskUserQuestion）
    │  3-3. Evidenceディレクトリ作成（Bash tool）
    │  3-4. プラン作成
    │  3-5. プラン保存（Write tool）
    │  3-6. ユーザー承認
    │  3-7. 修正対応（Edit tool、上限5回）
    │  3-8. プラン承認後の接続
    │
    ▼
    完了（plan.md が Evidence に保存される）
    │
    ▼
プラン実行（Phase 4）※本指示書のスコープ外
```

---

## ヒアリング仕様【1ターン1質問方式】

**一括で質問せず、1問ずつ順番に聞き、回答をplan.mdに記録してから次の質問へ。**

### Step 1: Q1（タスク種別）- 2段階選択

**Q1カテゴリ選択（AskUserQuestion）:**

| カテゴリ | 詳細選択肢 |
|---------|-----------|
| 図表（PlantUML） | 業務フロー図 / シーケンス図 / クラス図 / DFD / ユースケース図 / コンテキスト図 / コンポーネント図 |
| 一覧表 | 機能一覧表 / CRUD表 / 外部IF一覧 / 非機能要件一覧 / アクター権限マトリクス |
| UI設計 | 画面遷移図 / ワイヤーフレーム |

**Q1a（深掘り・テキスト質問）:**

| Q1詳細の回答 | Q1a質問 |
|-------------|---------|
| 業務フロー図 | どのフロー番号？（3.1〜3.11、新規） |
| シーケンス図 | どの機能のシーケンス？ |
| クラス図 | どの部分を作成/更新？ |
| DFD | どのレベル？ |
| その他 | 具体的に何を作成？ |

### Step 2: Q2（スコープ）+ Q2a/Q2b（深掘り）

| Q2の回答 | Q2a（深掘り） | Q2b（追加確認）※必須 |
|---------|-------------|----------------------|
| UC番号で指定 | 具体的なUC番号は？ | 他に関連UCは？除外項目は？ |
| 機能名で指定 | 具体的な機能名は？ | 同上 |
| 画面名で指定 | 具体的な画面名は？ | 同上 |

### Step 3: Q3（優先度）+ Q3a（深掘り）

複数UC指定時: 「すべて同じ優先度ですか？」

### Step 4: Q4-Q5（特殊タスクのみ）

Q1で標準14種別に該当しない場合のみ実行。

---

## タスク規模判定（客観的基準）

| 規模 | 判定条件 | テンプレート |
|:----:|---------|:------------:|
| **S** | 成果物1個 AND 依存ファイル0個 AND 設計決定0件 | 7セクション |
| **M** | 成果物2-3個 OR 依存ファイル1-2個 OR 設計決定1-2件 | 8セクション |
| **L** | 成果物4個以上 OR 依存ファイル3個以上 OR 設計決定3件以上 | 11セクション |

**判定フロー:**
```
成果物数をカウント
    │
    ├─ 1個 → 依存ファイル数をカウント
    │         ├─ 0個 → 設計決定数をカウント
    │         │         ├─ 0件 → S（小）
    │         │         └─ 1件以上 → M（中）
    │         └─ 1個以上 → M（中）
    │
    ├─ 2-3個 → M（中）
    │
    └─ 4個以上 → L（大）
```

---

## プランの保存先

```
docs/evidence/<yyyyMMdd_HHmm_task_name>/plan.md
```
例: `docs/evidence/20251211_1430_business_flow_3_10/plan.md`

---

## 対応タスク種別（14種類）

| # | タスク種別 | # | タスク種別 |
|:-:|-----------|:-:|-----------|
| 1 | 業務フロー図 | 8 | コンテキスト図 |
| 2 | シーケンス図 | 9 | 画面遷移図 |
| 3 | クラス図 | 10 | ワイヤーフレーム |
| 4 | DFD | 11 | コンポーネント図 |
| 5 | 機能一覧表 | 12 | 外部IF一覧 |
| 6 | CRUD表 | 13 | 非機能要件 |
| 7 | ユースケース図 | 14 | アクター権限 |

---

## 例外処理

### ユーザーによる中断

| 発言パターン | AI動作 |
|-------------|--------|
| 「やめる」「キャンセル」「中断」 | プランニングを中断、再開方法を案内 |
| 「後で」「また今度」 | 承知して終了、再開方法を案内 |
| 「わからない」（3回連続） | 一旦中断を提案 |

### エラー処理

| エラー種別 | AI動作 |
|-----------|--------|
| CLAUDE.md未存在 | ユーザーに続行確認 |
| その他ファイル未存在 | plan.mdに「❌ 未参照」と記録し続行 |
| AskUserQuestion失敗 | テキスト質問にフォールバック |
| Write tool失敗 | リトライ1回→手動保存を依頼 |

### 回答検証エラー（リトライ上限: 3回）

| エラー種別 | AI動作 |
|-----------|--------|
| 選択肢以外の回答 | 選択肢を再提示 |
| UC番号が存在しない | 正しいUC番号を確認依頼 |
| 3回失敗時 | **手動入力モード**に移行 |

### プランニング再開

ユーザーが「プランニングを再開」と言った場合:
1. 既存plan.mdを検索
2. 前回の状態を確認
3. 「続きから再開」or「最初からやり直す」を確認

---

## 制約・ルール

### 共通制約（C1-C6）

| # | 制約 | 説明 |
|:-:|------|------|
| C1 | proposals/内ドキュメントとの整合性 | アクター名、コンポーネント名、用語を統一 |
| C2 | 命名規則・フォーマットの統一 | 既存ファイルのスタイルを踏襲 |
| C3 | アクター名・コンポーネント名の一致 | ユースケース図、コンテキスト図と照合 |
| C4 | Evidence 3点セット作成 | instructions.md, 00_raw_notes.md, work_sheet.md |
| C5 | active_context.md更新 | 進捗、次のステップを反映 |
| C6 | SERENA Memory永続化 | セッション終了時にwrite_memory |

### PlantUML固有制約（P1-P8）

| # | 制約 | 説明 |
|:-:|------|------|
| P1 | if/fork/switch内スイムレーン遷移禁止 | 70%の確率でレンダリングエラー |
| P2 | SVG XMLでの視覚確認禁止 | PNG画像で視覚確認 |
| P3 | ソース+PNG対比確認必須 | 4パス方式でレビュー |
| P4 | Context7確認必須 | 仕様確認後にコーディング |
| P5 | レビューログ未更新でPublish禁止 | レビュー証跡を残す |
| P6 | レビュー後の.puml修正してPublish禁止 | 修正したら再レビュー |
| P7 | ソースから接続推測して✅禁止 | PNG画像で視覚確認 |
| P8 | PNGと.puml同時読み込み禁止 | 確証バイアス防止 |

---

## v3.5での主な改善点

| # | 問題（v3.4以前） | 対応（v3.5） |
|:-:|-----------------|-------------|
| 1 | 状態管理の欠如（ステートレス未考慮） | **核心原則1: 状態管理**を新設。plan.mdへの逐次記録方式 |
| 2 | 「ユーザー応答を待つ」の技術的不明瞭さ | **核心原則2: 1ターン1質問**を新設。ターン終了の定義を明確化 |
| 3 | テキスト質問の出力形式が未定義 | **核心原則3: テキスト質問の出力形式**を新設 |
| 4 | 複数タスクの同時指定への対応がない | **Phase 0: 複数タスクの判定**を追加 |
| 5 | Phase 2でのContext7使用指示がない | **Phase 2: Context7での仕様確認**を追加 |
| 6 | plan.mdの更新手順が曖昧 | **Edit tool使用**を明記 |
| 7 | プラン実行後のフローへの接続がない | **Phase 3-8: プラン承認後の接続**を追加 |
| 8 | AskUserQuestion失敗時の具体例がない | **フォールバック形式**を追加 |
| 9 | 「3回失敗時は手動入力を許可」の出力形式が不明 | **手動入力モード**の出力形式を定義 |
| 10 | プラン修正5回超過後の処理が曖昧 | **3つの選択肢**を明確化 |
| 11 | 参照ファイル確認結果に状態列がない | **✅/❌状態列**を追加 |
| 12 | 既存プランがある場合の扱いが不明 | **Phase 0-1: 既存plan.mdの確認**を追加 |
| 13 | タスク規模の判定ロジックが主観的 | **客観的基準**（成果物数/依存ファイル数/設計決定数）に変更 |
| 14 | クイックリファレンスがない | **冒頭にクイックリファレンス**を追加 |
| 15 | Readエラー時の「続行確認」方法が不明 | **エラー処理A/B/C/D/E**を詳細定義 |

---

## バージョン履歴

| Ver | 日付 | 変更内容 |
|:---:|------|---------|
| 1.0 | 2025-12-10 | 初版（ユーザー記入必須方式） |
| 2.0 | 2025-12-11 | Claudeヒアリング方式に変更 |
| 3.0 | 2025-12-11 | 厳格評価に基づく全面改訂 |
| 3.1 | 2025-12-11 | 再評価に基づく問題点解消 |
| 3.2 | 2025-12-11 | 段階的質問＋深掘り方式に変更 |
| 3.3 | 2025-12-11 | 厳格評価フィードバック反映 |
| 3.4 | 2025-12-11 | AI向け指示書観点での全面改訂 |
| 3.5 | 2025-12-11 | **厳格評価91点Aランク達成**（全問題点解消） |

---

## 関連ドキュメント

- `CLAUDE.md` - プロジェクトガイド
- `docs/guides/PlantUML_Development_Constitution.md` - PlantUML憲法
- `docs/context/technical_decisions.md` - 技術決定記録
- `docs/context/active_context.md` - 現在の進捗
