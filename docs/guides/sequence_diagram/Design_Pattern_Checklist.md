# シーケンス図 設計パターンチェックリスト

**作成日**: 2025-12-21
**バージョン**: 1.0
**目的**: シーケンス図作成時に設計品質を確保するためのチェックリスト

---

## 概要

本チェックリストは、PlantUML構文の正確性（LL-001〜LL-027）とは別に、**設計パターンの観点**からシーケンス図を検証するためのものです。

**背景**: UC 3-10作成時の根本原因分析により、以下の問題が特定されました：
- プロセスに設計パターン検証ステップがなかった
- 4パスレビューがPlantUML構文に偏重していた
- 「知識はあったが適用トリガーがなかった」（LL-025の拡張）

---

## 使用タイミング

| タイミング | 使用するチェックリスト |
|-----------|----------------------|
| **PlantUMLコード作成前** | §1 UC固有分析 |
| **PlantUMLコード作成中** | §2〜§5 設計パターン |
| **5パスレビュー Pass 5** | 全セクション |

---

## 1. UC固有分析（作成前に実施）

対象UCの特性を分析し、必要な設計パターンを特定する。

| # | 質問 | 回答 | 該当時の必須パターン |
|:-:|------|:----:|---------------------|
| 1 | ユーザー入力がリアルタイムか？ | Yes/No | デバウンス（DP-002） |
| 2 | 外部APIを呼び出すか？ | Yes/No | タイムアウト、リトライ、503（DP-001） |
| 3 | 同一リクエストが繰り返されるか？ | Yes/No | キャッシュ（DP-003） |
| 4 | 高頻度呼び出しが想定されるか？ | Yes/No | レート制限（DP-004） |
| 5 | 機密データを扱うか？ | Yes/No | 監査ログ（DP-005） |
| 6 | 複数サービスを跨ぐか？ | Yes/No | 分散トレーシング（DP-006） |

---

## 2. レジリエンスパターン（必須確認）

外部システム連携時の耐障害性を確保する。

### チェックリスト

- [ ] **DP-001**: 外部API呼び出しにタイムアウトがあるか？
  - 推奨: 10秒（LLM）、5秒（Embedding）、3秒（Storage）
- [ ] **DP-001**: 一時的エラー（5xx、429）にリトライ機構があるか？
  - 推奨: 指数バックオフ（1s → 2s → 4s）、最大3回
- [ ] **DP-001**: 503 Service Unavailable を考慮しているか？
  - 外部API（OpenAI、OpenRouter、Supabase）すべてに適用
- [ ] サーキットブレーカーが必要か？
  - 高頻度呼び出し（>100 req/min）の場合に検討

### DP-001: 外部API呼び出しの基本パターン

```
外部API呼び出しには必ず以下を考慮する:
1. タイムアウト設定
2. リトライ機構（指数バックオフ）
3. 503 Service Unavailable エラーハンドリング
4. フォールバック戦略（該当する場合）
```

**適用例**:
```plantuml
alt 503 Service Unavailable
    ExternalAPI --> Service : 503 SERVICE_UNAVAILABLE
    Service -> Service : リトライ待機\n(指数バックオフ)
    Service -> ExternalAPI : リトライ (最大3回)
end
```

---

## 3. パフォーマンスパターン（必須確認）

ユーザー体験とコスト最適化を確保する。

### チェックリスト

- [ ] **DP-002**: ユーザー入力にデバウンスがあるか？
  - 推奨: 300ms（検索）、500ms（自動保存）
- [ ] **DP-003**: 繰り返し呼び出しにキャッシュがあるか？
  - Embedding: 同一クエリのベクトルをキャッシュ
  - API結果: 人気クエリの結果をキャッシュ
- [ ] ページネーションが適切か？
  - 推奨: limit=10〜50、offset/cursorベース
- [ ] 不要なAPI呼び出しを削減しているか？

### DP-002: デバウンスパターン

```
リアルタイム検索・入力監視には必ずデバウンスを適用する:
- 検索: 300ms
- 自動保存: 500ms〜1000ms
- バリデーション: 200ms
```

**適用例**:
```plantuml
User -> Browser : 検索クエリを入力
Browser -> Browser : デバウンス待機（300ms）
note right: 連続入力中は\nAPI呼び出しを抑制
Browser -> APIRoutes : POST /api/search
```

### DP-003: キャッシュパターン

```
コスト削減・レイテンシ改善のためキャッシュを検討する:
- Embeddingキャッシュ: 同一クエリ → 同一ベクトル
- 結果キャッシュ: 人気クエリ → TTL付きキャッシュ
- セッションキャッシュ: ユーザー固有データ
```

**適用例**:
```plantuml
Service -> Cache : get(cacheKey)
alt キャッシュヒット
    Cache --> Service : cachedResult
else キャッシュミス
    Service -> ExternalAPI : API呼び出し
    ExternalAPI --> Service : result
    Service -> Cache : set(cacheKey, result, TTL)
end
```

---

## 4. セキュリティパターン（必須確認）

セキュリティリスクを軽減する。

### チェックリスト

- [ ] **DP-004**: ユーザー単位のレート制限があるか？
  - 推奨: 100 req/min（API）、10 req/min（AI機能）
- [ ] **DP-005**: 監査ログが必要か？
  - 管理機能、権限変更、データ削除には必須
- [ ] 入力検証が網羅的か？
  - XSS、SQLインジェクション、パストラバーサル
- [ ] 認証・認可チェックが適切な位置にあるか？
  - API Routesの最初で実施

### DP-004: レート制限パターン

```
高頻度呼び出し可能なAPIにはレート制限を適用する:
- 通常API: 100 req/min/user
- AI機能: 10 req/min/user（コスト考慮）
- 管理API: 30 req/min/admin
```

**適用例**:
```plantuml
APIRoutes -> RateLimiter : checkLimit(userId)
alt レート超過
    RateLimiter --> APIRoutes : 429 RATE_LIMITED
    APIRoutes --> Browser : 429 Too Many Requests
else 許可
    RateLimiter --> APIRoutes : allowed
    APIRoutes -> Service : 処理続行
end
```

### DP-005: 監査ログパターン

```
以下の操作には監査ログを記録する:
- ユーザー権限変更
- データ削除（論理/物理）
- 管理者操作
- 認証失敗（連続）
```

---

## 5. オブザーバビリティパターン（推奨確認）

運用・デバッグを容易にする。

### チェックリスト

- [ ] **DP-006**: 分散トレーシングが必要か？
  - 複数サービス跨ぎの場合に検討
- [ ] エラーログが適切か？
  - スタックトレース、リクエストID、ユーザーID
- [ ] パフォーマンスメトリクスがあるか？
  - query_time_ms、処理件数

### DP-006: トレーシングパターン

```
複数サービスを跨ぐ処理には traceId を伝播する:
- リクエストヘッダー: X-Trace-Id
- ログ出力: [traceId] メッセージ
- エラーレスポンス: { traceId: "xxx", error: "..." }
```

---

## 6. クラス図整合性（LL-026拡張）

シーケンス図とクラス図の整合性を確保する。

### チェックリスト

- [ ] 呼び出すServiceメソッドがクラス図に存在するか？
- [ ] メソッドの引数・戻り値がクラス図と一致するか？
- [ ] 依存関係の経路がクラス図と一致するか？
  - 例: `LearningService → EmbeddingService` は正しいか？
  - 例: `LearningService → AIService → EmbeddingService` が正しくないか？
- [ ] 新規メソッドが必要な場合、クラス図を先に更新したか？

---

## 設計パターン知見ベース（DP-001〜DP-006）

| ID | 知見 | カテゴリ |
|----|------|---------|
| **DP-001** | 外部API呼び出しには必ずタイムアウト・リトライ・503を考慮する | レジリエンス |
| **DP-002** | リアルタイム検索・入力にはデバウンス（300ms）を適用する | パフォーマンス |
| **DP-003** | 同一クエリのEmbeddingはキャッシュする（コスト削減） | パフォーマンス |
| **DP-004** | 高頻度呼び出しAPIにはユーザー単位のレート制限を適用する | セキュリティ |
| **DP-005** | 権限変更・データ削除・管理操作には監査ログを記録する | セキュリティ |
| **DP-006** | 複数サービス跨ぎ処理にはtraceIdを伝播する | オブザーバビリティ |

---

## 関連ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| `Activation_Bar_Knowledge_Base.md` | LL-001〜LL-027（PlantUML構文知見） |
| `Sequence_Diagram_Patterns.md` | NL-001〜NL-007（非アクティブバーパターン） |
| `PlantUML_Development_Constitution.md` | 5パスレビュー手順 |
| `Sequence_Diagram_Authoring_Guide.md` | シーケンス図作成ガイドライン |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-21 | 初版作成（UC 3-10根本原因分析に基づく） |
