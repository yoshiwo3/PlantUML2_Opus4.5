# PlantUML開発憲法

**バージョン**: 3.4
**最終更新**: 2025-12-08

ClaudeCodeが高品質なPlantUML図表を作成するための行動規範。

---

## 目的

本憲法の目的：

- PlantUML図表の**品質保証**
- 視覚的レビューによる**問題の早期発見**
- 正式版SVGの**一元管理**

### 重要な前提

| 項目 | 内容 |
|------|------|
| **レビュー形式** | PNG形式を使用（SVGはXMLテキストとして返されるため視覚確認不可） |
| **レビューログ** | `.review.json`でレビュー結果・履歴を管理 |
| **正式版保存** | レビュー完了（status: completed）& ハッシュ一致の場合のみ |

### 関連ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| `docs/guides/PlantUML_Environment_Setup.md` | 環境構成（Java, Graphviz, ディレクトリ構成） |
| `docs/guides/PlantUML_Script_Reference.md` | スクリプト詳細・出力例、トラブルシューティング |
| `docs/guides/validate_plantuml_issues_template_spec.md` | issuesテンプレート仕様書 |
| `.serena/memories/plantuml_svg_generation_standard.md` | Serenaメモリ（PlantUML生成標準） |
| PlantUML公式 | https://plantuml.com/ |

---

## 1. 必須プロセス

> **⚠️ AIへの指示**: PlantUML作業開始前に、必ずこのセクションの全体フローを把握してから作業を開始せよ。

### 1.1 全体フロー

```
┌─────────────────────────────────────────────────────────────────┐
│  1. Context7で仕様確認                                           │
│           ↓                                                     │
│  2. 本憲法 § 2, § 3 を確認（禁止事項・既知制限）                  │
│           ↓                                                     │
│  3. コード作成（.puml）                                          │
│           ↓                                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Phase 1: Review                                         │    │
│  │   4. PNG + レビューログ生成（-Review）                  │    │
│  │   5. 視覚的レビュー（4パス方式）                         │    │
│  │   6. ソース+PNG対比確認（§ 4.3 参照）                    │    │
│  │   7. レビューログ更新（§ 4.4 参照）                      │    │
│  └─────────────────────────────────────────────────────────┘    │
│           ↓                                                     │
│       問題あり？ ─→ はい ─→ § 1.3 改善ループ ─→ Step 3 に戻る   │
│           ↓ いいえ                                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Phase 2: Publish                                        │    │
│  │   8. SVG生成・正式版保存（-Publish）                    │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 Phase 1: Review 詳細

| Step | 内容 | 参照 |
|:----:|------|:----:|
| 1 | Context7で仕様確認 | 下記参照 |
| 2 | 本憲法 § 2, § 3 を確認 | § 2, § 3 |
| 3 | コード作成（`<図表名>.puml`） | - |
| 4 | PNG + レビューログ生成 | § 5 `-Review` |
| 5-7 | レビュー・対比確認・ログ更新 | § 4.3〜4.4 |

#### ファイル命名規則

| 項目 | 規則 | 例 |
|------|------|-----|
| ファイル名 | `<図表名>.puml` | `admin_flow_mvp.puml` |
| @startuml | `@startuml <図表名>` | `@startuml admin_flow_mvp` |
| 日本語 | 可（ただし英数字推奨） | `管理機能フロー.puml` |

**命名のベストプラクティス**:
- スネークケース（`admin_flow_mvp`）を推奨
- 図表タイプを含める（`_flow`, `_sequence`, `_class`）
- 日付を含める場合は末尾に（`admin_flow_20251207`）

#### Context7の使用方法

##### 基本的な呼び出し

```
mcp__context7__resolve-library-id → libraryName: "plantuml"
mcp__context7__get-library-docs   → topic: "<図表タイプ>"
```

| 図表タイプ | topic |
|-----------|-------|
| アクティビティ図 | `"activity diagram swimlane"` |
| シーケンス図 | `"sequence diagram"` |
| ユースケース図 | `"use case diagram"` |
| クラス図 | `"class diagram"` |
| コンポーネント図 | `"component diagram"` |
| 状態図 | `"state diagram"` |

##### 反復照会パターン（重要）

**1回の参照で終わらせない。** 作成→確認→修正のサイクルで品質を高める：

```
[作成前] Context7照会 → 基本構文を確認
           ↓
[作成中] コード作成
           ↓
[問題発生時] Context7再照会 → 代替構文・回避策を確認
           ↓
[修正後] Context7照会 → 修正内容の妥当性を確認
```

| 段階 | Context7の役割 |
|------|---------------|
| 1回目（作成前） | 基本構文・使用可能な機能を確認 |
| 2回目（問題発生時） | 代替構文・回避策を確認 |
| N回目（問題残存時） | さらに詳細な仕様・制約を確認 |

### 1.3 改善ループ（問題発見時）

> **Note**: Context7の使用方法・反復照会パターンは § 1.2 を参照。本セクションは問題発見後の改善プロセスに特化。

```
問題発見 → § 3/Context7で調査 → 回避策適用 → PNG再生成 → 再レビュー
    ↑                                                    │
    └────────────── 問題が残る場合 ←─────────────────────┘
```

**調査の優先順位**: § 3（既知の制限）→ Context7（§ 1.2参照）→ GitHub Issues → 公式ドキュメント

#### 改善手順（6ステップ）

1. **問題の特定**: 対比確認テーブル（§ 4.3）で問題箇所を明確化
2. **原因の調査**: 上記優先順位で調査
3. **回避策の適用**: § 3 の回避策または新規回避策を適用
4. **コード修正**: .puml を修正
5. **再レビュー**: PNG再生成（`-Review`）→ 4パスレビュー
6. 問題が残れば **1 に戻る**

### 1.4 Phase 2: Publish

レビュー完了（status: completed）後に実行する。

**コマンド**: § 5 `-Publish` 参照

### 1.5 改善サイクル完了時の更新

新たに発見したPlantUMLの制限は、**問題解決直後**に § 3「その他の制限」テーブルに追加する。

#### § 3 への反映基準

以下の**3条件すべて**を満たす問題を追加する：

| # | 条件 | 理由 |
|:-:|------|------|
| 1 | PlantUMLの仕様・バグに起因する | コードミスではなくPlantUML自体の制限 |
| 2 | 回避策が存在する | 単なる「できない」ではなく対処法がある |
| 3 | § 3 に未記載 | 既知の制限と重複しない |

#### 改善サイクルの記録

| # | 更新対象 | 記録内容 | タイミング |
|:-:|---------|---------|-----------|
| 1 | `work_sheet.md` | 発見した問題、原因分析、適用した回避策、対比確認テーブル | 各イテレーション完了時 |
| 2 | 本憲法 § 3 | 新たに発見した問題パターン・回避策 | 問題解決直後 |

**work_sheet.md テンプレート**: `docs/templates/work_sheet_template.md`

---

## 2. 禁止事項（MUST NOT）

以下の行為は**絶対に禁止**する。違反した場合、図表は品質基準を満たさない。

| # | 禁止事項 | 理由 | 詳細 |
|:-:|---------|------|:----:|
| 1 | **if/fork/switch内でスイムレーン遷移するコードを書く** | 接続線が描画されない（孤立ノード発生） | § 3 |
| 2 | **SVGのXMLテキストを見て視覚確認したと判断する** | SVGは画像として認識されない | § 4.1 |
| 3 | **ソース+PNG対比確認をスキップする** | 接続線の途切れを見落とす | § 4.3 |
| 4 | **Context7確認なしでPlantUMLコードを作成する** | 構文エラー・非互換の見落とし | § 1.2 |
| 5 | **レビューログ未更新でPublishする** | 品質保証の証跡がない | § 4.4 |
| 6 | **レビュー後に.pumlを修正してPublishする** | ハッシュ不一致で品質担保不可 | § 5 |
| 7 | **ソースコードから接続を推測して✅をつける** | 実際に描画されていない接続線を見落とす | § 4.3 |
| 8 | **PNGと.pumlを同時に読み込む** | ソースの知識がPNG視覚確認に確証バイアスを与える | § 4.3 |

---

## 3. 既知の制限と回避策

PlantUMLの既知の問題。**コード作成前に必ず確認せよ。**

### 最重要：if/fork内でのスイムレーン遷移

**if文/fork文の内部でスイムレーンを変更すると、接続線が描画されない。**

#### 禁止パターン1: if内で複数回スイムレーン遷移

```plantuml
' ❌ 禁止パターン1: if内で複数のスイムレーンに遷移
|開発者|
if (確認?) then (はい)
  |Frontend Service|     ← 問題: if内でスイムレーン変更
  :リクエスト送信;
  |Supabase|             ← 問題: if内でさらにスイムレーン変更
  :データ更新;
endif
```

#### 禁止パターン2: endif直後のスイムレーン遷移

```plantuml
' ❌ 禁止パターン2: endif直後のスイムレーン遷移
|開発者|
if (条件) then (はい)
  :処理;
endif
|Frontend Service|       ← 問題: endif直後のスイムレーン遷移も接続が切れる
:結果表示;
```

#### 禁止パターン3: fork内でスイムレーン遷移

```plantuml
' ❌ 禁止パターン3: fork内でスイムレーン遷移
|Frontend Service|
fork
  :内部ログ取得;
  |Supabase|             ← 問題: fork内でスイムレーン変更
  :ログ集計;
fork again
  :外部API呼出;
end fork
```

#### 禁止パターン4: switch/case内でスイムレーン遷移

```plantuml
' ❌ 禁止パターン4: switch/case内でスイムレーン遷移
|開発者|
switch (操作を選択)
case (詳細確認)
  :ユーザーをクリック;
  |Frontend Service|     ← 問題: case内でスイムレーン変更
  :ユーザー詳細表示;     ← 最初のcase以外で孤立ノードになる
  detach
case (権限変更)
  :権限変更をクリック;   ← 孤立ノード（上流接続なし）
  |Frontend Service|
  :権限変更ダイアログ;
  detach
endswitch
```

> **重要**: switch/case内でスイムレーン遷移すると、**最初のcase以外のノードが孤立**する。これは10フロー中7フローで発見された頻出パターン（2025-12-08確認）。

```plantuml
' ✅ 回避策1：if外でスイムレーン遷移
if (確認?) then (はい)
  :確認OK;
else (キャンセル)
  stop
endif
|Frontend|       ← if外なのでOK
:処理;
```

```plantuml
' ✅ 回避策2：1つのスイムレーン内に収め、noteで詳細を説明
|Frontend Service|
:処理を実行;
note right
  **処理フロー**
  1. Supabaseにリクエスト送信
  2. データ更新実行
  3. 結果を受信
end note

if (成功?) then (はい)
  #palegreen:完了通知;
else (エラー)
  #mistyrose:エラー通知;
endif
stop
```

```plantuml
' ✅ 回避策3：図を分割する（概要図と詳細図）
|開発者|
start
:操作を選択;
switch (操作)
case (処理A)
  :処理Aへ;
  note right: 詳細は「処理A詳細図」参照
  detach
case (処理B)
  :処理Bへ;
  note right: 詳細は「処理B詳細図」参照
  detach
endswitch
```

#### 回避策の使い分け

| 状況 | 推奨回避策 | 理由 |
|------|:---------:|------|
| 単純な分岐後に別レーンで処理継続 | **回避策1** | 最もシンプル、可読性高 |
| 複数サービス間の複雑な内部処理 | **回避策2** | noteで詳細説明、図はシンプルに |
| 10ステップ以上の大規模フロー | **回避策3** | 概要図+詳細図で階層化 |
| 分岐内で異なる終了パスがある | **回避策1** | 各パスをif外で処理 |

### その他の制限

**※ 新たに発見した問題は、このテーブルに行を追加すること（§ 1.5 参照）**

| 問題 | 回避策 | 発見日 |
|------|--------|:------:|
| **switch/case内でスイムレーン遷移すると孤立ノード発生** | switch全体を1スイムレーン内に収め、他レーンの処理はnoteで説明 | 2025-12-08 |
| **if/else両方でスイムレーン遷移すると else側が孤立** | if全体を1スイムレーン内に収め、noteで説明 | 2025-12-08 |
| endif直後のスイムレーン遷移で接続が切れる | endif後に1行アクションを入れてから遷移 | - |
| ネストしたsplit/forkとスイムレーン ([Issue #2161](https://github.com/plantuml/plantuml/issues/2161)) | 構造を簡素化、detachで分岐を終端 | - |
| シーケンス図で`note bottom of`使用不可 | `note over`を使用 | - |

#### 問題パターンの発見統計（2025-12-08）

3.9 管理機能フロー（10フロー）のレビューで発見：

| 問題パターン | 発見数 | 割合 |
|-------------|:------:|:----:|
| switch/case内スイムレーン遷移 | 3 | 30% |
| if/else内スイムレーン遷移 | 3 | 30% |
| endif直後のスイムレーン遷移 | 1 | 10% |
| **合計** | **7** | **70%** |

> **教訓**: 分岐構造（if/switch/fork）内でのスイムレーン遷移は非常に頻繁に問題を引き起こす。**コード作成時に回避策を先に適用する**ことを推奨。

---

## 4. レビュー手順

### 4.1 PNG形式での視覚確認

SVGはXMLテキストとして返される。**PNGのみ**がマルチモーダル機能で視覚確認可能。

#### 視覚的レビューの実行手順

```
1. Read tool でPNGファイルを読み込む
2. マルチモーダル機能が自動的に画像を視覚的に分析
3. 4パス方式（§ 4.2）で段階的にレビュー
```

**重要**: PNGファイルはReadツールで読み込むと、AIのマルチモーダル機能により視覚的に認識される。テキストとして処理しようとしてはならない。

### 4.2 4パスレビュー

**接続線の見落としを防ぐため、4段階に分けてレビューする。**

| パス | 確認内容 | 重要度 |
|:---:|---------|:-----:|
| Pass 1 | **全体構造**: スイムレーン構成、開始/終了ノード | ○ |
| Pass 2 | **接続線**: すべての線が正しく結線、途切れ・孤立なし | **最重要** |
| Pass 3 | **ノード内容**: テキスト、条件分岐ラベル | ○ |
| Pass 4 | **スタイル**: 色分け、note配置、レイアウト | ○ |

#### Pass 1: 全体構造

- [ ] スイムレーン数が仕様通りか
- [ ] 処理の流れの方向が正しいか（上から下）
- [ ] `start`ノードが存在するか
- [ ] `stop`/`end`ノードが存在するか

#### Pass 2: 接続線（最重要）

##### 上流・下流接続の概念

```
        上流接続（入力）
              ↓
    ┌─────────────────┐
    │     ノード      │
    └─────────────────┘
              ↓
        下流接続（出力）
```

| 方向 | 確認内容 | 見落とすと |
|:---:|---------|-----------|
| **上流** | ノードに矢印が**入っているか** | 孤立ノード |
| **下流** | ノードから矢印が**出ているか** | 行き止まり |

##### チェックリスト

各ノードの**上流接続（入力）と下流接続（出力）**を確認する。

| # | 確認項目 | チェック内容 |
|:-:|---------|-------------|
| 1 | **開始ノード** | `start`から最初のアクションへ矢印が直接接続されているか |
| 2 | **終了ノード** | すべてのフローが`stop`または`end`に直接接続されているか |
| 3 | **分岐の結線** | `if/else`、`switch`の全分岐が前後のノードと直接接続されているか |
| 4 | **スイムレーン間** | スイムレーンをまたぐ矢印がノードと直接接続しているか |
| 5 | **孤立ノード** | 上位のノードまたは下位のノードと直接接続していない |
| 6 | **ループ構造** | `repeat`、`while`のループがノードと直接接続しているか |
| 7 | **並行処理** | `fork/join`、`split`が正しくペアになっているか |

#### Pass 3: ノード内容

- [ ] テキストの正確性（誤字脱字なし）
- [ ] 条件分岐のラベルが正しいか
- [ ] 処理内容が仕様と一致しているか

#### Pass 4: スタイル

- [ ] **色分け**: 成功=`#palegreen`、エラー=`#mistyrose`、確認=`#lightyellow`
- [ ] **note配置**: 補足説明が正しい位置に配置されているか
- [ ] **レイアウト**: 幅・高さが適切か、可読性は十分か

### 4.3 対比確認

#### 核心ルール

**各ノードについて、入力線と出力線を追跡し、上位・下位ノードまで途切れなく繋がっているか確認する。**

#### 手順

> **⚠️ 重要**: PNGと.pumlを同時に読み込んではならない（禁止事項#8）。ソースの知識が視覚確認に確証バイアスを与える。

**Phase A: PNG視覚確認（.pumlを読む前に実施）**

1. PNGのみを読み込む（.pumlは読まない）
2. 最初のノードを選ぶ
3. **入力線の確認**: ノードに入る線を逆方向に追跡 → 接続先ノード名を特定
4. **出力線の確認**: ノードから出る線を順方向に追跡 → 接続先ノード名を特定
5. **記録**: 接続先ノード名を記録（途切れている場合は❌）
6. 次のノードへ進み、3-5を繰り返す
7. PNG視覚確認の結果をテーブル形式で記録

**Phase B: ソース対比確認（PNG確認完了後）**

8. .pumlを読み込む
9. PNG確認結果とソースを対比し、問題箇所の行番号を特定

#### 記録形式

| 列 | 記録内容 |
|---|---------|
| 上流接続 | 接続先ノード名（繋がっている場合）または ❌（途切れている場合） |
| 下流接続 | 接続先ノード名（繋がっている場合）または ❌（途切れている場合） |
| 判定 | OK（両方接続あり）または NG（❌が1つ以上） |

> **注**: start の上流は「-」、stop/detach の下流は「-」（正常）

#### テーブル例

```
| ノード | 上流接続 | 下流接続 | 判定 |
|--------|---------|---------|:----:|
| start | - | 「パラメータ設定」をクリック | OK |
| パラメータを調整 | モデルを選択 | ❌ | NG |
| 更新成功? | ❌ | 完了通知, エラー通知 | NG |
| stop | 完了通知, エラー通知 | - | OK |
```

→ **ノード名を書くことで追跡を強制し、見落としを防止する**

> **詳細**: 背景説明・危険パターン・具体例は「付録A: 対比確認ガイド」参照

### 4.4 レビューログ更新

4パスレビュー + ソース対比確認の完了後、`.review.json`の`current`を更新する。

#### レビューログの初期状態

`-Review`実行時に自動生成される`.review.json`の構造：

```json
{
  "file": "diagram.puml",
  "current": {
    "hash": "A1B2C3D4E5F6G7H8",
    "timestamp": "2025-12-07T10:30:00",
    "status": "pending",
    "review": {
      "pass1_structure": false,
      "pass2_connections": false,
      "pass3_content": false,
      "pass4_style": false
    },
    "issues": [
      {
        "pass": null,
        "symptom": null,
        "cause": null
      }
    ],
    "reviewed_at": null
  },
  "history": []
}
```

| フィールド | 説明 |
|-----------|------|
| `file` | 対象の.pumlファイル名 |
| `hash` | ファイルのハッシュ値（変更検知用） |
| `timestamp` | レビューログ生成日時 |
| `status` | `pending` → `completed` または `failed` |
| `history` | 過去のレビュー履歴（再Review時に前回のcurrentが移動） |

#### 更新手順

**問題なしの場合（4ステップ）:**

1. `issues`を空配列`[]`に変更
2. `review`の各passを`true`に変更
3. `status`を`"completed"`に変更
4. `reviewed_at`に現在日時を記入（ISO 8601形式: `2025-12-07T10:35:00`）

**問題ありの場合（5ステップ）:**

1. `issues`にテンプレートの`pass`/`symptom`/`cause`に値を記入（複数問題は配列に追加）
2. `review`の該当passを`false`のまま維持
3. `status`を`"failed"`に変更
4. `reviewed_at`に現在日時を記入
5. .puml修正後、再度`-Review`実行（前回のcurrentはhistoryに自動移動）

#### 問題なしの場合

```json
{
  "current": {
    "status": "completed",
    "review": {
      "pass1_structure": true,
      "pass2_connections": true,
      "pass3_content": true,
      "pass4_style": true
    },
    "issues": [],
    "reviewed_at": "2025-12-07T10:35:00"
  }
}
```

#### 問題ありの場合

```json
{
  "current": {
    "status": "failed",
    "review": {
      "pass1_structure": true,
      "pass2_connections": false,
      "pass3_content": true,
      "pass4_style": true
    },
    "issues": [
      {
        "pass": 2,
        "symptom": "行8「:リクエスト送信;」の上流接続がない",
        "cause": "if文内でスイムレーン遷移している（Issue #1007）"
      }
    ],
    "reviewed_at": "2025-12-07T10:35:00"
  }
}
```

#### issues の書き方

| フィールド | 内容 |
|-----------|------|
| `pass` | 問題を検出したパス番号（1-4） |
| `symptom` | **何が**起きているか（現象） |
| `cause` | **なぜ**起きているか（原因） |

#### 問題発見→修正→再レビューのフロー

```
status: failed で記録 → .puml修正 → 再 -Review → 再レビュー → status: completed
                                      ↑
                        （前回のcurrentはhistoryに自動移動）
```

---

## 5. コマンドリファレンス

### `-Review`: レビュー用PNG生成

```powershell
pwsh scripts/validate_plantuml.ps1 -InputPath ".\diagram.puml" -Review
```

**生成されるファイル:**

| ファイル | 用途 |
|---------|------|
| `diagram.png` | 視覚的レビュー用（マルチモーダル機能で確認） |
| `diagram.review.json` | レビューログ（status: pending） |

### `-Publish`: 正式版SVG保存

```powershell
pwsh scripts/validate_plantuml.ps1 -InputPath ".\diagram.puml" -Publish -DiagramType "<type>"
```

**DiagramType一覧:**

| DiagramType | 保存先 |
|-------------|--------|
| `business_flow` | `docs/proposals/diagrams/business_flow/` |
| `sequence` | `docs/proposals/diagrams/sequence/` |
| `usecase` | `docs/proposals/diagrams/usecase/` |
| `context` | `docs/proposals/diagrams/context/` |
| `component` | `docs/proposals/diagrams/component/` |
| `class` | `docs/proposals/diagrams/class/` |
| `dfd` | `docs/proposals/diagrams/dfd/` |

**図表タイプとDiagramTypeの対応**:

| 図表タイプ（§ 1.2 topic） | DiagramType |
|--------------------------|-------------|
| アクティビティ図（業務フロー） | `business_flow` |
| シーケンス図 | `sequence` |
| ユースケース図 | `usecase` |
| コンテキスト図 | `context` |
| コンポーネント図 | `component` |
| クラス図 | `class` |
| データフロー図 | `dfd` |

**スクリプトの検証内容:**

| # | 検証項目 | 失敗時のエラー |
|:-:|---------|---------------|
| 1 | レビューログ存在 | `"Review log not found. Run -Review first."` |
| 2 | status = completed | `"Review not completed. Status: pending/failed"` |
| 3 | ハッシュ一致 | `"File modified after review. Run -Review again."` |

### 保存先ルール

| 用途 | 保存先 | 説明 |
|------|--------|------|
| 正式版SVG | `docs/proposals/diagrams/<DiagramType>/` | PRDに採用する図表 |
| 一時検証用PNG | `docs/evidence/<日付>/` | レビュー・作業証跡 |
| レビューログ | `.puml`と同じディレクトリ | 品質保証の証跡 |

### ファイル管理

| ファイル | Publish後の扱い | 理由 |
|---------|----------------|------|
| `.puml` | **保持** | ソースコードとして管理 |
| `.review.json` | **保持** | 品質保証の証跡、履歴分析に使用 |
| `.png` | **保持（evidence内）** | 作業証跡として保存 |
| `.svg` | **proposals/diagrams/に保存** | 正式版として管理 |

### Gitコミット

```bash
git add docs/proposals/diagrams/
git commit -m "docs: 業務フロー図SVGを追加"
```

---

## 6. ディレクトリ構成

PlantUML開発で使用する主要なディレクトリ構成。

```
PlantUML2_Opus4.5/
├── docs/
│   ├── evidence/                    # 作業証跡
│   │   └── yyyyMMdd_HHmm_<work>/    # 日時_作業名
│   │       ├── *.puml               # PlantUMLソース
│   │       ├── *.png                # レビュー用PNG
│   │       ├── *.review.json        # レビューログ
│   │       ├── instructions.md      # 作業指示
│   │       ├── 00_raw_notes.md      # 作業メモ
│   │       └── work_sheet.md        # 作業結果
│   ├── proposals/
│   │   └── diagrams/                # ★ 正式版SVG保存先
│   │       ├── business_flow/       # 業務フロー図
│   │       ├── sequence/            # シーケンス図
│   │       ├── usecase/             # ユースケース図
│   │       ├── context/             # コンテキスト図
│   │       ├── component/           # コンポーネント図
│   │       ├── class/               # クラス図
│   │       └── dfd/                 # データフロー図
│   ├── guides/                      # ガイドドキュメント
│   │   ├── PlantUML_Development_Constitution.md  # ★ 本憲法
│   │   ├── PlantUML_Environment_Setup.md         # 環境構成
│   │   └── PlantUML_Script_Reference.md          # スクリプト詳細
│   └── templates/                   # テンプレート
│       └── work_sheet_template.md   # work_sheet雛形
├── scripts/
│   └── validate_plantuml.ps1        # ★ PlantUML検証・SVG生成スクリプト
└── .serena/
    └── memories/
        └── plantuml_svg_generation_standard.md  # Serenaメモリ
```

### ファイル配置ルール

| 用途 | 保存先 | ファイル形式 |
|------|--------|-------------|
| 作業中の.puml | `docs/evidence/<日時_作業名>/` | `*.puml` |
| レビュー用PNG | `docs/evidence/<日時_作業名>/` | `*.png` |
| レビューログ | `docs/evidence/<日時_作業名>/` | `*.review.json` |
| **正式版SVG** | `docs/proposals/diagrams/<DiagramType>/` | `*.svg` |

### DiagramTypeと保存先の対応

| DiagramType | 保存先ディレクトリ |
|-------------|-------------------|
| `business_flow` | `docs/proposals/diagrams/business_flow/` |
| `sequence` | `docs/proposals/diagrams/sequence/` |
| `usecase` | `docs/proposals/diagrams/usecase/` |
| `context` | `docs/proposals/diagrams/context/` |
| `component` | `docs/proposals/diagrams/component/` |
| `class` | `docs/proposals/diagrams/class/` |
| `dfd` | `docs/proposals/diagrams/dfd/` |

---

## 付録

環境構成・インストール方法・トラブルシューティングは以下を参照：
- `docs/guides/PlantUML_Environment_Setup.md`

### 付録A: 対比確認ガイド

#### A.1 なぜ対比確認が必要か

PlantUMLには既知のレンダリングバグがあり、ソースコードでは接続があってもPNG上では描画されないことがある。

| 確認方法 | 検出できること | 検出できないこと |
|---------|--------------|----------------|
| ソースコードのみ | 構文エラー | 描画されない接続線 |
| PNGのみ | 見た目の問題 | どの行が原因か |
| **対比確認** | 両方 | - |

#### A.2 用語定義

| 用語 | 定義 |
|------|------|
| 直接接続 | 線がノードからノードへ途切れなく繋がっている |
| 上位ノード | フロー上で前にあるノード（入力元） |
| 下位ノード | フロー上で後にあるノード（出力先） |

#### A.3 危険パターン

以下の箇所は接続線が途切れやすい。優先的に確認すること：

- if/fork/switch内でのスイムレーン遷移
- endif/end fork直後のスイムレーン遷移
- 複数レーンをまたぐ分岐

#### A.4 確認の具体例

**PNG上での追跡手順**:

```
ノード「チェーンをクリック」を確認する場合：

【入力線の確認】
1. PNGで「チェーンをクリック」を見つける
2. このノードに入る線を探す
3. 線を逆方向に追跡する
   → 「操作を選択」まで繋がっているか？
4. 途中で線が途切れている → ❌

【出力線の確認】
1. このノードから出る線を探す
2. 線を順方向に追跡する
   → 「編集画面表示」まで繋がっているか？
3. 途中で線が途切れている → ❌
```

**対比確認テーブル例**:

| ノード | 上流接続 | 下流接続 | 判定 |
|--------|---------|---------|:----:|
| start | - | 「フォールバック設定」をクリック | OK |
| 「フォールバック設定」をクリック | start | フォールバックチェーン一覧表示 | OK |
| チェーンをクリック | ❌ | ❌ | NG |
| 編集画面表示 | ❌ | 設定を変更 | NG |
| stop | LLM管理画面へ | - | OK |

→ ノード名を記録することで「本当に追跡したか」が検証可能になる

#### A.5 問題箇所の特定（Grepパターン）

PNG確認で❌が見つかった後、ソースコードで原因を特定する：

**スイムレーン遷移箇所**:
```
Grep: pattern="^\s*\|.*\|"
```

**if/fork/switch構文**:
```
Grep: pattern="^\s*(if |else|endif|fork|end fork|switch|case|endswitch)"
```

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-12-08 | 3.4 | **§2/§3 禁止パターン拡張**: if/fork → if/fork/switch に拡張、禁止パターン4（switch/case内スイムレーン遷移）追加、問題発見統計追加（3.9管理機能フロー10件中7件で修正必要） |
| 2025-12-07 | 3.3 | **§4.3 記録形式改善**: 接続確認でノード名を記録する形式に変更（✅/❌ → ノード名/❌）、追跡を強制し見落とし防止 |
| 2025-12-07 | 3.2 | **§2 禁止事項#8追加、§4.3 2フェーズ化**: PNGと.pumlの同時読み込み禁止（確証バイアス防止）、手順をPhase A（PNG視覚確認）とPhase B（ソース対比）に分離 |
| 2025-12-07 | 3.1 | **§4.3 再構成**: 情報過多対策として本文を簡潔化（約90行→約25行）、詳細は「付録A: 対比確認ガイド」に分離、行動中心の手順に改善 |
| 2025-12-07 | 3.0 | **§4.3 簡素化**: 核心ルール「1ノードずつ直接接続を確認」に集約、約50%削減（140行→70行）、3条件・反証主義・チェックリスト削除 |
| 2025-12-07 | 2.9 | **§4.3 大幅改善**: 「接続」の厳密な定義（3条件）、PNG先行方式（確証バイアス対策）、線の終点記録必須化、反証主義導入、出力形式改善 |
| 2025-12-07 | 2.8 | **§2 禁止事項#7追加、§4.3 確認手順強化**: 推測で✅をつけることを禁止、各ノード確認手順・出力形式・自己検証チェックリスト追加 |
| 2025-12-07 | 2.7 | **§ 6 ディレクトリ構成追加**: PlantUML開発で使用するディレクトリ構成、ファイル配置ルール、DiagramType対応表 |
| 2025-12-07 | 2.6 | **品質改善**: 視覚レビュー手順、ファイル命名規則、Context7統合、禁止理由追加、回避策ガイダンス、記録指示追加 |
| 2025-12-07 | 2.5 | **重要情報復元**: Context7 topic一覧・反復照会パターン、上流/下流接続図解、対比確認テーブルテンプレート |
| 2025-12-07 | 2.4 | **重複削減完了**: 706行→570行（19%削減） |
| 2025-12-07 | 2.0-2.3 | 重複削減Phase 1-4 |
| 2025-12-07 | 1.0-1.9 | 初版作成〜構成改善 |

> 詳細な変更履歴は Git コミット履歴を参照
