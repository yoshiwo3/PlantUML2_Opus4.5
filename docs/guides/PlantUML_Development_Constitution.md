# PlantUML開発憲法

**バージョン**: 1.0
**作成日**: 2025-12-07

ClaudeCodeが高品質なPlantUML図表を作成するための行動規範。

---

## 1. 禁止事項（MUST NOT）

以下の行為は**絶対に禁止**する。違反した場合、図表は品質基準を満たさない。

| # | 禁止事項 | 理由 |
|:-:|---------|------|
| 1 | **if/fork内でスイムレーン遷移するコードを書く** | 接続線が描画されない（Issue #1007） |
| 2 | **SVGのXMLテキストを見て視覚確認したと判断する** | SVGはReadツールで画像として認識されない |
| 3 | **ソース+PNG対比確認をスキップする** | 接続線の途切れを見落とす |
| 4 | **Context7確認なしでPlantUMLコードを作成する** | 構文エラーや非互換性の見落とし |
| 5 | **レビューログ未更新でPublishする** | 品質保証の証跡がない |
| 6 | **レビュー後に.pumlを修正してPublishする** | ハッシュ不一致で品質担保できない |

---

## 2. 既知の制限と回避策

PlantUMLの既知の問題。**コード作成前に必ず確認せよ。**

### 最重要：if/fork内でのスイムレーン遷移

**if文/fork文の内部でスイムレーンを変更すると、接続線が描画されない。**

```plantuml
' ❌ 禁止パターン
if (確認?) then (はい)
  |Frontend|     ← 接続線が描画されない
  :処理;
endif
```

```plantuml
' ✅ 回避策：if外でスイムレーン遷移
if (確認?) then (はい)
  :確認OK;
else (キャンセル)
  stop
endif
|Frontend|       ← if外なのでOK
:処理;
```

### その他の制限

**※ 新たに発見した問題は、このテーブルに行を追加すること（§ 6.3 参照）**

| 問題 | 回避策 |
|------|--------|
| endif直後のスイムレーン遷移で接続が切れる | endif後に1行アクションを入れてから遷移 |
| ネストしたsplit/forkとスイムレーン ([Issue #2161](https://github.com/plantuml/plantuml/issues/2161)) | 構造を簡素化、detachで分岐を終端 |
| シーケンス図で`note bottom of`使用不可 | `note over`を使用 |

---

## 3. 必須事項（MUST）

以下は**必ず実行**すること。

### 3.1 PNG形式で視覚確認すること

SVGはXMLテキストとして返される。**PNGのみ**がマルチモーダル機能で視覚確認可能。

### 3.2 各ノードの上流・下流接続を確認すること

```
        上流接続（入力）
              ↓
    ┌─────────────────┐
    │     ノード      │
    └─────────────────┘
              ↓
        下流接続（出力）
```

| 方向 | 確認内容 | 見落とすと |
|:---:|---------|-----------|
| **上流** | ノードに矢印が**入っているか** | 孤立ノード |
| **下流** | ノードから矢印が**出ているか** | 行き止まり |

### 3.3 ソース+PNG対比確認を実施すること

#### なぜ対比確認が必要か

| 確認方法 | 検出できること | 検出できないこと |
|---------|--------------|----------------|
| ソースコードのみ | 構文エラー、論理的な接続 | **描画されない接続線** |
| PNGのみ | 見た目の問題 | **どの行が原因か** |
| **ソース+PNG対比** | コードでは接続→画像では途切れ | - |

PlantUMLには既知のレンダリングバグがあり、**コード上は正しくても描画されない接続線がある**（Issue #1007）。

#### 確認手順

```
1. PNGを読み込む（Read tool → マルチモーダル機能で視覚確認）
2. ソースコードを読み込む（Read tool）
3. 問題箇所を抽出（Grepパターン使用）
4. 各ノードの上流・下流接続をPNGで確認
5. 対比確認テーブルを作成して記録
```

#### Grepパターン

```powershell
# スイムレーン遷移箇所を抽出
grep -nE "^\s*\|.*\|" diagram.puml

# if/fork構文を抽出
grep -nE "^\s*(if |else|endif|fork|end fork)" diagram.puml
```

### 3.4 対比確認テーブルを作成すること

```markdown
| ノード | 行 | 上流接続 | 下流接続 | 判定 |
|--------|:--:|:--------:|:--------:|:----:|
| start | 4 | - | ✅ →:操作選択 | OK |
| :操作選択; | 6 | ✅ start→ | ✅ →if | OK |
| :リクエスト送信; | 14 | ❌ なし | ✅ →:DB更新 | **要修正** |
| :DB更新; | 19 | ✅ →リクエスト | ❌ なし | **要修正** |
| stop | 40 | ✅ →完了通知 | - | OK |
```

### 3.5 レビューログを更新すること

4パスレビュー + ソース対比確認の完了後、`.review.json`の`current`を更新する。

#### 問題なしの場合

```json
{
  "current": {
    "status": "completed",
    "review": {
      "pass1_structure": true,
      "pass2_connections": true,
      "pass3_content": true,
      "pass4_style": true
    },
    "issues": [],
    "reviewed_at": "2025-12-07T10:35:00"
  }
}
```

#### 問題ありの場合

```json
{
  "current": {
    "status": "failed",
    "review": {
      "pass1_structure": true,
      "pass2_connections": false,
      "pass3_content": true,
      "pass4_style": true
    },
    "issues": [
      {
        "pass": 2,
        "symptom": "行8「:リクエスト送信;」の上流接続がない",
        "cause": "if文内でスイムレーン遷移している（Issue #1007）"
      }
    ],
    "reviewed_at": "2025-12-07T10:35:00"
  }
}
```

#### issues の書き方

| フィールド | 内容 |
|-----------|------|
| `pass` | 問題を検出したパス番号（1-4） |
| `symptom` | **何が**起きているか（現象） |
| `cause` | **なぜ**起きているか（原因） |

#### 問題発見→修正→再レビューのフロー

```
status: failed で記録 → .puml修正 → 再 -Review → 再レビュー → status: completed
                                      ↑
                        （前回のcurrentはhistoryに自動移動）
```

---

## 4. 品質基準（4パスレビュー）

| パス | 確認内容 | 重要度 |
|:---:|---------|:-----:|
| Pass 1 | **全体構造**: スイムレーン構成、開始/終了ノード | ○ |
| Pass 2 | **接続線**: すべての線が正しく結線、途切れ・孤立なし | **最重要** |
| Pass 3 | **ノード内容**: テキスト、条件分岐ラベル | ○ |
| Pass 4 | **スタイル**: 色分け、note配置、レイアウト | ○ |

### Pass 2 チェックリスト

- [ ] start→最初のアクション接続
- [ ] 全フロー→stop/end到達
- [ ] if/else、switchの全分岐接続
- [ ] スイムレーン間の矢印途切れなし
- [ ] 孤立ノードなし

---

## 5. 必須プロセス

### 5.1 全体フロー

```
┌─────────────────────────────────────────────────────────────────┐
│  1. Context7で仕様確認                                           │
│           ↓                                                     │
│  2. 本憲法 § 1, § 2 を確認（禁止事項・既知制限）                  │
│           ↓                                                     │
│  3. コード作成（.puml）                                          │
│           ↓                                                     │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Phase 1: Review                                         │    │
│  │   4. PNG + レビューログ生成（-Review）                  │    │
│  │   5. 視覚的レビュー（4パス方式）                         │    │
│  │   6. ソース+PNG対比確認（§ 3.3, § 3.4 参照）            │    │
│  │   7. レビューログ更新（§ 3.5 参照）                      │    │
│  └─────────────────────────────────────────────────────────┘    │
│           ↓                                                     │
│       問題あり？ ─→ はい ─→ § 5.3 改善ループ ─→ Step 3 に戻る   │
│           ↓ いいえ                                              │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ Phase 2: Publish                                        │    │
│  │   8. SVG生成・正式版保存（-Publish）                    │    │
│  └─────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 Phase 1: Review 詳細

#### Step 1: Context7で仕様確認

```
mcp__context7__resolve-library-id → libraryName: "plantuml"
mcp__context7__get-library-docs   → topic: "<図表タイプ>"
```

| 図表タイプ | topic |
|-----------|-------|
| アクティビティ図 | `"activity diagram swimlane"` |
| シーケンス図 | `"sequence diagram"` |
| ユースケース図 | `"use case diagram"` |
| クラス図 | `"class diagram"` |
| コンポーネント図 | `"component diagram"` |
| 状態図 | `"state diagram"` |

#### Step 2: 本憲法を確認

- § 1 禁止事項（if/fork内スイムレーン遷移など）
- § 2 既知の制限と回避策

#### Step 3: コード作成

```
ファイル命名: <図表名>.puml
コード内命名: @startuml <図表名> ... @enduml
```

#### Step 4: PNG + レビューログ生成

```powershell
pwsh scripts/validate_plantuml.ps1 -InputPath ".\diagram.puml" -Review
```

**生成されるファイル:**
- `diagram.png` - 視覚的レビュー用
- `diagram.review.json` - レビューログ（status: pending）

#### Step 5-7: レビュー・対比確認・ログ更新

§ 3.3〜3.5 の手順に従う。

### 5.3 改善ループ（問題発見時）

レビューで問題を発見した場合、以下のループを回す：

```
問題発見 → 原因調査 → コード修正 → PNG再生成（-Review）→ 再レビュー
    ↑                                                    │
    └────────────── 問題が残る場合 ←─────────────────────┘
```

#### 調査の優先順位

| 順位 | 調査先 | 確認内容 |
|:---:|--------|---------|
| 1 | **本憲法 § 2** | 既知の制限に該当するか確認 |
| 2 | **Context7** | 正しい構文・代替構文を確認 |
| 3 | **GitHub Issues** | 未知の問題か、回避策があるか調査 |
| 4 | **公式ドキュメント** | 仕様・制約を確認 |

#### 改善手順

1. **問題の特定**: § 3.4 対比確認テーブルで問題箇所を明確化
2. **原因の調査**: 上記優先順位で調査
3. **回避策の適用**: § 2 の回避策または新規回避策を適用
4. **コード修正**: Step 3 に戻り .puml を修正
5. **再レビュー**: Step 4-7 を再実行
6. 問題が残れば 1 に戻る

### 5.4 Phase 2: Publish

レビュー完了（status: completed）後に実行する。

```powershell
pwsh scripts/validate_plantuml.ps1 -InputPath ".\diagram.puml" -Publish -DiagramType "<type>"
```

| DiagramType | 保存先 |
|-------------|--------|
| `business_flow` | `docs/proposals/diagrams/business_flow/` |
| `sequence` | `docs/proposals/diagrams/sequence/` |
| `usecase` | `docs/proposals/diagrams/usecase/` |
| `context` | `docs/proposals/diagrams/context/` |
| `component` | `docs/proposals/diagrams/component/` |
| `class` | `docs/proposals/diagrams/class/` |
| `dfd` | `docs/proposals/diagrams/dfd/` |

### 5.5 改善サイクル完了時の更新

改善サイクルを通じて得た知見を記録・蓄積する。

| # | 更新対象 | 記録内容 | 性質 |
|:-:|---------|---------|------|
| 1 | `work_sheet.md` | 各イテレーションの経緯（発見した問題、原因分析、適用した回避策、対比確認テーブル） | セッション単位の詳細記録 |
| 2 | **本憲法 § 2「その他の制限」テーブル** | 新たに発見した問題パターン・回避策を行追加 | 永続的な知識ベース |

**work_sheet.md テンプレート**: `docs/templates/work_sheet_template.md`

#### § 2 への反映基準

以下の条件を**すべて満たす**問題は、§ 2「その他の制限」テーブルに追加する：

| # | 条件 | 理由 |
|:-:|------|------|
| 1 | PlantUMLの仕様・バグに起因する | コードミスではなくPlantUML自体の制限 |
| 2 | 回避策が存在する | 単なる「できない」ではなく対処法がある |
| 3 | § 2 に未記載 | 既知の制限と重複しない |

#### 反映タイミング

**問題解決直後**に § 2 へ追記する（セッション終了時ではない）

#### 反映手順

```
1. work_sheet.md の「問題と解決」セクションを確認
2. 上記3条件を満たすか判定
3. 満たす場合 → § 2「その他の制限」テーブルに行追加
   - 問題: 現象を簡潔に記述
   - 回避策: 具体的な対処法を記述
4. コミットメッセージに「§ 2 更新」を含める
```

**重要**: `work_sheet.md`だけでなく、本憲法にも反映することで、学んだ知識がプロジェクト全体に蓄積される。

---

## 6. コマンドリファレンス

```powershell
# レビュー用PNG生成
pwsh scripts/validate_plantuml.ps1 -InputPath ".\diagram.puml" -Review

# 正式版SVG保存
pwsh scripts/validate_plantuml.ps1 -InputPath ".\diagram.puml" -Publish -DiagramType "business_flow"
```

---

## 付録

環境構成・インストール方法・トラブルシューティングは以下を参照：
- `docs/guides/PlantUML_Environment_Setup.md`

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-12-07 | 1.3 | § 5, § 6 統合・再構成（Phase 1/2 明記、改善ループ統合、コマンド・生成ファイル明記） |
| 2025-12-07 | 1.2 | § 3.3「ソース+PNG対比確認」追加、§ 3.4 テーブル例拡充、§ 6 調査優先順位・改善手順追加 |
| 2025-12-07 | 1.1 | § 6「イテレーティブ改善」を旧ガイドから復元（Context7ループ、topic一覧） |
| 2025-12-07 | 1.0 | 初版作成。PlantUML_SVG_Generation_Guide.md v4.0から憲法部分を抽出・再構成 |
