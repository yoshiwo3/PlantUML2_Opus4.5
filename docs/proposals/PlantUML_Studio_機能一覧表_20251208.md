# PlantUML Studio - 機能一覧表

**作成日**: 2025-12-08
**バージョン**: 1.5
**対象範囲**: 全32ユースケース（MVP + Phase 2 + v3）

---

## 目次

- [概要](#概要)
- [0. 共通定義](#0-共通定義)
  - [0.1 共通エラーコード](#01-共通エラーコード)
  - [0.2 エラーハンドリング方針](#02-エラーハンドリング方針)
  - [0.3 リトライ戦略](#03-リトライ戦略)
- [凡例](#凡例)
- [1. 認証機能（F-AUTH）](#1-認証機能f-auth)
  - [1.1 機能サマリ](#11-機能サマリ)
  - [1.2 機能詳細](#12-機能詳細)
- [2. プロジェクト管理機能（F-PRJ）](#2-プロジェクト管理機能f-prj)
  - [2.1 機能サマリ](#21-機能サマリ)
  - [2.2 機能詳細](#22-機能詳細)
- [3. 図表操作機能（F-DGM）](#3-図表操作機能f-dgm)
  - [3.1 機能サマリ](#31-機能サマリ)
  - [3.2 機能詳細](#32-機能詳細)
- [4. AI機能（F-AI）](#4-ai機能f-ai)
  - [4.1 機能サマリ](#41-機能サマリ)
  - [4.2 機能詳細](#42-機能詳細)
- [5. 管理機能（F-ADM）](#5-管理機能f-adm)
  - [5.1 機能サマリ](#51-機能サマリ)
  - [5.2 機能詳細](#52-機能詳細)
- [6. 業務フロー・DFD対比表](#6-業務フローdfd対比表)
  - [6.1 業務フロー別対応表](#61-業務フロー別対応表サマリ)
  - [6.2 データフロー詳細対応表](#62-データフロー詳細対応表)
  - [6.3 データストア対応表](#63-データストア対応表)
- [7. UCカバレッジサマリ](#7-ucカバレッジサマリ)
- [8. 整合性チェック結果](#8-整合性チェック結果)
- [9. クラス図への橋渡し](#9-クラス図への橋渡し)
  - [9.1 抽出エンティティ候補](#91-抽出エンティティ候補)
  - [9.2 エンティティ属性候補](#92-エンティティ属性候補)
  - [9.3 エンティティ関連図](#93-エンティティ関連図概念レベル)
  - [9.4 関連定義](#94-関連定義)
  - [9.5 ドメインオブジェクト候補](#95-ドメインオブジェクト候補)
  - [9.6 Repository Pattern](#96-repository-patterntd-006準拠)

---

## 概要

本ドキュメントは、PlantUML Studioの機能一覧を定義し、業務フロー図・データフロー図（DFD）との対応関係を明確化する。

### 目的

1. **機能の網羅性確認**: 全UCが機能としてカバーされているか
2. **業務フロー・DFD対比**: フロー間の整合性確認
3. **不備発見**: 業務フロー・DFDの漏れ・矛盾を特定
4. **クラス図への橋渡し**: 次フェーズへの入力

### 整合性確認対象

| ドキュメント | バージョン | 整合ポイント |
|-------------|-----------|-------------|
| ユースケース図 | 2025-11-30 | UC番号、アクター、機能定義 |
| 業務フロー図 | 2025-12-01 | BF番号、処理フロー |
| データフロー図（DFD） | v3.1 | プロセス（P）、データフロー（DF） |
| TD-006 | - | Storage Only構成 |
| TD-007 | - | AI機能プロバイダー構成 |

---

## 0. 共通定義

本セクションでは、全機能で共通して適用されるエラーコード、エラーハンドリング方針、リトライ戦略を定義する。各機能固有のエラーは、それぞれの機能詳細セクションで定義される。

### 0.1 共通エラーコード

全機能で発生しうる共通エラーを以下に定義する。**各機能の「エラーケース」テーブルには、以下の共通エラーが暗黙的に含まれる**。

#### 認証・セッション関連エラー

| エラーコード | 条件 | ユーザーへの表示 | 対応アクション |
|-------------|------|-----------------|---------------|
| `SESSION_EXPIRED` | アクセストークンの有効期限切れ（1時間経過） | 「セッションの有効期限が切れました。再度ログインしてください。」 | ログイン画面にリダイレクト |
| `SESSION_INVALID` | 無効なセッション（トークン改竄、サーバー側削除等） | 「セッションが無効です。再度ログインしてください。」 | ログイン画面にリダイレクト |
| `REFRESH_TOKEN_EXPIRED` | リフレッシュトークンの有効期限切れ（7日経過） | 「ログインの有効期限が切れました。再度ログインしてください。」 | ログイン画面にリダイレクト |
| `UNAUTHORIZED` | 認証が必要な操作に未認証でアクセス | 「この操作にはログインが必要です。」 | ログイン画面にリダイレクト |
| `FORBIDDEN` | 権限不足（一般ユーザーが管理機能にアクセス等） | 「この操作を行う権限がありません。」 | 前の画面に戻る |

#### 接続・インフラ関連エラー

| エラーコード | 条件 | ユーザーへの表示 | 対応アクション |
|-------------|------|-----------------|---------------|
| `NETWORK_ERROR` | ネットワーク接続失敗（オフライン等） | 「ネットワーク接続に失敗しました。接続状況を確認してください。」 | リトライボタン表示 |
| `STORAGE_CONNECTION_ERROR` | Supabase Storage接続失敗 | 「ストレージに接続できません。しばらく待ってから再試行してください。」 | 自動リトライ後、リトライボタン表示 |
| `DATABASE_CONNECTION_ERROR` | Supabase Database接続失敗 | 「データベースに接続できません。しばらく待ってから再試行してください。」 | 自動リトライ後、リトライボタン表示 |
| `SERVICE_UNAVAILABLE` | サービス全体が利用不可 | 「サービスが一時的に利用できません。しばらく待ってから再試行してください。」 | ステータスページへのリンク表示 |
| `MAINTENANCE_MODE` | 計画メンテナンス中 | 「現在メンテナンス中です。終了予定: {end_time}」 | メンテナンス情報表示 |

#### レート制限・リソース関連エラー

| エラーコード | 条件 | ユーザーへの表示 | 対応アクション |
|-------------|------|-----------------|---------------|
| `RATE_LIMIT_EXCEEDED` | APIリクエストレート制限超過 | 「リクエストが多すぎます。{retry_after}秒後に再試行してください。」 | 指定時間後に自動リトライ |
| `QUOTA_EXCEEDED` | ユーザー/システムのクォータ超過 | 「利用上限に達しました。プランをアップグレードするか、管理者にお問い合わせください。」 | 設定画面へのリンク表示 |
| `RESOURCE_EXHAUSTED` | サーバーリソース枯渇 | 「サーバーが混み合っています。しばらく待ってから再試行してください。」 | 自動リトライ |

#### 入力・バリデーション関連エラー

| エラーコード | 条件 | ユーザーへの表示 | 対応アクション |
|-------------|------|-----------------|---------------|
| `INVALID_INPUT` | 入力値が不正（型エラー等） | 「入力内容が不正です。」 | 入力フィールドをハイライト |
| `VALIDATION_ERROR` | バリデーションルール違反 | 「{field_name}: {validation_message}」 | 入力フィールドにエラーメッセージ表示 |
| `PAYLOAD_TOO_LARGE` | リクエストサイズ超過（10MB上限） | 「データが大きすぎます。{max_size}MB以内にしてください。」 | ファイルサイズ削減のガイダンス |

#### 予期しないエラー

| エラーコード | 条件 | ユーザーへの表示 | 対応アクション |
|-------------|------|-----------------|---------------|
| `INTERNAL_SERVER_ERROR` | サーバー内部エラー（500） | 「予期しないエラーが発生しました。問題が続く場合はサポートにお問い合わせください。」 | エラーID表示、サポートリンク |
| `UNKNOWN_ERROR` | 分類できないエラー | 「エラーが発生しました。再試行してください。」 | リトライボタン表示 |

### 0.2 エラーハンドリング方針

#### エラーレスポンス形式

全APIは以下の統一形式でエラーを返却する：

```typescript
interface ErrorResponse {
  success: false;
  error: {
    code: string;           // エラーコード（上記定義）
    message: string;        // ユーザー向けメッセージ
    details?: {             // 詳細情報（デバッグ用、本番では省略可）
      field?: string;       // エラー発生フィールド
      reason?: string;      // 詳細理由
      timestamp: string;    // ISO 8601形式
      request_id: string;   // リクエスト追跡ID
    };
    retry_after?: number;   // リトライ可能な場合の待機秒数
  };
}
```

#### エラー処理の優先順位

エラー発生時、以下の優先順位で処理を行う：

1. **セッションエラー（SESSION_*, UNAUTHORIZED, FORBIDDEN）**: 最優先で検出し、認証フローにリダイレクト
2. **ネットワークエラー（NETWORK_*, *_CONNECTION_ERROR）**: リトライ戦略を適用
3. **レート制限エラー（RATE_LIMIT_*, QUOTA_*）**: 指定時間待機後リトライ
4. **バリデーションエラー（INVALID_*, VALIDATION_*）**: ユーザーに修正を促す
5. **その他のエラー**: エラーログ記録、ユーザーに汎用メッセージ表示

#### クライアント側の実装パターン

```typescript
// 全APIコールをラップするエラーハンドラー
async function apiCall<T>(fn: () => Promise<T>): Promise<T> {
  try {
    return await fn();
  } catch (error) {
    const errorCode = error.code || 'UNKNOWN_ERROR';

    // セッションエラー: 即座にログイン画面へ
    if (['SESSION_EXPIRED', 'SESSION_INVALID', 'REFRESH_TOKEN_EXPIRED', 'UNAUTHORIZED'].includes(errorCode)) {
      await supabase.auth.signOut();
      redirect('/login');
    }

    // 権限エラー: 前の画面へ
    if (errorCode === 'FORBIDDEN') {
      toast.error(error.message);
      router.back();
      return;
    }

    // リトライ可能エラー: リトライ戦略適用
    if (error.retry_after) {
      await delay(error.retry_after * 1000);
      return apiCall(fn); // 再帰的リトライ
    }

    throw error; // 上位で処理
  }
}
```

### 0.3 リトライ戦略

#### リトライ対象エラー

| エラーコード | リトライ | 最大回数 | 初期待機 | バックオフ |
|-------------|:--------:|:--------:|:--------:|:----------:|
| `NETWORK_ERROR` | ✅ | 3 | 1秒 | 指数（×2） |
| `STORAGE_CONNECTION_ERROR` | ✅ | 3 | 2秒 | 指数（×2） |
| `DATABASE_CONNECTION_ERROR` | ✅ | 3 | 2秒 | 指数（×2） |
| `SERVICE_UNAVAILABLE` | ✅ | 2 | 5秒 | 指数（×2） |
| `RATE_LIMIT_EXCEEDED` | ✅ | 1 | `retry_after`値 | なし |
| `RESOURCE_EXHAUSTED` | ✅ | 2 | 3秒 | 指数（×2） |
| `INTERNAL_SERVER_ERROR` | ✅ | 1 | 3秒 | なし |
| `SESSION_*` | ❌ | - | - | - |
| `VALIDATION_*` | ❌ | - | - | - |
| `FORBIDDEN` | ❌ | - | - | - |

#### 指数バックオフ実装

```typescript
async function withRetry<T>(
  fn: () => Promise<T>,
  options: {
    maxRetries: number;
    initialDelayMs: number;
    backoffMultiplier: number;
    retryableErrors: string[];
  }
): Promise<T> {
  let lastError: Error;
  let delay = options.initialDelayMs;

  for (let attempt = 0; attempt <= options.maxRetries; attempt++) {
    try {
      return await fn();
    } catch (error) {
      lastError = error;

      if (!options.retryableErrors.includes(error.code)) {
        throw error; // リトライ不可
      }

      if (attempt < options.maxRetries) {
        await sleep(delay);
        delay *= options.backoffMultiplier;
      }
    }
  }

  throw lastError; // 最大リトライ回数到達
}
```

#### 機能別リトライ設定

| 機能カテゴリ | 最大リトライ | 理由 |
|-------------|:------------:|------|
| F-AUTH（認証） | 0 | セキュリティ上、リトライ不可 |
| F-PRJ（プロジェクト） | 3 | Storage操作は一時的失敗が多い |
| F-DGM（図表操作） | 3 | Storage操作は一時的失敗が多い |
| F-AI（AI機能） | 2 | 外部API依存、フォールバック優先 |
| F-ADM（管理機能） | 2 | 管理操作は慎重に |

---

## 凡例

### 優先度

| 優先度 | 説明 | UC数 |
|:------:|------|:----:|
| MVP | 最小限の製品要件（Phase 1） | 14 |
| Phase 2 | 拡張機能 | 16 |
| v3 | DB追加後の機能 | 2 |

### 状況

| 状況 | 説明 |
|:----:|------|
| 定義済 | 業務フロー・DFD両方で定義済み |
| BFのみ | 業務フローのみ定義（DFD未対応） |
| DFDのみ | DFDのみ定義（業務フロー未対応） |
| 未定義 | 両方とも未定義（Phase 2/v3） |

### 採番体系

| 項目 | 形式 | 例 |
|------|------|-----|
| 機能ID | F-{カテゴリ}-{連番} | F-AUTH-01 |
| ユースケース | UC {パッケージ}-{連番} | UC 1-1 |
| 業務フロー | BF 3.{連番} | BF 3.1 |
| DFDプロセス | P{連番}.0 | P1.0 |
| データフロー | DF-{連番} | DF-1 |

---

## 1. 認証機能（F-AUTH）

### 1.1 機能サマリ

| 機能ID | 機能名 | UC | BF | DFD | 優先度 | 状況 |
|:------:|--------|:--:|:--:|:---:|:------:|:----:|
| F-AUTH-01 | ログイン | 1-1 | 3.4 | P1.0 | MVP | 定義済 |
| F-AUTH-02 | ログアウト | 1-2 | 3.4 | P1.0 | MVP | 定義済 |

### 1.2 機能詳細

#### F-AUTH-01: ログイン

| 項目 | 内容 |
|------|------|
| **機能名** | ログイン |
| **機能ID** | F-AUTH-01 |
| **対応UC** | UC 1-1 ログインする |
| **主アクター** | エンドユーザー |
| **二次アクター** | Supabase Auth |

**機能概要**:
OAuth 2.0 PKCE（Proof Key for Code Exchange）フローを使用して、GitHub または Google アカウントでユーザー認証を行う。認証成功後、JWTアクセストークンとリフレッシュトークンを発行し、セッションを確立する。

**処理フロー**:
1. ユーザーがログインボタン（GitHub/Google）をクリック
2. システムがcode_verifier（ランダム文字列）を生成し、SHA256ハッシュからcode_challengeを作成
3. OAuthプロバイダー（GitHub/Google）の認証画面にリダイレクト
4. ユーザーがOAuthプロバイダーで認証・認可を承認
5. OAuthプロバイダーから認可コード（authorization_code）を受信
6. Supabase Authがcode_verifierを使用してトークンを取得
7. JWTアクセストークン（有効期限: 1時間）とリフレッシュトークンを発行
8. ユーザー情報（user_id, email, provider）をセッションに保存
9. ダッシュボード画面にリダイレクト

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| provider | ENUM('github', 'google') | ✅ | 認証プロバイダー選択 |
| redirect_uri | URL | ✅ | 認証後のリダイレクト先 |
| code_verifier | VARCHAR(128) | ✅ | PKCE用検証コード（システム生成） |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| access_token | JWT | アクセストークン（有効期限: 1時間） |
| refresh_token | VARCHAR(512) | リフレッシュトークン（有効期限: 7日） |
| expires_at | TIMESTAMP | トークン有効期限（UTC） |
| user_id | UUID | ユーザー識別子 |
| email | VARCHAR(255) | ユーザーメールアドレス |

**前提条件**:
- インターネット接続が有効であること
- OAuthプロバイダー（GitHub/Google）が稼働していること
- ユーザーがGitHub/Googleアカウントを保有していること

**事後条件**:
- セッションが確立され、認証状態がブラウザに保存される
- 以降のAPIリクエストにアクセストークンが自動付与される
- last_sign_in_at が更新される

**エラーケース**:
| エラーコード | 条件 | ユーザーへの表示 |
|-------------|------|-----------------|
| `AUTH_PROVIDER_ERROR` | OAuthプロバイダーとの通信失敗 | 「認証プロバイダーに接続できません。しばらく待ってから再試行してください。」 |
| `AUTH_CANCELLED` | ユーザーが認証をキャンセル | 「ログインがキャンセルされました。」 |
| `AUTH_INVALID_STATE` | state パラメータ不一致（CSRF攻撃防止） | 「セキュリティエラーが発生しました。再度ログインしてください。」 |
| `AUTH_CODE_EXPIRED` | 認可コードの有効期限切れ | 「認証の有効期限が切れました。再度ログインしてください。」 |

**データフロー対応**:
- 入力: DF-1（ログイン情報: provider, redirect_uri, code_verifier）
- 出力: DF-2（認証トークン: access_token, refresh_token, expires_at, user_id）
- エラー: DF-2E（認証エラー: error_code, error_message, provider）
- データストア: D2（認証情報）

---

#### F-AUTH-02: ログアウト

| 項目 | 内容 |
|------|------|
| **機能名** | ログアウト |
| **機能ID** | F-AUTH-02 |
| **対応UC** | UC 1-2 ログアウトする |
| **主アクター** | エンドユーザー |
| **二次アクター** | Supabase Auth |

**機能概要**:
現在のユーザーセッションを終了し、すべての認証トークンを無効化する。ブラウザに保存された認証情報をクリアし、ログイン画面にリダイレクトする。

**処理フロー**:
1. ユーザーがログアウトボタンをクリック
2. システムがSupabase Auth APIの signOut() を呼び出し
3. サーバー側でリフレッシュトークンを無効化
4. ブラウザのローカルストレージ/Cookieから認証情報を削除
5. Next.jsのキャッシュを revalidatePath('/', 'layout') でクリア
6. ログイン画面（/login）にリダイレクト

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| scope | ENUM('global', 'local') | ❌ | ログアウト範囲（デフォルト: global） |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| success | BOOLEAN | ログアウト成功フラグ |
| redirect_url | URL | リダイレクト先（/login） |

**前提条件**:
- ユーザーがログイン状態であること

**事後条件**:
- セッションが完全に終了する
- リフレッシュトークンが無効化される
- ブラウザの認証情報がクリアされる
- 保護されたページへのアクセスが拒否される

**エラーケース**:
| エラーコード | 条件 | ユーザーへの表示 |
|-------------|------|-----------------|
| `LOGOUT_FAILED` | サーバー側でのセッション終了失敗 | 「ログアウトに失敗しました。ブラウザを閉じてください。」 |

**データフロー対応**:
- 出力: DF-2（認証状態変更結果: success, redirect_url）※ログアウト時はトークン無効化後のリダイレクト先を返却
- データストア: D2（認証情報からセッション削除）

> **注記**: DF-2はログイン・ログアウト両方の認証状態変更結果を表す。ログアウト時はトークン発行ではなく、セッション終了結果を返却する。

---

## 2. プロジェクト管理機能（F-PRJ）

### 2.1 機能サマリ

| 機能ID | 機能名 | UC | BF | DFD | 優先度 | 状況 |
|:------:|--------|:--:|:--:|:---:|:------:|:----:|
| F-PRJ-01 | プロジェクト作成 | 2-1 | 3.5 | P2.0 | MVP | 定義済 |
| F-PRJ-02 | プロジェクト選択 | 2-2 | 3.5 | P2.0 | MVP | 定義済 |
| F-PRJ-03 | プロジェクト編集 | 2-3 | 3.5 | P2.0 | MVP | 定義済 |
| F-PRJ-04 | プロジェクト削除 | 2-4 | 3.5 | P2.0 | MVP | 定義済 |

### 2.2 機能詳細

#### F-PRJ-01: プロジェクト作成

| 項目 | 内容 |
|------|------|
| **機能名** | プロジェクト作成 |
| **機能ID** | F-PRJ-01 |
| **対応UC** | UC 2-1 プロジェクトを作成する |
| **主アクター** | エンドユーザー |
| **二次アクター** | - |

**機能概要**:
図表をグループ化して管理するための「プロジェクト」を新規作成する。プロジェクトはSupabase Storage上のフォルダ構造として実現され、`/{user_id}/{project_name}/` の形式でパスが作成される。

**処理フロー**:
1. ユーザーがダッシュボードで「新規プロジェクト」ボタンをクリック
2. プロジェクト作成ダイアログが表示される
3. ユーザーがプロジェクト名（必須）と説明（任意）を入力
4. 「作成」ボタンクリックでバリデーション実行
   - プロジェクト名の文字数チェック（1〜100文字）
   - 使用可能文字チェック（英数字、日本語、アンダースコア、ハイフン、スペース）
   - 重複チェック（同一ユーザー内で一意）
5. バリデーション成功後、Supabase Storageにフォルダを作成
6. プロジェクト一覧を更新し、新規プロジェクトを表示
7. 作成したプロジェクトを自動選択状態にする

**入力データ**:
| データ項目 | 型 | 必須 | 制約 | 説明 |
|-----------|-----|:----:|------|------|
| project_name | VARCHAR(100) | ✅ | `^[a-zA-Z0-9ぁ-んァ-ン一-龯_\-\s]{1,100}$` | プロジェクト名 |
| description | TEXT | ❌ | 最大500文字 | プロジェクト説明 |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| success | BOOLEAN | 作成成功フラグ |
| project | Object | 作成されたプロジェクト情報 |
| project.name | VARCHAR(100) | プロジェクト名 |
| project.path | VARCHAR(255) | Storageパス |
| project.created_at | TIMESTAMP | 作成日時 |

**前提条件**:
- ユーザーがログイン状態であること
- 同名のプロジェクトが存在しないこと

**事後条件**:
- Supabase Storageにプロジェクトフォルダが作成される
- プロジェクト一覧に新規プロジェクトが表示される
- 作成したプロジェクトが選択状態になる

**エラーケース**:
| エラーコード | 条件 | ユーザーへの表示 |
|-------------|------|-----------------|
| `PROJECT_NAME_REQUIRED` | プロジェクト名が空 | 「プロジェクト名を入力してください。」 |
| `PROJECT_NAME_TOO_LONG` | 100文字超過 | 「プロジェクト名は100文字以内で入力してください。」 |
| `PROJECT_NAME_INVALID_CHAR` | 不正文字を含む | 「プロジェクト名に使用できない文字が含まれています。」 |
| `PROJECT_NAME_DUPLICATE` | 同名プロジェクトが存在 | 「同じ名前のプロジェクトが既に存在します。」 |
| `STORAGE_ERROR` | Storage作成失敗 | 「プロジェクトの作成に失敗しました。再試行してください。」 |

**データフロー対応**:
- 入力: DF-11（プロジェクト作成リクエスト: action="create", project_name）
- 出力: DF-15（プロジェクト操作結果: success, project, projects[], message）
- エラー: DF-15E（プロジェクト操作エラー: error_code, error_message, project_name）
- データストア: D1（図表ストレージにフォルダ作成）

---

#### F-PRJ-02: プロジェクト選択

| 項目 | 内容 |
|------|------|
| **機能名** | プロジェクト選択 |
| **機能ID** | F-PRJ-02 |
| **対応UC** | UC 2-2 プロジェクトを選択する |
| **主アクター** | エンドユーザー |
| **二次アクター** | - |

**機能概要**:
作業対象のプロジェクトを切り替える。選択状態はSupabaseの`users.last_selected_project_id`に保存され（TD-005）、ブラウザリロードやデバイス切り替え後も前回の作業を即座に再開できる。

**処理フロー**:
1. ユーザーがサイドバーまたはダッシュボードでプロジェクト一覧を表示
2. プロジェクトをクリックして選択
3. システムが`last_selected_project_id`をSupabaseに保存
4. 選択したプロジェクト内の図表一覧を取得・表示
5. エディタ領域に「図表を選択または新規作成」のプレースホルダーを表示

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| project_name | VARCHAR(100) | ✅ | 選択するプロジェクト名 |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| success | BOOLEAN | 選択成功フラグ |
| project | Object | 選択されたプロジェクト情報 |
| diagrams | Array | プロジェクト内の図表一覧 |
| diagrams[].name | VARCHAR(100) | 図表名 |
| diagrams[].type | ENUM('puml', 'excalidraw') | 図表タイプ |
| diagrams[].updated_at | TIMESTAMP | 最終更新日時 |

**前提条件**:
- ユーザーがログイン状態であること
- 指定したプロジェクトが存在すること

**事後条件**:
- 選択状態がSupabaseに永続化される
- 図表一覧が更新される
- 次回ログイン時に同じプロジェクトが選択状態になる

**エラーケース**:
| エラーコード | 条件 | ユーザーへの表示 |
|-------------|------|-----------------|
| `PROJECT_NOT_FOUND` | プロジェクトが存在しない | 「指定されたプロジェクトが見つかりません。」 |
| `PERMISSION_DENIED` | 他ユーザーのプロジェクト | 「このプロジェクトにアクセスする権限がありません。」 |

**データフロー対応**:
- 入力: DF-12（プロジェクト選択リクエスト: action="select", project_name）
- 出力: DF-15（プロジェクト操作結果: success, project, diagrams[]）
- データストア: D1（図表一覧を読み取り）

---

#### F-PRJ-03: プロジェクト編集

| 項目 | 内容 |
|------|------|
| **機能名** | プロジェクト編集 |
| **機能ID** | F-PRJ-03 |
| **対応UC** | UC 2-3 プロジェクトを編集する |
| **主アクター** | エンドユーザー |
| **二次アクター** | - |

**機能概要**:
既存プロジェクトの名前を変更する。Supabase Storage上のフォルダパスも連動して変更され、配下の図表ファイルは自動的に新しいパスに移動される。

**処理フロー**:
1. ユーザーがプロジェクト一覧でコンテキストメニュー（右クリック）または編集アイコンをクリック
2. プロジェクト編集ダイアログが表示される（現在の名前がプリセット）
3. ユーザーが新しいプロジェクト名を入力
4. 「保存」ボタンクリックでバリデーション実行
5. バリデーション成功後、以下を実行:
   - 配下の全ファイルを新しいパスにコピー
   - 元のファイルを削除
   - フォルダ構造を更新
6. プロジェクト一覧を更新
7. 選択状態を維持（新しい名前で）

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| project_name | VARCHAR(100) | ✅ | 現在のプロジェクト名 |
| new_name | VARCHAR(100) | ✅ | 新しいプロジェクト名 |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| success | BOOLEAN | 更新成功フラグ |
| project | Object | 更新されたプロジェクト情報 |

**前提条件**:
- ユーザーがログイン状態であること
- 指定したプロジェクトが存在すること
- 新しい名前が既存プロジェクトと重複しないこと

**事後条件**:
- プロジェクト名が変更される
- Storageパスが更新される
- 配下の図表は新しいパスからアクセス可能になる

**エラーケース**:
| エラーコード | 条件 | ユーザーへの表示 |
|-------------|------|-----------------|
| `PROJECT_NOT_FOUND` | プロジェクトが存在しない | 「指定されたプロジェクトが見つかりません。」 |
| `PROJECT_NAME_DUPLICATE` | 新しい名前が重複 | 「同じ名前のプロジェクトが既に存在します。」 |
| `RENAME_FAILED` | ファイル移動失敗 | 「プロジェクト名の変更に失敗しました。再試行してください。」 |

**データフロー対応**:
- 入力: DF-13（プロジェクト更新リクエスト: action="update", project_name, new_name）
- 出力: DF-15（プロジェクト操作結果: success, project, message）
- エラー: DF-15E（プロジェクト操作エラー: error_code, error_message, project_name）
- データストア: D1（パス更新）

---

#### F-PRJ-04: プロジェクト削除

| 項目 | 内容 |
|------|------|
| **機能名** | プロジェクト削除 |
| **機能ID** | F-PRJ-04 |
| **対応UC** | UC 2-4 プロジェクトを削除する |
| **主アクター** | エンドユーザー |
| **二次アクター** | - |

**機能概要**:
プロジェクトとその配下のすべての図表を完全に削除する。削除は不可逆操作のため、確認ダイアログで明示的な承認を求める。

**処理フロー**:
1. ユーザーがプロジェクト一覧でコンテキストメニューまたは削除アイコンをクリック
2. 確認ダイアログを表示:
   - 「プロジェクト "{project_name}" を削除しますか？」
   - 「このプロジェクト内の {N} 件の図表もすべて削除されます。」
   - 「この操作は取り消せません。」
3. ユーザーが「削除」ボタンをクリック
4. システムが以下を実行:
   - プロジェクトフォルダ配下の全ファイルを削除
   - プロジェクトフォルダを削除
5. プロジェクト一覧を更新
6. 削除したプロジェクトが選択状態だった場合、別のプロジェクトを自動選択（または「プロジェクトを選択してください」を表示）

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| project_name | VARCHAR(100) | ✅ | 削除するプロジェクト名 |
| confirm | BOOLEAN | ✅ | 削除確認フラグ（true必須） |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| success | BOOLEAN | 削除成功フラグ |
| deleted_count | INTEGER | 削除された図表数 |

**前提条件**:
- ユーザーがログイン状態であること
- 指定したプロジェクトが存在すること
- ユーザーが削除を明示的に確認すること

**事後条件**:
- プロジェクトが完全に削除される
- 配下の全図表が削除される
- プロジェクト一覧から該当プロジェクトが消える

**エラーケース**:
| エラーコード | 条件 | ユーザーへの表示 |
|-------------|------|-----------------|
| `PROJECT_NOT_FOUND` | プロジェクトが存在しない | 「指定されたプロジェクトが見つかりません。」 |
| `DELETE_NOT_CONFIRMED` | 確認フラグがfalse | 「削除を確認してください。」 |
| `DELETE_FAILED` | Storage削除失敗 | 「プロジェクトの削除に失敗しました。再試行してください。」 |

**データフロー対応**:
- 入力: DF-14（プロジェクト削除リクエスト: action="delete", project_name, confirm=true）
- 出力: DF-15（プロジェクト操作結果: success, deleted_count, message）
- エラー: DF-15E（プロジェクト操作エラー: error_code, error_message, project_name）
- データストア: D1（フォルダと全ファイルを削除）

---

## 3. 図表操作機能（F-DGM）

### 3.1 機能サマリ

| 機能ID | 機能名 | UC | BF | DFD | 対象 | 優先度 | 状況 |
|:------:|--------|:--:|:--:|:---:|:----:|:------:|:----:|
| F-DGM-01 | 図表作成 | 3-1 | 3.1, 3.3 | P3.0 | 共通 | MVP | 定義済 |
| F-DGM-02 | テンプレート選択 | 3-2 | 3.1, 3.3 | P3.0 | 共通 | MVP | 定義済 |
| F-DGM-03 | 図表編集 | 3-3 | 3.1, 3.3 | P3.0 | 共通 | MVP | 定義済 |
| F-DGM-04 | 図表プレビュー | 3-4 | 3.1 | P4.0 | PlantUML | MVP | 定義済 |
| F-DGM-05 | 図表保存 | 3-5 | 3.6 | P3.0 | 共通 | MVP | 定義済 |
| F-DGM-06 | 図表エクスポート | 3-6 | 3.6 | P7.0 | 共通 | MVP | 定義済 |
| F-DGM-07 | バージョン履歴確認 | 3-7 | 3.7 | - | 共通 | v3 | BFのみ |
| F-DGM-08 | 過去バージョン復元 | 3-8 | 3.7 | - | 共通 | v3 | BFのみ |
| F-DGM-09 | 図表削除 | 3-9 | 3.8 | P3.0 | 共通 | MVP | 定義済 |
| F-DGM-10 | 学習コンテンツ検索 | 3-10 | 3.10 | - | 共通 | Phase 2 | 未定義 |
| F-DGM-11 | 学習コンテンツ確認 | 3-11 | 3.10 | - | 共通 | Phase 2 | 未定義 |

### 3.2 機能詳細

#### F-DGM-01: 図表作成

| 項目 | 内容 |
|------|------|
| **機能名** | 図表作成 |
| **機能ID** | F-DGM-01 |
| **対応UC** | UC 3-1 図表を作成する |
| **主アクター** | エンドユーザー |
| **二次アクター** | - |
| **対象** | PlantUML / Excalidraw 共通 |

**機能概要**:
選択中のプロジェクト内に新しい図表を作成する。図表タイプ（PlantUML / Excalidraw）を選択し、空のエディタまたはテンプレートから作成を開始できる。PlantUML図表は`.puml`ファイル、Excalidraw図表は`.excalidraw.json`ファイルとしてSupabase Storageに保存される。

**処理フロー**:
1. ユーザーがプロジェクト選択状態で「新規図表」ボタンをクリック
2. 図表作成ダイアログが表示される:
   - 図表名入力（必須）
   - 図表タイプ選択（PlantUML / Excalidraw）
   - 作成方法選択（空のエディタ / テンプレートから）
3. ユーザーが情報を入力して「作成」をクリック
4. バリデーション実行:
   - 図表名の文字数チェック（1〜100文字）
   - 使用可能文字チェック（英数字、日本語、アンダースコア、ハイフン）
   - 重複チェック（同一プロジェクト内で一意）
5. 図表タイプに応じたエディタを開く:
   - PlantUML: Monaco Editorで空の@startuml〜@endumlブロック、またはテンプレートコード
   - Excalidraw: Excalidraw UIで空のキャンバス、またはテンプレートJSON
6. Storageにファイルを作成（初期内容を保存）

**入力データ**:
| データ項目 | 型 | 必須 | 制約 | 説明 |
|-----------|-----|:----:|------|------|
| project_name | VARCHAR(100) | ✅ | 存在するプロジェクト | 所属プロジェクト |
| diagram_name | VARCHAR(100) | ✅ | `^[a-zA-Z0-9ぁ-んァ-ン一-龯_\-]{1,100}$` | 図表名（拡張子なし） |
| content_type | ENUM('puml', 'excalidraw') | ✅ | - | 図表タイプ |
| template_id | VARCHAR(50) | ❌ | - | テンプレートID（選択時のみ） |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| success | BOOLEAN | 作成成功フラグ |
| diagram | Object | 作成された図表情報 |
| diagram.name | VARCHAR(100) | 図表名 |
| diagram.path | VARCHAR(255) | Storageパス |
| diagram.content_type | ENUM | 図表タイプ |
| diagram.source_code | TEXT | 初期ソースコード |

**前提条件**:
- ユーザーがログイン状態であること
- プロジェクトが選択されていること
- 同名の図表が同一プロジェクト内に存在しないこと

**事後条件**:
- Storageに図表ファイルが作成される
- エディタが開き、編集可能状態になる
- 図表一覧に新規図表が表示される

**エラーケース**:
| エラーコード | 条件 | ユーザーへの表示 |
|-------------|------|-----------------|
| `DIAGRAM_NAME_REQUIRED` | 図表名が空 | 「図表名を入力してください。」 |
| `DIAGRAM_NAME_TOO_LONG` | 100文字超過 | 「図表名は100文字以内で入力してください。」 |
| `DIAGRAM_NAME_INVALID_CHAR` | 不正文字を含む | 「図表名に使用できない文字が含まれています。」 |
| `DIAGRAM_NAME_DUPLICATE` | 同名図表が存在 | 「同じ名前の図表がこのプロジェクト内に既に存在します。」 |
| `PROJECT_NOT_SELECTED` | プロジェクト未選択 | 「先にプロジェクトを選択してください。」 |

**データフロー対応**:
- 入力: DF-3（図表操作リクエスト: action="create", diagram_name, content_type, template_id?）
- 出力: DF-4（図表保存データ: file_path, source_code）, DF-16（図表操作結果）
- データストア: D1（図表ストレージに新規ファイル作成）

---

#### F-DGM-02: テンプレート選択

| 項目 | 内容 |
|------|------|
| **機能名** | テンプレート選択 |
| **機能ID** | F-DGM-02 |
| **対応UC** | UC 3-2 テンプレートを選択する |
| **主アクター** | エンドユーザー |
| **二次アクター** | - |
| **対象** | PlantUML / Excalidraw 共通 |

**機能概要**:
図表作成時に、定義済みテンプレートから開始コードを選択する。テンプレートは図表タイプ（PlantUML/Excalidraw）とカテゴリ（シーケンス図、クラス図、ワイヤーフレーム等）で分類されており、プレビュー画像付きで一覧表示される。

**処理フロー**:
1. 図表作成ダイアログで「テンプレートから作成」を選択
2. テンプレート一覧画面に遷移:
   - タブで図表タイプをフィルタリング（PlantUML / Excalidraw / すべて）
   - カテゴリでサブフィルタリング
3. テンプレートカードに以下を表示:
   - テンプレート名
   - プレビューサムネイル（SVG/PNG）
   - 簡単な説明
4. ユーザーがテンプレートをクリックして選択
5. 「このテンプレートを使用」ボタンで確定
6. テンプレートのソースコードがエディタにロードされる

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| content_type | ENUM('puml', 'excalidraw', 'all') | ❌ | フィルタリング用タイプ（デフォルト: all） |
| category | VARCHAR(50) | ❌ | カテゴリフィルタ |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| templates | Array | テンプレート一覧 |
| templates[].id | VARCHAR(50) | テンプレートID |
| templates[].name | VARCHAR(100) | テンプレート名 |
| templates[].category | VARCHAR(50) | カテゴリ（sequence, class, usecase, wireframe等） |
| templates[].content_type | ENUM | 対応図表タイプ |
| templates[].preview_url | URL | プレビュー画像URL |
| templates[].description | TEXT | 説明文 |
| templates[].source_code | TEXT | テンプレートソースコード |

**前提条件**:
- 図表作成フローの一部として実行されること

**事後条件**:
- 選択されたテンプレートのソースコードがエディタにロードされる

**テンプレートカテゴリ一覧**:
| カテゴリID | 名称 | 対応タイプ |
|-----------|------|-----------|
| `sequence` | シーケンス図 | PlantUML |
| `class` | クラス図 | PlantUML |
| `usecase` | ユースケース図 | PlantUML |
| `activity` | アクティビティ図 | PlantUML |
| `state` | ステート図 | PlantUML |
| `component` | コンポーネント図 | PlantUML |
| `er` | ER図 | PlantUML |
| `wireframe` | ワイヤーフレーム | Excalidraw |
| `flowchart` | フローチャート | Excalidraw |
| `mockup` | モックアップ | Excalidraw |

**データフロー対応**:
- 入力: DF-23（テンプレート一覧リクエスト: action="list_templates", content_type, category?）
- 出力: DF-24（テンプレート一覧レスポンス: templates[]）
- データストア: D1（テンプレートファイル読み取り）

---

#### F-DGM-03: 図表編集

| 項目 | 内容 |
|------|------|
| **機能名** | 図表編集 |
| **機能ID** | F-DGM-03 |
| **対応UC** | UC 3-3 図表を編集する |
| **主アクター** | エンドユーザー |
| **二次アクター** | - |
| **対象** | PlantUML / Excalidraw 共通 |

**機能概要**:
図表のソースコードまたは視覚的なキャンバスを編集する。PlantUMLはMonaco Editor（VS Code同様のテキストエディタ）でコードを編集し、Excalidrawは専用の描画UIでオブジェクトを配置・編集する。

**処理フロー**:

**PlantUML編集**:
1. Monaco Editorにソースコードを表示
2. エディタ機能を提供:
   - シンタックスハイライト（PlantUML構文）
   - オートコンプリート（キーワード、エイリアス）
   - エラーマーカー（構文エラー箇所を赤下線で表示）
   - 行番号表示
   - 折りたたみ（@startuml〜@endumlブロック）
3. 入力待機処理（デバウンス500ms）後、自動プレビュー更新
4. Ctrl+S で手動保存

**Excalidraw編集**:
1. Excalidraw UIにキャンバスを表示
2. 描画ツールを提供:
   - 図形（矩形、円、菱形、線、矢印）
   - テキスト入力
   - フリーハンド描画
   - 画像挿入
   - グループ化/解除
3. 操作ごとにJSON形式で状態を保持
4. Ctrl+S で手動保存

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| project_name | VARCHAR(100) | ✅ | プロジェクト名 |
| diagram_name | VARCHAR(100) | ✅ | 図表名 |
| source_code | TEXT | ✅ | 編集後のソースコード/JSON |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| is_modified | BOOLEAN | 未保存の変更があるか |
| preview_svg | BLOB | プレビュー画像（PlantUMLのみ） |
| errors | Array | 構文エラー一覧（PlantUMLのみ） |

**前提条件**:
- 図表が開かれていること
- ユーザーに編集権限があること（自分の図表）

**事後条件**:
- 編集内容がエディタに反映される
- 未保存フラグが立つ（タイトルに * マーク）
- PlantUMLの場合、プレビューが自動更新される

**エラーケース**:
| エラーコード | 条件 | ユーザーへの表示 |
|-------------|------|-----------------|
| `SOURCE_CODE_TOO_LARGE` | 1MB超過 | 「ソースコードが大きすぎます。1MB以内に収めてください。」 |
| `SOURCE_CODE_INVALID_ENCODING` | 不正なエンコーディング | 「ソースコードの文字エンコーディングが不正です。」 |

**データフロー対応**:
- 入力: DF-3（図表操作リクエスト: action="update", source_code）
- 出力: DF-4（図表保存データ）, DF-16（図表操作結果）
- データストア: D1（編集内容を保存）

---

#### F-DGM-04: 図表プレビュー

| 項目 | 内容 |
|------|------|
| **機能名** | 図表プレビュー |
| **機能ID** | F-DGM-04 |
| **対応UC** | UC 3-4 図表をプレビューする |
| **主アクター** | エンドユーザー |
| **二次アクター** | OpenRouter API（エラー時のAI修正提案） |
| **対象** | PlantUML専用 |

**機能概要**:
PlantUMLソースコードをリアルタイムでSVG/PNG画像にレンダリングし、プレビューパネルに表示する。構文エラーがある場合はエラーメッセージを表示し、AIによる修正提案を提示する。内部的にnode-plantuml（Java 17 + Graphviz）を使用してローカルでレンダリングする。

**処理フロー**:
1. ユーザーがソースコードを編集
2. 入力待機処理（デバウンス500ms）で編集完了を検知
3. PlantUML Serviceに検証・レンダリングリクエストを送信
4. node-plantumlでソースコードを処理:
   - 構文チェック
   - SVG/PNG生成
5. 処理結果に応じて:
   - **成功**: プレビューパネルにSVG画像を表示
   - **警告あり**: 画像を表示 + 警告メッセージをトースト表示
   - **エラー**: エラーメッセージを表示 + AIによる修正提案をオプション表示
6. エラー時にAI修正提案を選択した場合:
   - OpenRouter APIに修正リクエスト送信
   - 修正コードをエディタに反映（差分表示）
   - ユーザーが「適用」または「キャンセル」を選択

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| source_code | TEXT | ✅ | PlantUMLソースコード |
| format | ENUM('svg', 'png') | ❌ | 出力形式（デフォルト: svg） |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| is_valid | BOOLEAN | 構文検証結果 |
| preview_svg | BLOB | プレビュー画像（SVG） |
| errors | Array | エラー一覧 |
| errors[].line | INTEGER | エラー行番号 |
| errors[].message | TEXT | エラーメッセージ |
| warnings | Array | 警告一覧 |
| suggested_fix | TEXT | AI修正提案（エラー時のみ） |
| ai_explanation | TEXT | 修正の説明（エラー時のみ） |

**前提条件**:
- PlantUML図表が開かれていること
- ソースコードが存在すること

**事後条件**:
- プレビューパネルに画像またはエラーが表示される
- エラー箇所がエディタにマーキングされる

**エラーケース**:
| エラーコード | 条件 | ユーザーへの表示 |
|-------------|------|-----------------|
| `SYNTAX_ERROR` | PlantUML構文エラー | 「構文エラー: {error_message}（行{line}）」 |
| `RENDER_ERROR` | レンダリング失敗 | 「図表の生成に失敗しました。構文を確認してください。」 |
| `RENDER_TIMEOUT` | タイムアウト（30秒） | 「図表の生成がタイムアウトしました。コードを簡素化してください。」 |
| `AI_UNAVAILABLE` | AI修正提案失敗 | 「AI修正提案を取得できませんでした。」 |

**データフロー対応**:
- 入力: DF-5（検証リクエスト: source_code, content_type="puml"）
- 出力: DF-6（検証結果: is_valid, preview_svg, errors[], warnings[]）
- エラー: DF-6E（検証エラー: errors[], suggested_fix?, ai_explanation?）
- 外部連携: OpenRouter API（AI修正提案時のみ）

---

#### F-DGM-05: 図表保存

| 項目 | 内容 |
|------|------|
| **機能名** | 図表保存 |
| **機能ID** | F-DGM-05 |
| **対応UC** | UC 3-5 図表を保存する |
| **主アクター** | エンドユーザー |
| **二次アクター** | OpenRouter API（用語一貫性チェック） |
| **対象** | PlantUML / Excalidraw 共通 |

**機能概要**:
編集中の図表をSupabase Storageに保存する。保存は手動操作（Ctrl+S または保存ボタン）でのみ実行される（TD-006: 自動保存なし）。保存時に用語一貫性チェックが自動実行され、プロジェクト内の用語の揺れを検出して通知する。

**処理フロー**:
1. ユーザーがCtrl+S を押すか、保存ボタンをクリック
2. バリデーション実行:
   - ソースコードのサイズチェック（最大1MB）
   - エンコーディングチェック（UTF-8）
3. 用語一貫性チェック（自動実行）:
   - プロジェクト内の他の図表と用語を比較
   - 揺れがある場合は通知（例: 「User」と「ユーザー」の混在）
   - チェック結果は通知のみで保存はブロックしない
4. Supabase Storageに保存:
   - ソースファイル: `/{user_id}/{project_name}/{diagram_name}.puml` または `.excalidraw.json`
   - プレビュー画像: `/{user_id}/{project_name}/{diagram_name}.preview.svg`
   - メタデータ: ファイル内コメントに埋め込み（TD-006 B案）
5. 保存完了をトースト通知
6. 未保存フラグをクリア

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| project_name | VARCHAR(100) | ✅ | プロジェクト名 |
| diagram_name | VARCHAR(100) | ✅ | 図表名 |
| source_code | TEXT | ✅ | ソースコード（最大1MB） |
| preview_svg | BLOB | ❌ | プレビュー画像（最大5MB） |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| success | BOOLEAN | 保存成功フラグ |
| saved_at | TIMESTAMP | 保存日時 |
| consistency_issues | Array | 用語一貫性の問題一覧 |
| consistency_issues[].term | TEXT | 問題のある用語 |
| consistency_issues[].variants | Array | 揺れのバリエーション |
| consistency_issues[].suggestion | TEXT | 推奨表記 |

**前提条件**:
- 図表が開かれていること
- 編集内容があること（変更がない場合も保存可能）

**事後条件**:
- Storageにファイルが保存される
- updated_at が更新される
- 未保存フラグがクリアされる
- 用語一貫性の問題があれば通知される

**エラーケース**:
| エラーコード | 条件 | ユーザーへの表示 |
|-------------|------|-----------------|
| `SOURCE_CODE_TOO_LARGE` | 1MB超過 | 「ソースコードが大きすぎます。1MB以内に収めてください。」 |
| `STORAGE_QUOTA_EXCEEDED` | ストレージ容量超過 | 「ストレージ容量が不足しています。不要な図表を削除してください。」 |
| `SAVE_FAILED` | 保存失敗 | 「保存に失敗しました。再試行してください。」 |
| `CONSISTENCY_CHECK_FAILED` | 用語チェック失敗 | （保存は続行、チェック結果のみスキップ） |

**データフロー対応**:
- 入力: DF-3（図表操作リクエスト: action="update", source_code）
- 出力: DF-4（図表保存データ: file_path, source_code, preview_svg）, DF-16（図表操作結果）
- 外部連携: OpenRouter API（用語一貫性チェック）
- データストア: D1（図表ストレージに保存）

---

#### F-DGM-06: 図表エクスポート

| 項目 | 内容 |
|------|------|
| **機能名** | 図表エクスポート |
| **機能ID** | F-DGM-06 |
| **対応UC** | UC 3-6 図表をエクスポートする |
| **主アクター** | エンドユーザー |
| **二次アクター** | - |
| **対象** | PlantUML / Excalidraw 共通 |

**機能概要**:
図表をPNG、SVG、またはPDF形式でローカルにダウンロードする。エクスポート時に解像度やサイズのオプションを指定可能。

**処理フロー**:
1. ユーザーがエクスポートボタンをクリック
2. エクスポートダイアログが表示:
   - 出力形式選択（PNG / SVG / PDF）
   - オプション設定（形式により異なる）
3. ユーザーが形式とオプションを選択して「エクスポート」をクリック
4. 形式に応じた処理:
   - **PNG**: PlantUMLはnode-plantumlで生成、Excalidrawはcanvas APIで生成
   - **SVG**: そのまま出力（ベクター形式）
   - **PDF**: SVGを変換してPDF生成
5. ブラウザのダウンロードダイアログで保存先を選択
6. ファイルをダウンロード

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| project_name | VARCHAR(100) | ✅ | プロジェクト名 |
| diagram_name | VARCHAR(100) | ✅ | 図表名 |
| format | ENUM('png', 'svg', 'pdf') | ✅ | 出力形式 |
| options.scale | FLOAT | ❌ | 拡大率（PNG/PDFのみ、デフォルト: 1.0） |
| options.background | ENUM('white', 'transparent') | ❌ | 背景色（PNG/SVGのみ） |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| file | BLOB | エクスポートされたファイルデータ |
| filename | VARCHAR(255) | ファイル名（`{diagram_name}.{format}`） |
| content_type | VARCHAR(50) | MIMEタイプ |
| file_size | INTEGER | ファイルサイズ（bytes） |

**前提条件**:
- 図表が開かれていること
- 図表に内容があること

**事後条件**:
- ファイルがローカルにダウンロードされる

**出力形式詳細**:
| 形式 | MIME Type | 用途 |
|------|-----------|------|
| PNG | image/png | プレゼンテーション、ドキュメント埋め込み |
| SVG | image/svg+xml | 高品質印刷、Web表示、編集可能 |
| PDF | application/pdf | ドキュメント配布、印刷 |

**エラーケース**:
| エラーコード | 条件 | ユーザーへの表示 |
|-------------|------|-----------------|
| `EXPORT_FAILED` | エクスポート処理失敗 | 「エクスポートに失敗しました。再試行してください。」 |
| `DIAGRAM_EMPTY` | 図表が空 | 「エクスポートする内容がありません。」 |

**データフロー対応**:
- 入力: DF-10（エクスポートリクエスト: project_name, diagram_name, format, options）
- 出力: ファイルダウンロード（ブラウザ経由）
- データストア: D1（図表読み取り）

---

#### F-DGM-07: バージョン履歴確認

| 項目 | 内容 |
|------|------|
| **機能名** | バージョン履歴確認 |
| **機能ID** | F-DGM-07 |
| **対応UC** | UC 3-7 バージョン履歴を確認する |
| **主アクター** | エンドユーザー |
| **二次アクター** | - |
| **対象** | PlantUML / Excalidraw 共通 |
| **優先度** | v3（DB追加後に実装） |

**機能概要**:
図表の過去バージョン一覧を表示する。各バージョンはSHA-256ハッシュで識別され、保存日時、変更サマリ、プレビューサムネイルとともに表示される。選択したバージョンの内容をプレビュー表示し、現在のバージョンとの差分を確認できる。

**処理フロー**:
1. ユーザーが「履歴」ボタンまたはメニューをクリック
2. バージョン履歴パネルが表示:
   - バージョン一覧（新しい順）
   - 各バージョン: 日時、ハッシュ（先頭8文字）、サムネイル
3. ユーザーがバージョンを選択
4. 選択バージョンの詳細を表示:
   - フルプレビュー画像
   - ソースコード（読み取り専用）
   - 現在バージョンとの差分ビュー（オプション）
5. 「復元」ボタンで復元フローに遷移（F-DGM-08）

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| project_name | VARCHAR(100) | ✅ | プロジェクト名 |
| diagram_name | VARCHAR(100) | ✅ | 図表名 |
| limit | INTEGER | ❌ | 取得件数（デフォルト: 20） |
| offset | INTEGER | ❌ | 開始位置（ページネーション用） |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| versions | Array | バージョン一覧 |
| versions[].version_id | UUID | バージョンID |
| versions[].hash | VARCHAR(64) | SHA-256ハッシュ |
| versions[].created_at | TIMESTAMP | 保存日時 |
| versions[].file_size | INTEGER | ファイルサイズ |
| versions[].thumbnail_url | URL | サムネイル画像URL |
| total_count | INTEGER | 総バージョン数 |

**前提条件**:
- 図表が存在すること
- バージョン履歴機能が有効であること（v3以降）

**事後条件**:
- バージョン一覧が表示される

**注記**: 本機能はv3（DB追加後）で実装予定。MVPではバージョン管理機能は提供されない。

---

#### F-DGM-08: 過去バージョン復元

| 項目 | 内容 |
|------|------|
| **機能名** | 過去バージョン復元 |
| **機能ID** | F-DGM-08 |
| **対応UC** | UC 3-8 過去バージョンを復元する |
| **主アクター** | エンドユーザー |
| **二次アクター** | - |
| **対象** | PlantUML / Excalidraw 共通 |
| **優先度** | v3（DB追加後に実装） |

**機能概要**:
選択した過去バージョンの内容を現在の図表に復元する。復元前に現在の内容を自動的にバージョンとして保存し、データ損失を防止する。

**処理フロー**:
1. バージョン履歴画面でユーザーが「復元」ボタンをクリック
2. 確認ダイアログを表示:
   - 「このバージョンに復元しますか？」
   - 「現在の内容は新しいバージョンとして保存されます。」
3. ユーザーが「復元」を確認
4. システムが以下を実行:
   - 現在の内容を新しいバージョンとして保存（復元前バックアップ）
   - 選択バージョンの内容を現在のファイルにコピー
   - エディタの内容を更新
5. 復元完了をトースト通知

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| project_name | VARCHAR(100) | ✅ | プロジェクト名 |
| diagram_name | VARCHAR(100) | ✅ | 図表名 |
| version_id | UUID | ✅ | 復元するバージョンID |
| confirm | BOOLEAN | ✅ | 復元確認フラグ |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| success | BOOLEAN | 復元成功フラグ |
| backup_version_id | UUID | 復元前バックアップのバージョンID |
| restored_at | TIMESTAMP | 復元日時 |

**前提条件**:
- バージョン履歴機能が有効であること（v3以降）
- 指定したバージョンが存在すること

**事後条件**:
- 選択バージョンの内容が現在のファイルに反映される
- 復元前の内容がバージョンとして保存される
- エディタの表示が更新される

**注記**: 本機能はv3（DB追加後）で実装予定。MVPではバージョン管理機能は提供されない。

---

#### F-DGM-09: 図表削除

| 項目 | 内容 |
|------|------|
| **機能名** | 図表削除 |
| **機能ID** | F-DGM-09 |
| **対応UC** | UC 3-9 図表を削除する |
| **主アクター** | エンドユーザー |
| **二次アクター** | - |
| **対象** | PlantUML / Excalidraw 共通 |

**機能概要**:
図表とその関連ファイル（ソースファイル、プレビュー画像、バージョン履歴）を完全に削除する。削除は不可逆操作のため、確認ダイアログで明示的な承認を求める。

**処理フロー**:
1. ユーザーが図表一覧でコンテキストメニューまたは削除アイコンをクリック
2. 確認ダイアログを表示:
   - 「図表 "{diagram_name}" を削除しますか？」
   - 「この操作は取り消せません。」
3. ユーザーが「削除」ボタンをクリック
4. システムが以下を実行:
   - ソースファイルを削除（`.puml` または `.excalidraw.json`）
   - プレビュー画像を削除（`.preview.svg`）
   - バージョン履歴を削除（v3以降）
5. 図表一覧を更新
6. 削除した図表が開かれていた場合、エディタをクリア

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| project_name | VARCHAR(100) | ✅ | プロジェクト名 |
| diagram_name | VARCHAR(100) | ✅ | 削除する図表名 |
| confirm | BOOLEAN | ✅ | 削除確認フラグ（true必須） |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| success | BOOLEAN | 削除成功フラグ |
| deleted_files | Array | 削除されたファイル一覧 |

**前提条件**:
- 図表が存在すること
- ユーザーが削除を明示的に確認すること

**事後条件**:
- 図表ファイルが完全に削除される
- 関連ファイル（プレビュー、履歴）も削除される
- 図表一覧から該当図表が消える

**エラーケース**:
| エラーコード | 条件 | ユーザーへの表示 |
|-------------|------|-----------------|
| `DIAGRAM_NOT_FOUND` | 図表が存在しない | 「指定された図表が見つかりません。」 |
| `DELETE_NOT_CONFIRMED` | 確認フラグがfalse | 「削除を確認してください。」 |
| `DELETE_FAILED` | Storage削除失敗 | 「図表の削除に失敗しました。再試行してください。」 |

**データフロー対応**:
- 入力: DF-3（図表操作リクエスト: action="delete", diagram_name, confirm=true）
- 出力: DF-16（図表操作結果: success, deleted_files[]）
- データストア: D1（ファイル削除）

---

#### F-DGM-10: 学習コンテンツ検索

| 項目 | 内容 |
|------|------|
| **機能名** | 学習コンテンツ検索 |
| **機能ID** | F-DGM-10 |
| **対応UC** | UC 3-10 学習コンテンツを検索する |
| **主アクター** | エンドユーザー |
| **二次アクター** | OpenRouter API |
| **対象** | PlantUML / Excalidraw 共通 |
| **優先度** | Phase 2 |

**機能概要**:
編集中に「書き方がわからない」場面で、PlantUML構文や図表作成のベストプラクティスをRAG（Retrieval-Augmented Generation）検索する。ユーザーの質問に対して、関連する学習コンテンツを検索し、AIが回答を生成する。

**処理フロー**:
1. ユーザーがヘルプパネルまたは検索ボックスで質問を入力
2. 質問をEmbedding化（OpenAI API経由、text-embedding-3-small）
3. Supabase pgvectorでベクトル類似検索を実行（cosine similarity）
4. 関連コンテンツを取得（上位5件、類似度0.7以上）
5. 取得したコンテンツをコンテキストとしてLLMに送信
6. AIが質問に対する回答を生成
7. 回答と参照元コンテンツを表示

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| query | TEXT | ✅ | 検索クエリ（最大500文字） |
| content_type | ENUM('puml', 'excalidraw', 'all') | ❌ | フィルタリング対象（デフォルト: all） |
| limit | INTEGER | ❌ | 取得件数（デフォルト: 5、最大: 20） |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| answer | TEXT | AIが生成した回答 |
| sources | Array | 参照元コンテンツ一覧 |
| sources[].content_id | UUID | コンテンツID |
| sources[].title | VARCHAR(200) | コンテンツタイトル |
| sources[].snippet | TEXT | 関連箇所の抜粋（200文字） |
| sources[].similarity | FLOAT | 類似度スコア（0.0〜1.0） |

**エラーケース**:
| エラーコード | 条件 | ユーザーへの表示 |
|-------------|------|-----------------|
| `SEARCH_QUERY_TOO_SHORT` | クエリが2文字未満 | 「検索キーワードは2文字以上で入力してください。」 |
| `SEARCH_NO_RESULTS` | 該当コンテンツなし | 「関連するコンテンツが見つかりませんでした。別のキーワードで試してください。」 |
| `EMBEDDING_ERROR` | Embedding API失敗 | 「検索処理に失敗しました。再試行してください。」 |

**依存機能**: F-ADM-09（Embeddingモデル設定）、F-ADM-11（学習コンテンツ登録）

**注記**: 本機能はPhase 2で実装予定。DB（pgvector拡張）と学習コンテンツの事前登録が必要。

---

#### F-DGM-11: 学習コンテンツ確認

| 項目 | 内容 |
|------|------|
| **機能名** | 学習コンテンツ確認 |
| **機能ID** | F-DGM-11 |
| **対応UC** | UC 3-11 学習コンテンツを確認する |
| **主アクター** | エンドユーザー |
| **二次アクター** | - |
| **対象** | PlantUML / Excalidraw 共通 |
| **優先度** | Phase 2 |

**機能概要**:
学習コンテンツ検索（F-DGM-10）で取得した結果の詳細を確認する。コンテンツの全文、サンプルコード、関連リンクを表示し、サンプルコードをエディタに挿入できる。

**処理フロー**:
1. 検索結果画面でコンテンツをクリック
2. コンテンツ詳細パネルを表示:
   - タイトル、カテゴリ、更新日時
   - 本文（Markdown形式）
   - サンプルコード（シンタックスハイライト付き）
   - 関連リンク
3. 「コードを挿入」ボタンでサンプルコードをエディタに挿入
4. 「関連を検索」ボタンで類似コンテンツを再検索

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| content_id | UUID | ✅ | コンテンツID |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| content | Object | コンテンツ詳細 |
| content.id | UUID | コンテンツID |
| content.title | VARCHAR(200) | タイトル |
| content.category | VARCHAR(50) | カテゴリ |
| content.body | TEXT | 本文（Markdown） |
| content.sample_code | TEXT | サンプルコード |
| content.content_type | ENUM | 対象図表タイプ |
| content.related_links | Array | 関連リンク |
| content.updated_at | TIMESTAMP | 更新日時 |

**エラーケース**:
| エラーコード | 条件 | ユーザーへの表示 |
|-------------|------|-----------------|
| `CONTENT_NOT_FOUND` | コンテンツが存在しない | 「コンテンツが見つかりませんでした。」 |

**注記**: 本機能はPhase 2で実装予定。F-DGM-10と連携して動作する。

---

## 4. AI機能（F-AI）

### 4.1 機能サマリ

| 機能ID | 機能名 | UC | BF | DFD | 優先度 | 状況 |
|:------:|--------|:--:|:--:|:---:|:------:|:----:|
| F-AI-01 | AI Question-Start | 4-1 | 3.2 | P5.0 | MVP | 定義済 |
| F-AI-02 | 目的別AIチャット | 4-2 | 3.2 | P5.0 | Phase 2 | 定義済 |

### 4.2 機能詳細

#### F-AI-01: AI Question-Start

| 項目 | 内容 |
|------|------|
| **機能名** | AI Question-Start |
| **機能ID** | F-AI-01 |
| **対応UC** | UC 4-1 AI Question-Startで図表を生成する |
| **主アクター** | エンドユーザー |
| **二次アクター** | OpenRouter API |

**機能概要**:
ユーザーが作成したい図表の目的を自然言語で説明すると、AIが対話形式で要件を引き出し、適切なテンプレートを提案し、PlantUMLコードを自動生成する。非エンジニアでも簡単に図表を作成開始できる機能。

**処理フロー**:
1. ユーザーがAI Question-Start画面を開く
2. 「何を作成したいですか？」というプロンプトが表示される
3. ユーザーが目的を入力（例: 「ログイン機能のシーケンス図を作りたい」）
4. AIが追加の質問を投げかける:
   - 「認証方式は何ですか？（OAuth、パスワード等）」
   - 「関係するシステムは何ですか？」
   - 「エラーケースも含めますか？」
5. ユーザーが回答を重ねる（2〜5往復）
6. AIが以下を提案:
   - 推奨図表タイプ（シーケンス図、アクティビティ図等）
   - テンプレート候補（複数の場合は選択肢）
   - 生成されたPlantUMLコード
7. ユーザーが「このコードを使用」をクリック
8. 新規図表作成フロー（F-DGM-01）に遷移し、生成コードが適用される

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| question | TEXT | ✅ | ユーザーの質問/目的説明 |
| context_code | TEXT | ❌ | 既存のコード（追加質問時） |
| conversation_id | UUID | ❌ | 会話セッションID |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| response | TEXT | AIの回答/質問 |
| is_final | BOOLEAN | 最終回答かどうか |
| suggested_type | ENUM | 推奨図表タイプ |
| suggested_templates | Array | 推奨テンプレート一覧 |
| generated_code | TEXT | 生成されたPlantUMLコード |
| conversation_id | UUID | 会話セッションID |

**前提条件**:
- ユーザーがログイン状態であること
- OpenRouter APIが利用可能であること

**事後条件**:
- ユーザーが図表作成を開始できる状態になる
- 生成されたコードが新規図表に適用可能になる

**エラーケース**:
| エラーコード | 条件 | ユーザーへの表示 |
|-------------|------|-----------------|
| `AI_RATE_LIMIT` | APIレート制限 | 「リクエストが多すぎます。しばらく待ってから再試行してください。」 |
| `AI_MODEL_UNAVAILABLE` | モデル障害 | 「AIサービスが一時的に利用できません。」 |
| `AI_CONTEXT_TOO_LONG` | コンテキスト超過 | 「会話が長くなりすぎました。新しい会話を開始してください。」 |
| `AI_TIMEOUT` | タイムアウト | 「応答がタイムアウトしました。再試行してください。」 |

**データフロー対応**:
- 入力: DF-7（AI質問リクエスト: question, context_code?, conversation_id?）
- 出力: DF-8（LLMプロンプト: model, messages[], temperature）
- エラー: DF-9E（AI処理エラー: error_code, error_message）

---

#### F-AI-02: 目的別AIチャット

| 項目 | 内容 |
|------|------|
| **機能名** | 目的別AIチャット |
| **機能ID** | F-AI-02 |
| **対応UC** | UC 4-2 目的別AIチャットを利用する |
| **主アクター** | エンドユーザー |
| **二次アクター** | OpenRouter API |
| **優先度** | Phase 2 |

**機能概要**:
編集中の図表に対して、目的別のAIアシスタントと対話する。AIは現在のプロジェクトフェーズ（要件定義、設計、実装）を認識し、適切な図表セットを提案したり、図表の改善アドバイスを提供する。

**処理フロー**:
1. ユーザーがAIチャットパネルを開く
2. AIがコンテキストを分析:
   - 現在開いている図表の内容
   - プロジェクト内の他の図表
   - 作業履歴
3. ユーザーが質問を入力（例: 「この設計に不足している図表は？」）
4. AIがフェーズを認識して回答:
   - 要件定義フェーズ: ユースケース図、コンテキスト図を提案
   - 設計フェーズ: クラス図、シーケンス図を提案
   - 実装フェーズ: コンポーネント図、デプロイ図を提案
5. AIが具体的な改善提案やサンプルコードを提示
6. ユーザーが提案を採用する場合、ワンクリックで適用

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| message | TEXT | ✅ | ユーザーのチャットメッセージ |
| context | Object | ❌ | コンテキスト情報 |
| context.current_diagram | TEXT | ❌ | 現在開いている図表のソースコード |
| context.project_diagrams | Array | ❌ | プロジェクト内の他の図表名一覧 |
| context.phase | ENUM('requirements', 'design', 'implementation') | ❌ | プロジェクトフェーズ |
| conversation_id | UUID | ❌ | チャットセッションID |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| response | TEXT | AIの回答 |
| suggestions | Array | 改善提案一覧 |
| suggestions[].type | ENUM | 提案タイプ（diagram/code/refactor） |
| suggestions[].title | TEXT | 提案タイトル |
| suggestions[].description | TEXT | 提案詳細 |
| suggestions[].code | TEXT | 適用可能なコード（該当時） |
| recommended_diagrams | Array | 推奨図表タイプ一覧 |
| conversation_id | UUID | チャットセッションID |

**チャットモード一覧**:
| モードID | 名称 | 用途 |
|---------|------|------|
| `review` | レビューモード | 現在の図表をレビューし、改善点を指摘 |
| `suggest` | 提案モード | 不足している図表を提案 |
| `explain` | 解説モード | 図表の内容を説明 |
| `refactor` | リファクタモード | コードの最適化を提案 |

**エラーケース**:
| エラーコード | 条件 | ユーザーへの表示 |
|-------------|------|-----------------|
| `AI_CONTEXT_ANALYSIS_FAILED` | コンテキスト分析失敗 | 「図表の分析に失敗しました。再試行してください。」 |
| `AI_RATE_LIMIT` | レート制限 | 「リクエストが多すぎます。しばらく待ってから再試行してください。」 |

**注記**: 本機能はPhase 2で実装予定。F-AI-01（Question-Start）の発展版として位置づけ。

---

## 5. 管理機能（F-ADM）

### 5.1 機能サマリ

| 機能ID | 機能名 | UC | BF | DFD | 優先度 | 状況 |
|:------:|--------|:--:|:--:|:---:|:------:|:----:|
| F-ADM-01 | ユーザー管理 | 5-1 | 3.9 | P6.0 | MVP | 定義済 |
| F-ADM-02 | LLMモデル登録 | 5-2 | 3.9 | P6.0 | MVP | 定義済 |
| F-ADM-03 | LLMモデル切替 | 5-3 | 3.9 | P6.0 | MVP | 定義済 |
| F-ADM-04 | LLMプロンプト管理 | 5-4 | 3.9 | P6.0 | MVP | 定義済 |
| F-ADM-05 | LLMパラメータ設定 | 5-5 | 3.9 | P6.0 | MVP | 定義済 |
| F-ADM-06 | LLMワークフロー定義 | 5-6 | 3.11 | - | Phase 2 | 未定義 |
| F-ADM-07 | LLM使用量監視 | 5-7 | 3.9 | P6.0 | MVP | 定義済 |
| F-ADM-08 | LLMフォールバック設定 | 5-8 | 3.9 | P6.0 | MVP | 定義済 |
| F-ADM-09 | Embeddingモデル設定 | 5-9 | 3.11 | - | Phase 2 | 未定義 |
| F-ADM-10 | Embedding使用量監視 | 5-10 | 3.11 | - | Phase 2 | 未定義 |
| F-ADM-11 | 学習コンテンツ登録 | 5-11 | 3.11 | - | Phase 2 | 未定義 |
| F-ADM-12 | 学習コンテンツ管理 | 5-12 | 3.11 | - | Phase 2 | 未定義 |
| F-ADM-13 | システム設定変更 | 5-13 | 3.9 | P6.0 | MVP | 定義済 |

### 5.2 機能詳細

#### F-ADM-01: ユーザー管理

| 項目 | 内容 |
|------|------|
| **機能名** | ユーザー管理 |
| **機能ID** | F-ADM-01 |
| **対応UC** | UC 5-1 ユーザーを管理する |
| **主アクター** | 開発者（管理者） |
| **二次アクター** | Supabase |

**機能概要**:
システムに登録されたユーザーの一覧表示、詳細確認、権限変更、アカウント無効化を行う。ユーザー情報はSupabase Authから取得し、追加の権限情報はアプリケーション側で管理する。

**処理フロー**:

**ユーザー一覧表示**:
1. 管理画面でユーザー管理メニューを選択
2. ユーザー一覧を表示:
   - ユーザーID、メールアドレス、認証プロバイダー
   - 最終ログイン日時、作成日時
   - 権限（一般ユーザー/開発者）
   - ステータス（有効/無効）
3. 検索・フィルタリング機能を提供

**ユーザー詳細確認**:
1. ユーザー一覧で特定ユーザーをクリック
2. 詳細情報を表示:
   - 基本情報（上記 + プロフィール情報）
   - 利用統計（プロジェクト数、図表数、AI使用量）
   - アクティビティログ（最近の操作履歴）

**権限変更**:
1. ユーザー詳細画面で「権限変更」をクリック
2. 新しい権限を選択（一般ユーザー ↔ 開発者）
3. 確認ダイアログで承認
4. 権限を更新

**アカウント無効化**:
1. ユーザー詳細画面で「アカウント無効化」をクリック
2. 確認ダイアログを表示
3. 承認後、ユーザーのステータスを「無効」に変更
4. 無効化されたユーザーはログイン不可になる

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| action | ENUM('list', 'detail', 'update_role', 'disable') | ✅ | 操作種別 |
| user_id | UUID | ❌ | 対象ユーザーID（detail/update_role/disable時） |
| new_role | ENUM('user', 'developer') | ❌ | 新しい権限（update_role時） |
| filters | Object | ❌ | フィルタ条件（list時） |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| users | Array | ユーザー一覧（list時） |
| user | Object | ユーザー詳細（detail時） |
| success | BOOLEAN | 操作成功フラグ（update_role/disable時） |

**前提条件**:
- 操作者が開発者権限を持っていること

**事後条件**:
- 操作に応じてユーザー情報が更新される

**データフロー対応**:
- 入力: DF-17（ユーザー管理リクエスト: command="user", action, user_id?, filters?）
- 出力: DF-20/21（管理機能クエリ/結果）, DF-22（管理機能結果）
- エラー: DF-22E（管理機能エラー）
- データストア: D2（認証情報）

---

#### F-ADM-02: LLMモデル登録

| 項目 | 内容 |
|------|------|
| **機能名** | LLMモデル登録 |
| **機能ID** | F-ADM-02 |
| **対応UC** | UC 5-2 LLMモデルを登録する |
| **主アクター** | 開発者（管理者） |
| **二次アクター** | OpenRouter API, Supabase |

**機能概要**:
OpenRouter経由で利用可能なLLMモデルをシステムに登録する。モデルごとに識別名、APIモデルID、コスト情報、利用制限を設定し、機能別に使用するモデルを管理できるようにする。

**処理フロー**:
1. 管理画面でLLM管理メニューを選択
2. 「モデル登録」ボタンをクリック
3. モデル登録フォームに入力:
   - 表示名（例: 「Claude 3.5 Sonnet」）
   - OpenRouterモデルID（例: 「anthropic/claude-3.5-sonnet」）
   - 入力トークン単価（$/M tokens）
   - 出力トークン単価（$/M tokens）
   - 最大コンテキスト長
   - 説明・備考
4. 「接続テスト」ボタンでモデルの疎通確認
5. テスト成功後、「登録」ボタンで保存
6. 登録済みモデル一覧に追加される

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| display_name | VARCHAR(100) | ✅ | 表示名 |
| model_id | VARCHAR(200) | ✅ | OpenRouterモデルID |
| input_cost | DECIMAL(10,6) | ✅ | 入力トークン単価（$/M） |
| output_cost | DECIMAL(10,6) | ✅ | 出力トークン単価（$/M） |
| max_context | INTEGER | ✅ | 最大コンテキスト長（tokens） |
| description | TEXT | ❌ | 説明・備考 |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| success | BOOLEAN | 登録成功フラグ |
| model | Object | 登録されたモデル情報 |
| test_result | Object | 接続テスト結果 |

**前提条件**:
- 操作者が開発者権限を持っていること
- OpenRouter APIキーが設定されていること
- 指定したモデルがOpenRouterで利用可能であること

**事後条件**:
- モデルがシステムに登録され、機能割当に使用可能になる

**データフロー対応**:
- 入力: DF-18（LLM管理リクエスト: command="llm", action="register_model", model_config）
- 出力: DF-22（管理機能結果: success, model）
- エラー: DF-22E（管理機能エラー）
- 外部連携: OpenRouter API（接続テスト）
- データストア: D2（モデル設定保存）

---

#### F-ADM-03: LLMモデル切替

| 項目 | 内容 |
|------|------|
| **機能名** | LLMモデル切替 |
| **機能ID** | F-ADM-03 |
| **対応UC** | UC 5-3 LLMモデルを切り替える |
| **主アクター** | 開発者（管理者） |
| **二次アクター** | Supabase |

**機能概要**:
システムの各機能（AI Question-Start、用語チェック、エラー修正提案等）で使用するLLMモデルを切り替える。機能ごとに異なるモデルを割り当てることで、コストと品質のバランスを最適化できる。

**処理フロー**:
1. 管理画面でLLM管理メニューを選択
2. 「機能別モデル割当」タブを選択
3. 機能一覧と現在のモデル割当を表示:
   - AI Question-Start: Claude 3.5 Sonnet
   - 用語一貫性チェック: GPT-4o mini
   - エラー修正提案: Claude 3.5 Sonnet
   - 等...
4. 変更したい機能の「変更」ボタンをクリック
5. 登録済みモデルのドロップダウンから選択
6. 「保存」ボタンで確定
7. 即座に反映（再起動不要）

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| feature_id | VARCHAR(50) | ✅ | 機能ID |
| model_id | VARCHAR(200) | ✅ | 割り当てるモデルID |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| success | BOOLEAN | 切替成功フラグ |
| feature_assignments | Array | 更新後の機能別モデル割当一覧 |

**機能ID一覧**:
| feature_id | 機能名 | 推奨モデル |
|-----------|--------|-----------|
| `ai_question_start` | AI Question-Start | 高性能モデル（Claude 3.5 Sonnet） |
| `ai_chat` | 目的別AIチャット | 高性能モデル（Claude 3.5 Sonnet） |
| `terminology_check` | 用語一貫性チェック | 低コストモデル（GPT-4o mini） |
| `error_fix_suggest` | エラー修正提案 | 中性能モデル（Claude 3 Haiku） |
| `code_explain` | コード説明 | 低コストモデル（GPT-4o mini） |

**データフロー対応**:
- 入力: DF-18（LLM管理リクエスト: command="llm", action="switch_model", feature_id, model_id）
- 出力: DF-22（管理機能結果: success, feature_assignments[]）
- データストア: D2（割当設定保存）

---

#### F-ADM-04: LLMプロンプト管理

| 項目 | 内容 |
|------|------|
| **機能名** | LLMプロンプト管理 |
| **機能ID** | F-ADM-04 |
| **対応UC** | UC 5-4 LLMプロンプトを管理する |
| **主アクター** | 開発者（管理者） |
| **二次アクター** | Supabase |

**機能概要**:
各AI機能で使用するプロンプトテンプレートを作成・編集・削除する。システムプロンプト、ユーザープロンプトテンプレート、Few-shotサンプルを管理し、AIの応答品質を調整できる。

**処理フロー**:
1. 管理画面でLLM管理メニューを選択
2. 「プロンプト管理」タブを選択
3. プロンプトテンプレート一覧を表示
4. 操作を選択:
   - **新規作成**: フォームでテンプレート名、内容、対象機能を入力
   - **編集**: 既存テンプレートを選択して内容を修正
   - **削除**: 使用されていないテンプレートを削除
   - **テスト**: サンプル入力でプロンプトをテスト実行
5. 変更を保存

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| action | ENUM('create', 'update', 'delete', 'test') | ✅ | 操作種別 |
| prompt_id | UUID | ❌ | プロンプトID（update/delete/test時） |
| name | VARCHAR(100) | ❌ | テンプレート名（create/update時） |
| feature_id | VARCHAR(50) | ❌ | 対象機能ID（create/update時） |
| system_prompt | TEXT | ❌ | システムプロンプト |
| user_template | TEXT | ❌ | ユーザープロンプトテンプレート |
| few_shot_examples | Array | ❌ | Few-shotサンプル |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| success | BOOLEAN | 操作成功フラグ |
| prompt | Object | プロンプト情報 |
| test_result | Object | テスト実行結果（test時） |

**データフロー対応**:
- 入力: DF-18（LLM管理リクエスト: command="llm", action="manage_prompt", prompt_config）
- 出力: DF-22（管理機能結果: success, prompt）
- データストア: D2（プロンプト保存）

---

#### F-ADM-05: LLMパラメータ設定

| 項目 | 内容 |
|------|------|
| **機能名** | LLMパラメータ設定 |
| **機能ID** | F-ADM-05 |
| **対応UC** | UC 5-5 LLMパラメータを設定する |
| **主アクター** | 開発者（管理者） |
| **二次アクター** | Supabase |

**機能概要**:
LLM呼び出し時のパラメータ（temperature、max_tokens、top_p等）を機能別に設定する。応答の創造性や一貫性を調整し、用途に応じた最適な設定を適用できる。

**処理フロー**:
1. 管理画面でLLM管理メニューを選択
2. 「パラメータ設定」タブを選択
3. 機能別のパラメータ設定一覧を表示
4. 設定を変更したい機能を選択
5. パラメータを調整:
   - temperature（0.0〜2.0）: 応答のランダム性
   - max_tokens（1〜32000）: 最大出力トークン数
   - top_p（0.0〜1.0）: nucleus sampling
   - frequency_penalty（-2.0〜2.0）: 繰り返し抑制
   - presence_penalty（-2.0〜2.0）: 新規トピック促進
6. 「保存」ボタンで確定

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| feature_id | VARCHAR(50) | ✅ | 機能ID |
| temperature | FLOAT | ❌ | 0.0〜2.0（デフォルト: 0.7） |
| max_tokens | INTEGER | ❌ | 1〜32000（デフォルト: 4096） |
| top_p | FLOAT | ❌ | 0.0〜1.0（デフォルト: 1.0） |
| frequency_penalty | FLOAT | ❌ | -2.0〜2.0（デフォルト: 0） |
| presence_penalty | FLOAT | ❌ | -2.0〜2.0（デフォルト: 0） |

**推奨パラメータ設定**:
| 機能 | temperature | max_tokens | 理由 |
|------|:-----------:|:----------:|------|
| AI Question-Start | 0.7 | 4096 | 創造的な提案が必要 |
| 用語一貫性チェック | 0.1 | 2048 | 一貫した判定が必要 |
| エラー修正提案 | 0.3 | 2048 | 正確な修正が必要 |

**データフロー対応**:
- 入力: DF-18（LLM管理リクエスト: command="llm", action="set_params", feature_id, params）
- 出力: DF-22（管理機能結果: success, params）
- データストア: D2（パラメータ保存）

---

#### F-ADM-06: LLMワークフロー定義（Phase 2）

| 項目 | 内容 |
|------|------|
| **機能名** | LLMワークフロー定義 |
| **機能ID** | F-ADM-06 |
| **対応UC** | UC 5-6 LLMワークフローを定義する |
| **主アクター** | 開発者（管理者） |
| **二次アクター** | OpenRouter API, Supabase |
| **優先度** | Phase 2 |

**機能概要**:
複数のLLM呼び出しを連鎖させた処理パイプライン（ワークフロー）を定義する。例えば「コード分析→問題特定→修正提案→検証」のような多段階処理を定義できる。

**処理フロー**:
1. 管理画面でワークフロー管理メニューを選択
2. 「新規ワークフロー」ボタンをクリック
3. ワークフロー定義画面でステップを構成:
   - ステップ名、使用モデル、プロンプト
   - 入力（前ステップの出力/ユーザー入力）
   - 条件分岐（成功/失敗/条件付き）
4. ワークフローをビジュアルエディタで編集（ノードベース）
5. テスト実行で動作確認
6. 有効化して機能に割り当て

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| workflow_name | VARCHAR(100) | ✅ | ワークフロー名 |
| description | TEXT | ❌ | 説明 |
| steps | Array | ✅ | ステップ定義一覧 |
| steps[].name | VARCHAR(50) | ✅ | ステップ名 |
| steps[].model_id | VARCHAR(200) | ✅ | 使用モデル |
| steps[].prompt_id | UUID | ✅ | プロンプトテンプレート |
| steps[].input_mapping | JSON | ❌ | 入力マッピング |
| steps[].conditions | JSON | ❌ | 分岐条件 |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| workflow_id | UUID | ワークフローID |
| success | BOOLEAN | 作成/更新成功フラグ |
| test_result | Object | テスト実行結果 |

**ワークフロー例**:
| ワークフロー名 | ステップ構成 | 用途 |
|---------------|-------------|------|
| コードレビュー | 分析→問題抽出→改善提案 | 図表のレビュー |
| 段階的生成 | 要件確認→設計→生成→検証 | 複雑な図表生成 |

**注記**: 本機能はPhase 2で実装予定。LangChain/LangGraph等のライブラリ活用を検討。

---

#### F-ADM-07: LLM使用量監視

| 項目 | 内容 |
|------|------|
| **機能名** | LLM使用量監視 |
| **機能ID** | F-ADM-07 |
| **対応UC** | UC 5-7 LLM使用量を監視する |
| **主アクター** | 開発者（管理者） |
| **二次アクター** | OpenRouter API, Supabase |

**機能概要**:
システム全体およびユーザー別のLLM使用量（トークン数、コスト）を監視する。期間別、モデル別、機能別のレポートを表示し、コスト管理とリソース最適化を支援する。

**処理フロー**:
1. 管理画面でLLM管理メニューを選択
2. 「使用量監視」タブを選択
3. ダッシュボードを表示:
   - 今月の総コスト（推定）
   - トークン使用量推移グラフ
   - モデル別使用量円グラフ
   - 機能別使用量棒グラフ
4. フィルタリング・ドリルダウン:
   - 期間選択（今日/今週/今月/カスタム）
   - ユーザー別内訳
   - APIログ詳細
5. アラート設定:
   - 日次/月次コスト上限
   - アラート通知先

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| total_cost | DECIMAL | 総コスト（USD） |
| total_tokens | Object | 総トークン数（input/output） |
| by_model | Array | モデル別使用量 |
| by_feature | Array | 機能別使用量 |
| by_user | Array | ユーザー別使用量 |
| daily_trend | Array | 日次推移データ |

**データフロー対応**:
- 入力: DF-18（LLM管理リクエスト: command="llm", action="get_usage", period, filters）
- 出力: DF-22（管理機能結果: stats）
- 外部連携: OpenRouter API（使用量取得）
- データストア: D2（使用量ログ）

---

#### F-ADM-08: LLMフォールバック設定

| 項目 | 内容 |
|------|------|
| **機能名** | LLMフォールバック設定 |
| **機能ID** | F-ADM-08 |
| **対応UC** | UC 5-8 LLMフォールバックを設定する |
| **主アクター** | 開発者（管理者） |
| **二次アクター** | Supabase |

**機能概要**:
プライマリモデルが障害やレート制限で利用できない場合に自動的に切り替えるフォールバックモデルを設定する。OpenRouterのプロバイダールーティング機能と組み合わせて、高可用性を実現する。

**処理フロー**:
1. 管理画面でLLM管理メニューを選択
2. 「フォールバック設定」タブを選択
3. 機能ごとのフォールバックチェーンを設定:
   - プライマリモデル
   - セカンダリモデル（1つ目のフォールバック）
   - ターシャリモデル（2つ目のフォールバック）
4. フォールバック条件を設定:
   - レート制限時
   - タイムアウト時
   - エラー発生時
5. 「保存」ボタンで確定

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| feature_id | VARCHAR(50) | ✅ | 機能ID |
| primary_model | VARCHAR(200) | ✅ | プライマリモデルID |
| secondary_model | VARCHAR(200) | ❌ | セカンダリモデルID |
| tertiary_model | VARCHAR(200) | ❌ | ターシャリモデルID |
| fallback_conditions | Array | ❌ | フォールバック条件 |

**データフロー対応**:
- 入力: DF-18（LLM管理リクエスト: command="llm", action="set_fallback", feature_id, fallback_config）
- 出力: DF-22（管理機能結果: success, fallback_config）
- データストア: D2（フォールバック設定保存）

---

#### F-ADM-09: Embeddingモデル設定（Phase 2）

| 項目 | 内容 |
|------|------|
| **機能名** | Embeddingモデル設定 |
| **機能ID** | F-ADM-09 |
| **対応UC** | UC 5-9 Embeddingモデルを設定する |
| **主アクター** | 開発者（管理者） |
| **二次アクター** | OpenAI API |
| **優先度** | Phase 2 |

**機能概要**:
学習コンテンツ検索（F-DGM-10）で使用するOpenAI Embeddingモデルの設定を行う。モデル選択、次元数、チャンクサイズ、オーバーラップ設定を管理する。

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| model_name | VARCHAR(100) | ✅ | Embeddingモデル名（text-embedding-3-small等） |
| dimensions | INTEGER | ❌ | ベクトル次元数（デフォルト: 1536） |
| chunk_size | INTEGER | ❌ | チャンクサイズ（デフォルト: 512 tokens） |
| chunk_overlap | INTEGER | ❌ | チャンクオーバーラップ（デフォルト: 50 tokens） |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| success | BOOLEAN | 設定成功フラグ |
| config | Object | 現在の設定 |
| test_result | Object | 接続テスト結果 |

**依存機能**: F-DGM-10（学習コンテンツ検索）

**注記**: 本機能はPhase 2で実装予定。TD-007準拠でOpenAI API直接接続。

---

#### F-ADM-10: Embedding使用量監視（Phase 2）

| 項目 | 内容 |
|------|------|
| **機能名** | Embedding使用量監視 |
| **機能ID** | F-ADM-10 |
| **対応UC** | UC 5-10 Embedding使用量を監視する |
| **主アクター** | 開発者（管理者） |
| **二次アクター** | OpenAI API |
| **優先度** | Phase 2 |

**機能概要**:
Embedding APIの使用量（トークン数、コスト）を監視する。期間別、コンテンツ別のレポートを表示し、コスト管理を支援する。

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| total_tokens | INTEGER | 総トークン数 |
| total_cost | DECIMAL | 総コスト（USD） |
| by_period | Array | 期間別使用量 |
| by_content | Array | コンテンツ別使用量 |

**注記**: 本機能はPhase 2で実装予定。F-ADM-07（LLM使用量監視）と統合ダッシュボードで表示。

---

#### F-ADM-11: 学習コンテンツ登録（Phase 2）

| 項目 | 内容 |
|------|------|
| **機能名** | 学習コンテンツ登録 |
| **機能ID** | F-ADM-11 |
| **対応UC** | UC 5-11 学習コンテンツを登録する |
| **主アクター** | 開発者（管理者） |
| **二次アクター** | OpenAI API, Supabase |
| **優先度** | Phase 2 |

**機能概要**:
PlantUML構文ドキュメント、ベストプラクティス等のMarkdown/PDFファイルをアップロードし、RAG検索用にベクトルインデックスを作成する。

**処理フロー**:
1. 管理画面で学習コンテンツ管理メニューを選択
2. 「新規登録」ボタンをクリック
3. コンテンツ情報を入力:
   - タイトル、カテゴリ、対象図表タイプ
   - Markdown/PDFファイルをアップロード
4. 「登録」ボタンで処理開始:
   - ファイルをパース
   - チャンク分割
   - Embedding生成（OpenAI API）
   - pgvectorに保存
5. 完了通知（インデックス件数表示）

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| title | VARCHAR(200) | ✅ | コンテンツタイトル |
| category | VARCHAR(50) | ✅ | カテゴリ（syntax/bestpractice/example等） |
| content_type | ENUM('puml', 'excalidraw', 'general') | ✅ | 対象図表タイプ |
| file | FILE | ✅ | Markdown/PDFファイル（最大10MB） |
| tags | Array | ❌ | タグ一覧 |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| content_id | UUID | コンテンツID |
| success | BOOLEAN | 登録成功フラグ |
| chunk_count | INTEGER | 生成されたチャンク数 |
| token_count | INTEGER | 使用トークン数 |

**対応ファイル形式**:
| 形式 | 拡張子 | パース方法 |
|------|--------|-----------|
| Markdown | .md | 見出し・段落で分割 |
| PDF | .pdf | テキスト抽出後分割 |

**注記**: 本機能はPhase 2で実装予定。F-DGM-10（学習コンテンツ検索）の前提機能。

---

#### F-ADM-12: 学習コンテンツ管理（Phase 2）

| 項目 | 内容 |
|------|------|
| **機能名** | 学習コンテンツ管理 |
| **機能ID** | F-ADM-12 |
| **対応UC** | UC 5-12 学習コンテンツを管理する |
| **主アクター** | 開発者（管理者） |
| **二次アクター** | Supabase |
| **優先度** | Phase 2 |

**機能概要**:
登録済み学習コンテンツの一覧表示、編集、削除、カテゴリ管理を行う。

**処理フロー**:
1. 管理画面で学習コンテンツ管理メニューを選択
2. コンテンツ一覧を表示:
   - タイトル、カテゴリ、チャンク数、登録日
   - カテゴリ/タグでフィルタリング
3. 操作を選択:
   - **編集**: タイトル、カテゴリ、タグを更新（本文更新は再登録）
   - **削除**: コンテンツとベクトルインデックスを削除
   - **再インデックス**: Embedding設定変更後の再生成

**入力データ（編集時）**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| content_id | UUID | ✅ | コンテンツID |
| title | VARCHAR(200) | ❌ | 新しいタイトル |
| category | VARCHAR(50) | ❌ | 新しいカテゴリ |
| tags | Array | ❌ | 新しいタグ一覧 |

**出力データ**:
| データ項目 | 型 | 説明 |
|-----------|-----|------|
| contents | Array | コンテンツ一覧 |
| total_count | INTEGER | 総件数 |
| categories | Array | カテゴリ一覧（件数付き） |

**注記**: 本機能はPhase 2で実装予定。F-ADM-11と連携。

---

#### F-ADM-13: システム設定変更

| 項目 | 内容 |
|------|------|
| **機能名** | システム設定変更 |
| **機能ID** | F-ADM-13 |
| **対応UC** | UC 5-13 システム設定を変更する |
| **主アクター** | 開発者（管理者） |
| **二次アクター** | Supabase |

**機能概要**:
システム全体の設定（機能フラグ、表示設定、制限値、外部連携設定）を変更する。設定変更は即座に反映され、システム再起動は不要。

**処理フロー**:
1. 管理画面でシステム設定メニューを選択
2. 設定カテゴリを選択:
   - 機能フラグ: 機能の有効/無効切替
   - 表示設定: UIテーマ、デフォルト言語
   - 制限値: ファイルサイズ上限、API呼び出し制限
   - 外部連携: OAuth設定、Webhook URL
3. 設定値を変更
4. 「保存」ボタンで確定
5. 変更履歴がログに記録される

**入力データ**:
| データ項目 | 型 | 必須 | 説明 |
|-----------|-----|:----:|------|
| category | ENUM('feature_flags', 'display', 'limits', 'external') | ✅ | 設定カテゴリ |
| settings | Object | ✅ | 設定値オブジェクト |

**設定項目例**:
| カテゴリ | 設定キー | 型 | 説明 |
|---------|---------|-----|------|
| feature_flags | ai_question_start_enabled | BOOLEAN | AI Question-Start有効フラグ |
| feature_flags | excalidraw_enabled | BOOLEAN | Excalidraw有効フラグ |
| display | default_theme | ENUM('light', 'dark', 'system') | デフォルトテーマ |
| limits | max_file_size_mb | INTEGER | 最大ファイルサイズ（MB） |
| limits | max_projects_per_user | INTEGER | ユーザーあたり最大プロジェクト数 |
| external | webhook_url | URL | Webhook通知先URL |

**データフロー対応**:
- 入力: DF-19（システム設定リクエスト: command="system", action, settings）
- 出力: DF-22（管理機能結果: success, settings）
- エラー: DF-22E（管理機能エラー）
- データストア: D2（設定保存）

---

## 6. 業務フロー・DFD対比表

### 6.1 業務フロー別対応表（サマリ）

| BF | 業務フロー名 | 対応UC | 対応プロセス | 入力DF | 出力DF | エラーDF | 状況 |
|:--:|-------------|--------|:------------:|:------:|:------:|:--------:|:----:|
| 3.1 | PlantUML図表作成 | 3-1〜3-4 | P3.0, P4.0 | DF-3, DF-5, DF-23 | DF-4, DF-6, DF-16, DF-24 | DF-6E | ✅ |
| 3.2 | PlantUML AI支援 | 4-1, 4-2 | P5.0 | DF-7 | DF-8 | DF-9E | ✅ |
| 3.3 | Excalidraw作成 | 3-1〜3-3 | P3.0 | DF-3 | DF-4, DF-16 | - | ✅ |
| 3.4 | 認証 | 1-1, 1-2 | P1.0 | DF-1 | DF-2 | DF-2E | ✅ |
| 3.5 | プロジェクト管理 | 2-1〜2-4 | P2.0 | DF-11〜14 | DF-15 | DF-15E | ✅ |
| 3.6 | 保存・エクスポート | 3-5, 3-6 | P3.0, P7.0 | DF-3, DF-10 | DF-4, DF-16 | - | ✅ |
| 3.7 | バージョン管理 | 3-7, 3-8 | - | - | - | - | ⚠️ |
| 3.8 | 図表削除 | 3-9 | P3.0 | DF-3 | DF-16 | - | ✅ |
| 3.9 | 管理機能（MVP） | 5-1〜5-5, 5-7, 5-8, 5-13 | P6.0 | DF-17〜19 | DF-20〜22 | DF-22E | ✅ |
| 3.10 | 学習コンテンツ | 3-10, 3-11 | - | - | - | - | 🔴 |
| 3.11 | 管理機能（Phase 2） | 5-6, 5-9〜5-12 | - | - | - | - | 🔴 |

### 6.2 データフロー詳細対応表

#### 認証フロー（BF 3.4）

| DF | 名称 | 方向 | データ項目 | 型 |
|:--:|------|:----:|-----------|-----|
| DF-1 | ログイン情報 | 入力 | `provider` | ENUM('github', 'google') |
| | | | `redirect_uri` | URL |
| | | | `code_verifier` | VARCHAR(128) |
| DF-2 | 認証トークン | 出力 | `access_token` | JWT |
| | | | `refresh_token` | VARCHAR(512) |
| | | | `expires_at` | TIMESTAMP |
| | | | `user_id` | UUID |
| DF-2E | 認証エラー | エラー | `error_code` | VARCHAR(50) |
| | | | `error_message` | TEXT |
| | | | `provider` | ENUM('github', 'google') |

#### プロジェクト管理フロー（BF 3.5）

| DF | 名称 | 方向 | データ項目 | 型 |
|:--:|------|:----:|-----------|-----|
| DF-11 | プロジェクト作成 | 入力 | `action` | ENUM('create') |
| | | | `project_name` | VARCHAR(100) |
| | | | `description` | TEXT (nullable) |
| DF-12 | プロジェクト選択 | 入力 | `action` | ENUM('select') |
| | | | `project_name` | VARCHAR(100) |
| DF-13 | プロジェクト更新 | 入力 | `action` | ENUM('update') |
| | | | `project_name` | VARCHAR(100) |
| | | | `new_name` | VARCHAR(100) (nullable) |
| DF-14 | プロジェクト削除 | 入力 | `action` | ENUM('delete') |
| | | | `project_name` | VARCHAR(100) |
| | | | `confirm` | BOOLEAN |
| DF-15 | 操作結果 | 出力 | `success` | BOOLEAN |
| | | | `project` | Object (nullable) |
| | | | `projects[]` | Array |
| | | | `message` | TEXT |
| DF-15E | 操作エラー | エラー | `error_code` | VARCHAR(50) |
| | | | `error_message` | TEXT |
| | | | `project_name` | VARCHAR(100) |

#### 図表操作フロー（BF 3.1, 3.3, 3.6, 3.8）

| DF | 名称 | 方向 | データ項目 | 型 |
|:--:|------|:----:|-----------|-----|
| DF-3 | 図表操作リクエスト | 入力 | `action` | ENUM('create', 'read', 'update', 'delete', 'list') |
| | | | `project_name` | VARCHAR(100) |
| | | | `diagram_name` | VARCHAR(100) |
| | | | `source_code` | TEXT (max 1MB) |
| | | | `content_type` | ENUM('puml', 'excalidraw') |
| | | | `template_id` | VARCHAR(50) (nullable) |
| DF-4 | 図表保存データ | 内部 | `file_path` | VARCHAR(255) |
| | | | `source_code` | TEXT |
| | | | `preview_svg` | BLOB (max 5MB) |
| | | | `metadata` | JSON |
| DF-5 | 検証リクエスト | 内部 | `source_code` | TEXT |
| | | | `content_type` | ENUM('puml', 'excalidraw') |
| | | | `options` | JSON |
| DF-6 | 検証結果 | 内部 | `is_valid` | BOOLEAN |
| | | | `preview_svg` | BLOB |
| | | | `errors[]` | Array |
| | | | `warnings[]` | Array |
| DF-6E | 検証エラー | エラー | `is_valid` | BOOLEAN (false) |
| | | | `errors[]` | Array |
| | | | `suggested_fix` | TEXT (nullable) |
| | | | `ai_explanation` | TEXT (nullable) |
| DF-10 | エクスポートリクエスト | 入力 | `project_name` | VARCHAR(100) |
| | | | `diagram_name` | VARCHAR(100) |
| | | | `format` | ENUM('png', 'svg', 'pdf') |
| | | | `options` | JSON |
| DF-16 | 図表操作結果 | 出力 | `diagrams[]` | Array |
| | | | `result` | Object |
| | | | `message` | TEXT |
| DF-23 | テンプレート一覧リクエスト | 入力 | `action` | ENUM('list_templates') |
| | | | `content_type` | ENUM('puml', 'excalidraw', 'all') |
| | | | `category` | VARCHAR(50) (nullable) |
| DF-24 | テンプレート一覧レスポンス | 出力 | `templates[]` | Array |
| | | | `templates[].id` | VARCHAR(50) |
| | | | `templates[].name` | VARCHAR(100) |
| | | | `templates[].category` | VARCHAR(50) |
| | | | `templates[].preview_url` | URL |

#### AI支援フロー（BF 3.2）

| DF | 名称 | 方向 | データ項目 | 型 |
|:--:|------|:----:|-----------|-----|
| DF-7 | AI質問リクエスト | 入力 | `question` | TEXT |
| | | | `context_code` | TEXT (nullable) |
| | | | `conversation_id` | UUID (nullable) |
| DF-8 | LLMプロンプト | 外部 | `model` | VARCHAR(100) |
| | | | `messages[]` | Array |
| | | | `temperature` | FLOAT |
| | | | `max_tokens` | INTEGER |
| DF-9 | Embeddingリクエスト | 外部 | `model` | VARCHAR(100) |
| | | | `input` | TEXT |
| | | | `encoding_format` | VARCHAR(20) |
| DF-9E | AI処理エラー | エラー | `error_code` | VARCHAR(50) |
| | | | `error_message` | TEXT |
| | | | `fallback_available` | BOOLEAN |

#### 管理機能フロー（BF 3.9）

| DF | 名称 | 方向 | データ項目 | 型 |
|:--:|------|:----:|-----------|-----|
| DF-17 | ユーザー管理リクエスト | 入力 | `command` | ENUM('user') |
| | | | `action` | ENUM('list', 'detail', 'update_role', 'disable') |
| | | | `user_id` | UUID (nullable) |
| | | | `filters` | JSON (nullable) |
| DF-18 | LLM管理リクエスト | 入力 | `command` | ENUM('llm') |
| | | | `action` | ENUM('register_model', 'switch_model', 'manage_prompt', 'set_params', 'get_usage', 'set_fallback') |
| | | | `model_config` | JSON (nullable) |
| | | | `prompt_config` | JSON (nullable) |
| DF-19 | システム設定リクエスト | 入力 | `command` | ENUM('system') |
| | | | `action` | VARCHAR(50) |
| | | | `settings` | JSON |
| DF-20 | 管理機能クエリ | 内部 | `query_type` | VARCHAR(50) |
| | | | `filters` | JSON |
| | | | `pagination` | JSON |
| DF-21 | 管理機能クエリ結果 | 内部 | `users[]` | Array |
| | | | `total_count` | INTEGER |
| | | | `page_info` | JSON |
| DF-22 | 管理機能結果 | 出力 | `success` | BOOLEAN |
| | | | `result` | Object |
| | | | `stats` | JSON (nullable) |
| | | | `logs[]` | Array (nullable) |
| DF-22E | 管理機能エラー | エラー | `error_code` | VARCHAR(50) |
| | | | `error_message` | TEXT |
| | | | `context` | JSON |

### 6.3 データストア対応表

| データストア | 関連BF | 関連DF | アクセス種別 | 主要データ項目 |
|:------------:|--------|--------|:------------:|---------------|
| D1: 図表ストレージ | 3.1, 3.3, 3.5, 3.6, 3.8 | DF-3, DF-4, DF-10〜15 | R/W/D | `source_code`, `preview_svg`, `metadata` |
| D2: 認証情報 | 3.4, 3.9 | DF-1, DF-2, DF-17, DF-20, DF-21 | R/W | `user_id`, `access_token`, `expires_at` |

**凡例**: R=Read, W=Write, D=Delete

---

## 7. UCカバレッジサマリ

### 7.1 優先度別カバレッジ

| 優先度 | 総UC数 | 完全カバー | BFのみ | 未定義 | カバレッジ |
|:------:|:------:|:----------:|:------:|:------:|:----------:|
| MVP | 14 | 14 | 0 | 0 | **100%** |
| Phase 2 | 16 | 9 | 0 | 7 | 56.3% |
| v3 | 2 | 0 | 2 | 0 | 0% |
| **合計** | **32** | **23** | **2** | **7** | **71.9%** |

### 7.2 カテゴリ別カバレッジ

| カテゴリ | 総UC数 | 完全カバー | BFのみ | 未定義 |
|---------|:------:|:----------:|:------:|:------:|
| 1. 認証 | 2 | 2 | 0 | 0 |
| 2. プロジェクト管理 | 4 | 4 | 0 | 0 |
| 3. 図表操作 | 11 | 7 | 2 | 2 |
| 4. AI機能 | 2 | 2 | 0 | 0 |
| 5. 管理機能 | 13 | 8 | 0 | 5 |

---

## 8. 整合性チェック結果

### 8.1 確認済み項目

| # | 確認項目 | 結果 |
|:-:|---------|:----:|
| 1 | MVP機能の業務フロー・DFD対応 | ✅ |
| 2 | アクター名の統一 | ✅ |
| 3 | 外部システム名の統一 | ✅ |
| 4 | データストア定義 | ✅ |
| 5 | TD-006（Storage Only構成）との整合性 | ✅ |
| 6 | TD-007（AI機能プロバイダー構成）との整合性 | ✅ |

### 8.2 発見した問題

| # | 種別 | 内容 | 対応方針 |
|:-:|:----:|------|---------|
| 1 | ⚠️ | UC 3-7, 3-8: BF定義済み、DFD未定義 | v3でDB追加時に対応 |
| 2 | 🔴 | UC 3-10, 3-11, 5-6, 5-9〜5-12: 未定義 | Phase 2で定義 |

---

## 9. クラス図への橋渡し

本セクションは、機能一覧表から抽出されたエンティティ・属性候補を整理し、クラス図作成フェーズへの入力を提供する。

### 9.1 抽出エンティティ候補

| エンティティ | 説明 | 関連機能 | データストア |
|-------------|------|---------|:------------:|
| **User** | システム利用者 | F-AUTH-01, F-AUTH-02, F-ADM-01 | D2 |
| **Project** | 図表をグループ化する単位 | F-PRJ-01〜04 | D1 |
| **Diagram** | PlantUML/Excalidraw図表 | F-DGM-01〜09 | D1 |
| **Template** | 図表作成用テンプレート | F-DGM-02 | D1 |
| **Session** | 認証セッション情報 | F-AUTH-01, F-AUTH-02 | D2 |
| **LLMModel** | 登録済みLLMモデル | F-ADM-02, F-ADM-03 | D2 |
| **Prompt** | LLMプロンプトテンプレート | F-ADM-04 | D2 |
| **SystemConfig** | システム設定 | F-ADM-13 | D2 |

### 9.2 エンティティ属性候補

本セクションの属性定義には、型・必須フラグに加えて**バリデーションルール**を明記する。

#### バリデーション凡例

| 記号 | 意味 |
|:----:|------|
| `PK` | Primary Key（主キー） |
| `FK` | Foreign Key（外部キー） |
| `UK` | Unique Key（一意制約） |
| `REGEX` | 正規表現パターン |
| `RANGE` | 値の範囲 |
| `ENUM` | 許可値リスト |

#### User（ユーザー）

| 属性 | 型 | 必須 | 制約条件 | 説明 |
|------|-----|:----:|---------|------|
| user_id | UUID | ✅ | `PK`, 自動生成 | ユーザー識別子 |
| email | VARCHAR(255) | ✅ | `UK`, `REGEX: ^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$` | メールアドレス |
| provider | ENUM | ✅ | `ENUM: 'github', 'google'` | 認証プロバイダー |
| role | ENUM | ✅ | `ENUM: 'user', 'developer'`, デフォルト: 'user' | 権限 |
| last_sign_in_at | TIMESTAMP | ❌ | `RANGE: >= created_at` | 最終ログイン日時 |
| last_selected_project_id | VARCHAR(100) | ❌ | `FK: Project.project_name` (nullable) | 最後に選択したプロジェクト（TD-005） |
| is_active | BOOLEAN | ✅ | デフォルト: true | アカウント有効フラグ |
| created_at | TIMESTAMP | ✅ | 自動設定（UTC） | 作成日時 |

#### Project（プロジェクト）

| 属性 | 型 | 必須 | 制約条件 | 説明 |
|------|-----|:----:|---------|------|
| project_name | VARCHAR(100) | ✅ | `UK: (user_id, project_name)`, `REGEX: ^[a-zA-Z0-9ぁ-んァ-ン一-龯_\-\s]{1,100}$`, 禁止文字: `\ / : * ? " < > \|` | プロジェクト名 |
| user_id | UUID | ✅ | `FK: User.user_id`, `ON DELETE CASCADE` | 所有者ユーザーID |
| description | TEXT | ❌ | `RANGE: 0-500文字` | プロジェクト説明 |
| storage_path | VARCHAR(255) | ✅ | 自動生成（`/{user_id}/{project_name}/`）, `UK` | Storageパス |
| created_at | TIMESTAMP | ✅ | 自動設定（UTC） | 作成日時 |
| updated_at | TIMESTAMP | ✅ | 自動更新（UTC）, `RANGE: >= created_at` | 更新日時 |

**ビジネスルール（project_name）**:
- 予約語禁止: `admin`, `system`, `null`, `undefined`, `api`, `auth`
- 先頭・末尾の空白は自動トリム
- 連続する空白は単一空白に正規化

#### Diagram（図表）

| 属性 | 型 | 必須 | 制約条件 | 説明 |
|------|-----|:----:|---------|------|
| diagram_name | VARCHAR(100) | ✅ | `UK: (project_name, diagram_name)`, `REGEX: ^[a-zA-Z0-9ぁ-んァ-ン一-龯_\-]{1,100}$`, 禁止文字: `\ / : * ? " < > \| .`（拡張子は含めない） | 図表名 |
| project_name | VARCHAR(100) | ✅ | `FK: Project.project_name`, `ON DELETE CASCADE` | 所属プロジェクト名 |
| content_type | ENUM | ✅ | `ENUM: 'puml', 'excalidraw'` | 図表タイプ |
| source_code | TEXT | ✅ | `RANGE: 1B-1MB`, エンコーディング: UTF-8 | ソースコード |
| preview_svg | BLOB | ❌ | `RANGE: 0-5MB`, MIMEタイプ: `image/svg+xml` | プレビュー画像 |
| file_path | VARCHAR(255) | ✅ | 自動生成, `UK` | Storageパス |
| file_size | INTEGER | ✅ | `RANGE: 1-1048576`（1MB） | ファイルサイズ（bytes） |
| template_id | VARCHAR(50) | ❌ | `FK: Template.template_id` (nullable) | 作成元テンプレート |
| created_at | TIMESTAMP | ✅ | 自動設定（UTC） | 作成日時 |
| updated_at | TIMESTAMP | ✅ | 自動更新（UTC）, `RANGE: >= created_at` | 更新日時 |

**ビジネスルール（diagram_name）**:
- ファイル拡張子（`.puml`, `.excalidraw.json`）は自動付与
- 予約語禁止: `index`, `default`, `new`

#### Template（テンプレート）

| 属性 | 型 | 必須 | 制約条件 | 説明 |
|------|-----|:----:|---------|------|
| template_id | VARCHAR(50) | ✅ | `PK`, `REGEX: ^[a-z0-9\-]{1,50}$`（kebab-case） | テンプレートID |
| name | VARCHAR(100) | ✅ | `RANGE: 1-100文字` | テンプレート名 |
| category | VARCHAR(50) | ✅ | `ENUM: 'sequence', 'class', 'usecase', 'activity', 'state', 'component', 'er', 'wireframe', 'flowchart', 'mockup'` | カテゴリ |
| content_type | ENUM | ✅ | `ENUM: 'puml', 'excalidraw'` | 対応図表タイプ |
| source_code | TEXT | ✅ | `RANGE: 1B-100KB` | テンプレートソースコード |
| preview_url | URL | ❌ | `REGEX: ^https?://.*\.(svg\|png)$` | プレビュー画像URL |
| description | TEXT | ❌ | `RANGE: 0-500文字` | 説明文 |

#### Session（セッション）

| 属性 | 型 | 必須 | 制約条件 | 説明 |
|------|-----|:----:|---------|------|
| session_id | UUID | ✅ | `PK`, 自動生成 | セッションID |
| user_id | UUID | ✅ | `FK: User.user_id`, `ON DELETE CASCADE` | ユーザーID |
| access_token | JWT | ✅ | Supabase管理, 有効期限: 1時間 | アクセストークン |
| refresh_token | VARCHAR(512) | ✅ | Supabase管理, 有効期限: 7日, `REGEX: ^[A-Za-z0-9_-]+$` | リフレッシュトークン |
| expires_at | TIMESTAMP | ✅ | `RANGE: > created_at`, `RANGE: <= created_at + 7日` | トークン有効期限 |
| created_at | TIMESTAMP | ✅ | 自動設定（UTC） | セッション作成日時 |

#### LLMModel（LLMモデル）

| 属性 | 型 | 必須 | 制約条件 | 説明 |
|------|-----|:----:|---------|------|
| model_id | VARCHAR(200) | ✅ | `PK`, `REGEX: ^[a-z0-9\-]+/[a-z0-9\.\-]+$`（provider/model形式） | OpenRouterモデルID |
| display_name | VARCHAR(100) | ✅ | `RANGE: 1-100文字` | 表示名 |
| input_cost | DECIMAL(10,6) | ✅ | `RANGE: 0.000000-999.999999`（$/M tokens） | 入力トークン単価 |
| output_cost | DECIMAL(10,6) | ✅ | `RANGE: 0.000000-999.999999`（$/M tokens） | 出力トークン単価 |
| max_context | INTEGER | ✅ | `RANGE: 1024-2097152`（1K〜2M tokens） | 最大コンテキスト長 |
| description | TEXT | ❌ | `RANGE: 0-1000文字` | 説明・備考 |
| is_active | BOOLEAN | ✅ | デフォルト: true | 有効フラグ |

#### LearningContent（学習コンテンツ）※Phase 2

| 属性 | 型 | 必須 | 制約条件 | 説明 |
|------|-----|:----:|---------|------|
| content_id | UUID | ✅ | `PK`, 自動生成 | コンテンツID |
| title | VARCHAR(200) | ✅ | `RANGE: 1-200文字` | タイトル |
| category | VARCHAR(50) | ✅ | `ENUM: 'syntax', 'bestpractice', 'example', 'tutorial'` | カテゴリ |
| content_type | ENUM | ✅ | `ENUM: 'puml', 'excalidraw', 'general'` | 対象図表タイプ |
| body | TEXT | ✅ | `RANGE: 1B-10MB`, Markdown形式 | 本文 |
| sample_code | TEXT | ❌ | `RANGE: 0-100KB` | サンプルコード |
| embedding_vector | VECTOR(1536) | ✅ | pgvector, 自動生成 | Embeddingベクトル |
| tags | VARCHAR[] | ❌ | 各タグ: `RANGE: 1-50文字`, 最大10タグ | タグ一覧 |
| created_at | TIMESTAMP | ✅ | 自動設定（UTC） | 作成日時 |
| updated_at | TIMESTAMP | ✅ | 自動更新（UTC） | 更新日時 |

### 9.3 エンティティ関連図（概念レベル）

```
┌─────────┐       1:N       ┌──────────┐       1:N       ┌──────────┐
│  User   │───────────────>│  Project │───────────────>│  Diagram │
└─────────┘                 └──────────┘                 └──────────┘
     │                                                        │
     │ 1:N                                                    │ N:1
     ▼                                                        ▼
┌─────────┐                                            ┌──────────┐
│ Session │                                            │ Template │
└─────────┘                                            └──────────┘

┌─────────┐                 ┌──────────┐               ┌──────────────┐
│LLMModel │<───────────────>│  Prompt  │               │ SystemConfig │
└─────────┘     N:M         └──────────┘               └──────────────┘
```

### 9.4 関連定義

| 関連 | カーディナリティ | 説明 |
|------|:----------------:|------|
| User → Project | 1:N | ユーザーは複数のプロジェクトを持つ |
| User → Session | 1:N | ユーザーは複数のセッションを持つ（デバイス別） |
| Project → Diagram | 1:N | プロジェクトは複数の図表を持つ |
| Diagram → Template | N:1 | 図表はテンプレートから作成可能（任意） |
| LLMModel → Prompt | N:M | モデルとプロンプトは多対多（機能別割当） |

### 9.5 ドメインオブジェクト候補

機能一覧表から抽出されたビジネスロジックを持つドメインオブジェクト候補:

| オブジェクト | 責務 | 関連機能 |
|-------------|------|---------|
| **AuthService** | OAuth認証、セッション管理 | F-AUTH-01, F-AUTH-02 |
| **ProjectService** | プロジェクトCRUD、Storage操作 | F-PRJ-01〜04 |
| **DiagramService** | 図表CRUD、Storage操作 | F-DGM-01, F-DGM-03, F-DGM-05, F-DGM-09 |
| **ValidationService** | PlantUML構文検証、レンダリング | F-DGM-04 |
| **ExportService** | PNG/SVG/PDFエクスポート | F-DGM-06 |
| **TemplateService** | テンプレート一覧・取得 | F-DGM-02 |
| **AIService** | AI Question-Start、用語チェック | F-AI-01, F-AI-02 |
| **AdminService** | ユーザー管理、システム設定 | F-ADM-01, F-ADM-13 |
| **LLMConfigService** | LLMモデル・プロンプト管理 | F-ADM-02〜08 |

### 9.6 Repository Pattern（TD-006準拠）

TD-006（Storage Only構成）に基づき、Repository Patternを採用:

```
┌─────────────────────────────────────┐
│        Application Layer            │
│  (DiagramService, ProjectService)   │
└──────────────────┬──────────────────┘
                   │
                   ▼
┌─────────────────────────────────────┐
│       IDiagramRepository            │
│       IProjectRepository            │
│         (Interface)                 │
└──────────────────┬──────────────────┘
                   │
         ┌────────┴────────┐
         │                 │
         ▼                 ▼
┌─────────────────┐ ┌─────────────────┐
│ MVP:            │ │ v3:             │
│ StorageRepo     │ │ DB+StorageRepo  │
│ (Supabase       │ │ (Supabase DB +  │
│  Storage Only)  │ │  Storage)       │
└─────────────────┘ └─────────────────┘
```

**メリット**:
- MVP→v3移行時、Repository実装の差し替えのみ
- アプリケーション層のコード変更不要
- テスト時にMock Repositoryで置換可能

---

## 変更履歴

| バージョン | 日付 | 変更内容 |
|:----------:|:----:|---------|
| v1.0 | 2025-12-08 | 初版作成（32UC機能定義） |
| v1.1 | 2025-12-08 | 業務フロー対比表追加 |
| v1.2 | 2025-12-08 | DFD対比表追加 |
| v1.3 | 2025-12-08 | クラス図橋渡し追加（§9） |
| v1.4 | 2025-12-08 | 目次追加、共通エラー定義追加（§0） |
| v1.5 | 2025-12-08 | Phase 2機能骨子追加（F-DGM-10〜11, F-AI-02, F-ADM-06〜12）、§9.2バリデーションルール明文化 |

---

**作成完了**: 2025-12-08 v1.5（Phase 2機能骨子追加、バリデーションルール明文化）
