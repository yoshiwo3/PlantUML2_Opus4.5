# 作業シート: 3.9 管理機能フロー（MVP）レビュー・修正

**作業日**: 2025-12-08
**作業者**: Claude Code
**所要時間**: 約60分

---

## 目標

`docs/proposals/PlantUML_Studio_業務フロー図_20251201.md`内の3.9 管理機能フロー（MVP）をPlantUML開発憲法に従ってレビュー・修正する。

---

## 完了した作業

### 1. 全10フローのPNG生成・4パスレビュー

| # | フロー | UC | 初回 | 修正内容 | 最終 |
|:-:|--------|:--:|:---:|---------|:---:|
| 1 | 3.9 概要図 | - | ❌ | endif後アクション追加 | ✅ |
| 2 | 3.9.1 ユーザー管理 | 5-1 | ❌ | switch内スイムレーン遷移削除 | ✅ |
| 3 | 3.9.2 LLM管理概要 | - | ✅ | - | ✅ |
| 4 | 3.9.2.1 LLMモデル登録 | 5-2 | ✅ | - | ✅ |
| 5 | 3.9.2.2 LLMモデル切替 | 5-3 | ✅ | - | ✅ |
| 6 | 3.9.2.3 LLMプロンプト管理 | 5-4 | ❌ | switch内スイムレーン遷移削除 | ✅ |
| 7 | 3.9.2.4 LLMパラメータ設定 | 5-5 | ❌ | if内スイムレーン遷移削除 | ✅ |
| 8 | 3.9.2.5 LLM使用量監視 | 5-7 | ❌ | if内スイムレーン遷移削除 | ✅ |
| 9 | 3.9.2.6 LLMフォールバック設定 | 5-8 | ❌ | switch内スイムレーン遷移削除 | ✅ |
| 10 | 3.9.3 システム設定 | 5-13 | ✅ | - | ✅ |

**修正率**: 7/10フロー（70%）で修正が必要

### 2. 発見した問題と修正

#### 問題A: endif直後のスイムレーン遷移（1フロー）

**対象**: 3.9 概要図

```plantuml
' 修正前（NG）
if (...) then (...)
  :処理;
endif
|別のレーン|     ← 接続線が途切れる

' 修正後（OK）
if (...) then (...)
  :処理;
  :待機処理;     ← アクション追加
endif
|別のレーン|
```

#### 問題B: switch/case内でのスイムレーン遷移（3フロー）

**対象**: 3.9.1 ユーザー管理、3.9.2.3 LLMプロンプト管理、3.9.2.6 LLMフォールバック設定

```plantuml
' 修正前（NG）
switch (選択)
case (A)
  :処理A;
  |Frontend|     ← 最初のcase以外で接続線が途切れる
  :結果A;

' 修正後（OK）
switch (選択)
case (A)
  :処理A;
  #color:結果A;
  note right: Frontend で処理
```

#### 問題C: if/else内でのスイムレーン遷移（3フロー）

**対象**: 3.9.2.4 LLMパラメータ設定、3.9.2.5 LLM使用量監視、3.9.2.2 LLMモデル切替（軽微）

```plantuml
' 修正前（NG）
if (条件?) then (はい)
  :処理;
  |Supabase|     ← if内でスイムレーン遷移 → else側が孤立
  :DB更新;
else (いいえ)
  :別処理;       ← 孤立ノード
endif

' 修正後（OK）
if (条件?) then (はい)
  :処理;
  #lightblue:実行;
  note right: Supabase で DB更新
else (いいえ)
  :別処理;
endif
```

### 3. 元ファイルへの反映

修正内容を`docs/proposals/PlantUML_Studio_業務フロー図_20251201.md`に反映済み。

**修正箇所（7箇所）**:
- 3.9 概要図（1921行目）
- 3.9.1 ユーザー管理（1980-2006行目）
- 3.9.2.3 LLMプロンプト管理（2223-2249行目）
- 3.9.2.4 LLMパラメータ設定（2277-2300行目）
- 3.9.2.5 LLM使用量監視（2340-2351行目）
- 3.9.2.6 LLMフォールバック設定（2374-2402行目）

---

## 成果物

### エビデンスフォルダ
`docs/evidence/20251208_0007_admin_flow_mvp/`

| ファイル | 内容 |
|---------|------|
| `01_admin_overview.puml` | 3.9 概要図 |
| `02_user_management.puml` | 3.9.1 ユーザー管理 |
| `03_llm_management_overview.puml` | 3.9.2 LLM管理概要 |
| `04_llm_model_register.puml` | 3.9.2.1 LLMモデル登録 |
| `05_llm_model_switch.puml` | 3.9.2.2 LLMモデル切替 |
| `06_llm_prompt_management.puml` | 3.9.2.3 LLMプロンプト管理 |
| `07_llm_parameter_setting.puml` | 3.9.2.4 LLMパラメータ設定 |
| `08_llm_usage_monitoring.puml` | 3.9.2.5 LLM使用量監視 |
| `09_llm_fallback_setting.puml` | 3.9.2.6 LLMフォールバック設定 |
| `10_system_settings.puml` | 3.9.3 システム設定 |
| `*.png` | レビュー用PNG（10件） |
| `*.review.json` | レビューログ（10件） |
| `instructions.md` | 作業指示書 |
| `00_raw_notes.md` | 作業メモ |
| `work_sheet.md` | 本シート |

### 更新ファイル

- `docs/proposals/PlantUML_Studio_業務フロー図_20251201.md`
  - 7箇所のPlantUMLコード修正

---

## 次のアクション

1. [ ] SVG正式版の生成（`-Publish`オプション）
2. [ ] `active_context.md`の更新（3.9フロー完了をマーク）
3. [ ] CLAUDE.mdの進捗更新

---

## 教訓・ナレッジ

### PlantUML憲法への追加推奨事項

**現行の禁止事項#1の拡張が必要**

```
| # | 禁止事項（現行） | 拡張推奨 |
|:-:|----------------|---------|
| 1 | if/fork内でスイムレーン遷移 | **if/fork/switch内でスイムレーン遷移** |
```

### 具体的な追加推奨

1. **switch/case内でのスイムレーン遷移も禁止**
   - 最初のcase以外で接続線が途切れる
   - 回避策: switch全体を1スイムレーン内に収め、他レーンの処理はnoteで説明

2. **if/else両方でスイムレーン遷移がある場合も禁止**
   - else側の接続線が途切れる
   - 回避策: if全体を1スイムレーン内に収め、noteで説明

3. **レビュー時の確認強化**
   - 「最初の分岐」だけでなく「すべての分岐」で接続線を確認
   - 孤立ノードは上流接続線の有無で判断

### 問題発見率

| 問題パターン | 発見フロー数 |
|-------------|:-----------:|
| endif直後のスイムレーン遷移 | 1 |
| switch/case内スイムレーン遷移 | 3 |
| if/else内スイムレーン遷移 | 3 |
| **合計** | **7** |
