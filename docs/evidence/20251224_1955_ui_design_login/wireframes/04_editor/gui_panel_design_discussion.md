# GUIパネル設計技術議論記録

**作成日時**: 2025-12-28
**セッション**: Session 12
**対象画面**: #04 エディタ画面
**claude ops参照**: ファイル変更履歴・タイムスタンプ検証済み

---

## 0. タイムライン概要

| 時刻 (JST) | イベント | 成果物/決定 |
|:----------:|---------|------------|
| 13:06 | v1.0作成 | 2パネルレイアウト（却下） |
| 13:37 | v2.0作成 | 3パネル+AIパネル構成 |
| 13:42 | v2.1更新 | エクスポートボタン追加 |
| 13:52 | TD-017決定 | GUIパネル図表タイプ別切り替え |
| 14:07-14:16 | v2.2更新 | 5セクションGUIパネル構造 |
| 14:41 | TD-018決定 | パネル間同期アーキテクチャ |
| 15:33 | 議論記録作成 | 本ファイル初版 |
| 15:34 | TD-019/TD-020決定 | 3層構造、Note対応 |

---

## 1. 議論の経緯

### 1.1 初期設計（v1.0 → v2.0）
**時刻**: 13:06〜13:37

**問題**: 初期設計は2パネルレイアウト（ファイルツリー + エディタ）であった。

**ユーザー指摘**:
> "ダメです。完全準拠する必要はありませんが、PlantUML_Studio_全図表タイプUI設計.mdを確認してみてください。"
> "下部AIパネルは必須です。"

**修正**: 3パネル構成（GUI / Code / Preview）+ 下部AIパネルに変更

---

### 1.2 リサイザー機能の確認
**時刻**: 13:40頃

**ユーザー確認**:
> "各ビューをD&Dでリスライドできますよね。"

**回答**: パネル間のリサイザーによるD&Dリサイズを確認。TD-016（1920×1080基準）に基づき、各パネル幅は可変。

---

### 1.3 GUIパネルの図表タイプ別切り替え（TD-017）
**時刻**: 13:52

**ユーザー質問**:
> "左パネルは作成する図表によって切り替える必要があることは認識していますか？"

**分析結果**:
- シーケンス図、クラス図、ユースケース図等で異なるGUIが必要
- 各図表タイプに最適化されたGUIを動的に切り替える設計を採用

**ユーザー指示**:
> "上記は技術的決定事項として記録しておいてください。"

**技術決定**: TD-017として記録

---

### 1.4 5セクションGUIパネル構造（v2.2）
**時刻**: 14:07〜14:16

**ユーザー要求**:
> "シーケンス図における左パネル（GUI操作）のあるべき構成をUltrathinkで分析して。"

**Ultrathink分析結果**:

| セクション | 機能 | 操作 |
|:----------:|------|------|
| Section 1 | 参加者管理 | 追加、編集、削除、D&D並べ替え |
| Section 2 | メッセージ作成 | From/To選択、タイプ、テキスト入力 |
| Section 3 | フラグメント挿入 | alt/opt/loop/par/break/critical/group |
| Section 4 | メッセージ一覧 | カード表示、D&D並べ替え、編集 |
| Section 5 | ツール | PlantUML生成、アクティブバー管理、Note追加 |

**ユーザー承認**: "はい。更新してく"

**注記**: 当初Section 6（アクティブバー専用）も検討されたが、操作性を考慮しモーダル方式に変更。Section 5のツールセクションに「アクティブバー管理」ボタンを配置する設計に決定。

---

### 1.5 アクティブバー管理（モーダル方式）
**時刻**: 14:20頃

**ユーザー質問**:
> "アクティブバーもGUIで設定できませんか？"
> "++、--だけでは同時に複数のアクティブバーを設置できないのでは？"

**問題分析**:
- PlantUMLの`++`/`--`は単一深度のみ対応
- 複数参加者の同時アクティベーションには対応困難
- `activate`/`deactivate`でも深度管理が複雑

**ユーザー提案**:
> "Section 6 までMVP範囲。左パネルにスライドバーを設置すればよいのでは？"
> "これを実現するならSection6はモーダル画面で行った方がよいかも"

**決定**: アクティブバー管理はモーダル方式を採用

**アクティブバー管理モーダル詳細設計**:

```
┌─────────────────────────────────────────────────────────────────────────┐
│ アクティブバー管理                                               [×]   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  メッセージ選択: [3. Server → DB: findUser()                     ▼]   │
│                                                                         │
│  ┌─ 深度グリッド ───────────────────────────────────────────────────┐   │
│  │                                                                   │   │
│  │     User   Browser   Server   DB   AuthService                   │   │
│  │  ┌──────┬──────┬──────┬──────┬──────┐                            │   │
│  │ 1│      │      │  ■   │      │      │ ← メッセージ1時点          │   │
│  │  ├──────┼──────┼──────┼──────┼──────┤                            │   │
│  │ 2│      │      │  ■   │  □   │      │ ← メッセージ2時点          │   │
│  │  ├──────┼──────┼──────┼──────┼──────┤                            │   │
│  │ 3│      │      │  ■   │  ■   │      │ ← 現在選択中 ★            │   │
│  │  ├──────┼──────┼──────┼──────┼──────┤                            │   │
│  │ 4│      │      │  ■   │  □   │      │                            │   │
│  │  └──────┴──────┴──────┴──────┴──────┘                            │   │
│  │                                                                   │   │
│  │  ■ = アクティブ（クリックで■↔□切替）                            │   │
│  │  深度: [1▼] ← 同一参加者の深度レベル                             │   │
│  │                                                                   │   │
│  └───────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  プレビュー:                                                            │
│  ┌───────────────────────────────────────────────────────────────────┐   │
│  │  User -> Server: request()                                       │   │
│  │  activate Server                                                  │   │
│  │  Server -> DB: query()                                           │   │
│  │  activate DB           ← 深度1                                   │   │
│  │  DB --> Server: data                                             │   │
│  │  deactivate DB                                                   │   │
│  └───────────────────────────────────────────────────────────────────┘   │
│                                                                         │
├─────────────────────────────────────────────────────────────────────────┤
│                                    [キャンセル]  [適用]                  │
└─────────────────────────────────────────────────────────────────────────┘
```

**操作フロー**:
1. Section 5の「アクティブバー管理」ボタンをクリック
2. モーダルが開き、全メッセージの深度グリッドを表示
3. セルをクリックしてアクティブ状態をトグル
4. 深度セレクタで多重アクティベーションを設定
5. リアルタイムプレビューで確認
6. 「適用」でCodeパネルに反映

---

### 1.6 パネル間同期アーキテクチャ（TD-018）
**時刻**: 14:41

**ユーザー要求**:
> "左パネルと中央パネルの関係性をUltrathinkで分析して"
> "この分析を TD-018: エディタパネル間同期アーキテクチャ として記録して"

**Ultrathink分析結果**:

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│  GUI Panel   │←───→│  Code Panel  │────→│Preview Panel │
└──────────────┘     └──────────────┘     └──────────────┘
```

**同期タイミング**:
| 方向 | 遅延 | 理由 |
|------|:----:|------|
| GUI → Code | 0ms（即時） | ユーザー操作を即座に反映 |
| Code → GUI | 300ms（デバウンス） | タイピング中の頻繁な更新を防止 |
| Code → Preview | 500ms（デバウンス） | レンダリングコスト考慮 |

**技術決定**: TD-018として記録

---

### 1.7 GUIパネル操作性の課題（3層構造提案）
**時刻**: 15:00頃

**ユーザー懸念**:
> "現在のGUIパネル設計で十分な操作性を担保できますか？GUIパネルエリアが狭すぎる気がします。"
> "クリック操作で左・中央パネルエリアを「GUI・コード」「GUI」「コード」に切り替えられる必要があるのでは？"
> "フラグメント毎にモーダル入力させた方がよいのでは？"
> "プロジェクト内の全メッセージはGUIパネル上でカード表示されており、D&Dで各メッセージの入れ替えを想定していたのですが"
> "作成したメッセージは1メッセージ毎にコードパネルに反映されるの？"

**Ultrathink分析結果**:

#### 課題1: GUIパネル幅（300px）の制約

| セクション | 必要な操作 | 260px幅での制約 |
|-----------|-----------|----------------|
| 参加者カード | 名前表示 + 編集/削除ボタン | 長い名前は省略表示必須 |
| メッセージ作成 | From/To選択 + タイプ + テキスト | 横並び不可、縦積み必須 |
| メッセージ一覧 | カード表示 + D&D + 編集 | カード情報が圧縮される |

**結論**: 300px固定は不十分。パネルモード切替が必須。

#### 課題2: パネルモード切替機構

**提案: 3モードトグル**（TD-021として独立決定）

```
モード1: GUI+Code（デフォルト）
┌────────┬────────────┬────────────┐
│ GUI    │ Code       │ Preview    │
│ 300px  │ 650px      │ 962px      │
└────────┴────────────┴────────────┘

モード2: GUI のみ（非コーダー向け）
┌───────────────────┬────────────┐
│ GUI               │ Preview    │
│ 950px             │ 962px      │
└───────────────────┴────────────┘

モード3: Code のみ（上級者向け）
┌────────────────────┬───────────┐
│ Code               │ Preview   │
│ 950px              │ 962px     │
└────────────────────┴───────────┘
```

#### 課題3: フラグメント入力UX

**問題**: 260px幅でネストされたフラグメント構造を表現困難

**解決策**: フラグメント専用モーダル
- 各条件ブロック内にメッセージ作成GUI配置
- メッセージ一覧もD&D可能なカード形式
- 条件間でのメッセージ移動もD&D対応

**ユーザー追加指摘**:
> "フラグメント専用モーダルにおいてプレビューエリアは不要。GUIパネルと同様メッセージ作成GUIが必要では？"

**修正**: フラグメントモーダルからプレビューを削除し、メッセージ作成GUIを配置

#### 課題4: メッセージ数増大時の操作性

**問題**:
- GUIパネル: 300px幅 × 約300px高（Section 4）
- 表示可能カード数: 約4〜5枚（スクロール必要）
- 複雑なシーケンス図: 20〜50メッセージも珍しくない

**ユーザー追加指摘**:
> "メッセージカードUIはいいアイデアですが、メッセージ数が多くなったときGUIパネル内でしか操作できないのは操作性を低下させませんか？"

**解決策**: メッセージ管理モーダル
- 2カラムレイアウト: 左=作成/フラグメント、右=メッセージ一覧
- 全メッセージ俯瞰: スクロール可能な広い一覧エリア
- 複数選択→フラグメント化: チェックボックスで選択し、一括でフラグメント適用

#### 課題5: メッセージ同期タイミング

**ユーザー質問**: "作成したメッセージは1メッセージ毎にコードパネルに反映されるの？"

**回答**: TD-018に基づき、GUI操作は**即時（0ms）**でCodeに反映。各メッセージ作成・編集・D&D操作は即座にPlantUMLコードに変換される。

---

## 2. 3層構造設計

**時刻**: 15:20頃
**ユーザー承認**: "はい。上記の3総構造でOKです。"

| 層 | 用途 | 操作領域 |
|:--:|------|---------|
| **1** | GUIパネル | 簡易操作、クイックアクセス（300px） |
| **2** | メッセージ管理モーダル | 全メッセージ俯瞰、D&D、フラグメント化（800px+） |
| **3** | フラグメント編集モーダル | フラグメント内の詳細編集（600px+） |

**モーダル間の遷移**:
```
GUIパネル
    │
    ├─→ [メッセージ管理を開く] → メッセージ管理モーダル
    │                               │
    │                               ├─→ [フラグメント編集] → フラグメント編集モーダル
    │                               │
    │                               └─→ [適用] → GUIパネルに戻る
    │
    └─→ [フラグメント挿入] → フラグメント編集モーダル（直接）
```

---

## 3. Note機能対応

**時刻**: 15:25頃

**ユーザー確認**:
> "基本的な機能としてnoteも対応しますよね。Ultrathinkで分析して。"

### 3.1 PlantUML Noteの種類

| 種類 | 構文 | 用途 |
|------|------|------|
| **参加者note** | `note left/right of <参加者>` | 参加者の状態・役割説明 |
| **メッセージnote** | `note left/right` (メッセージ直後) | メッセージの補足説明 |
| **範囲note** | `note over <参加者1>, <参加者2>` | 複数参加者間の状態説明 |
| **全体note** | `note across` | シーケンス全体への注記 |
| **六角形note** | `hnote over <参加者>` | 状態表現用六角形ノート |
| **四角形note** | `rnote over <参加者>` | 状態表現用四角形ノート |

### 3.2 関連要素

| 要素 | 構文 | 用途 |
|------|------|------|
| **区切り線** | `== タイトル ==` | シーケンスの論理区切り |
| **遅延** | `...` または `... 説明 ...` | 時間経過の表現 |
| **スペース** | `|||` または `||45||` | 視覚的な余白 |

### 3.3 3層構造へのNote統合

| 層 | Note種類 | 操作方法 |
|:--:|---------|---------|
| **1** GUIパネル | 全種類 | Section 5 [Note追加] ボタン → ポップオーバー |
| **2** メッセージ管理 | メッセージNote | カード内 [Note+] ボタン、既存Noteのインライン編集 |
| **2** メッセージ管理 | 参加者Note | 参加者カード [Note N件] → 管理ポップオーバー |
| **2** メッセージ管理 | 全体Note | 専用セクション [+ Note追加] |
| **3** フラグメント編集 | フラグメントNote | 条件ブロック内 [Note編集] |
| **3** フラグメント編集 | メッセージNote | カード内 [Note+] ボタン |

### 3.4 Note同期タイミング（TD-018準拠）

| 操作 | 同期タイミング | 備考 |
|------|--------------|------|
| Note追加 | **即時（0ms）** | 追加ボタンクリック時 |
| Note編集 | **即時（0ms）** | 編集確定時 |
| Note削除 | **即時（0ms）** | 削除確認後 |
| Code編集からのNote検出 | **300ms** | PlantUMLパーサーでnote構文を抽出 |

---

## 4. 技術決定事項サマリ

| TD | タイトル | 決定時刻 | 決定内容 |
|:--:|---------|:--------:|---------|
| TD-017 | GUIパネル図表タイプ別切り替え | 13:52 | 図表タイプに応じてGUIパネルを動的切り替え |
| TD-018 | パネル間同期アーキテクチャ | 14:41 | 双方向同期、Codeを正のソース、GUI→Code即時/Code→GUI 300ms |
| TD-019 | 3層操作UI構造 | 15:34 | GUIパネル→メッセージ管理モーダル→フラグメント編集モーダル |
| TD-020 | Note機能GUI対応 | 15:34 | 3層構造全体でNote操作をサポート |
| TD-021 | パネルモード切替機構 | 15:34 | GUI+Code/GUIのみ/Codeのみの3モード切替 |
| TD-022 | APIファースト・マイクロモジュール化 | 16:00 | GUIパネルの機能差替可能設計 |

---

## 5. 未解決課題

| # | 課題 | 状況 | 優先度 |
|:-:|------|------|:------:|
| 1 | パネルモードトグルUI設計 | TD-021決定済、ワイヤーフレーム反映待ち | 高 |
| 2 | メッセージカードUI詳細設計 | 承認済み、実装詳細未定 | 中 |
| 3 | フラグメントモーダルUI詳細 | 概念設計完了、ワイヤーフレーム未作成 | 中 |
| 4 | メッセージ管理モーダルUI詳細 | 概念設計完了、ワイヤーフレーム未作成 | 中 |
| 5 | アクティブバー管理モーダルUI詳細 | 概念設計完了、ワイヤーフレーム未作成 | 低 |

---

## 6. APIファースト・マイクロモジュール化方針（TD-022）

**時刻**: 16:00

### 6.1 議論経緯

**ユーザー指示**:
> "TD-020については後日レベル2～3もGUI化する可能性がある。このプロジェクト全体に話がおよぶが原則APIファスト（マイクロモジュール化）で開発予定。レベル2～3のGUI化に備えてGUIパネルも全体をマイクロモジュールで実装し、後日機能差替が可能な様式で開発を行うこと。"

**AI分析結果**:
1. GUI編集レベル（TD-020）のレベル2→1、レベル3→1アップグレードに備える必要性
2. プロジェクト全体にAPIファースト原則を適用
3. モジュール差し替え可能なアーキテクチャ設計

### 6.2 決定事項サマリ

| 項目 | 決定内容 |
|------|---------|
| **適用範囲** | プロジェクト全体（GUIパネル、パーサー、認証、ストレージ）|
| **設計原則** | APIファースト（インターフェース定義先行、疎結合、契約駆動）|
| **モジュール構造** | Module Registry API による登録・差し替え機構 |
| **将来対応** | レベル2/3モジュールをレベル1版に差し替え可能 |

### 6.3 技術詳細

> **詳細は `docs/context/technical_decisions.md` TD-022を参照**
>
> - ParsedElement基本型定義
> - GUIModuleインターフェース
> - バージョニング戦略（セマンティックバージョニング）
> - エラーハンドリング方針
> - 認証/ストレージモジュール詳細

**技術決定**: TD-022として記録

---

## 7. 関連ファイル

| ファイル | 内容 | 最終更新 |
|---------|------|:--------:|
| `default.excalidraw` | エディタ画面ワイヤーフレーム v2.2 | 14:16 |
| `docs/context/technical_decisions.md` | TD-017〜TD-022 記録 | 16:00 |

---

## 8. 検討されたが却下された選択肢

| 選択肢 | 却下理由 |
|--------|---------|
| GUIパネル内スクロールのみ（モーダルなし） | 全体俯瞰困難、D&D範囲限定 |
| 中央パネルにカード表示 | 実装複雑化、Code編集との競合 |
| 右パネル（Preview横）にGUI配置 | Preview視認性低下 |
| ボトムシート方式 | デスクトップ向けとして不適切 |
| フローティングパネル方式 | 配置管理が複雑、ドラッグ操作と競合 |
| Section 6としてアクティブバー管理 | 300px幅では深度グリッド表示困難 |

---

## 更新履歴

| 日時 | 内容 |
|------|------|
| 2025-12-28 15:33 | 初版作成（Session 12議論記録） |
| 2025-12-28 15:50 | v2改訂: タイムスタンプ追加、欠落発言補完、アクティブバー詳細追加、却下選択肢追加 |
| 2025-12-28 16:00 | v3改訂: §6 APIファースト・マイクロモジュール化方針追加、TD-022参照追加、GUI編集レベル定義追加 |
| 2025-12-28 17:30 | v4改訂: §6重複削減（詳細はTD-022参照方式に変更）、時刻修正（16:00頃→16:00）|
