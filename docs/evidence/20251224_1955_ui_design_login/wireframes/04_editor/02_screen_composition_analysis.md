# エディタ画面構成 ベストプラクティス分析

**作成日時**: 2025-12-28 18:00
**最終更新**: 2025-12-29（Session 13 Phase 2 - TD-019/TD-020 v2.0更新）
**対象**: #04 エディタ画面
**分析対象TD**: TD-017〜TD-032（エディタ画面関連）
**重要更新**: TD-019（3層→2層）、TD-020（3レベル→2レベル）のMVP対応完了

---

## 1. 分析目的

TD-017〜TD-032で決定された画面構成がベストプラクティスに適合しているかを評価し、改善点を特定する。

### 1.1 TD一覧（Session 13更新）

| TD | タイトル | セッション | 優先度 |
|:--:|---------|:----------:|:------:|
| TD-017 | GUIパネルの図表タイプ別動的切り替え | 12 | MVP |
| TD-018 | パネル間同期アーキテクチャ | 12 | MVP |
| TD-019 | **2層統合モーダル構造** ⚡v2.0 | 12→**13** | MVP |
| TD-020 | **2レベルGUI編集構造** ⚡v2.0 | 12→**13** | MVP |
| TD-021 | パネルモード切替機構 | 12 | MVP |
| TD-022 | GUIパネル内部構成（シーケンス図） | 12 | MVP |
| TD-023 | エディタ画面基本レイアウト | 12 | MVP |
| **TD-024** | **Undo/Redo機能** | **13** | **MVP** |
| **TD-025** | **WCAG 2.1 AA準拠** | **13** | **MVP** |
| **TD-026** | **オンボーディング機能** | **13** | **MVP** |
| **TD-027** | **編集状態表示** | **13** | **MVP** |
| **TD-028** | **AIコード適用機能** | **13** | **MVP** |
| **TD-029** | **ローカルバックアップ機構** | **13** | **MVP** |
| **TD-030** | **Previewパネルズーム機能** | **13** | **MVP** |
| **TD-031** | **ダークモード対応** | **13** | **MVP** |
| **TD-032** | **AIチャットパネル折りたたみ** | **13** | **MVP** |

---

## 2. 現在の画面構成（TD決定事項ベース）

### 2.1 基本レイアウト（TD-023: エディタ画面基本レイアウト）

> **TD-023**: エディタ画面の基本レイアウト定義。1920×1080を基準解像度とし、3パネル（GUI 300px / Code 650px / Preview 962px）＋ボトムAIチャットで構成。

#### モード1: GUI+Code（デフォルト）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ ヘッダー                                    [GUI+Code] [GUI] [Code] ← 新規 │
├────────┬─────────────┬──────────────────────────────────────────────────────┤
│ GUI    │ Code        │ Preview                                              │
│ Panel  │ Panel       │ Panel                                                │
│ 300px  │ 650px       │ 962px                                                │
│        │ (Monaco)    │ (PlantUML SVG)                                       │
│ 5セク  │             │                                                      │
│ ション │             │                                                      │
├────────┴─────────────┴──────────────────────────────────────────────────────┤
│ AIチャットパネル（ボトム）                                                   │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### モード2: GUIのみ（非コーダー向け）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ ヘッダー                                    [GUI+Code] [GUI] [Code]         │
├────────────────────────────────┬────────────────────────────────────────────┤
│ GUIパネル（拡張）               │ Preview                                    │
│ 950px                          │ 962px                                      │
│                                │                                            │
│ ← Codeは内部で維持（非表示）    │                                            │
├────────────────────────────────┴────────────────────────────────────────────┤
│ AIチャットパネル                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### モード3: Codeのみ（上級者向け）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ ヘッダー                                    [GUI+Code] [GUI] [Code]         │
├────────────────────────────────┬────────────────────────────────────────────┤
│ Codeパネル（拡張）              │ Preview                                    │
│ 950px                          │ 962px                                      │
│ (Monaco Editor)                │                                            │
├────────────────────────────────┴────────────────────────────────────────────┤
│ AIチャットパネル                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 GUIパネル内部構造（TD-019 層1）

```
┌──────────────────────────────┐
│ Section 1: 参加者             │ ← participant管理
├──────────────────────────────┤
│ Section 2: メッセージ表示     │ ← D&D並べ替え可能
│  [シーケンス編集] ボタン      │ → 層2統合モーダルへ ⚡v2.0
├──────────────────────────────┤
│ Section 3: Note追加           │ ← ポップオーバーでNote追加
├──────────────────────────────┤
│ Section 4: フラグメント       │ ← 層2統合モーダル内で編集 ⚡v2.0
│  [フラグメント挿入] ボタン    │
├──────────────────────────────┤
│ Section 5: 補助要素           │ ← 区切り線/遅延/スペース
└──────────────────────────────┘
     300px（モード1）
     950px（モード2）
```

### 2.3 2層統合モーダル構造（TD-019 v2.0）⚡ **Session 13で更新**

> **v1.0（却下）**: 3層構造 → **v2.0（採用）**: 2層統合モーダル

#### 層2: 統合編集モーダル（900×700px）

```
┌─────────────────────────────────────────────────────────────────┐
│ シーケンス編集                                            [×]  │
├─────────────────────────────────────────────────────────────────┤
│ 【参加者管理】                                                  │
│ [Alice] [Bob] [Server] [+追加]                                  │
├─────────────────────────────────────────────────────────────────┤
│ 【メッセージ/ノート一覧】                              [+追加 ▼]│
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ 1. Alice → Bob: リクエスト送信                      [≡][×] │ │
│ │ 2. 📝 note over Alice: 処理開始                     [≡][×] │ │
│ │    └─[展開]────────────────────────────────────────────────┤ │
│ │      │ 種類: [over ▼]  対象: [Alice ▼][+]                 │ │
│ │      │ 内容: [処理開始を記録______]                        │ │
│ │      └─────────────────────────────────────────────────────┤ │
│ │ 3. 🔀 alt [条件: x > 0]                             [≡][×] │ │
│ │    └─[展開]────────────────────────────────────────────────┤ │
│ │      │ 種類: [alt ▼]  条件: [x > 0____]                   │ │
│ │      │ 内包メッセージ:                                     │ │
│ │      │   3-1. Bob → Server: 処理A                  [≡][×] │ │
│ │      │   [+ メッセージ追加]                                │ │
│ │      │ [+ else追加]                                        │ │
│ │      └─────────────────────────────────────────────────────┤ │
│ │ 4. Bob → Alice: レスポンス                          [≡][×] │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│                                          [キャンセル] [適用]   │
└─────────────────────────────────────────────────────────────────┘
```

**v2.0の特徴**:
- **展開式インライン編集**: フラグメント/Noteをモーダル内で展開編集（別モーダル不要）
- **コンテキスト維持**: 全体一覧を見ながら詳細編集可能
- **入れ子モーダルなし**: モーダル疲れを回避

#### 対応フラグメント一覧（v2.0）

| フラグメント | 展開時の編集項目 |
|-------------|-----------------|
| `alt` | 条件式、内包メッセージ、else追加 |
| `opt` | 条件式、内包メッセージ |
| `loop` | ループ条件/回数、内包メッセージ |
| `par` | 並列ブロック追加、各ブロック内メッセージ |
| `break` | 条件式、内包メッセージ |
| `critical` | 内包メッセージ |
| `group` | グループ名、内包メッセージ |

<details>
<summary>v1.0（却下）: 3層モーダル構造</summary>

**層2: メッセージ管理モーダル（900×700px）**
```
┌─────────────────────────────────────────────────────────────────┐
│ メッセージ管理                                            [×]  │
├─────────────────────────────────────────────────────────────────┤
│ 【参加者管理セクション】                                        │
├─────────────────────┬───────────────────────────────────────────┤
│ メッセージ作成      │ 全メッセージ一覧                          │
│ フォーム            │                                           │
│ (350px)             │ ┌─────────────────────────────────────┐   │
│                     │ │ [カード1] Alice→Bob: hello         │   │
│ [フラグメント挿入]  │ │ [カード2] Bob→Alice: hi            │   │
│                     │ │ [カード3] ...                       │   │
│                     │ │         ↕ D&D並べ替え可能           │   │
│                     │ └─────────────────────────────────────┘   │
├─────────────────────┴───────────────────────────────────────────┤
│ 【全体Note（across）管理セクション】                            │
└─────────────────────────────────────────────────────────────────┘
```

**層3: フラグメント編集モーダル（700×600px）**
```
┌───────────────────────────────────────────────────────┐
│ フラグメント編集（alt/opt/loop等）              [×]  │
├───────────────────────────────────────────────────────┤
│ 条件1: [condition text        ]                       │
│ ┌─────────────────────────────────────────────────┐   │
│ │ メッセージ1                                     │   │
│ │ メッセージ2                     ↕ D&D可能       │   │
│ └─────────────────────────────────────────────────┘   │
│ [+ else追加]                                          │
├───────────────────────────────────────────────────────┤
│ 条件2 (else): [else condition   ]                     │
│ ┌─────────────────────────────────────────────────┐   │
│ │ メッセージ3                                     │   │
│ └─────────────────────────────────────────────────┘   │
├───────────────────────────────────────────────────────┤
│ フラグメントNote: [                ]                  │
│                                    [適用] [キャンセル]│
└───────────────────────────────────────────────────────┘
```

**却下理由**: 3層はUXベストプラクティス違反（2層が限界）、認知負荷高、D評価（65点）
</details>

### 2.4 2レベルGUI編集構造（TD-020 v2.0）⚡ **Session 13で更新**

> **v1.0（却下）**: 3レベル構造 → **v2.0（採用）**: 2レベル統一構造

| レベル | 操作 | 対象要素 | UI実装 |
|:------:|------|---------|--------|
| **Level 1** | 直接操作 | 追加/削除/並替 | クリック、D&D、右クリックメニュー |
| **Level 2** | 展開式編集 | 内容/設定変更 | インライン展開、フォーム入力 |

**要素別対応表**:

| 要素 | Level 1（直接操作） | Level 2（展開式編集） |
|------|:------------------:|:--------------------:|
| **参加者** | 追加/削除/並替 | 名前編集 |
| **メッセージ** | 追加/削除/並替 | 内容/矢印種類編集 |
| **Fragment** | 追加/削除/並替 | 種類/条件/内包メッセージ編集 |
| **Note** | 追加/削除/並替 | 種類/対象参加者/内容編集 |
| **補助要素** | 追加/削除/並替 | タイトル/数値編集 |

**Note対応詳細（v2.0追加）**:

| Note種類 | PlantUML構文 | Level 1操作 | Level 2編集項目 |
|---------|-------------|------------|----------------|
| 参加者Note | `note left/right of <参加者>` | 右クリック→追加 | 種類、対象、内容 |
| メッセージNote | `note left/right` | [Note+]ボタン | 位置、内容 |
| 範囲Note | `note over <A>, <B>` | 右クリック→追加 | 対象参加者（複数）、内容 |
| 全体Note | `note across` | [+追加]ボタン | 内容 |
| 六角形Note | `hnote over` | 種類変更で対応 | 形状、対象、内容 |
| 四角形Note | `rnote over` | 種類変更で対応 | 形状、対象、内容 |
| 複数行Note | `note ... end note` | 自動判定 | 内容（複数行対応） |

**v2.0の利点**:
- **操作の一貫性**: 全要素が同じ2レベル操作パターン
- **学習コスト低減**: 直感的な2択のみ
- **混乱回避**: 「なぜ編集できないのか」問題を解消

<details>
<summary>v1.0（却下）: 3レベル構造</summary>

| レベル | 対象構文 | GUIパネルでの表示・操作 |
|:------:|---------|------------------------|
| **1** | message, participant, note, fragment, 補助要素 | フォーム、D&D、モーダル |
| **2** | skinparam, title, header, footer, autonumber | クリック → ポップオーバー → テキスト入力 |
| **3** | !include, !define, !ifdef, box, newpage | 折りたたみ表示 → 展開でコード断片 → 「Codeで編集」リンク |

**却下理由**: 3種類の編集体験は混乱を招く、ユーザー期待との乖離、C評価（75点）
</details>

### 2.5 ヘッダー構成（TD-021）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ [Logo] PlantUML Studio │ ファイル名.puml │ [保存] [エクスポート] ... │ [■■□] │
└─────────────────────────────────────────────────────────────────────────────┘
                                                                      ↑
                                                            パネルモード切替トグル
                                                            [GUI+Code][GUI][Code]
```

**キーボードショートカット**: Ctrl+1, Ctrl+2, Ctrl+3

### 2.6 パネル間同期（TD-018）

```
        0ms（即時）           500ms（デバウンス）
GUIパネル ─────────→ Codeパネル ─────────────────→ Previewパネル
    ↑                    │
    └────────────────────┘
         300ms（デバウンス）
```

**エラー行ハイライト（TD-018 Session 13追加）**:
- Monaco Editorのデコレーション機能でエラー行を視覚的にハイライト
- ガター（行番号横）に赤い●アイコン表示
- ホバーでエラーメッセージ表示

### 2.7 Session 13追加機能

#### 2.7.1 Undo/Redo機能（TD-024）

| 項目 | 仕様 |
|------|------|
| 実装パターン | Command Pattern |
| 履歴保持数 | 最大100件 |
| ショートカット | `Ctrl+Z` / `Ctrl+Shift+Z` |

#### 2.7.2 アクセシビリティ（TD-025）

| カテゴリ | 対応内容 |
|---------|---------|
| 知覚可能 | コントラスト比4.5:1以上（WCAG AA） |
| 操作可能 | 全機能キーボード操作可能 |
| 理解可能 | 一貫したナビゲーション |
| 堅牢 | ARIA属性、セマンティックHTML |

#### 2.7.3 オンボーディング（TD-026）

- 初回ログイン時にステップバイステップツアー表示
- 7ステップ（ホーム→新規図表→エディタ→GUI→Code→Preview→AIチャット）
- スキップ可能、設定から再表示可能

#### 2.7.4 編集状態表示（TD-027）

```
┌─────────────────────────────────────────────────────────────┐
│ [Logo] │ sequence_diagram.puml ● 未保存 │ [保存] [Export] ... │
└─────────────────────────────────────────────────────────────┘
```

| 状態 | アイコン | 色 |
|------|---------|-----|
| 保存済み | ✓ | グレー |
| 未保存 | ● | オレンジ |
| 保存中 | ⟳ | ブルー |
| エラー | ⚠ | レッド |

#### 2.7.5 AIコード適用（TD-028）

```
┌─────────────────────────────────────────────┐
│ 🤖 AI:                                      │
│ ┌─────────────────────────────────────────┐ │
│ │ loop 認証リトライ                       │ │
│ │   User -> Auth: 認証要求                │ │
│ │ end                                     │ │
│ │ [📋 コピー] [▶ 適用] [👁 差分を見る]     │ │
│ └─────────────────────────────────────────┘ │
└─────────────────────────────────────────────┘
```

- 「適用」ボタンでCodeパネルに反映
- 適用前に差分プレビュー表示可能
- Undo可能（TD-024連携）

#### 2.7.6 ローカルバックアップ（TD-029）

| 項目 | 仕様 |
|------|------|
| 保存タイミング | 編集から30秒後（デバウンス） |
| 有効期間 | 7日経過で自動削除 |
| 容量管理 | 図表ごとに最新5件保持 |
| 復元UI | 「復元可能なバックアップがあります」通知 |

#### 2.7.7 Previewズーム（TD-030）

```
┌─────────────────────────────────────┐
│ Preview                    [−][+][Fit][1:1] 150% │
├─────────────────────────────────────┤
│         (SVG表示エリア)              │
└─────────────────────────────────────┘
```

| 操作 | 動作 |
|------|------|
| `Ctrl+ホイール` | ズームイン/アウト |
| `[Fit]` | パネルサイズにフィット |
| `[1:1]` | 100%表示 |
| ドラッグ | パン（位置移動） |

#### 2.7.8 ダークモード（TD-031）

| 要素 | ライトモード | ダークモード |
|------|-------------|-------------|
| 背景（メイン） | `#FFFFFF` | `#1E1E1E` |
| 背景（パネル） | `#F5F5F5` | `#252526` |
| テキスト | `#333333` | `#CCCCCC` |

- ヘッダーにトグルボタン配置
- システム設定（`prefers-color-scheme`）に追従
- localStorage に設定永続化

#### 2.7.9 AIチャット折りたたみ（TD-032）

**展開時**:
```
├───────────┴───────────┴─────────────────────┤
│ AI Chat                              [▼]    │ ← 高さ: 200px
└─────────────────────────────────────────────┘
```

**折りたたみ時**:
```
├───────────┴───────────┴─────────────────────┤
│ AI Chat [▲]                                 │ ← 高さ: 32px（バー表示のみ）
└─────────────────────────────────────────────┘
```

- `Ctrl+Shift+A` で切り替え
- 状態はlocalStorageに永続化

### 2.8 キーボードショートカット一覧（TD-021拡張）

| カテゴリ | ショートカット | 動作 |
|---------|---------------|------|
| パネルモード | `Ctrl+1` | モード1（GUI+Code） |
| パネルモード | `Ctrl+2` | モード2（GUIのみ） |
| パネルモード | `Ctrl+3` | モード3（Codeのみ） |
| 編集操作 | `Ctrl+S` | 保存 |
| 編集操作 | `Ctrl+Z` | Undo |
| 編集操作 | `Ctrl+Shift+Z` | Redo |
| UI操作 | `Ctrl+Shift+A` | AIチャット折りたたみ/展開 |
| プレビュー | `Ctrl+0` | Previewフィット表示 |
| プレビュー | `Ctrl++` | Previewズームイン |
| プレビュー | `Ctrl+-` | Previewズームアウト |
| モーダル | `Esc` | モーダルを閉じる |

---

## 3. 評価フレームワーク

| 観点 | 評価基準 |
|------|---------|
| UXベストプラクティス | 業界標準、認知負荷、操作効率 |
| ターゲットユーザー適合性 | ペルソナ（非コーダー〜上級者） |
| 競合ツール比較 | VS Code, Figma, Mermaid Live Editor等 |
| 技術的実現可能性 | 実装複雑度、パフォーマンス |
| アクセシビリティ | WCAG準拠、キーボード操作 |
| レスポンシブ対応 | 解像度別対応 |

### 採点基準

| スコア | 評価 | 定義 |
|:------:|:----:|------|
| 90-100 | A | ベストプラクティス完全準拠 |
| 80-89 | B | 軽微な改善余地あり |
| 70-79 | C | 中程度の問題あり、要改善 |
| 60-69 | D | 重大な問題あり、必須修正 |
| <60 | F | 設計見直し必要 |

---

## 4. 各要素の詳細評価

### 4.1 3パネルレイアウト（GUI + Code + Preview）

| 評価項目 | スコア | 詳細 |
|---------|:------:|------|
| 関心の分離 | ✅ | 編集（GUI/Code）と出力（Preview）の明確な分離 |
| ユーザースキル対応 | ✅ | 非コーダー（GUI）〜上級者（Code）をカバー |
| スペース効率 | ⚠️ | **300pxのGUIパネルは狭い** |

**競合比較**（※2025年12月時点の公式ドキュメント参照）:

| ツール | レイアウト | 備考 |
|--------|-----------|------|
| VS Code | サイドバー(250-300px) + エディタ + パネル | リサイズ可能 |
| Figma | 左パネル + キャンバス + 右パネル | 左右パネルは折りたたみ可能 |
| Mermaid Live | 2パネル（Code + Preview）| シンプル |
| PlantUML Server | 2パネル（Code + Preview）| シンプル |

**問題点**:
- **300px幅は業界標準の下限**。複雑なGUI操作には不足
- 1920px幅で3パネル＋AIチャットは情報密度が高い

**評価: 85/100**（-15: GUIパネル幅の制約）

---

### 4.2 パネルモード切替（3モード）

| 評価項目 | スコア | 詳細 |
|---------|:------:|------|
| 柔軟性 | ✅ | ユーザータイプ別に最適化可能 |
| 発見可能性 | ⚠️ | トグルボタンが目立たない可能性 |
| 認知負荷 | ⚠️ | モード切替の学習コスト |

**代替案との比較**:

| アプローチ | メリット | デメリット |
|-----------|---------|-----------|
| **固定3モード（現行案）** | シンプル、予測可能 | 柔軟性不足 |
| リサイズ可能パネル | 完全な柔軟性 | 実装複雑、レイアウト崩れリスク |
| 折りたたみ式パネル | 中間的柔軟性 | 状態管理が複雑 |

**評価: 90/100**（-10: 発見可能性の懸念）

---

### 4.3 2層統合モーダル構造 ✅ **Session 13でv2.0に更新**

| 評価項目 | v1.0スコア | v2.0スコア | 詳細 |
|---------|:----------:|:----------:|------|
| 幅制約の解決 | ✅ | ✅ | 300px制約を900pxモーダルで解消 |
| 操作階層 | ❌ | ✅ | **2層に削減、適正範囲** |
| コンテキスト維持 | ❌ | ✅ | 展開式で一覧表示を維持 |
| 戻り操作 | ❌ | ✅ | **展開/折りたたみで完結** |

**v2.0の改善点**:

| 問題 | v1.0（3層） | v2.0（2層） |
|------|-----------|-----------|
| モーダル疲れ | 3層の入れ子 | 入れ子なし、展開式 |
| コンテキスト喪失 | Preview見えず | 一覧を見ながら編集 |
| 操作効率 | 層を行き来 | 展開/折りたたみで完結 |
| 認知負荷 | 高（3階層理解必要） | 低（2層で完結） |

<details>
<summary>v1.0（却下）の評価詳細</summary>

**業界ベストプラクティスとの乖離**:

| パターン | 使用例 | 評価 |
|---------|--------|------|
| **センターモーダル** | 確認ダイアログ、設定 | 1-2層が限界 |
| **スライドオーバー** | Notion, Linear, Figma | コンテキスト維持、推奨 |
| **ドロワー** | Material Design | 部分的なコンテンツ表示 |
| **インプレース編集** | Figma | 最もシームレス |

**v1.0の問題点**:
1. **モーダル疲れ**: 3層のモーダルはユーザーを「閉じ込められた」感覚にさせる
2. **コンテキスト喪失**: メインのPreviewが見えなくなる
3. **操作効率低下**: 層を行き来する操作が多発

**v1.0評価: 65/100**（-35: UXベストプラクティスからの乖離）
</details>

**評価: 85/100**（v1.0: 65点 → v2.0: +20点改善）

---

### 4.4 2レベルGUI編集構造 ✅ **Session 13でv2.0に更新**

| 評価項目 | v1.0スコア | v2.0スコア | 詳細 |
|---------|:----------:|:----------:|------|
| 技術的合理性 | ✅ | ✅ | 構文カテゴリに応じた分類 |
| 一貫性 | ❌ | ✅ | **全要素で統一パターン** |
| 学習コスト | ⚠️ | ✅ | **直感的な2択のみ** |

**v2.0の改善点**:

```
v1.0のユーザー視点:
「なぜLevel 3は編集できないの？」

v2.0のユーザー視点:
「追加/削除はクリック、詳細編集は展開」← 統一パターン
```

| 操作 | v1.0（3レベル） | v2.0（2レベル） |
|------|----------------|----------------|
| 追加/削除 | Level 1のみ | **全要素でLevel 1** |
| 詳細編集 | Level 1: フォーム、Level 2: ポップオーバー、Level 3: 不可 | **全要素でLevel 2（展開式）** |

<details>
<summary>v1.0（却下）の評価詳細</summary>

**ユーザー視点の問題**:
```
ユーザーの期待:
「GUIで全部編集できるはず」

現実:
- Level 1: フォーム編集 ✓
- Level 2: ポップオーバー編集 △（異なるUX）
- Level 3: 編集不可、Codeへ誘導 ✗（期待はずれ）
```

**v1.0評価: 75/100**（-25: 一貫性の欠如）
</details>

**評価: 85/100**（v1.0: 75点 → v2.0: +10点改善）

---

### 4.5 パネル間同期（TD-018）

| 評価項目 | スコア | 詳細 |
|---------|:------:|------|
| アーキテクチャ | ✅ | Codeを正のソースとする設計は堅牢 |
| タイミング定義 | ✅ | 0ms/300ms/500msは業界標準 |
| 体感遅延 | ⚠️ | 300ms遅延は知覚可能 |

**評価: 95/100**（-5: 遅延の知覚可能性）

---

### 4.6 AIチャットパネル（ボトム）✅ **Session 13で解決**

| 評価項目 | スコア | 詳細 |
|---------|:------:|------|
| アクセス性 | ✅ | 常時表示で即座にアクセス可能 |
| スペース効率 | ✅ | **TD-032で折りたたみ機能追加済み** |
| 配置 | ✅ | ボトム配置はチャットUIの標準 |
| AIコード適用 | ✅ | **TD-028で「適用」ボタン + 差分プレビュー定義済み** |

**Session 13で解決済み**:
- ~~固定表示は編集スペースを圧迫~~ → TD-032で折りたたみ可能に
- ~~使用頻度が低い場合、無駄なスペース消費~~ → 折りたたみ時は32pxのみ

**評価: 95/100**（+15: 折りたたみ機能追加、AIコード適用機能追加）

---

### 4.7 レスポンシブ対応 ✅ **TD-023で定義済み**

| ブレークポイント | レイアウト | パネル幅 |
|-----------------|-----------|---------|
| ≥1920px | 3パネル | GUI 300px + Code 650px + Preview 962px |
| 1440-1919px | 3パネル（縮小）| GUI 250px + Code 500px + Preview 自動 |
| 1280-1439px | 2パネル | Code + Preview（GUI非表示推奨）|
| <1280px | 1パネル or タブ切替 | 単一パネル表示 |

**TD-023で定義済み**:
- 4ブレークポイントで段階的にレイアウト調整
- 小画面ではパネルモード2/3を推奨

**評価: 90/100**（+40: TD-023でレスポンシブ定義追加）

---

### 4.8 アクセシビリティ ✅ **TD-025で定義済み**

| 要件 | 現状 | TD参照 |
|------|------|--------|
| キーボードショートカット | ✅ 11種定義 | TD-021拡張 |
| フォーカス管理 | ✅ モーダル内フォーカストラップ定義 | TD-025 |
| スクリーンリーダー | ✅ ARIA属性、セマンティックHTML | TD-025 |
| 色コントラスト | ✅ WCAG AA 4.5:1以上 | TD-025, TD-031 |
| キーボードナビゲーション | ✅ Tab/Shift+Tab/Enter/Esc | TD-025 |

**TD-025で定義済み**:
- WCAG 2.1 AAレベル準拠
- 知覚可能・操作可能・理解可能・堅牢の4原則対応
- ダークモード対応（TD-031）でコントラスト比を両テーマで確保

**評価: 90/100**（+50: TD-025でアクセシビリティ定義追加）

---

### 4.9 データ安全性（Session 13追加）

| 評価項目 | スコア | TD参照 | 詳細 |
|---------|:------:|:------:|------|
| Undo/Redo | ✅ | TD-024 | Command Pattern、100件履歴 |
| 編集状態表示 | ✅ | TD-027 | 未保存/保存中/エラー状態の可視化 |
| ローカルバックアップ | ✅ | TD-029 | 30秒デバウンス、7日保持 |
| 離脱防止 | ✅ | TD-027 | `beforeunload`イベントで警告 |

**評価: 95/100**（データ喪失リスクを最小化する包括的な設計）

---

### 4.10 Previewパネル操作性（Session 13追加）

| 評価項目 | スコア | TD参照 | 詳細 |
|---------|:------:|:------:|------|
| ズーム機能 | ✅ | TD-030 | 25%〜400%、ボタン+ホイール対応 |
| フィット表示 | ✅ | TD-030 | ワンクリックでパネルサイズに調整 |
| パン操作 | ✅ | TD-030 | ドラッグで位置移動 |
| ズーム値表示 | ✅ | TD-030 | 現在のズーム率を数値表示 |

**評価: 95/100**（大規模図表の確認に必要な機能を網羅）

---

### 4.11 視覚的カスタマイズ（Session 13追加）

| 評価項目 | スコア | TD参照 | 詳細 |
|---------|:------:|:------:|------|
| ダークモード | ✅ | TD-031 | ライト/ダーク切替 |
| システム設定追従 | ✅ | TD-031 | `prefers-color-scheme`対応 |
| カラーパレット定義 | ✅ | TD-031 | 6色定義（背景/テキスト/アクセント等）|
| Monaco Editor連携 | ✅ | TD-031 | `vs`/`vs-dark`テーマ切替 |

**評価: 95/100**（長時間作業の目の疲労を軽減する設計）

---

### 4.12 ユーザー導入支援（Session 13追加）

| 評価項目 | スコア | TD参照 | 詳細 |
|---------|:------:|:------:|------|
| オンボーディング | ✅ | TD-026 | 7ステップツアー |
| スキップ機能 | ✅ | TD-026 | 即座にスキップ可能 |
| 再表示機能 | ✅ | TD-026 | 設定から再開可能 |
| 進捗保存 | ✅ | TD-026 | Supabase保存（デバイス間同期）|

**評価: 90/100**（初回ユーザーの学習曲線を緩和）

---

### 4.13 エラーフィードバック（Session 13追加）

| 評価項目 | スコア | TD参照 | 詳細 |
|---------|:------:|:------:|------|
| エラー行ハイライト | ✅ | TD-018追加 | Monaco Editorデコレーション |
| ガターマーカー | ✅ | TD-018追加 | 行番号横に赤●アイコン |
| ホバーメッセージ | ✅ | TD-018追加 | エラー内容をツールチップ表示 |
| 複数エラー対応 | ✅ | TD-018追加 | すべてのエラー行を同時表示 |

**評価: 95/100**（構文エラーの即座の認識と修正を支援）

---

## 5. 総合評価

### 5.1 Session 12→13項目（v2.0更新後）

| 項目 | Session 12 | Session 13 Phase 1 | Session 13 Phase 2 | 評価 |
|------|:----------:|:------------------:|:------------------:|:----:|
| 3パネルレイアウト | 85 | 85 | 85 | B |
| パネルモード切替 | 90 | 90 | 90 | A |
| **モーダル構造** | 65 (3層) | 65 (3層) | **85 (2層v2.0)** | **B** ⬆️ |
| **GUI編集レベル** | 75 (3レベル) | 75 (3レベル) | **85 (2レベルv2.0)** | **B** ⬆️ |
| パネル間同期 | 95 | 95 | 95 | A |
| AIチャットパネル | 80 | **95** | 95 | A |
| レスポンシブ対応 | 50 | **90** | 90 | A |
| アクセシビリティ | 40 | **90** | 90 | A |

### 5.2 Session 13追加項目

| 項目 | スコア | 評価 | TD |
|------|:------:|:----:|:--:|
| データ安全性 | 95 | A | TD-024,027,029 |
| Previewパネル操作性 | 95 | A | TD-030 |
| 視覚的カスタマイズ | 95 | A | TD-031 |
| ユーザー導入支援 | 90 | A | TD-026 |
| エラーフィードバック | 95 | A | TD-018追加 |

### 5.3 総合スコア

**総合スコア: 90.38/100（単純平均、評価A）** ⚡ **v2.0更新で達成**

> 計算方法: (85+90+85+85+95+95+90+90+95+95+95+90+95) / 13 = 1175 / 13 = 90.38

### 5.4 スコア改善サマリー

| 指標 | Session 12 | Session 13 Phase 1 | Session 13 Phase 2 | 改善 |
|------|:----------:|:------------------:|:------------------:|:----:|
| 総合スコア | 72.5 | 88.85 | **90.38** | **+17.88** |
| 評価 | C | B | **A** | **↑2ランク** |
| D/F評価項目数 | 2 | 2 | **0** | **-2** |
| A評価項目数 | 2 | 9 | **11** | **+9** |

**Phase 2での改善**:
| 項目 | Phase 1 | Phase 2 | 改善点 |
|------|:-------:|:-------:|--------|
| モーダル構造 | 65 (D) | 85 (B) | +20（3層→2層） |
| GUI編集レベル | 75 (C) | 85 (B) | +10（3レベル→2レベル） |

---

## 6. 問題点の解決状況（Session 13 Phase 2更新）

### 6.1 Session 13 Phase 1で解決済み ✅

| 旧問題 | 解決TD | 対応内容 |
|--------|:------:|---------|
| レスポンシブ対応の欠如 | TD-023 | 4ブレークポイント定義済み |
| アクセシビリティの欠如 | TD-025 | WCAG 2.1 AA準拠定義済み |
| AIチャット固定 | TD-032 | 折りたたみ機能追加済み |
| モード切替発見性 | TD-026 | オンボーディング追加済み |

### 6.2 Session 13 Phase 2で解決済み ✅ ⚡ **新規追加**

| 旧問題 | 解決TD | 対応内容 |
|--------|:------:|---------|
| **3層モーダル構造** | TD-019 v2.0 | **2層統合モーダル + 展開式インライン編集** |
| **3レベルGUI編集** | TD-020 v2.0 | **2レベル統一構造（直接操作 + 展開式編集）** |

#### 6.2.1 問題1解決: 3層→2層モーダル構造

**Before（v1.0）**:
```
層1（GUIパネル）→ 層2（メッセージ管理モーダル）→ 層3（フラグメント編集モーダル）
```

**After（v2.0）**:
```
層1（GUIパネル）→ 層2（統合編集モーダル）
                    └─ インライン展開で詳細編集（別モーダル不要）
```

**解決のポイント**:
1. **展開式インライン編集**: フラグメント/Noteをモーダル内で展開（層3を廃止）
2. **コンテキスト維持**: 一覧表示を維持しながら詳細編集
3. **操作効率向上**: 展開/折りたたみで完結、モーダル遷移なし

**評価改善**: 65点（D）→ 85点（B）= **+20点**

#### 6.2.2 問題2解決: 3レベル→2レベルGUI編集

**Before（v1.0）**:
| レベル | 操作 | 問題 |
|:------:|------|------|
| Level 1 | フォーム編集 | OK |
| Level 2 | ポップオーバー | 異なるUX |
| Level 3 | 編集不可→Code誘導 | 期待はずれ |

**After（v2.0）**:
| レベル | 操作 | 統一パターン |
|:------:|------|-------------|
| Level 1 | 追加/削除/並替 | 全要素共通 |
| Level 2 | 展開式編集 | 全要素共通 |

**解決のポイント**:
1. **操作の統一**: 全要素が同じ2レベル操作パターン
2. **学習コスト低減**: 「直接操作 or 展開」の2択のみ
3. **期待との一致**: 「なぜ編集できないのか」問題を解消

**評価改善**: 75点（C）→ 85点（B）= **+10点**

### 6.3 残存する問題点

**なし** ✅

Session 13 Phase 2で全ての重大問題（D/C評価）を解決。
全項目がB評価以上となり、総合スコアがA評価（90.38点）に到達。

---

## 7. 将来検討アクション（v2以降）

> **注記**: Session 13 Phase 2で全ての重大問題を解決。残りは優先度を下げて検討。

### 優先度: 高

**なし** ✅ - Session 13 Phase 2で全て解決済み

### 優先度: 中

| # | 課題 | 検討アクション | 対象TD | 現評価 |
|:-:|------|---------------|--------|:------:|
| 1 | GUIパネル300px | 最小幅を350pxに拡大 | TD-023 | B (85) |
| 2 | スライドオーバー方式 | 将来的により洗練されたUI検討 | TD-019 | B (85) |

### 優先度: 低（Session 13で解決済みの関連項目）

| # | 課題 | 状況 | 対象TD |
|:-:|------|------|--------|
| ~~1~~ | ~~3層モーダル~~ | ✅ 解決済み（v2.0: 2層統合） | TD-019 |
| ~~2~~ | ~~GUI編集レベル混乱~~ | ✅ 解決済み（v2.0: 2レベル統一） | TD-020 |
| ~~3~~ | ~~レスポンシブ未定義~~ | ✅ 解決済み | TD-023 |
| ~~4~~ | ~~アクセシビリティ未定義~~ | ✅ 解決済み | TD-025 |
| ~~5~~ | ~~AIチャット固定~~ | ✅ 解決済み | TD-032 |
| ~~6~~ | ~~モード切替発見性~~ | ✅ 解決済み | TD-026 |
| 7 | 固定モードの制約 | v3検討 | TD-023 |

---

## 8. 改善後の画面構成案（参考）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ ヘッダー                              [GUI+Code] [GUI] [Code]  [?] [設定]  │
├────────┬─────────────┬──────────────────────────────────────────────────────┤
│ GUI    │ Code        │ Preview                                              │
│ Panel  │ Panel       │ Panel                                                │
│ 350px  │ 600px       │ 962px                                                │
│        │ (Monaco)    │                                                      │
│ 5セク  │             │ ┌────────────────────────┐                           │
│ ション │             │ │ スライドオーバー       │ ← 層2相当               │
│        │             │ │ [メッセージ][フラグ]   │   タブで切替            │
│ [編集] │             │ │                        │   Previewは見える       │
│   ↓    │             │ └────────────────────────┘                           │
├────────┴─────────────┴──────────────────────────────────────────────────────┤
│ [▼] AIチャット（折りたたみ可能）                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**変更点**:
1. GUIパネル: 300px → 350px
2. 3層モーダル → スライドオーバー（Preview上に重ねる、1層に削減）
3. フラグメント編集はスライドオーバー内のタブで対応
4. AIチャットは折りたたみ可能

---

## 9. 結論

**Session 13 Phase 2で全問題解決。A評価（90.38点）達成。**

| 評価 | Session 12 | Session 13 Phase 1 | Session 13 Phase 2 |
|------|:----------:|:------------------:|:------------------:|
| **総合スコア** | 72.5/100 (C) | 88.85/100 (B) | **90.38/100 (A)** ⚡ |
| **A評価項目数** | 2 | 9 | **11** |
| **D/F評価項目数** | 2 | 2 | **0** ⚡ |
| **残存問題** | 5件 | 2件 | **0件** ⚡ |

### Session 13 Phase 1での改善点

| 改善内容 | 対応TD |
|---------|--------|
| アクセシビリティ定義 | TD-025 |
| レスポンシブ定義 | TD-023 |
| AIチャット折りたたみ | TD-032 |
| オンボーディング | TD-026 |
| Undo/Redo | TD-024 |
| 編集状態表示 | TD-027 |
| ローカルバックアップ | TD-029 |
| Previewズーム | TD-030 |
| ダークモード | TD-031 |
| AIコード適用 | TD-028 |
| エラー行ハイライト | TD-018追加 |
| キーボードショートカット拡張 | TD-021拡張 |

### Session 13 Phase 2での改善点 ⚡ **新規追加**

| 改善内容 | 対応TD | スコア改善 |
|---------|--------|:---------:|
| **3層→2層モーダル** | TD-019 v2.0 | 65→85 (+20) |
| **3レベル→2レベルGUI編集** | TD-020 v2.0 | 75→85 (+10) |
| **Note対応詳細定義** | TD-020 v2.0 | - |
| **group フラグメント対応** | TD-019 v2.0 | - |

---

## 10. 次のアクション

### 現行構成でMVP進行 ✅ **採用済み・完了**

| 項目 | Session 12 | Session 13 Phase 1 | Session 13 Phase 2 |
|------|-----------|-------------------|-------------------|
| **スコア** | 72.5/100 (C) | 88.85/100 (B) | **90.38/100 (A)** ⚡ |
| **TD範囲** | TD-017〜TD-023 | TD-017〜TD-032 | **同左（v2.0更新）** |
| **残存問題** | 5件 | 2件 | **0件** ⚡ |
| **次のアクション** | 問題解決待ち | 問題解決待ち | **ワイヤーフレーム作成開始** |

### ワイヤーフレーム作成準備完了 ✅

| 準備項目 | 状況 |
|---------|:----:|
| TD-017〜TD-032定義 | ✅ |
| 3層→2層モーダル解決 | ✅ |
| 3レベル→2レベルGUI解決 | ✅ |
| Note対応定義 | ✅ |
| groupフラグメント対応 | ✅ |
| 評価A達成（90点以上） | ✅ |

---

**決定履歴**:
- 2025-12-28 Session 12: 選択肢A採用（3層モーダル維持）、72.5点(C)
- 2025-12-29 Session 13 Phase 1: TD-024〜TD-032追加、88.85点(B)
- 2025-12-29 Session 13 Phase 2: TD-019/TD-020 v2.0更新、**90.38点(A)達成** ⚡

---

## 更新履歴

| 日時 | バージョン | 内容 |
|------|:----------:|------|
| 2025-12-29 | **v3.0** | **Session 13 Phase 2対応**: TD-019/TD-020をv2.0に更新（3層→2層、3レベル→2レベル）、総合スコア88.85→90.38に改善（A評価達成）、全残存問題解決、Note対応詳細追加、groupフラグメント対応追加、Section 11（議論経緯）追加 |
| 2025-12-29 | v2.0 | **Session 13 Phase 1対応**: TD-017〜TD-032に範囲拡張、評価項目13項目に拡大（+5）、総合スコア72.5→88.85に改善、Section 2.7追加（Session 13機能）、Section 4.9-4.13追加（新評価）、Section 5再計算、Section 6-7解決状況更新 |
| 2025-12-28 22:00 | v1.1 | 9問題対応完了 - TD-017〜TD-023に統一、採点基準追加、加重列削除・単純平均明記、TD-023説明追加、将来検討事項化、選択肢A/B/C詳細化、レスポンシブ根拠追加、選択肢A採用決定 |
| 2025-12-28 18:00 | v1.0 | 初版作成（Session 12 ベストプラクティス分析）|

---

## 11. 議論の経緯（Session 13 Phase 2）

### 11.1 問題認識

Session 13 Phase 1の評価結果（88.85点、B評価）において、以下2件がD/C評価として残存していた：

| 問題 | 評価 | 課題内容 |
|------|:----:|---------|
| TD-019（3層モーダル構造） | D (65点) | 認知負荷高、モーダル入れ子、操作効率低下 |
| TD-020（3レベルGUI編集） | C (75点) | 操作パターン不統一、学習コスト高 |

ユーザーから「残存問題（2件）はMVPで対応するため、今解決する必要があります」との指示があり、Phase 2として解決策を検討した。

### 11.2 TD-019の解決策検討

**問題の本質**:
- 3層（GUIパネル → メッセージ管理モーダル → フラグメント編集モーダル）は深すぎる
- UXベストプラクティスでは**2層が限界**
- モーダル入れ子によるコンテキスト喪失

**検討した選択肢**:

| 案 | 概要 | 評価 |
|:--:|------|:----:|
| A | 3層維持（現状） | D (65点) |
| B | タブ統合モーダル | B見込み |
| C | スライドオーバー | B見込み |
| D | インプレース編集 | 複雑すぎ |
| **E** | **2層統合モーダル（展開式フラグメント編集）** | **採用** |

**案E採用理由**:
1. **層3を展開式に統合**: フラグメント編集を層2内のインライン展開で対応
2. **実装シンプル**: 既存のモーダル構造を活かせる
3. **コンテキスト維持**: 一覧を見ながら詳細編集可能
4. **操作一貫性**: 全要素が同じ「展開→編集」パターン

### 11.3 TD-020の解決策検討

**問題の本質**:
- 3レベル（完全GUI / ポップオーバー / 読取専用）で操作が不統一
- 「なぜLevel 3は編集できないのか」というユーザー混乱

**検討した選択肢**:

| 案 | 概要 | 評価 |
|:--:|------|:----:|
| A | 3レベル維持 | C (75点) |
| B | 視覚的インジケータ追加 | C見込み |
| C | Level 3をポップオーバー化 | やや複雑 |
| **D** | **2レベル簡素化（直接操作 + 展開式編集）** | **採用** |

**案D採用理由**:
1. **全要素で統一パターン**: Level 1（直接操作）とLevel 2（展開式編集）の2択
2. **学習コスト低**: 「追加/削除はクリック、詳細編集は展開」という直感的ルール
3. **期待との一致**: 全要素がGUIで編集可能

### 11.4 groupフラグメントの対応確認

ユーザー質問: 「groupはLevel1で対応できるの？」

**回答**: YES。`group`は他のフラグメント（alt, opt, loop等）と構造的に同じ。
- Level 1: 追加/削除/並替（D&D）
- Level 2: グループ名編集、内包メッセージ編集

### 11.5 Note対応の詳細定義

ユーザー質問: 「noteへの対応は？」

**回答**: 全Note種類を2レベル構造で対応。

| Note種類 | Level 1 | Level 2 |
|---------|---------|---------|
| `note left/right of` | 右クリック→追加 | 種類、対象、内容編集 |
| `note left/right` | [Note+]ボタン | 位置、内容編集 |
| `note over A, B` | 右クリック→追加 | 対象参加者（複数選択）、内容編集 |
| `note across` | [+追加]ボタン | 内容編集 |
| `hnote`/`rnote` | 種類変更で対応 | 形状、対象、内容編集 |

**統合編集モーダル内での表示**:
- 📝 アイコンでNoteを識別
- メッセージ/フラグメントと同列に表示
- 展開式で詳細編集（種類ドロップダウン、対象参加者選択、内容テキストエリア）

### 11.6 決定事項

| 決定 | 内容 | 反映先 |
|------|------|--------|
| TD-019 v2.0 | 3層→2層統合モーダル + 展開式インライン編集 | `technical_decisions.md` |
| TD-020 v2.0 | 3レベル→2レベル統一構造（直接操作 + 展開式編集） | `technical_decisions.md` |
| group対応 | Level 1/2で他フラグメントと同様に対応 | TD-019 v2.0 |
| Note対応 | 全Note種類をLevel 1/2で統一対応 | TD-020 v2.0 |

### 11.7 評価改善

| 項目 | Before | After | 改善 |
|------|:------:|:-----:|:----:|
| TD-019 | 65点 (D) | 85点 (B) | +20 |
| TD-020 | 75点 (C) | 85点 (B) | +10 |
| **総合** | 88.85点 (B) | **90.38点 (A)** | **+1.53** |
| **残存問題** | 2件 | **0件** | **-2** |

### 11.8 関連ドキュメント更新

| ドキュメント | 更新内容 |
|-------------|---------|
| `technical_decisions.md` | TD-019 v2.0、TD-020 v2.0追加 |
| `02_screen_composition_analysis.md` | 本ドキュメント全面更新（v3.0） |

---

*End of Document*
