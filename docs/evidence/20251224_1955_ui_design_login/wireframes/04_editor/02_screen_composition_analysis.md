# エディタ画面構成 ベストプラクティス分析 v9.0

**作成日時**: 2025-12-28 18:00
**最終更新**: 2025-12-29（v9.0 - 品質監査対応版）
**対象**: #04 エディタ画面
**分析対象TD**: TD-017〜TD-033（エディタ画面関連）
**重要更新**: **5機能をv1.1延期** - TD-024, 025, 026, 029, 031（TD-017, 028はMVP復帰）

---

## 目次

1. [分析目的](#1-分析目的)
2. [現在の画面構成](#2-現在の画面構成td決定事項ベース)
3. [評価フレームワーク](#3-評価フレームワーク)
4. [各要素の詳細評価](#4-各要素の詳細評価)
5. [総合評価](#5-総合評価)
6. [問題解決状況](#6-問題解決状況)
7. [将来アクション](#7-将来アクション)
8. [トレーサビリティマトリクス](#8-トレーサビリティマトリクス) ⚡新規
9. [型定義一覧（完全版）](#9-型定義一覧完全版) ⚡新規
10. [統合決定事項一覧](#10-統合決定事項一覧) ⚡統合
11. [TD-028 AIコード適用機能 詳細設計](#11-td-028-aiコード適用機能-詳細設計)
12. [更新履歴](#12-更新履歴)

**付録**
- [付録A: 議論の経緯（詳細記録）](#付録a-議論の経緯詳細記録) ⚡新規
  - [A.1 Session 13 Phase 2: TD-019/TD-020 改善](#a1-session-13-phase-2-td-019td-020-改善)
  - [A.2 Session 13 Phase 6: TD-028 AIコード適用機能](#a2-session-13-phase-6-td-028-aiコード適用機能)
  - [A.3 Session 13 Phase 7: エラー修正機能](#a3-session-13-phase-7-エラー修正機能)
  - [A.4 Session 13 Phase 8: 階層的憲法システム](#a4-session-13-phase-8-階層的憲法システム)
  - [A.5 品質監査対応（Session 13 Phase 9）](#a5-品質監査対応session-13-phase-9)
  - [A.6 関連ドキュメント](#a6-関連ドキュメント)

---

## 1. 分析目的

TD-017〜TD-033で決定された画面構成がベストプラクティスに適合しているかを評価し、改善点を特定する。

### 1.1 TD一覧（Session 13 Phase 4更新）

| TD | タイトル | セッション | 優先度 |
|:--:|---------|:----------:|:------:|
| **TD-017** | GUIパネルの図表タイプ別動的切り替え | 12 | **MVP** ⚡復帰 |
| TD-018 | パネル間同期アーキテクチャ | 12 | MVP |
| TD-019 | **2層統合モーダル構造** ⚡v2.1（セクション折りたたみ追加） | 12→**13** | MVP |
| TD-020 | **2レベルGUI編集構造** ⚡v2.0 | 12→**13** | MVP |
| TD-021 | パネルモード切替機構 | 12 | MVP |
| TD-022 | GUIパネル内部構成（シーケンス図） | 12 | MVP |
| TD-023 | エディタ画面基本レイアウト | 12 | MVP |
| **TD-024** | **Undo/Redo機能** | **13** | **⏸️ v1.1延期** |
| **TD-025** | **WCAG 2.1 AA準拠** | **13** | **⏸️ v1.1延期** |
| **TD-026** | **オンボーディング機能** | **13** | **⏸️ v1.1延期** |
| **TD-027** | **編集状態表示** | **13** | MVP |
| **TD-028** | **AIコード適用機能** | **13** | **MVP** ⚡復帰 |
| **TD-029** | **ローカルバックアップ機構** ⚡v1.1（復元UI詳細追加） | **13** | **⏸️ v1.1延期** |
| **TD-030** | **Previewパネルズーム機能** | **13** | MVP |
| **TD-031** | **ダークモード対応** | **13** | **⏸️ v1.1延期** |
| **TD-032** | **AIチャットパネル折りたたみ** | **13** | MVP |
| **TD-033** | **キーボードショートカットヘルプ** ⚡新規 | **13** | MVP |

### 1.2 MVP延期機能一覧（5機能）

> **決定日**: 2025-12-29
> **評価基準**: 技術実現性、実装複雑度、リスク、MVP適合性、仕様完成度（各20点、計100点）
> **Phase 5更新**: TD-017, TD-028をMVP復帰（12機能に拡大）

| TD | 機能名 | スコア | 評価 | 延期理由 | 代替対応 |
|:--:|--------|:------:|:----:|----------|----------|
| **024** | Undo/Redo | 60 | D | GUI/Code/AIの統一履歴管理が困難 | MVP: ブラウザ標準Undo（Monaco内）、v1.1: 統合実装 |
| **025** | WCAG準拠 | 61 | D | 78基準全対応は過剰（AA準拠の最小実装で十分） | MVP: 基本キーボード操作、v1.1: 監査ツール対応 |
| **026** | オンボーディング | 70 | C | UIが安定する前のガイドは修正コスト高 | MVP: ヘルプページ、v1.1: インタラクティブツアー |
| **029** | ローカルバックアップ | 75 | C | Supabase保存が正式手段、ローカルは補助的 | MVP: Supabase自動保存、v1.1: ローカルキャッシュ |
| **031** | ダークモード | 68 | D | PlantUML SVGのテーマ問題（skinparamとの整合性）未解決 | MVP: ライトモード固定、v1.1: テーマ対応 |

**スコア凡例**:
| スコア | 評価 | 判定 |
|:------:|:----:|------|
| 90-100 | A | MVP必須 |
| 80-89 | B | MVP推奨 |
| 70-79 | C | MVP任意（延期可） |
| 60-69 | D | v1.1延期推奨 |
| <60 | F | v1.1延期必須 |

### 1.3 MVP実装機能一覧（12機能）

| TD | 機能名 | スコア | 評価 | MVP必須理由 |
|:--:|--------|:------:|:----:|-------------|
| **017** | **GUI動的切り替え** | **80** | **B** | **Registry Patternで実現可能、拡張性確保** ⚡復帰 |
| 018 | パネル間同期 | 88 | B | 3パネル構成の基盤、リアルタイムプレビュー必須 |
| 019 | 2層統合モーダル | 85 | B | GUI編集のコア機能 |
| 020 | 2レベルGUI編集 | 83 | B | 操作一貫性の基盤 |
| 021 | パネルモード切替 | 85 | B | ユーザータイプ対応の基本機能 |
| 022 | GUIパネル内部構成 | 80 | B | シーケンス図GUI編集の基盤 |
| 023 | 基本レイアウト | 90 | A | エディタ画面の根幹 |
| 027 | 編集状態表示 | 82 | B | データ喪失防止の最小対策 |
| **028** | **AIコード適用** | **80** | **B** | **Monaco API整備済み、AI機能の中核** ⚡復帰 |
| 030 | Previewズーム | 78 | C | 大規模図表確認に必要 |
| 032 | AIチャット折りたたみ | 80 | B | 画面スペース確保 |
| 033 | ショートカットヘルプ | 85 | B | 学習支援の最小対策 |

---

## 2. 現在の画面構成（TD決定事項ベース）

### 2.1 基本レイアウト（TD-023: エディタ画面基本レイアウト）

> **TD-023**: エディタ画面の基本レイアウト定義。1920×1080を基準解像度とし、3パネル（GUI 300px / Code 650px / Preview 962px）＋ボトムAIチャットで構成。

#### モード1: GUI+Code（デフォルト）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ ヘッダー                                    [GUI+Code] [GUI] [Code] ← 新規 │
├────────┬─────────────┬──────────────────────────────────────────────────────┤
│ GUI    │ Code        │ Preview                                              │
│ Panel  │ Panel       │ Panel                                                │
│ 300px  │ 650px       │ 962px                                                │
│        │ (Monaco)    │ (PlantUML SVG)                                       │
│ 5セク  │             │                                                      │
│ ション │             │                                                      │
├────────┴─────────────┴──────────────────────────────────────────────────────┤
│ AIチャットパネル（ボトム）                                                   │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### モード2: GUIのみ（非コーダー向け）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ ヘッダー                                    [GUI+Code] [GUI] [Code]         │
├────────────────────────────────┬────────────────────────────────────────────┤
│ GUIパネル（拡張）               │ Preview                                    │
│ 950px                          │ 962px                                      │
│                                │                                            │
│ ← Codeは内部で維持（非表示）    │                                            │
├────────────────────────────────┴────────────────────────────────────────────┤
│ AIチャットパネル                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### モード3: Codeのみ（上級者向け）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ ヘッダー                                    [GUI+Code] [GUI] [Code]         │
├────────────────────────────────┬────────────────────────────────────────────┤
│ Codeパネル（拡張）              │ Preview                                    │
│ 950px                          │ 962px                                      │
│ (Monaco Editor)                │                                            │
├────────────────────────────────┴────────────────────────────────────────────┤
│ AIチャットパネル                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 GUIパネル内部構造（TD-019 層1）⚡ **v2.1更新**

> **v2.1更新（2025-12-29）**: 5セクション構成の折りたたみ式アコーディオン設計

| セクション | デフォルト状態 | 使用頻度 |
|-----------|:------------:|:--------:|
| 1. 参加者 | **展開** | 高 |
| 2. メッセージ表示 | **展開** | 高 |
| 3. Note追加 | 折りたたみ | 中 |
| 4. フラグメント | 折りたたみ | 中 |
| 5. 補助要素 | 折りたたみ | 低 |

```
┌──────────────────────────────┐
│ ▼ Section 1: 参加者          │ ← デフォルト展開
│ ┌──────────────────────────┐ │
│ │ [Alice] [Bob] [+追加]    │ │
│ └──────────────────────────┘ │
├──────────────────────────────┤
│ ▼ Section 2: メッセージ表示  │ ← デフォルト展開
│ ┌──────────────────────────┐ │
│ │ 1. Alice→Bob: hello      │ │
│ │ 2. Bob→Alice: hi         │ │
│ │ [シーケンス編集を開く]    │ │ → 層2統合モーダルへ
│ └──────────────────────────┘ │
├──────────────────────────────┤
│ ▶ Section 3: Note追加        │ ← クリックで展開
├──────────────────────────────┤
│ ▶ Section 4: フラグメント    │ ← クリックで展開
├──────────────────────────────┤
│ ▶ Section 5: 補助要素        │ ← クリックで展開
└──────────────────────────────┘
     300px（モード1）
     950px（モード2）
```

**設計根拠**:
- **視認性向上**: 折りたたみにより300pxでも主要セクションが見やすい
- **操作効率**: 高頻度セクション（1, 2）はデフォルト展開
- **段階的開示**: 低頻度機能は必要時のみ展開

### 2.3 2層統合モーダル構造（TD-019 v2.0）⚡ **Session 13で更新**

> **v1.0（却下）**: 3層構造 → **v2.0（採用）**: 2層統合モーダル

#### 層2: 統合編集モーダル（900×700px）

```
┌─────────────────────────────────────────────────────────────────┐
│ シーケンス編集                                            [×]  │
├─────────────────────────────────────────────────────────────────┤
│ 【参加者管理】                                                  │
│ [Alice] [Bob] [Server] [+追加]                                  │
├─────────────────────────────────────────────────────────────────┤
│ 【メッセージ/ノート一覧】                              [+追加 ▼]│
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ 1. Alice → Bob: リクエスト送信                      [≡][×] │ │
│ │ 2. 📝 note over Alice: 処理開始                     [≡][×] │ │
│ │    └─[展開]────────────────────────────────────────────────┤ │
│ │      │ 種類: [over ▼]  対象: [Alice ▼][+]                 │ │
│ │      │ 内容: [処理開始を記録______]                        │ │
│ │      └─────────────────────────────────────────────────────┤ │
│ │ 3. 🔀 alt [条件: x > 0]                             [≡][×] │ │
│ │    └─[展開]────────────────────────────────────────────────┤ │
│ │      │ 種類: [alt ▼]  条件: [x > 0____]                   │ │
│ │      │ 内包メッセージ:                                     │ │
│ │      │   3-1. Bob → Server: 処理A                  [≡][×] │ │
│ │      │   [+ メッセージ追加]                                │ │
│ │      │ [+ else追加]                                        │ │
│ │      └─────────────────────────────────────────────────────┤ │
│ │ 4. Bob → Alice: レスポンス                          [≡][×] │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                 │
│                                          [キャンセル] [適用]   │
└─────────────────────────────────────────────────────────────────┘
```

**v2.0の特徴**:
- **展開式インライン編集**: フラグメント/Noteをモーダル内で展開編集（別モーダル不要）
- **コンテキスト維持**: 全体一覧を見ながら詳細編集可能
- **入れ子モーダルなし**: モーダル疲れを回避

#### 対応フラグメント一覧（v2.0）

| フラグメント | 展開時の編集項目 |
|-------------|-----------------|
| `alt` | 条件式、内包メッセージ、else追加 |
| `opt` | 条件式、内包メッセージ |
| `loop` | ループ条件/回数、内包メッセージ |
| `par` | 並列ブロック追加、各ブロック内メッセージ |
| `break` | 条件式、内包メッセージ |
| `critical` | 内包メッセージ |
| `group` | グループ名、内包メッセージ |

<details>
<summary>v1.0（却下）: 3層モーダル構造</summary>

**層2: メッセージ管理モーダル（900×700px）**
```
┌─────────────────────────────────────────────────────────────────┐
│ メッセージ管理                                            [×]  │
├─────────────────────────────────────────────────────────────────┤
│ 【参加者管理セクション】                                        │
├─────────────────────┬───────────────────────────────────────────┤
│ メッセージ作成      │ 全メッセージ一覧                          │
│ フォーム            │                                           │
│ (350px)             │ ┌─────────────────────────────────────┐   │
│                     │ │ [カード1] Alice→Bob: hello         │   │
│ [フラグメント挿入]  │ │ [カード2] Bob→Alice: hi            │   │
│                     │ │ [カード3] ...                       │   │
│                     │ │         ↕ D&D並べ替え可能           │   │
│                     │ └─────────────────────────────────────┘   │
├─────────────────────┴───────────────────────────────────────────┤
│ 【全体Note（across）管理セクション】                            │
└─────────────────────────────────────────────────────────────────┘
```

**却下理由**: 3層はUXベストプラクティス違反（2層が限界）、認知負荷高、D評価（65点）
</details>

### 2.4 2レベルGUI編集構造（TD-020 v2.0）⚡ **Session 13で更新**

> **v1.0（却下）**: 3レベル構造 → **v2.0（採用）**: 2レベル統一構造

| レベル | 操作 | 対象要素 | UI実装 |
|:------:|------|---------|--------|
| **Level 1** | 直接操作 | 追加/削除/並替 | クリック、D&D、右クリックメニュー |
| **Level 2** | 展開式編集 | 内容/設定変更 | インライン展開、フォーム入力 |

**要素別対応表**:

| 要素 | Level 1（直接操作） | Level 2（展開式編集） |
|------|:------------------:|:--------------------:|
| **参加者** | 追加/削除/並替 | 名前編集 |
| **メッセージ** | 追加/削除/並替 | 内容/矢印種類編集 |
| **Fragment** | 追加/削除/並替 | 種類/条件/内包メッセージ編集 |
| **Note** | 追加/削除/並替 | 種類/対象参加者/内容編集 |
| **補助要素** | 追加/削除/並替 | タイトル/数値編集 |

**Note対応詳細（v2.0追加）**:

| Note種類 | PlantUML構文 | Level 1操作 | Level 2編集項目 |
|---------|-------------|------------|----------------|
| 参加者Note | `note left/right of <参加者>` | 右クリック→追加 | 種類、対象、内容 |
| メッセージNote | `note left/right` | [Note+]ボタン | 位置、内容 |
| 範囲Note | `note over <A>, <B>` | 右クリック→追加 | 対象参加者（複数）、内容 |
| 全体Note | `note across` | [+追加]ボタン | 内容 |
| 六角形Note | `hnote over` | 種類変更で対応 | 形状、対象、内容 |
| 四角形Note | `rnote over` | 種類変更で対応 | 形状、対象、内容 |
| 複数行Note | `note ... end note` | 自動判定 | 内容（複数行対応） |

### 2.5 ヘッダー構成（TD-021）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ [Logo] PlantUML Studio │ ファイル名.puml │ [保存] [エクスポート] ... │ [■■□] │
└─────────────────────────────────────────────────────────────────────────────┘
                                                                      ↑
                                                            パネルモード切替トグル
                                                            [GUI+Code][GUI][Code]
```

**キーボードショートカット**: Ctrl+1, Ctrl+2, Ctrl+3

### 2.6 パネル間同期（TD-018）

```
        0ms（即時）           500ms（デバウンス）
GUIパネル ─────────→ Codeパネル ─────────────────→ Previewパネル
    ↑                    │
    └────────────────────┘
         300ms（デバウンス）
```

**エラー行ハイライト（TD-018 Session 13追加）**:
- Monaco Editorのデコレーション機能でエラー行を視覚的にハイライト
- ガター（行番号横）に赤い●アイコン表示
- ホバーでエラーメッセージ表示

### 2.7 Session 13追加機能

#### 2.7.1 Undo/Redo機能（TD-024）⏸️ v1.1延期

| 項目 | 仕様 |
|------|------|
| 実装パターン | Command Pattern |
| 履歴保持数 | 最大100件 |
| ショートカット | `Ctrl+Z` / `Ctrl+Shift+Z` |

#### 2.7.2 アクセシビリティ（TD-025）⏸️ v1.1延期

| カテゴリ | 対応内容 |
|---------|---------|
| 知覚可能 | コントラスト比4.5:1以上（WCAG AA） |
| 操作可能 | 全機能キーボード操作可能 |
| 理解可能 | 一貫したナビゲーション |
| 堅牢 | ARIA属性、セマンティックHTML |

#### 2.7.3 オンボーディング（TD-026）⏸️ v1.1延期

- 初回ログイン時にステップバイステップツアー表示
- 7ステップ（ホーム→新規図表→エディタ→GUI→Code→Preview→AIチャット）
- スキップ可能、設定から再表示可能

#### 2.7.4 編集状態表示（TD-027）

```
┌─────────────────────────────────────────────────────────────┐
│ [Logo] │ sequence_diagram.puml ● 未保存 │ [保存] [Export] ... │
└─────────────────────────────────────────────────────────────┘
```

| 状態 | アイコン | 色 |
|------|---------|-----|
| 保存済み | ✓ | グレー |
| 未保存 | ● | オレンジ |
| 保存中 | ⟳ | ブルー |
| エラー | ⚠ | レッド |

#### 2.7.5 AIコード適用（TD-028）

> **詳細設計**: [§11 TD-028 AIコード適用機能 詳細設計](#11-td-028-aiコード適用機能-詳細設計) 参照

```
┌─────────────────────────────────────────────┐
│ 🤖 AI:                                      │
│ ┌─────────────────────────────────────────┐ │
│ │ loop 認証リトライ                       │ │
│ │   User -> Auth: 認証要求                │ │
│ │ end                                     │ │
│ │ [📋 コピー] [▶ 適用] [👁 差分を見る]     │ │
│ └─────────────────────────────────────────┘ │
└─────────────────────────────────────────────┘
```

- 「適用」ボタンでCodeパネルに反映
- 適用前に差分プレビュー表示可能
- Undo可能

#### 2.7.6 ローカルバックアップ（TD-029）⏸️ v1.1延期

| 項目 | 仕様 |
|------|------|
| 保存タイミング | 編集から30秒後（デバウンス） |
| 有効期間 | 7日経過で自動削除 |
| 容量管理 | 図表ごとに最新5件保持 |
| 復元UI | 「復元可能なバックアップがあります」通知 |

#### 2.7.7 Previewズーム（TD-030）

```
┌─────────────────────────────────────┐
│ Preview                    [−][+][Fit][1:1] 150% │
├─────────────────────────────────────┤
│         (SVG表示エリア)              │
└─────────────────────────────────────┘
```

| 操作 | 動作 |
|------|------|
| `Ctrl+ホイール` | ズームイン/アウト |
| `[Fit]` | パネルサイズにフィット |
| `[1:1]` | 100%表示 |
| ドラッグ | パン（位置移動） |

#### 2.7.8 ダークモード（TD-031）⏸️ v1.1延期

| 要素 | ライトモード | ダークモード |
|------|-------------|-------------|
| 背景（メイン） | `#FFFFFF` | `#1E1E1E` |
| 背景（パネル） | `#F5F5F5` | `#252526` |
| テキスト | `#333333` | `#CCCCCC` |

#### 2.7.9 AIチャット折りたたみ（TD-032）

**展開時**:
```
├───────────┴───────────┴─────────────────────┤
│ AI Chat                              [▼]    │ ← 高さ: 200px
└─────────────────────────────────────────────┘
```

**折りたたみ時**:
```
├───────────┴───────────┴─────────────────────┤
│ AI Chat [▲]                                 │ ← 高さ: 32px（バー表示のみ）
└─────────────────────────────────────────────┘
```

- `Ctrl+Shift+A` で切り替え
- 状態はlocalStorageに永続化

#### 2.7.10 キーボードショートカットヘルプ（TD-033）

> **追加日**: 2025-12-29（機能提供方法評価による改善）

**起動方法**:
- `?`キー押下
- ヘッダーの`?`アイコンクリック

**ヘルプモーダル**:
```
┌────────────────────────────────────────────────┐
│ キーボードショートカット                   [×] │
├────────────────────────────────────────────────┤
│ パネルモード                                   │
│ │ Ctrl+1    GUI+Code モード                   │
│ │ Ctrl+2    GUI のみモード                    │
│ │ Ctrl+3    Code のみモード                   │
│                                                │
│ 編集操作                                       │
│ │ Ctrl+S    保存                              │
│ │ Ctrl+Z    元に戻す                          │
│ │ Ctrl+Shift+Z やり直し                       │
│                                                │
│ UI操作                                         │
│ │ Ctrl+Shift+A AIチャット折りたたみ           │
│ │ ?         このヘルプを表示                  │
│                                                │
│ プレビュー                                     │
│ │ Ctrl+0    フィット表示                      │
│ │ Ctrl++/-  ズームイン/アウト                 │
└────────────────────────────────────────────────┘
```

### 2.8 キーボードショートカット一覧

| カテゴリ | ショートカット | 動作 |
|---------|---------------|------|
| パネルモード | `Ctrl+1` | モード1（GUI+Code） |
| パネルモード | `Ctrl+2` | モード2（GUIのみ） |
| パネルモード | `Ctrl+3` | モード3（Codeのみ） |
| 編集操作 | `Ctrl+S` | 保存 |
| 編集操作 | `Ctrl+Z` | Undo |
| 編集操作 | `Ctrl+Shift+Z` | Redo |
| UI操作 | `Ctrl+Shift+A` | AIチャット折りたたみ/展開 |
| **ヘルプ** | **`?`** | **ショートカットヘルプ表示** |
| プレビュー | `Ctrl+0` | Previewフィット表示 |
| プレビュー | `Ctrl++` | Previewズームイン |
| プレビュー | `Ctrl+-` | Previewズームアウト |
| モーダル | `Esc` | モーダルを閉じる |

---

## 3. 評価フレームワーク

| 観点 | 評価基準 |
|------|---------|
| UXベストプラクティス | 業界標準、認知負荷、操作効率 |
| ターゲットユーザー適合性 | ペルソナ（非コーダー〜上級者） |
| 競合ツール比較 | VS Code, Figma, Mermaid Live Editor等 |
| 技術的実現可能性 | 実装複雑度、パフォーマンス |
| アクセシビリティ | WCAG準拠、キーボード操作 |
| レスポンシブ対応 | 解像度別対応 |

### 採点基準

| スコア | 評価 | 定義 |
|:------:|:----:|------|
| 90-100 | A | ベストプラクティス完全準拠 |
| 80-89 | B | 軽微な改善余地あり |
| 70-79 | C | 中程度の問題あり、要改善 |
| 60-69 | D | 重大な問題あり、必須修正 |
| <60 | F | 設計見直し必要 |

---

## 4. 各要素の詳細評価

### 4.1 3パネルレイアウト

| 評価項目 | スコア | 詳細 |
|---------|:------:|------|
| 関心の分離 | ✅ | 編集（GUI/Code）と出力（Preview）の明確な分離 |
| ユーザースキル対応 | ✅ | 非コーダー（GUI）〜上級者（Code）をカバー |
| スペース効率 | ⚠️ | **300pxのGUIパネルは狭い** |

**評価: 85/100**（-15: GUIパネル幅の制約）

### 4.2 パネルモード切替（3モード）

**評価: 90/100**（-10: 発見可能性の懸念）

### 4.3 2層統合モーダル構造 ✅

**評価: 85/100**（v1.0: 65点 → v2.0: +20点改善）

### 4.4 2レベルGUI編集構造 ✅

**評価: 85/100**（v1.0: 75点 → v2.0: +10点改善）

### 4.5 パネル間同期（TD-018）

**評価: 95/100**（-5: 遅延の知覚可能性）

### 4.6 AIチャットパネル ✅

**評価: 95/100**（+15: 折りたたみ機能追加、AIコード適用機能追加）

### 4.7 レスポンシブ対応（TD-023）

**評価: 90/100**（-10: 極小解像度での最適化余地）

### 4.8 Undo/Redo機能（TD-024）⏸️ v1.1延期

**評価: 60/100**（D評価 → v1.1延期）

### 4.9 アクセシビリティ（TD-025）⏸️ v1.1延期

**評価: 61/100**（D評価 → v1.1延期）

### 4.10 オンボーディング（TD-026）⏸️ v1.1延期

**評価: 70/100**（C評価 → v1.1延期）

### 4.11 データ安全性（TD-027, TD-029）

**評価: 95/100**（編集状態表示 + 自動バックアップ）

### 4.12 Previewズーム（TD-030）

**評価: 95/100**（標準的なズーム機能完備）

### 4.13 ダークモード（TD-031）⏸️ v1.1延期

**評価: 68/100**（D評価 → v1.1延期）

---

## 5. 総合評価

### MVP機能（12機能）評価

| # | 評価項目 | スコア |
|:-:|---------|:------:|
| 1 | 3パネルレイアウト | 85 |
| 2 | パネルモード切替 | 90 |
| 3 | 2層統合モーダル（TD-019 v2.0） | 85 |
| 4 | 2レベルGUI編集（TD-020 v2.0） | 85 |
| 5 | パネル間同期（TD-018） | 95 |
| 6 | AIチャットパネル | 95 |
| 7 | レスポンシブ対応 | 90 |
| 8 | データ安全性 | 95 |
| 9 | Previewズーム | 95 |
| 10 | AIチャット折りたたみ | 95 |
| 11 | ショートカットヘルプ | 95 |
| 12 | GUIパネル動的切り替え | 80 |
| 13 | AIコード適用 | 80 |
| | **平均** | **89.62** |

**総合評価: 89.62/100（B+評価）**

---

## 6. 問題解決状況

| Session | 問題 | 対応TD | 解決状態 |
|:-------:|------|--------|:--------:|
| 12 | 3層モーダル構造 | TD-019 v2.0 | ✅ 解決 |
| 12 | 3レベルGUI編集 | TD-020 v2.0 | ✅ 解決 |
| 13 | AIチャット固定表示 | TD-032 | ✅ 解決 |
| 13 | ショートカット可視性 | TD-033 | ✅ 解決 |

**残存問題: 0件**

---

## 7. 将来アクション

### v1.1での対応予定

| TD | 機能 | 対応内容 |
|:--:|------|---------|
| TD-024 | Undo/Redo | GUI/Code/AI統合履歴管理 |
| TD-025 | WCAG準拠 | 監査ツール対応 |
| TD-026 | オンボーディング | インタラクティブツアー |
| TD-029 | ローカルバックアップ | 復元UI詳細 |
| TD-031 | ダークモード | テーマ対応 |

---

## 8. トレーサビリティマトリクス ⚡新規

### 8.1 UC → TD → 仕様 → 実装 マッピング

| UC | UC名 | 関連TD | 仕様セクション | 型定義 | 実装コード |
|:--:|------|:------:|---------------|--------|-----------|
| UC 3-1 | 図表作成 | TD-017, 019 | §2.2-2.3 | - | - |
| UC 3-2 | テンプレート選択 | TD-022 | §2.2 | - | - |
| UC 3-3 | コード編集 | TD-018, 020 | §2.4, 2.6 | - | - |
| UC 3-4 | プレビュー | TD-023, 030 | §2.1, 2.7.7 | - | - |
| UC 3-5 | 保存 | TD-027 | §2.7.4 | - | - |
| UC 3-6 | エクスポート | TD-023 | §2.5 | - | - |
| UC 4-1 | AI Question-Start | TD-028 | §11.1-11.5 | SelectedElement | buildApplyPrompt |
| UC 4-2 | AIチャット | TD-028, 032 | §11.6-11.9 | ErrorFixRequest | handleSyntaxError |

### 8.2 TD詳細度評価

| 詳細度 | TD一覧 | 説明 |
|:------:|--------|------|
| **完全** | TD-028 | 型定義、実装コード、フロー図、エッジケース全て |
| **完全** | TD-019, TD-020 | 画面構成、UI詳細、却下理由含む |
| **概要** | TD-017, TD-018, TD-021-027, TD-029-033 | 概要レベル |

---

## 9. 型定義一覧（完全版）⚡新規

### 9.1 コア型定義

```typescript
// ========================================
// 選択要素
// ========================================
interface SelectedElement {
  text: string;          // 要素のテキスト内容
  lineNumber: number;    // コード内の行番号
}

// ========================================
// エラー修正リクエスト
// ========================================
interface ErrorFixRequest {
  originalRequest: string;        // 元のユーザー依頼
  errorMessage: string;           // エラーメッセージ
  errorLineNumber: number;        // エラー行番号
  surroundingCode: string;        // エラー行 ± 5行
  fullCode: string;               // 完全な@startuml〜@enduml
  attemptHistory: AttemptRecord[]; // 過去の試行履歴
}

interface AttemptRecord {
  attemptNumber: number;          // 試行番号
  errorMessage: string;           // エラーメッセージ
  appliedFix: string;             // 試行した修正内容（概要）
}

// ========================================
// エラー情報 ⚡新規追加
// ========================================
interface ErrorInfo {
  message: string;                // エラーメッセージ
  lineNumber: number;             // エラー行番号
  code: ErrorCode;                // エラーコード
}

enum ErrorCode {
  SYNTAX_ERROR = 'SYNTAX_ERROR',
  RENDER_ERROR = 'RENDER_ERROR',
  VALIDATION_ERROR = 'VALIDATION_ERROR'
}
```

### 9.2 憲法システム型定義

```typescript
// ========================================
// 憲法（Constitution）
// ========================================
interface Constitution {
  version: string;
  type: 'base' | 'llm' | 'diagram' | 'combined';
  extends?: string | string[];
  target?: string;                    // LLM名 or 図表名
  target_llm?: string;                // combined用
  target_diagram?: string;            // combined用

  // ルール定義
  requirements?: string[];            // 必須ルール
  prohibitions?: string[];            // 禁止事項
  recommendations?: string[];         // 推奨事項

  // 追加ルール（継承時）
  additional_requirements?: string[];
  additional_prohibitions?: string[];
  additional_recommendations?: string[];

  // 出力形式
  output_format?: OutputFormat;

  // 既知の問題（運用知見）
  known_issues?: KnownIssue[];

  // メタ情報
  notes?: string[];
  updated_at?: string;
  updated_by?: string;
}

// ========================================
// 出力形式 ⚡新規追加
// ========================================
interface OutputFormat {
  wrapper?: string;                 // コードラッパー（例: "```plantuml"）
  single_block?: boolean;           // 単一ブロック出力強制
  no_explanation?: boolean;         // 説明文禁止
  max_lines?: number;               // 最大行数制限
}

// ========================================
// 既知の問題 ⚡新規追加
// ========================================
interface KnownIssue {
  id: string;                       // 例: "SEQ-001", "ACT-002"
  description: string;              // 問題の説明
  workaround: string;               // 回避策
}
```

### 9.3 プロバイダー・リゾルバー型定義

```typescript
// ========================================
// 憲法プロバイダー
// ========================================
interface IConstitutionProvider {
  load(path: string): Promise<Constitution | null>;
  list(): Promise<string[]>;
  getVersion(path: string): Promise<string | null>;
}

// ========================================
// 憲法リゾルバー
// ========================================
interface IConstitutionResolver {
  resolve(llm: LLMType, diagramType: DiagramType): Promise<ResolvedConstitution>;
}

interface ResolvedConstitution {
  requirements: string[];
  prohibitions: string[];
  recommendations: string[];
  outputFormat: OutputFormat;
  knownIssues: KnownIssue[];
  resolvedFrom: string[];           // マージ元ファイル一覧
  resolvedAt: Date;
}
```

### 9.4 プロンプトビルダー型定義

```typescript
// ========================================
// プロンプトビルダー
// ========================================
interface IPromptBuilder {
  build(context: PromptContext): Promise<string>;
}

interface PromptContext {
  type: 'apply' | 'error_fix' | 'generate';
  llm: LLMType;
  diagramType: DiagramType;
  userRequest: string;
  currentCode?: string;
  targetElements?: SelectedElement[];
  appliedCode?: string;
  errorInfo?: ErrorInfo;
  attemptHistory?: AttemptRecord[];
}

type LLMType = 'claude' | 'gpt4' | 'gemini' | 'llama' | 'mistral';
type DiagramType = 'sequence' | 'class' | 'activity' | 'usecase' | 'state' | 'component';

// ========================================
// テンプレートエンジン ⚡新規追加
// ========================================
interface ITemplateEngine {
  render(template: string, variables: Record<string, unknown>): string;
}
```

### 9.5 Monaco Editor API ⚡新規追加

```typescript
// ========================================
// Monaco Editor 連携API
// ========================================
interface IMonacoEditorAPI {
  // 値の取得・設定
  getValue(): string;
  setValue(value: string): void;

  // 選択範囲 ⚡新規追加
  getSelection(): ISelection | null;
  setSelection(selection: ISelection): void;

  // デコレーション
  createDecorationsCollection(decorations: IModelDeltaDecoration[]): IEditorDecorationsCollection;

  // カーソル位置
  getPosition(): IPosition | null;
  setPosition(position: IPosition): void;

  // 行情報
  getLineContent(lineNumber: number): string;
  getLineCount(): number;
}

interface ISelection {
  startLineNumber: number;
  startColumn: number;
  endLineNumber: number;
  endColumn: number;
}

interface IPosition {
  lineNumber: number;
  column: number;
}

interface IModelDeltaDecoration {
  range: IRange;
  options: IModelDecorationOptions;
}

interface IRange {
  startLineNumber: number;
  startColumn: number;
  endLineNumber: number;
  endColumn: number;
}

interface IModelDecorationOptions {
  isWholeLine?: boolean;
  className?: string;
  glyphMarginClassName?: string;
  hoverMessage?: IMarkdownString;
}
```

---

## 10. 統合決定事項一覧 ⚡統合

> このセクションは、各セクションに分散していた決定事項を統合したものです。

### 10.1 基本アーキテクチャ決定

| # | カテゴリ | 項目 | 決定内容 | 参照TD |
|:-:|---------|------|---------|:------:|
| 1 | レイアウト | パネル構成 | 3パネル（GUI 300px / Code 650px / Preview 962px） | TD-023 |
| 2 | レイアウト | AIチャット | ボトム配置、折りたたみ可能 | TD-032 |
| 3 | モーダル | 構造 | 2層統合モーダル（展開式インライン編集） | TD-019 |
| 4 | GUI編集 | 構造 | 2レベル（直接操作 + 展開式編集） | TD-020 |
| 5 | 同期 | タイミング | GUI→Code: 0ms / Code→Preview: 500ms / Code→GUI: 300ms | TD-018 |

### 10.2 AIコード適用決定

| # | カテゴリ | 項目 | 決定内容 | 参照 |
|:-:|---------|------|---------|------|
| 6 | 技術制約 | AI直接修正 | 不可能（システム経由で適用） | §11.1 |
| 7 | 対象選択（GUI） | 選択方法 | メッセージカードクリック、累積選択 | §11.3 |
| 8 | 対象選択（Code） | 選択方法 | トグルボタン → ドラッグ選択 | §11.3 |
| 9 | 選択連動 | 3パネル連動 | GUI/Code/Preview すべてでハイライト | §11.3 |
| 10 | 適用処理 | 適用方式 | 確認ダイアログ → AI送信 → 結果適用 | §11.5 |
| 11 | 適用処理 | Undo | Ctrl+Z 1回で全復元 | §11.5 |

### 10.3 エラー処理決定

| # | カテゴリ | 項目 | 決定内容 | 参照 |
|:-:|---------|------|---------|------|
| 12 | 通知方式 | エラー表示 | Previewパネル上部のインラインバナー | §11.8 |
| 13 | 通知方式 | AIチャット | **使用しない**（会話履歴汚染防止） | §11.8 |
| 14 | 通知方式 | Monaco | 黄色背景ハイライト | §11.8 |
| 15 | 送信内容 | エラー周辺コード | **必須**（± 5行 = 計11行） | §11.8 |
| 16 | 送信内容 | 試行履歴 | **必須** | §11.8 |
| 17 | 回数制限 | 警告 | **5回目**に警告メッセージ | §11.8 |
| 18 | 回数制限 | 上限 | 6回目以降は再生成ボタン非活性化 | §11.8 |

### 10.4 階層的憲法システム決定

| # | カテゴリ | 項目 | 決定内容 | 参照 |
|:-:|---------|------|---------|------|
| 19 | アーキテクチャ | 構造 | 4層階層構造（Base→LLM→Diagram→Combined） | §11.9 |
| 20 | アーキテクチャ | 継承 | 差分定義、マージで最終憲法を解決 | §11.9 |
| 21 | アーキテクチャ | 格納形式 | YAML（MVP）、Supabase（v1.1） | §11.9 |
| 22 | プロンプト | 構築方式 | ビルダーパターン + ファクトリ | §11.9 |
| 23 | プロンプト | 憲法反映 | 動的に挿入（ハードコード禁止） | §11.9 |
| 24 | 運用 | 更新方式 | YAMLファイル更新のみ（デプロイ不要） | §11.9 |
| 25 | スコープ | MVP | base + 2 LLM + 3 diagram | §11.9 |
| 26 | スコープ | v1.1 | 全LLM + 全図表 + Combined + 管理UI | §11.9 |

### 10.5 MVP vs v1.1 スコープ

| 項目 | MVP | v1.1 |
|------|:---:|:----:|
| **Layer 1: 基底憲法** | ✅ | ✅ |
| **Layer 2: LLM層**（Claude, GPT-4） | ✅ | ✅ |
| **Layer 3: 図表層**（sequence, class, activity） | ✅ | ✅ |
| 全LLM対応（Gemini, Llama, Mistral） | ❌ | ✅ |
| 全図表対応（6種類以上） | ❌ | ✅ |
| **Layer 4: Combined層** | ❌ | ✅ |
| **ファイルベースプロバイダー** | ✅ | ✅ |
| Supabaseプロバイダー（DB管理） | ❌ | ✅ |
| 管理UI（憲法編集画面） | ❌ | ✅ |
| A/Bテスト機能 | ❌ | ✅ |
| 効果測定ダッシュボード | ❌ | ✅ |

---

## 11. TD-028 AIコード適用機能 詳細設計

> **作成日**: 2025-12-29
> **対象TD**: TD-028 AIコード適用機能
> **優先度**: MVP

### 11.1 技術的制約の明確化

#### 11.1.1 AIの技術的限界

| 能力 | 可否 | 理由 |
|------|:----:|------|
| テキストを受け取る | ✅ | LLM APIの基本機能 |
| テキストを返す | ✅ | LLM APIの基本機能 |
| Code panel（Monaco Editor）を直接操作 | ❌ | AIにはブラウザアクセス手段がない |
| ブラウザDOMを操作 | ❌ | AIはテキストイン・テキストアウトのAPI |
| Function Calling / Tool Use | ❌ | OpenRouter + 多様LLMのため使用不可 |

#### 11.1.2 システムの技術的能力

| 能力 | 可否 | 実現方法 |
|------|:----:|---------|
| AI応答からコードを抽出 | ✅ | `@startuml`〜`@enduml` パターン検出（正規表現） |
| Code panelを更新 | ✅ | Monaco Editor API (`editor.setValue()`) |
| Preview を更新 | ✅ | PlantUML レンダリング API |
| 選択要素のハイライト | ✅ | Monaco Editor Decorations API |

#### 11.1.3 重要な理解

```
「AIがCode panelを直接修正する」 = ❌ 技術的に不可能

「AIがコードを返す → システムが適用する」 = ✅ 実際の動作

ユーザー視点では「クリック一つでコードが更新される」体験が実現可能
```

### 11.2 確定したフロー

```
① ユーザーが対象コード（○○）を指定
   └─ GUIパネル: メッセージカードをクリック
   └─ Codeパネル: トグルボタンON → ドラッグで範囲選択

② ユーザーがAIチャットで依頼入力
   └─ 例:「loop処理にしてAとBの繰り返しでYの時に次のプロセスに移動」

③ AIがチャット欄でコード候補を回答
   └─ 自然言語の説明 + PlantUMLコードスニペット

④ ユーザーがAI回答からコード（△△）を範囲選択
   └─ トグルボタンON → ドラッグで範囲選択
   └─「コードを適用」ボタンをクリック

⑤ システムがAIに修正依頼を送信
   └─ 依頼文（後述のベストプラクティス形式）
   └─ AIが修正後の完全コードをテキストで返す

⑥ システムがAI応答を処理
   └─ @startuml〜@enduml を抽出
   └─ Monaco Editor API でCode panelを更新

⑦ 修正後コードがPreviewに自動レンダリング
   └─ ユーザーが結果を確認
   └─ 不満なら Ctrl+Z で元に戻す
```

### 11.3 対象コード特定機能

#### 11.3.1 GUIパネルでの選択

| # | 決定項目 | 決定内容 |
|:-:|---------|---------|
| 1 | 選択方法 | メッセージカードをクリック |
| 2 | 複数選択 | 複数回クリック（累積選択） |
| 3 | 選択クリア | クリアボタン |

#### 11.3.2 Codeパネルでの選択

| # | 決定項目 | 決定内容 |
|:-:|---------|---------|
| 4 | 選択方法 | ドラッグで範囲選択 |
| 5 | モード開始 | トグルボタン（ON/OFF切替） |
| 6 | モード中の表示 | Codeパネル枠線の色変更 |
| 7 | モード終了 | トグルボタンOFF |

#### 11.3.3 選択状態の連動

| # | 決定項目 | 決定内容 |
|:-:|---------|---------|
| 8 | GUI選択時の表示 | GUI: 選択カード表示 / Code: 黄色ハイライト / Preview: メッセージ色変更 |
| 9 | Code選択時のGUI連動 | 対応カードをハイライト |
| 10 | Code選択時のPreview連動 | 対応メッセージの色変更 |
| 11 | GUI/Code併用 | 排他（後から選択した方が有効） |
| 12 | AIへの情報伝達 | 要素テキスト + 行番号 |

### 11.4 AIチャットからのコード選択

| # | 決定項目 | 決定内容 |
|:-:|---------|---------|
| 13 | 選択モード | トグルボタンでモード切替（Codeパネルと同様） |
| 14 | 選択方法 | ドラッグでテキスト範囲選択 |
| 15 | 未選択で適用ボタン押下 | ボタン無効化（グレーアウト） |
| 16 | 部分選択（@startumlのみ等） | エラー表示「完全なコードを選択してください」 |

### 11.5 適用処理

#### 11.5.1 基本動作

| # | 決定項目 | 決定内容 |
|:-:|---------|---------|
| 17 | 適用ボタンの動作 | 確認ダイアログ後にAIへ送信 → 結果を適用 |
| 18 | 適用後のUndo | Ctrl+Z 1回で全復元 |
| 19 | 複数@startuml〜@enduml検出時 | 最大のブロック使用 |

#### 11.5.2 エラー処理

| # | 失敗パターン | 決定内容 |
|:-:|-------------|---------|
| 20 | コードブロックなし | AIに再生成依頼 |
| 21 | 構文エラー | AIに修正依頼（ワンボタン）→ §11.8参照 |

### 11.6 AIへの依頼文ベストプラクティス

#### 11.6.1 推奨フォーマット

```
【コード修正実行】

■ ユーザーの依頼
「${originalUserRequest}」

■ 修正対象
${○○.text}（${○○.lineNumber}行目）

■ 適用コード
${△△}

■ 指示
上記の依頼意図に基づき、修正対象を適用コードで修正してください。

■ 出力形式
修正後の完全なPlantUMLコード（@startuml〜@enduml）のみ。
説明文は不要です。
```

#### 11.6.2 実装コード例

```typescript
function buildApplyPrompt(
  originalRequest: string,
  target: SelectedElement | SelectedElement[] | null,
  appliedCode: string
): string {
  // 修正対象のフォーマット
  let targetText: string;
  if (target === null) {
    targetText = '未指定（依頼内容に基づきAIが判断）';
  } else if (Array.isArray(target)) {
    targetText = target
      .map((t, i) => `${i + 1}. ${t.text}（${t.lineNumber}行目）`)
      .join('\n');
  } else {
    targetText = `${target.text}（${target.lineNumber}行目）`;
  }

  return `【コード修正実行】

■ ユーザーの依頼
「${originalRequest}」

■ 修正対象
${targetText}

■ 適用コード
${appliedCode}

■ 指示
上記の依頼意図に基づき、修正対象を適用コードで修正してください。

■ 出力形式
修正後の完全なPlantUMLコード（@startuml〜@enduml）のみ。
説明文は不要です。`;
}
```

### 11.7 システム処理フロー

```typescript
async function handleApplyCode(
  originalRequest: string,
  selectedTarget: SelectedElement | null,
  selectedCode: string,
  currentCode: string
): Promise<void> {
  // 1. バリデーション
  if (!selectedCode.trim()) {
    showError('コードを選択してください');
    return;
  }

  // 2. 確認ダイアログ
  const confirmed = await showConfirmDialog('選択したコードを適用しますか？');
  if (!confirmed) return;

  // 3. AIに修正依頼を送信
  const prompt = buildApplyPrompt(originalRequest, selectedTarget, selectedCode);
  const aiResponse = await sendToAI(prompt);

  // 4. AI応答からコードを抽出
  const extractedCode = extractPlantUMLCode(aiResponse);
  if (!extractedCode) {
    showError('AIからの応答に有効なPlantUMLコードが含まれていません');
    showRegenerateButton();
    return;
  }

  // 5. Undo用に現在の状態を保存
  saveUndoState(currentCode);

  // 6. Code panelを更新
  monacoEditor.setValue(extractedCode);

  // 7. 成功メッセージ
  showSuccess('コードを適用しました');
}

function extractPlantUMLCode(response: string): string | null {
  // @startuml〜@enduml を抽出
  const regex = /@startuml[\s\S]*?@enduml/g;
  const matches = response.match(regex);

  if (!matches || matches.length === 0) {
    return null;
  }

  // 複数ブロックがある場合は最大のものを返す
  return matches.reduce((largest, current) =>
    current.length > largest.length ? current : largest
  );
}
```

### 11.8 エラー修正機能 詳細設計

#### 11.8.1 エラー発生時の画面状態

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ ヘッダー                                    [GUI+Code] [GUI] [Code]         │
├────────┬─────────────┬──────────────────────────────────────────────────────┤
│ GUI    │ Code        │ Preview                                              │
│ Panel  │ Panel       │ Panel                                                │
│        │             │                                                      │
│        │  12│ ★黄色  │  ┌──────────────────────────────────────────────┐   │
│        │  ハイライト │  │ ⚠️ 構文エラー（12行目）                     │   │
│        │             │  │ Expected 'as' keyword                       │   │
│        │             │  │            [再生成] [閉じる]                 │   │
│        │             │  └──────────────────────────────────────────────┘   │
│        │             │                                                      │
├────────┴─────────────┴──────────────────────────────────────────────────────┤
│ AIチャットパネル（エラー通知なし = クリーンな会話履歴維持）                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 11.8.2 エラー通知バナー仕様

| 項目 | 仕様 |
|------|------|
| **表示位置** | Previewパネル上端（Code/Preview境界付近）|
| **背景色** | オレンジ系警告色（#FFF3CD または類似）|
| **テキスト色** | 濃いオレンジ/茶色（#856404）|
| **アイコン** | ⚠️ 警告アイコン |
| **内容** | エラー種別（行番号）+ エラーメッセージ |
| **ボタン** | 「再生成」「閉じる」|

#### 11.8.3 AIへの送信内容（エラー修正依頼）

| 項目 | 内容 | 必須 |
|------|------|:----:|
| **元の依頼** | ユーザーの最初の修正依頼 | ✅ |
| **エラーメッセージ** | PlantUMLバリデーションエラー | ✅ |
| **エラー行番号** | 構文エラーの発生行 | ✅ |
| **エラー周辺コード** | エラー行 ± 5行（計11行）| ✅ |
| **完全コード** | @startuml〜@enduml全体 | ✅ |
| **前回試行履歴** | 過去の修正試行とエラー内容 | ✅ |

#### 11.8.4 回数制限と警告

| 試行回数 | システム動作 |
|:--------:|-------------|
| 1〜4回目 | 通常のエラー再生成処理 |
| **5回目** | **警告メッセージ表示** + 手動修正推奨 |
| 6回目以降 | 再生成ボタン**非活性化**、手動修正のみ |

#### 11.8.5 エラー修正依頼プロンプト

```typescript
function buildErrorFixPrompt(request: ErrorFixRequest): string {
  let historyText = '';
  if (request.attemptHistory.length > 0) {
    historyText = '\n■ 過去の修正試行\n';
    historyText += request.attemptHistory
      .map(a => `  ${a.attemptNumber}回目: ${a.errorMessage}`)
      .join('\n');
    historyText += '\n';
  }

  return `【エラー修正依頼】

■ 元の依頼
「${request.originalRequest}」

■ 発生したエラー
${request.errorMessage}
（${request.errorLineNumber}行目）

■ エラー周辺のコード
\`\`\`plantuml
${request.surroundingCode}
\`\`\`
${historyText}
■ 完全なコード
\`\`\`plantuml
${request.fullCode}
\`\`\`

■ 指示
上記のエラーを修正した完全なPlantUMLコード（@startuml〜@enduml）のみを返してください。
説明文は不要です。`;
}
```

#### 11.8.6 周辺コード抽出関数

```typescript
function extractSurroundingCode(
  fullCode: string,
  errorLine: number,
  contextLines: number = 5
): string {
  const lines = fullCode.split('\n');
  const startLine = Math.max(0, errorLine - contextLines - 1);
  const endLine = Math.min(lines.length, errorLine + contextLines);

  return lines
    .slice(startLine, endLine)
    .map((line, idx) => {
      const lineNum = startLine + idx + 1;
      const marker = lineNum === errorLine ? '>>> ' : '    ';
      return `${marker}${lineNum}| ${line}`;
    })
    .join('\n');
}
```

### 11.9 階層的憲法システム

#### 11.9.1 アーキテクチャ概要

```
┌─────────────────────────────────────────────────────────────────┐
│                    階層的憲法システム                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Layer 1: 基底憲法（Base Constitution）                   │   │
│  │ ・全LLM・全図表共通ルール                                │   │
│  │ ・@startuml必須、出力形式、基本禁止事項                  │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                           │                                     │
│           ┌───────────────┴───────────────┐                     │
│           ▼                               ▼                     │
│  ┌─────────────────┐             ┌─────────────────┐           │
│  │ Layer 2: LLM層  │             │ Layer 3: 図表層 │           │
│  │ ・claude.yaml   │             │ ・sequence.yaml │           │
│  │ ・gpt4.yaml     │             │ ・class.yaml    │           │
│  │ ・gemini.yaml   │             │ ・activity.yaml │           │
│  └────────┬────────┘             └────────┬────────┘           │
│           │                               │                     │
│           └───────────────┬───────────────┘                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Layer 4: 組み合わせ層（Combined）                        │   │
│  │ ・claude_activity.yaml（特定組み合わせの問題対応）       │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### 11.9.2 ディレクトリ構成

```
src/ai/constitution/
├── schemas/
│   ├── base.yaml               # 基底憲法
│   ├── llm/
│   │   ├── claude.yaml
│   │   ├── gpt4.yaml
│   │   ├── gemini.yaml
│   │   └── llama.yaml
│   ├── diagram/
│   │   ├── sequence.yaml
│   │   ├── class.yaml
│   │   ├── activity.yaml
│   │   ├── usecase.yaml
│   │   ├── state.yaml
│   │   └── component.yaml
│   └── combined/
│       ├── claude_activity.yaml
│       └── gpt4_sequence.yaml
├── IConstitutionProvider.ts
├── IConstitutionResolver.ts
├── HierarchicalResolver.ts
└── providers/
    ├── FileConstitutionProvider.ts
    └── SupabaseConstitutionProvider.ts  # v1.1
```

#### 11.9.3 階層的解決実装

```typescript
class HierarchicalConstitutionResolver implements IConstitutionResolver {
  constructor(private provider: IConstitutionProvider) {}

  async resolve(llm: LLMType, diagramType: DiagramType): Promise<ResolvedConstitution> {
    // 1. 各層の憲法を読み込み
    const base = await this.provider.load('base');
    const llmSpecific = await this.provider.load(`llm/${llm}`);
    const diagramSpecific = await this.provider.load(`diagram/${diagramType}`);
    const combined = await this.provider.load(`combined/${llm}_${diagramType}`);

    // 2. 読み込み結果をログ
    const resolvedFrom: string[] = [];
    if (base) resolvedFrom.push('base');
    if (llmSpecific) resolvedFrom.push(`llm/${llm}`);
    if (diagramSpecific) resolvedFrom.push(`diagram/${diagramType}`);
    if (combined) resolvedFrom.push(`combined/${llm}_${diagramType}`);

    // 3. 優先度順にマージ（後勝ち）
    const merged = this.merge([base, llmSpecific, diagramSpecific, combined]);

    return {
      ...merged,
      resolvedFrom,
      resolvedAt: new Date()
    };
  }

  private merge(constitutions: (Constitution | null)[]): Omit<ResolvedConstitution, 'resolvedFrom' | 'resolvedAt'> {
    const result = {
      requirements: [] as string[],
      prohibitions: [] as string[],
      recommendations: [] as string[],
      outputFormat: {} as OutputFormat,
      knownIssues: [] as KnownIssue[]
    };

    for (const c of constitutions) {
      if (!c) continue;

      // 配列は結合
      if (c.requirements) result.requirements.push(...c.requirements);
      if (c.additional_requirements) result.requirements.push(...c.additional_requirements);

      if (c.prohibitions) result.prohibitions.push(...c.prohibitions);
      if (c.additional_prohibitions) result.prohibitions.push(...c.additional_prohibitions);

      if (c.recommendations) result.recommendations.push(...c.recommendations);
      if (c.additional_recommendations) result.recommendations.push(...c.additional_recommendations);

      if (c.known_issues) result.knownIssues.push(...c.known_issues);

      // オブジェクトは上書きマージ
      if (c.output_format) {
        result.outputFormat = { ...result.outputFormat, ...c.output_format };
      }
    }

    // 重複排除
    result.requirements = [...new Set(result.requirements)];
    result.prohibitions = [...new Set(result.prohibitions)];
    result.recommendations = [...new Set(result.recommendations)];

    return result;
  }
}
```

#### 11.9.4 運用改善サイクル

```
┌─────────────────────────────────────────────────────────────────┐
│                    憲法改善サイクル                              │
├─────────────────────────────────────────────────────────────────┤
│  ① エラー発生・品質問題検出                                     │
│                    ▼                                            │
│  ② 原因分析                                                     │
│     ├─ LLM固有の問題？ → llm/claude.yaml を更新                │
│     ├─ 図表固有の問題？ → diagram/activity.yaml を更新         │
│     └─ 組み合わせ固有？ → combined/claude_activity.yaml を作成 │
│                    ▼                                            │
│  ③ 憲法ファイル更新（YAMLファイルのみ）                         │
│                    ▼                                            │
│  ④ 即時反映（デプロイ不要）                                     │
│                    ▼                                            │
│  ⑤ 効果検証                                                     │
└─────────────────────────────────────────────────────────────────┘
```

---

## 12. 更新履歴

| 日時 | バージョン | 内容 |
|------|:----------:|------|
| 2025-12-29 | **v9.0** | **品質監査対応版**: 目次追加、トレーサビリティマトリクス追加、型定義完全版追加（OutputFormat, KnownIssue, ErrorInfo, ITemplateEngine, Monaco API）、統合決定事項セクション追加、重複コンテンツ正規化 |
| 2025-12-29 | v3.2 | Session 13 Phase 4対応: MVP延期7機能を明示化 |
| 2025-12-29 | v3.1 | Session 13 Phase 3対応: TD-019 v2.1、TD-029 v1.1、TD-033新規 |
| 2025-12-29 | v3.0 | Session 13 Phase 2対応: TD-019/TD-020をv2.0に更新、総合スコア90.38 |
| 2025-12-29 | v2.0 | Session 13 Phase 1対応: TD-017〜TD-032に範囲拡張、評価項目13項目 |
| 2025-12-28 22:00 | v1.1 | 9問題対応完了、TD-017〜TD-023に統一 |
| 2025-12-28 18:00 | v1.0 | 初版作成（Session 12 ベストプラクティス分析）|

---

## 付録A: 議論の経緯（詳細記録）

> **重要**: この付録は、設計判断の背景と議論の過程を完全に記録したものです。
> 将来のメンテナンスおよび設計判断の追跡のために保存されています。

---

### A.1 Session 13 Phase 2: TD-019/TD-020 改善

#### A.1.1 問題認識

Session 13 Phase 1の評価結果（88.85点、B評価）において、以下2件がD/C評価として残存していた：

| 問題 | 評価 | 課題内容 |
|------|:----:|---------|
| TD-019（3層モーダル構造） | D (65点) | 認知負荷高、モーダル入れ子、操作効率低下 |
| TD-020（3レベルGUI編集） | C (75点) | 操作パターン不統一、学習コスト高 |

ユーザーから「残存問題（2件）はMVPで対応するため、今解決する必要があります」との指示があり、Phase 2として解決策を検討した。

#### A.1.2 TD-019 解決策検討

**問題の本質**:
- 3層（GUIパネル → メッセージ管理モーダル → フラグメント編集モーダル）は深すぎる
- UXベストプラクティスでは**2層が限界**
- モーダル入れ子によるコンテキスト喪失

**検討した選択肢**:

| 案 | 概要 | 評価 |
|:--:|------|:----:|
| A | 3層維持（現状） | D (65点) |
| B | タブ統合モーダル | B見込み |
| C | スライドオーバー | B見込み |
| D | インプレース編集 | 複雑すぎ |
| **E** | **2層統合モーダル（展開式フラグメント編集）** | **採用** |

**案E採用理由**:
1. **層3を展開式に統合**: フラグメント編集を層2内のインライン展開で対応
2. **実装シンプル**: 既存のモーダル構造を活かせる
3. **コンテキスト維持**: 一覧を見ながら詳細編集可能
4. **操作一貫性**: 全要素が同じ「展開→編集」パターン

#### A.1.3 TD-020 解決策検討

**問題の本質**:
- 3レベル（完全GUI / ポップオーバー / 読取専用）で操作が不統一
- 「なぜLevel 3は編集できないのか」というユーザー混乱

**検討した選択肢**:

| 案 | 概要 | 評価 |
|:--:|------|:----:|
| A | 3レベル維持 | C (75点) |
| B | 視覚的インジケータ追加 | C見込み |
| C | Level 3をポップオーバー化 | やや複雑 |
| **D** | **2レベル簡素化（直接操作 + 展開式編集）** | **採用** |

**案D採用理由**:
1. **全要素で統一パターン**: Level 1（直接操作）とLevel 2（展開式編集）の2択
2. **学習コスト低**: 「追加/削除はクリック、詳細編集は展開」という直感的ルール
3. **期待との一致**: 全要素がGUIで編集可能

#### A.1.4 groupフラグメント対応

**ユーザー質問**: 「groupはLevel1で対応できるの？」

**回答**: YES。`group`は他のフラグメント（alt, opt, loop等）と構造的に同じ。
- Level 1: 追加/削除/並替（D&D）
- Level 2: グループ名編集、内包メッセージ編集

#### A.1.5 Note対応詳細定義

**ユーザー質問**: 「noteへの対応は？」

**回答**: 全Note種類を2レベル構造で対応。

| Note種類 | Level 1 | Level 2 |
|---------|---------|---------|
| `note left/right of` | 右クリック→追加 | 種類、対象、内容編集 |
| `note left/right` | [Note+]ボタン | 位置、内容編集 |
| `note over A, B` | 右クリック→追加 | 対象参加者（複数選択）、内容編集 |
| `note across` | [+追加]ボタン | 内容編集 |
| `hnote`/`rnote` | 種類変更で対応 | 形状、対象、内容編集 |

**統合編集モーダル内での表示**:
- 📝 アイコンでNoteを識別
- メッセージ/フラグメントと同列に表示
- 展開式で詳細編集（種類ドロップダウン、対象参加者選択、内容テキストエリア）

#### A.1.6 決定事項

| 決定 | 内容 | 反映先 |
|------|------|--------|
| TD-019 v2.0 | 3層→2層統合モーダル + 展開式インライン編集 | `technical_decisions.md` |
| TD-020 v2.0 | 3レベル→2レベル統一構造（直接操作 + 展開式編集） | `technical_decisions.md` |
| group対応 | Level 1/2で他フラグメントと同様に対応 | TD-019 v2.0 |
| Note対応 | 全Note種類をLevel 1/2で統一対応 | TD-020 v2.0 |

#### A.1.7 評価改善

| 項目 | Before | After | 改善 |
|------|:------:|:-----:|:----:|
| TD-019 | 65点 (D) | 85点 (B) | +20 |
| TD-020 | 75点 (C) | 85点 (B) | +10 |
| **総合** | 88.85点 (B) | **90.38点 (A)** | **+1.53** |
| **残存問題** | 2件 | **0件** | **-2** |

---

### A.2 Session 13 Phase 6: TD-028 AIコード適用機能

#### A.2.1 初期提案と問題点

**初期提案（却下）**: AIチャット内の各コードブロックに「適用」ボタンを配置

**問題点**:
- AI回答は自然言語であり、構造化されていない
- 各回答にボタンを配置するのは非現実的
- どのコードブロックが「最終提案」か判別困難

#### A.2.2 代替案の検討

| 案 | 内容 | 評価 |
|:--:|------|:----:|
| A | 最新コードのみ適用 | △ 最新が希望でない可能性 |
| B | コードブロック抽出表示 | × カスタム開発が必要 |
| C | Undo履歴で対応 | × 複数候補の比較不可 |
| **D** | **ユーザーによる範囲選択** | **✅ 採用** |

#### A.2.3 「AIが直接修正」の議論

**ユーザーからの質問**: 「AIがCode panelを直接修正できないの？」

**技術的回答**:
- AI（LLM）はテキストイン・テキストアウトのAPI
- AIにはブラウザやMonaco Editorへのアクセス手段がない
- Function Calling / Tool UseもOpenRouter制約で使用不可

**解決策**:
- 「AI直接修正」はユーザー視点の抽象化
- 実際は「AIがコードを返す → システムが適用する」
- ユーザー体験としては「クリック一つでコードが更新」が実現可能

#### A.2.4 依頼文の重要性

**初期の依頼文（問題あり）**:
```
○○を△△で修正せよ
```

**問題点**:
- 機械的置換のみで、意図が伝わらない
- 構造追加（loopで囲む等）に対応できない

**改善後の依頼文**:
```
【コード修正実行】
■ ユーザーの依頼「${originalRequest}」
■ 修正対象 ...
■ 適用コード ...
■ 指示 上記の依頼意図に基づき...
```

**改善点**:
- 「元の依頼」を含めることで意図が明確に
- 構造化により各要素の役割が明確
- 出力形式の制約で抽出しやすく

#### A.2.5 技術的制約の明確化

| 能力 | 可否 | 理由 |
|------|:----:|------|
| テキストを受け取る | ✅ | LLM APIの基本機能 |
| テキストを返す | ✅ | LLM APIの基本機能 |
| Code panel（Monaco Editor）を直接操作 | ❌ | AIにはブラウザアクセス手段がない |
| ブラウザDOMを操作 | ❌ | AIはテキストイン・テキストアウトのAPI |
| Function Calling / Tool Use | ❌ | OpenRouter + 多様LLMのため使用不可 |

#### A.2.6 システムの技術的能力

| 能力 | 可否 | 実現方法 |
|------|:----:|---------|
| AI応答からコードを抽出 | ✅ | `@startuml`〜`@enduml` パターン検出（正規表現） |
| Code panelを更新 | ✅ | Monaco Editor API (`editor.setValue()`) |
| Preview を更新 | ✅ | PlantUML レンダリング API |
| 選択要素のハイライト | ✅ | Monaco Editor Decorations API |

#### A.2.7 決定事項サマリー

| カテゴリ | 決定項目 | 決定内容 |
|---------|---------|---------|
| **技術制約** | AI直接修正 | 不可能（システム経由で適用） |
| **対象選択（GUI）** | 選択方法 | メッセージカードクリック、累積選択 |
| **対象選択（Code）** | 選択方法 | トグルボタン → ドラッグ選択 |
| **選択連動** | 3パネル連動 | GUI/Code/Preview すべてでハイライト |
| **AI回答選択** | 選択方法 | トグルボタン → ドラッグ選択 |
| **適用処理** | 適用方式 | 確認ダイアログ → AI送信 → 結果適用 |
| **適用処理** | Undo | Ctrl+Z 1回で全復元 |
| **エラー処理** | 構文エラー | AIに修正依頼（ワンボタン）|
| **依頼文** | フォーマット | 構造化形式（元依頼 + 対象 + 適用コード + 指示） |

---

### A.3 Session 13 Phase 7: エラー修正機能

#### A.3.1 ユーザーからのフィードバック（4点）

Phase 6のTD-028詳細設計に対して、ユーザーから以下4点のフィードバックがあった：

| # | フィードバック | 対応内容 |
|:-:|---------------|---------|
| 1 | **エラー周辺コード** | 「完全コードがあるからOKだろう」という甘い考えを修正 → 周辺コード(± 5行)を必須に |
| 2 | **回数制限の警告** | 「5回連続エラーでAIが諦める」では説明不足 → 5回目に警告、6回目以降は非活性化 |
| 3 | **MVP範囲の確認** | 「エラー修正はMVPか」の確認 → TD-028はMVP必須 |
| 4 | **エラー表示場所** | 「AIチャット欄に表示？」 → 不使用（会話履歴汚染防止）、Previewパネル上部バナーを使用 |

#### A.3.2 エラー通知方式の決定

| 要素 | 実装 | 理由 |
|------|------|------|
| **Monaco Editor ハイライト** | 黄色背景（TD-017準拠）| エラー箇所を視覚的に明示 |
| **インラインバナー** | Preview上部に表示 | ワークフロー中断を避ける |
| **AIチャット欄** | **使用しない** | 会話履歴の汚染を防止 |
| **モーダル** | **使用しない** | 作業フローの中断を防止 |

#### A.3.3 エラー周辺コードの重要性

**なぜエラー周辺コードが必要か**:
- AIの会話履歴はコンテキストウィンドウの制限で失われる可能性
- 周辺コンテキストがあると、AIがエラー原因をより正確に特定できる
- 特に長いPlantUMLコードの場合、エラー箇所のみでは文脈不足

**送信内容**:
| 項目 | 内容 | 必須 |
|------|------|:----:|
| **元の依頼** | ユーザーの最初の修正依頼 | ✅ |
| **エラーメッセージ** | PlantUMLバリデーションエラー | ✅ |
| **エラー行番号** | 構文エラーの発生行 | ✅ |
| **エラー周辺コード** | エラー行 ± 5行（計11行）| ✅ |
| **完全コード** | @startuml〜@enduml全体 | ✅ |
| **前回試行履歴** | 過去の修正試行とエラー内容 | ✅ |

#### A.3.4 回数制限と警告

| 試行回数 | システム動作 |
|:--------:|-------------|
| 1〜4回目 | 通常のエラー再生成処理（バナー表示 → 再生成 → 自動適用）|
| **5回目** | **警告メッセージ表示** + 再生成ボタン有効 + 手動修正推奨メッセージ |
| 6回目以降 | 再生成ボタン**非活性化**、手動修正のみ可能 |

#### A.3.5 自動適用の技術的仕組み

**「自動適用」とは**:
エラー再生成後、ユーザーが範囲選択や「適用」ボタンを押さずとも、
システムがAI応答からコードを抽出し自動でCode panelに反映する仕組み。

**技術的には通常適用と同一**:
```
【通常適用フロー】
ユーザー → AI回答から範囲選択 → 「適用」クリック
  → システムがAIに修正依頼送信
  → AI応答受信
  → @startuml〜@enduml抽出（正規表現）
  → Monaco Editor setValue()
  → 構文検証 → エラーあり → エラー処理へ

【エラー再生成フロー（自動適用）】
ユーザー → 「再生成」クリック
  → システムがAIにエラー修正依頼送信
  → AI応答受信
  → @startuml〜@enduml抽出（正規表現）★
  → Monaco Editor setValue()           ★ ← 自動適用（ユーザー操作不要）
  → 構文検証
    → エラーなし → 完了、バナー消去
    → エラーあり → エラー処理ループ（試行回数+1）
```

#### A.3.6 決定事項サマリー

| カテゴリ | 項目 | 決定内容 |
|---------|------|---------|
| **通知方式** | エラー表示 | Previewパネル上部のインラインバナー |
| **通知方式** | AIチャット | **使用しない**（会話履歴汚染防止）|
| **通知方式** | モーダル | **使用しない**（フロー中断防止）|
| **通知方式** | Monaco | 黄色背景ハイライト（TD-017準拠）|
| **送信内容** | エラー周辺コード | **必須**（± 5行 = 計11行）|
| **送信内容** | 試行履歴 | **必須**（AIが同じ修正を繰り返さないため）|
| **適用方式** | 自動適用 | AI応答から自動抽出・自動setValue()（通常適用と同一技術）|
| **回数制限** | 警告 | **5回目**に警告メッセージ |
| **回数制限** | 上限 | 6回目以降は再生成ボタン非活性化 |

---

### A.4 Session 13 Phase 8: 階層的憲法システム

#### A.4.1 問題提起

**現状の問題（ハードコードされたプロンプト）**:

| 問題 | 影響 |
|------|------|
| LLMごとに生成品質が異なる | Claude/GPT/Gemini/Llamaで出力傾向が違う |
| PlantUML構文エラーが頻発 | 図表タイプごとに既知の制限がある |
| プロンプト修正 = コード修正 | デプロイが必要、改善サイクルが遅い |
| A/Bテストが困難 | プロンプト効果測定ができない |
| 組み合わせ爆発 | 5 LLM × 10 図表 = 50パターンの個別対応が困難 |

**根本原因**:
- AIへの依頼文がソースコードにハードコードされている
- LLMの「癖」や図表の「既知制限」が体系化されていない
- 運用で得た知見をプロンプトに反映する仕組みがない

#### A.4.2 解決策：階層的憲法システム

**コンセプト**:
- **憲法（Constitution）**: AIが守るべきルール・制約を外部ファイルで定義
- **階層構造**: 共通→LLM固有→図表固有→組み合わせ固有の4層で継承
- **動的マージ**: 実行時に適切な憲法を組み合わせてプロンプトを生成
- **即時反映**: YAMLファイル更新のみでデプロイ不要

**アーキテクチャ概要**:
```
┌─────────────────────────────────────────────────────────────────┐
│                    階層的憲法システム                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Layer 1: 基底憲法（Base Constitution）                   │   │
│  │ ・全LLM・全図表共通ルール                                │   │
│  │ ・@startuml必須、出力形式、基本禁止事項                  │   │
│  └────────────────────────┬────────────────────────────────┘   │
│                           │                                     │
│           ┌───────────────┴───────────────┐                     │
│           ▼                               ▼                     │
│  ┌─────────────────┐             ┌─────────────────┐           │
│  │ Layer 2: LLM層  │             │ Layer 3: 図表層 │           │
│  │ ・claude.yaml   │             │ ・sequence.yaml │           │
│  │ ・gpt4.yaml     │             │ ・class.yaml    │           │
│  │ ・gemini.yaml   │             │ ・activity.yaml │           │
│  │ ・llama.yaml    │             │ ・usecase.yaml  │           │
│  └────────┬────────┘             └────────┬────────┘           │
│           │                               │                     │
│           └───────────────┬───────────────┘                     │
│                           ▼                                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │ Layer 4: 組み合わせ層（Combined）                        │   │
│  │ ・claude_activity.yaml（特定組み合わせの問題対応）       │   │
│  │ ・gpt4_sequence.yaml                                     │   │
│  │ ・必要な場合のみ作成（全組み合わせは不要）               │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

#### A.4.3 各層の責務

| 層 | ファイル | 責務 | 内容例 |
|:--:|---------|------|--------|
| **Layer 1** | `base.yaml` | 全共通ルール | @startuml必須、単一ブロック出力、説明文禁止 |
| **Layer 2** | `llm/*.yaml` | LLMの癖対応 | Claude:説明抑制、GPT:冗長防止、Gemini:特定構文回避 |
| **Layer 3** | `diagram/*.yaml` | 図表固有構文 | Activity:if内遷移禁止、Sequence:activate対応 |
| **Layer 4** | `combined/*.yaml` | 特定問題対応 | Claude+Activity:partition内if回避 |

**ファイル数の現実**:
- Layer 1: 1ファイル
- Layer 2: 4〜5ファイル（主要LLM）
- Layer 3: 6〜10ファイル（主要図表）
- Layer 4: 必要時のみ（0〜10ファイル）

**合計: 約15〜25ファイル**（50パターンではなく）

#### A.4.4 運用改善サイクル

```
┌─────────────────────────────────────────────────────────────────┐
│                    憲法改善サイクル                              │
├─────────────────────────────────────────────────────────────────┤
│  ① エラー発生・品質問題検出                                     │
│                    ▼                                            │
│  ② 原因分析                                                     │
│     ├─ LLM固有の問題？ → llm/claude.yaml を更新                │
│     ├─ 図表固有の問題？ → diagram/activity.yaml を更新         │
│     └─ 組み合わせ固有？ → combined/claude_activity.yaml を作成 │
│                    ▼                                            │
│  ③ 憲法ファイル更新（YAMLファイルのみ）                         │
│                    ▼                                            │
│  ④ 即時反映（デプロイ不要）                                     │
│                    ▼                                            │
│  ⑤ 効果検証                                                     │
└─────────────────────────────────────────────────────────────────┘
```

#### A.4.5 憲法ファイル仕様

**共通スキーマ**:
```typescript
interface Constitution {
  version: string;
  type: 'base' | 'llm' | 'diagram' | 'combined';
  extends?: string | string[];
  target?: string;                    // LLM名 or 図表名
  target_llm?: string;                // combined用
  target_diagram?: string;            // combined用

  // ルール定義
  requirements?: string[];            // 必須ルール
  prohibitions?: string[];            // 禁止事項
  recommendations?: string[];         // 推奨事項

  // 追加ルール（継承時）
  additional_requirements?: string[];
  additional_prohibitions?: string[];
  additional_recommendations?: string[];

  // 出力形式
  output_format?: {
    wrapper?: string;                 // コードラッパー
    single_block?: boolean;           // 単一ブロック強制
    no_explanation?: boolean;         // 説明文禁止
    max_lines?: number;               // 最大行数
  };

  // 既知の問題（運用知見）
  known_issues?: {
    id: string;
    description: string;
    workaround: string;
  }[];

  // メタ情報
  notes?: string[];
  updated_at?: string;
  updated_by?: string;
}
```

#### A.4.6 憲法ファイル実例

**base.yaml（Layer 1: 基底憲法）**:
```yaml
version: "1.0.0"
type: "base"
updated_at: "2025-12-29"

# 全LLM・全図表に適用される基本ルール
requirements:
  - "必ず @startuml で開始し @enduml で終了する"
  - "コードブロックは1つのみ出力する"
  - "説明文や前置きは出力しない、コードのみ"
  - "指示された出力形式を厳守する"

prohibitions:
  - "複数の @startuml〜@enduml ブロックを出力しない"
  - "「以下のコードを...」等の前置きを出力しない"
  - "コード後の解説や補足を出力しない"
  - "未完成のコード（...や省略記号）を出力しない"

recommendations:
  - "シンプルで読みやすい構造を心がける"
  - "不要な装飾（skinparam過多）を避ける"

output_format:
  single_block: true
  no_explanation: true

notes:
  - "この憲法は全てのLLM・図表に継承される"
  - "Layer 2-4 で上書き・追加可能"
```

**diagram/activity.yaml（Layer 3: アクティビティ図固有）**:
```yaml
version: "1.0.0"
type: "diagram"
target: "activity"
extends: "base"
updated_at: "2025-12-29"

additional_requirements:
  - "endif後に1行アクションを入れてからスイムレーン遷移する"
  - "複雑な分岐はnoteで説明を補足する"
  - "開始点(@startuml直後)と終了点(stop/end)を明確にする"

additional_prohibitions:
  - "if/elseif/else 内でスイムレーン（|lane|）遷移しない"
  - "fork/join 内でスイムレーン遷移しない"
  - "switch/case 内でスイムレーン遷移しない"
  - "while内でスイムレーン遷移しない"

known_issues:
  - id: "ACT-001"
    description: "if内スイムレーン遷移でレンダリングエラー"
    workaround: "if全体を1スイムレーン内に収め、noteで詳細を説明"
  - id: "ACT-002"
    description: "fork内スイムレーン遷移でレンダリングエラー"
    workaround: "fork全体を1スイムレーン内に収める"
  - id: "ACT-003"
    description: "endif直後のスイムレーン遷移でエラー"
    workaround: "endif後に1行アクション（例: :処理完了;）を入れてから遷移"

notes:
  - "アクティビティ図はPlantUMLの既知制限が多い"
  - "スイムレーン使用時は特に注意が必要"
```

#### A.4.7 インターフェース定義

```typescript
// IConstitutionProvider.ts - 憲法ファイルの読み込みを抽象化
interface IConstitutionProvider {
  load(path: string): Promise<Constitution | null>;
  list(): Promise<string[]>;
  getVersion(path: string): Promise<string | null>;
}

// IConstitutionResolver.ts - 階層的な憲法解決を抽象化
interface IConstitutionResolver {
  resolve(llm: LLMType, diagramType: DiagramType): Promise<ResolvedConstitution>;
}

interface ResolvedConstitution {
  requirements: string[];
  prohibitions: string[];
  recommendations: string[];
  outputFormat: OutputFormat;
  knownIssues: KnownIssue[];
  resolvedFrom: string[];    // マージ元ファイル一覧
  resolvedAt: Date;
}

// IPromptBuilder.ts - プロンプト構築を抽象化
interface IPromptBuilder {
  build(context: PromptContext): Promise<string>;
}

interface PromptContext {
  type: 'apply' | 'error_fix' | 'generate';
  llm: LLMType;
  diagramType: DiagramType;
  userRequest: string;
  currentCode?: string;
  targetElements?: SelectedElement[];
  appliedCode?: string;
  errorInfo?: ErrorInfo;
  attemptHistory?: AttemptRecord[];
}

type LLMType = 'claude' | 'gpt4' | 'gemini' | 'llama' | 'mistral';
type DiagramType = 'sequence' | 'class' | 'activity' | 'usecase' | 'state' | 'component';
```

#### A.4.8 優先度と実装計画

| 優先度 | 内容 | 対応時期 |
|:------:|------|:--------:|
| **MVP** | TD-028基本機能（固定プロンプト） | v1.0 |
| **v1.1** | 階層的憲法システム（FileConstitutionProvider） | v1.1 |
| v2.0 | SupabaseConstitutionProvider（DB管理） | v2.0 |
| v2.0 | 管理UI（憲法編集画面） | v2.0 |

---

### A.5 品質監査対応（Session 13 Phase 9）

#### A.5.1 監査の背景

ユーザーからの要請：「品質が最優先の評価軸」「正確さが重要」「情報の消失が心配」「トレーサビリティを高める必要がある」

#### A.5.2 監査結果

**品質監査レポート（03_quality_audit_report.md）で特定された課題**:

| カテゴリ | 課題 | 対応 |
|---------|------|------|
| **型定義** | 4種類の不足（OutputFormat, KnownIssue, ErrorInfo, ITemplateEngine） | v9.0で完全版追加 |
| **トレーサビリティ** | UC→TD→仕様→実装の追跡困難 | トレーサビリティマトリクス追加 |
| **重複** | 約11%の冗長コンテンツ | 参照形式で正規化 |
| **目次** | なし | v9.0で目次追加 |

#### A.5.3 v9.0での対応

| 追加セクション | 内容 |
|---------------|------|
| **§1 目次** | 全セクションへのナビゲーション |
| **§8 トレーサビリティマトリクス** | UC→TD→仕様→実装コンポーネントの対応表 |
| **§9 完全型定義** | 不足していた4型 + Monaco API定義 |
| **§10 統合決定事項** | 全決定事項の一覧（参照先付き） |
| **付録A** | 議論履歴の詳細記録（本セクション） |

#### A.5.4 禁止事項

**オリジナルファイル（02_screen_composition_analysis.md）の直接修正は禁止**

- v9.0は別ファイルとして作成
- オリジナルは監査・比較のために保存
- 情報の消失を防止

---

### A.6 関連ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| `technical_decisions.md` | TD-017〜TD-033定義 |
| `02_screen_composition_analysis.md` | オリジナル版（v3.2、2709行） |
| `03_quality_audit_report.md` | 品質監査レポート |
| `02_screen_composition_analysis_v9.md` | 本ドキュメント（改善版） |

---

*End of Document v9.0*
