# 検索機能設計書

**作成日**: 2025-12-27
**関連UC**: UC 3-10（学習コンテンツ検索）
**関連TD**: TD-006（Storage Only MVP）、TD-007（AI機能プロバイダー構成）

---

## 1. 概要

PlantUML Studioにおける検索機能の設計方針を定義する。

### 1.1 検索対象

| 対象 | 検索可能な属性 | ユースケース |
|------|---------------|-------------|
| **プロジェクト** | 名前、説明、作成日、更新日 | 「前に作ったあのプロジェクト」を探す |
| **図表** | ファイル名、種類(PlantUML/Excalidraw)、所属PJ | 「認証のシーケンス図」を探す |
| **学習コンテンツ** | タイトル、本文、カテゴリ | UC 3-10（構文や例を探す） |

### 1.2 TD-006（Storage Only MVP）との整合性

**制約**: MVPはデータベースなし → Storage APIのみ

| 検索方式 | MVP可能性 | 理由 |
|----------|:---------:|------|
| ファイル名検索 | ✅ | Storage metadata取得可能 |
| ファイル内容検索 | ⚠️ | 全ファイル読込が必要（高コスト） |
| 全文検索 | ❌ | DB必須（v3で対応） |
| セマンティック検索 | ❌ | Embedding + DB必須（v3+） |

---

## 2. MVP検索機能設計

### 2.1 グローバル検索（ヘッダー）

**配置**: 全画面共通ヘッダー中央

```
┌─────────────────────────────────────────────────────┐
│ PlantUML Studio  [🔍 プロジェクト・図表を検索...]  [👤]│
└─────────────────────────────────────────────────────┘
```

**機能仕様**:

| 項目 | 仕様 |
|------|------|
| 検索対象 | プロジェクト名、図表名 |
| 検索方式 | インクリメンタル検索（部分一致） |
| デバウンス | 200ms |
| キーボードショートカット | Ctrl+K / Cmd+K |
| 結果表示 | ドロップダウン（タイプ別グループ化） |
| 最大表示件数 | 各タイプ5件（「もっと見る」で全件） |

**検索結果UI**:

```
┌─────────────────────────────────────────────────────┐
│ 🔍 認証                                    [×]      │
├─────────────────────────────────────────────────────┤
│ プロジェクト                                        │
│   📁 認証システム設計          更新: 2025-12-25    │
│   📁 OAuth認証PoC              更新: 2025-12-20    │
├─────────────────────────────────────────────────────┤
│ 図表                                                │
│   📊 認証シーケンス図.puml     PJ: 認証システム設計 │
│   📊 認証フロー.puml           PJ: OAuth認証PoC    │
│   📊 認証クラス図.puml         PJ: 認証システム設計 │
├─────────────────────────────────────────────────────┤
│ [Enter]開く [↑↓]移動 [Esc]閉じる                   │
└─────────────────────────────────────────────────────┘
```

### 2.2 学習コンテンツ検索（UC 3-10）

**配置**: 学習コンテンツ画面専用

```
┌─────────────────────────────────────────────────────┐
│ 学習コンテンツ                                      │
├────────────┬────────────────────────────────────────┤
│ カテゴリ    │ [🔍 構文・例を検索...]                │
│            │                                        │
│ ▼ 基本構文  │ 検索結果: "クラス図" (3件)            │
│   シーケンス │                                        │
│   クラス    │ ┌────────────────────────────────────┐ │
│   アクティビティ│ │ 📖 クラス図の基本構文              │ │
│            │ │    class定義、継承、実装...         │ │
│ ▼ 応用     │ ├────────────────────────────────────┤ │
│   デザインパターン│ │ 📖 クラス図のスタイリング          │ │
│   大規模図表 │ │    skinparam、色設定...            │ │
│            │ └────────────────────────────────────┘ │
└────────────┴────────────────────────────────────────┘
```

**機能仕様**:

| 項目 | 仕様 |
|------|------|
| 検索対象 | タイトル、本文、カテゴリ |
| 検索方式 | キーワードマッチ（AND検索） |
| カテゴリフィルタ | サイドバーで選択可能 |
| 結果表示 | カード形式（スニペット付き） |
| ハイライト | 検索キーワードを強調表示 |

---

## 3. 実装方式

### 3.1 MVP推奨: クライアントサイドフィルタ

**理由**:
- Storage APIのみでDB不要
- 小〜中規模データ（〜100件）で十分なパフォーマンス
- 実装コストが低い

**実装イメージ**:

```typescript
// hooks/useSearch.ts
import { useMemo, useState } from 'react';
import { useDebouncedValue } from '@/hooks/useDebouncedValue';

interface SearchResults {
  projects: Project[];
  diagrams: Diagram[];
}

export function useSearch(
  projects: Project[],
  diagrams: Diagram[]
): {
  query: string;
  setQuery: (q: string) => void;
  results: SearchResults;
  isSearching: boolean;
} {
  const [query, setQuery] = useState('');
  const debouncedQuery = useDebouncedValue(query, 200);

  const results = useMemo(() => {
    if (!debouncedQuery.trim()) {
      return { projects: [], diagrams: [] };
    }

    const q = debouncedQuery.toLowerCase();

    return {
      projects: projects
        .filter(p => p.name.toLowerCase().includes(q))
        .slice(0, 5),
      diagrams: diagrams
        .filter(d => d.name.toLowerCase().includes(q))
        .slice(0, 5),
    };
  }, [debouncedQuery, projects, diagrams]);

  return {
    query,
    setQuery,
    results,
    isSearching: query !== debouncedQuery,
  };
}
```

### 3.2 検索コンポーネント構成

```
components/
├── search/
│   ├── GlobalSearch.tsx       # ヘッダー検索バー
│   ├── SearchResults.tsx      # 検索結果ドロップダウン
│   ├── SearchResultItem.tsx   # 結果アイテム
│   ├── LearningSearch.tsx     # 学習コンテンツ検索
│   └── useSearch.ts           # 検索フック
```

---

## 4. UXパターン

### 4.1 採用パターン

| パターン | 説明 | 採用 |
|----------|------|:----:|
| **インスタント検索** | 入力と同時に結果表示（debounce 200ms） | ✅ |
| Enterで検索 | Enter押下後に検索実行 | ❌ |
| **キーボードナビ** | ↑↓で結果選択、Enterで開く | ✅ |
| **Escで閉じる** | Escキーで検索結果を閉じる | ✅ |
| **フォーカス時に履歴** | 空の状態で最近のアイテム表示 | ✅ |
| 検索履歴保存 | 過去の検索キーワード保存 | ⭕ v2 |
| オートコンプリート | 入力候補表示 | ⭕ v2 |

### 4.2 空状態・エラー処理

| 状態 | 表示内容 |
|------|---------|
| 検索前（フォーカス時） | 最近のプロジェクト・図表（5件ずつ） |
| 検索中 | ローディングインジケーター |
| 結果0件 | 「"〇〇"に一致する結果はありません」 |
| エラー | 「検索中にエラーが発生しました。再試行してください」 |

---

## 5. フェーズ別ロードマップ

| Phase | 検索機能 | 技術要件 | 優先度 |
|:-----:|----------|---------|:------:|
| **MVP** | プロジェクト名・図表名検索 | Storage API + Client filter | P1 |
| **MVP** | 学習コンテンツ検索（UC 3-10） | API Routes + Text match | P1 |
| **MVP** | キーボードショートカット | クライアント実装 | P2 |
| v2 | 検索履歴 | LocalStorage | P3 |
| v3 | 図表内容の全文検索 | DB + Full-text index | P2 |
| v3 | 高度なフィルタ（日付、タイプ） | DB queries | P3 |
| v4+ | セマンティック検索 | Embedding (TD-007) + pgvector | P3 |

---

## 6. 画面サイズ対応

### 6.1 検索バーのレスポンシブ設計

| ビューポート | 検索バー幅 | 配置 |
|-------------|-----------|------|
| ≥1920px | 400px | ヘッダー中央 |
| 1366-1919px | 300px | ヘッダー中央 |
| 1280-1365px | 280px | ヘッダー中央 |
| <1280px | アイコンのみ | クリックで展開 |

---

## 7. アクセシビリティ

| 要件 | 対応 |
|------|------|
| キーボード操作 | Ctrl+K、↑↓、Enter、Esc |
| スクリーンリーダー | aria-label、role="search"、aria-live |
| フォーカス管理 | 検索結果内でフォーカストラップ |
| 色のコントラスト | WCAG AA準拠（4.5:1以上） |

---

## 8. 関連ドキュメント

| ドキュメント | パス |
|-------------|------|
| TD-006 Storage設計 | `docs/context/technical_decisions.md` §TD-006 |
| TD-007 AI機能構成 | `docs/context/technical_decisions.md` §TD-007 |
| UC図 | `docs/proposals/02_ユースケース図_20251130.md` |
| ダッシュボードWF | `../02_dashboard.excalidraw` |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-27 | 初版作成 |
