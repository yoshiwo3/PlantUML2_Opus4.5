@startuml PlantUML_Studio_Sequence_LLMUsageMonitor
'==================================================
' ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³: LLMä½¿ç”¨é‡ç›£è¦–ãƒ•ãƒ­ãƒ¼
' UC 5-7 LLMä½¿ç”¨é‡ã‚’ç›£è¦–ã™ã‚‹
' åŸºæº–: æ¥­å‹™ãƒ•ãƒ­ãƒ¼å›³ 3.9.2.5, æ©Ÿèƒ½ä¸€è¦§è¡¨ F-ADM-07, ã‚¯ãƒ©ã‚¹å›³ v1.8
' æ¤œè¨¼: Context7 MCP - PlantUML Sequence Diagram
' è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³: DP-001ï¼ˆãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹ï¼‰
'
' ã‚¯ãƒ©ã‚¹å›³æ•´åˆæ€§ç¢ºèª:
'   IUsageLogRepository.getByPeriod(period: DateRange): UsageReport  âœ…
'   IUsageLogRepository.getByModel(modelId, period): UsageLog[]      âœ…
'   IUsageLogRepository.getByUser(userId, period): UsageLog[]        âœ…
'   OpenRouterClient.getCredits(): CreditInfo                        ğŸ” è¿½åŠ ææ¡ˆ
'==================================================

skinparam sequenceArrowThickness 2
skinparam roundcorner 10
skinparam maxmessagesize 200

skinparam participant {
    BackgroundColor #FAFAFA
    BorderColor #666666
}

skinparam note {
    BackgroundColor #FFFDE7
    BorderColor #FBC02D
}

title LLMä½¿ç”¨é‡ç›£è¦–ãƒ•ãƒ­ãƒ¼ï¼ˆUC 5-7ï¼‰

actor Developer as "é–‹ç™ºè€…\n(ç®¡ç†è€…æ¨©é™)"
participant Browser as "ãƒ–ãƒ©ã‚¦ã‚¶\n(Next.js Client)" #E3F2FD
participant APIRoutes as "API Routes\n(/api/admin/usage)" #FFF3E0
participant UsageLogRepo as "IUsageLogRepository\n(Supabaseå®Ÿè£…)" #E8F5E9
participant OpenRouter as "OpenRouter API" #F3E5F5
database SupabaseDB as "Supabase DB\n(llm_usage_logs)" #E1F5FE

== åˆæœŸèª­è¾¼: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º ==

Developer -> Browser : ã€Œä½¿ç”¨é‡ç›£è¦–ã€ã‚’ã‚¯ãƒªãƒƒã‚¯
activate Browser

Browser -> APIRoutes : GET /api/admin/usage\n?period=30d
activate APIRoutes

APIRoutes -> APIRoutes : ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼\n+ ç®¡ç†è€…æ¨©é™ç¢ºèª

note over APIRoutes
  **æ¨©é™ãƒã‚§ãƒƒã‚¯ï¼ˆLL-015ï¼‰**
  - èªè¨¼æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨
  - role = 'developer' ã§ã‚ã‚‹ã“ã¨
end note

alt æœªèªè¨¼ 401
    APIRoutes --> Browser : 401 UNAUTHORIZED
    Browser --> Developer : ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

else æ¨©é™ãªã— 403
    ' LL-001: elseåˆ†å²ã¯ALTé–‹å§‹æ™‚ç‚¹ã®çŠ¶æ…‹ã‚’ç¶™æ‰¿
    APIRoutes --> Browser : 403 FORBIDDEN\n{ error: "DEVELOPER_REQUIRED" }
    Browser --> Developer : ã€Œé–‹ç™ºè€…æ¨©é™ãŒå¿…è¦ã§ã™ã€

else èªè¨¼ãƒ»æ¨©é™OK
    ' ä¸¦åˆ—å‡¦ç†: å†…éƒ¨ãƒ­ã‚° + OpenRouteræ®‹é«˜
    par å†…éƒ¨ãƒ­ã‚°å–å¾—
        APIRoutes -> UsageLogRepo : getByPeriod(period)
        activate UsageLogRepo

        note over UsageLogRepo
          **ã‚¯ãƒ©ã‚¹å›³v1.8æº–æ‹ **
          getByPeriod(period: DateRange): UsageReport
        end note

        UsageLogRepo -> SupabaseDB : SELECT SUM(tokens), SUM(cost),\nmodel_id, feature_type, DATE(created_at)\nFROM llm_usage_logs\nWHERE created_at >= ?\nGROUP BY model_id, feature_type, DATE(created_at)
        activate SupabaseDB
        SupabaseDB --> UsageLogRepo : usage_logs[]
        deactivate SupabaseDB

        UsageLogRepo --> APIRoutes : UsageReport\n{ totalTokens, totalCost,\n  byModel[], byFeature[],\n  dailyTrend[] }
        deactivate UsageLogRepo

    else OpenRouteræ®‹é«˜å–å¾—
        APIRoutes -> OpenRouter : GET /api/v1/key\n(Authorization: Bearer API_KEY)
        activate OpenRouter

        note over OpenRouter
          **DP-001: ãƒ¬ã‚¸ãƒªã‚¨ãƒ³ã‚¹è¨­å®š**
          - timeout: 10ç§’
          - retry: 2å›ï¼ˆexponential backoffï¼‰
          - fallback: æ®‹é«˜ä¸æ˜ã§ç¶™ç¶š
        end note

        alt ã‚µãƒ¼ãƒ“ã‚¹éšœå®³/ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            OpenRouter --> APIRoutes : ServiceError / Timeout
            deactivate OpenRouter

            note right of APIRoutes
              **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†**
              æ®‹é«˜æƒ…å ±=null ã¨ã—ã¦
              ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤ºã¯ç¶™ç¶š
            end note

            APIRoutes -> APIRoutes : creditInfo = null\n(æ®‹é«˜ä¸æ˜ãƒ•ãƒ©ã‚°è¨­å®š)

        else æ­£å¸¸
            OpenRouter --> APIRoutes : { data: { credits, usage } }
            deactivate OpenRouter
        end
    end

    APIRoutes --> Browser : 200 OK\n{ usageReport, creditInfo }
    Browser -> Browser : ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º\n- ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæ®‹é«˜\n- æœŸé–“åˆ¥ä½¿ç”¨é‡ã‚°ãƒ©ãƒ•\n- ãƒ¢ãƒ‡ãƒ«åˆ¥ã‚³ã‚¹ãƒˆå†…è¨³\n- æ©Ÿèƒ½åˆ¥ãƒˆãƒ¼ã‚¯ãƒ³æ•°
    Browser --> Developer : ä½¿ç”¨é‡ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º
end

deactivate APIRoutes
deactivate Browser

== è©³ç´°ãƒ•ã‚£ãƒ«ã‚¿: æœŸé–“ãƒ»ãƒ¢ãƒ‡ãƒ«ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ ==

Developer -> Browser : ãƒ•ã‚£ãƒ«ã‚¿æ¡ä»¶ã‚’å¤‰æ›´\n(æœŸé–“/ãƒ¢ãƒ‡ãƒ«/ãƒ¦ãƒ¼ã‚¶ãƒ¼)
activate Browser

Browser -> APIRoutes : GET /api/admin/usage\n?period=7d&modelId=xxx&userId=yyy
activate APIRoutes

APIRoutes -> APIRoutes : ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼\n+ ç®¡ç†è€…æ¨©é™ç¢ºèª

alt æœªèªè¨¼/æ¨©é™ãªã—
    APIRoutes --> Browser : 401/403
    Browser --> Developer : ã‚¨ãƒ©ãƒ¼è¡¨ç¤º

else èªè¨¼ãƒ»æ¨©é™OK
    APIRoutes -> APIRoutes : ãƒ•ã‚£ãƒ«ã‚¿ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è§£æ

    alt ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚£ãƒ«ã‚¿æŒ‡å®šã‚ã‚Š
        APIRoutes -> UsageLogRepo : getByModel(modelId, period)
        activate UsageLogRepo

        note over UsageLogRepo
          **ã‚¯ãƒ©ã‚¹å›³v1.8æº–æ‹ **
          getByModel(modelId: String, period: DateRange): UsageLog[]
        end note

        UsageLogRepo -> SupabaseDB : SELECT * FROM llm_usage_logs\nWHERE model_id = ?\nAND created_at >= ?
        activate SupabaseDB
        SupabaseDB --> UsageLogRepo : usage_logs[]
        deactivate SupabaseDB

        UsageLogRepo --> APIRoutes : UsageLog[]
        deactivate UsageLogRepo

    else ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿æŒ‡å®šã‚ã‚Š
        APIRoutes -> UsageLogRepo : getByUser(userId, period)
        activate UsageLogRepo

        note over UsageLogRepo
          **ã‚¯ãƒ©ã‚¹å›³v1.8æº–æ‹ **
          getByUser(userId: UUID, period: DateRange): UsageLog[]
        end note

        UsageLogRepo -> SupabaseDB : SELECT * FROM llm_usage_logs\nWHERE user_id = ?\nAND created_at >= ?
        activate SupabaseDB
        SupabaseDB --> UsageLogRepo : usage_logs[]
        deactivate SupabaseDB

        UsageLogRepo --> APIRoutes : UsageLog[]
        deactivate UsageLogRepo

    else æœŸé–“ã®ã¿
        APIRoutes -> UsageLogRepo : getByPeriod(period)
        activate UsageLogRepo

        UsageLogRepo -> SupabaseDB : SELECT ... FROM llm_usage_logs\nWHERE created_at >= ?
        activate SupabaseDB
        SupabaseDB --> UsageLogRepo : usage_logs[]
        deactivate SupabaseDB

        UsageLogRepo --> APIRoutes : UsageReport
        deactivate UsageLogRepo
    end

    APIRoutes --> Browser : 200 OK\n{ filteredData }
    Browser -> Browser : ãƒ•ã‚£ãƒ«ã‚¿çµæœè¡¨ç¤º\n(ã‚°ãƒ©ãƒ•/ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°)
    Browser --> Developer : ãƒ•ã‚£ãƒ«ã‚¿çµæœè¡¨ç¤º
end

deactivate APIRoutes
deactivate Browser

@enduml
