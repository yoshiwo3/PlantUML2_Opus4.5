# Instructions - UC 5-7 LLM使用量監視 シーケンス図

**作成日時**: 2025-12-22 08:54
**対象UC**: UC 5-7 LLM使用量を監視する
**Evidence**: `docs/evidence/20251222_0854_sequence_llm_usage_monitor/`

---

## 目標

UC 5-7 LLM使用量監視のシーケンス図を作成し、統合版に追記する。

---

## 参照ドキュメント

| ドキュメント | 内容 |
|-------------|------|
| `03_業務フロー図_20251201.md` §3.9.2.5 | LLM使用量監視フロー |
| `05_機能一覧表_20251213.md` F-ADM-07 | LLM使用量監視機能詳細 |
| `06_クラス図_20251208.md` | UsageLogRepository, LLMConfigService |
| `08_シーケンス図_20251214.md` | 統合版（§11 LLMモデル登録の後に追記） |

---

## UC固有分析（設計パターン）

| # | 質問 | 回答 | 適用パターン |
|:-:|------|:----:|-------------|
| 1 | ユーザー入力がリアルタイムか？ | No | - |
| 2 | 外部APIを呼び出すか？ | **Yes** | **DP-001**（OpenRouter API） |
| 3 | 同一リクエストが繰り返されるか？ | Yes | DP-003検討 |
| 4 | 高頻度呼び出しが想定されるか？ | No | - |
| 5 | 機密データを扱うか？ | No | - |
| 6 | 複数サービスを跨ぐか？ | Yes | DP-006検討 |

**適用するDP**:
- **DP-001**: OpenRouter API呼び出しにタイムアウト・リトライ・503

---

## 業務フロー概要

1. 開発者が「使用量監視」をクリック
2. Frontend Serviceが並行処理:
   - 内部ログ取得 → Supabase llm_usage_logs集計
   - OpenRouter残高取得 → /api/v1/key呼び出し
3. 使用量ダッシュボード表示
   - クレジット残高
   - 期間別使用量グラフ
   - モデル別コスト内訳
   - 機能別トークン数
4. 詳細確認（期間・フィルタ選択）オプション

---

## 完了条件

- [ ] PlantUMLコード作成
- [ ] Phase 1-B: 視覚品質評価 90点以上
- [ ] Phase 1-A: コード品質評価 90点以上
- [ ] SVG生成・統合版追記
- [ ] Phase 2: ドキュメント品質評価 90点以上
- [ ] active_context.md更新
- [ ] SERENA Memory保存
