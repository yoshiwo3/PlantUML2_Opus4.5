# 3.9 管理機能フロー（MVP）

**関連ユースケース**: UC 5-1 ユーザーを管理する, UC 5-2〜5-5 LLM管理, UC 5-7〜5-8 LLM監視・フォールバック, UC 5-13 システム設定を変更する
**アクター**: 開発者（管理者権限）
**技術決定**: TD-007（AI機能プロバイダー構成）

---

## 設計思想

管理機能は**開発者専用**の機能であり、エンドユーザーはアクセスできない。
TD-007に基づき、AI機能はLLM（OpenRouter経由）とEmbedding（OpenAI直接）で分離されている。
MVPでは**LLM管理**に焦点を当て、Embedding管理・学習コンテンツ管理はPhase 2で実装する。

### アクセス制御

| 機能 | エンドユーザー | 管理者 | 開発者 |
|------|:-------------:|:------:|:------:|
| AIチャット利用 | ✅ | ✅ | ✅ |
| LLMモデル設定閲覧 | ❌ | ✅ | ✅ |
| LLMモデル設定変更 | ❌ | ❌ | ✅ |
| 使用量閲覧 | ❌ | ✅ | ✅ |
| システム設定変更 | ❌ | ❌ | ✅ |

### MVP管理機能一覧

| UC | 機能名 | カテゴリ | LLM設計書参照 |
|:--:|--------|----------|:------------:|
| 5-1 | ユーザーを管理する | 5-A. ユーザー管理 | - |
| 5-2 | LLMモデルを登録する | 5-B. LLM管理 | LM-01 |
| 5-3 | LLMモデルを切り替える | 5-B. LLM管理 | LM-02 |
| 5-4 | LLMプロンプトを管理する | 5-B. LLM管理 | LM-03 |
| 5-5 | LLMパラメータを設定する | 5-B. LLM管理 | LM-04 |
| 5-7 | LLM使用量を監視する | 5-B. LLM管理 | LM-06 |
| 5-8 | LLMフォールバックを設定する | 5-B. LLM管理 | LM-07 |
| 5-13 | システム設定を変更する | 5-E. システム設定 | - |

---

## 3.9 概要図

```plantuml
@startuml business_flow_admin_overview
skinparam ActivityFontSize 12
skinparam ConditionEndStyle hline

title 業務フロー図 - 管理機能（MVP概要）

|開発者|
start
:管理画面にアクセス;

|Frontend Service|
:権限チェック;
if (開発者権限?) then (はい)
  :管理ダッシュボード表示;
else (いいえ)
  #mistyrose:アクセス拒否;
  stop
endif

|開発者|
switch (管理機能を選択)
case (ユーザー管理\nUC 5-1)
  #lightblue:ユーザー管理画面へ;
  note right
    詳細は 3.9.1 参照
  end note
  detach
case (LLM管理\nUC 5-2〜5-5, 5-7, 5-8)
  #palegreen:LLM管理画面へ;
  note right
    詳細は 3.9.2 参照
  end note
  detach
case (システム設定\nUC 5-13)
  #lightyellow:システム設定画面へ;
  note right
    詳細は 3.9.3 参照
  end note
  detach
case (戻る)
  :ダッシュボードへ;
  stop
endswitch

@enduml
```

---

## 3.9.1 ユーザー管理フロー詳細（UC 5-1）

### 概要

ユーザーの一覧表示、詳細確認、権限変更、無効化を行う。
Supabase Authのユーザー情報を参照・更新する。

### ユーザー管理概要図

```plantuml
@startuml business_flow_user_management_overview
skinparam ActivityFontSize 12
skinparam ConditionEndStyle hline

title 業務フロー図 - ユーザー管理（概要）

|開発者|
start
:ユーザー管理画面へ遷移;

|Frontend Service|
:ユーザー一覧取得\n（Supabase Auth API）;
:一覧表示;
note right
  **表示項目**
  - メールアドレス
  - 認証プロバイダー
  - 最終ログイン日時
  - ステータス（有効/無効）
end note

|開発者|
switch (操作を選択)
case (詳細確認)
  :ユーザーをクリック;
  |Frontend Service|
  #lightblue:ユーザー詳細表示;
  detach
case (権限変更)
  :権限変更をクリック;
  |Frontend Service|
  #palegreen:権限変更ダイアログ;
  note right
    roles: user, admin, developer
  end note
  detach
case (無効化)
  :無効化をクリック;
  |Frontend Service|
  #lightyellow:確認ダイアログ → 無効化実行;
  detach
case (戻る)
  :管理ダッシュボードへ;
  stop
endswitch

@enduml
```

### ユーザー詳細確認フロー

```plantuml
@startuml business_flow_user_detail
skinparam ActivityFontSize 12

title 業務フロー図 - ユーザー詳細確認

|開発者|
start
:ユーザーをクリック;

|Frontend Service|
:ユーザー詳細取得\n（Supabase Admin API）;

|Supabase|
:ユーザー情報返却;
note right
  - user_id
  - email
  - provider (github/google)
  - created_at
  - last_sign_in_at
  - app_metadata (role)
  - user_metadata
end note

|Frontend Service|
:詳細パネル表示;

|開発者|
:内容を確認;
:パネルを閉じる;
stop

@enduml
```

### 権限変更フロー

```plantuml
@startuml business_flow_user_role_change
skinparam ActivityFontSize 12
skinparam ConditionEndStyle hline

title 業務フロー図 - ユーザー権限変更

|開発者|
start
:権限変更ボタンをクリック;

|Frontend Service|
:権限変更ダイアログ表示;
note right
  **選択可能な権限**
  - user: 一般ユーザー
  - admin: 管理者（閲覧権限）
  - developer: 開発者（全権限）
end note

|開発者|
:新しい権限を選択;
:「変更」をクリック;

|Frontend Service|
#lightyellow:確認ダイアログ表示;

|開発者|
if (確認?) then (はい)
  |Frontend Service|
  :権限更新リクエスト;

  |Supabase|
  :app_metadata.role 更新;

  |Frontend Service|
  if (更新成功?) then (はい)
    :一覧更新;
    #palegreen:完了通知;
  else (エラー)
    #mistyrose:エラー通知;
  endif
else (キャンセル)
  |Frontend Service|
  :ダイアログを閉じる;
endif
stop

@enduml
```

### ユーザー無効化フロー

```plantuml
@startuml business_flow_user_disable
skinparam ActivityFontSize 12
skinparam ConditionEndStyle hline

title 業務フロー図 - ユーザー無効化

|開発者|
start
:無効化ボタンをクリック;

|Frontend Service|
#lightyellow:確認ダイアログ表示;
note right
  「このユーザーを無効化しますか？」
  「無効化されたユーザーは
  　ログインできなくなります」
end note

|開発者|
if (確認?) then (はい)
  |Frontend Service|
  :無効化リクエスト;

  |Supabase|
  :ユーザーBAN処理\n（banned_until設定）;

  |Frontend Service|
  if (処理成功?) then (はい)
    :一覧更新;
    #palegreen:完了通知;
  else (エラー)
    #mistyrose:エラー通知;
  endif
else (キャンセル)
  |Frontend Service|
  :ダイアログを閉じる;
endif
stop

@enduml
```

### ユーザー管理フローテーブル

| 操作 | ステップ | 処理内容 | 担当 | エラー処理 |
|------|:-------:|---------|------|-----------|
| 一覧表示 | 1 | ユーザー管理画面へ遷移 | 開発者 | - |
| | 2 | ユーザー一覧取得（Admin API） | Supabase | 失敗時: エラー通知 |
| | 3 | 一覧表示 | Frontend Service | - |
| 詳細確認 | 1 | ユーザーをクリック | 開発者 | - |
| | 2 | ユーザー詳細取得 | Supabase | 失敗時: エラー通知 |
| | 3 | 詳細パネル表示 | Frontend Service | - |
| 権限変更 | 1 | 権限変更ボタンをクリック | 開発者 | - |
| | 2 | 権限選択ダイアログ表示 | Frontend Service | - |
| | 3 | 新しい権限を選択・確認 | 開発者 | キャンセル時: 閉じる |
| | 4 | app_metadata.role更新 | Supabase | 失敗時: エラー通知 |
| 無効化 | 1 | 無効化ボタンをクリック | 開発者 | - |
| | 2 | 確認ダイアログ表示 | Frontend Service | - |
| | 3 | 確認 | 開発者 | キャンセル時: 閉じる |
| | 4 | ユーザーBAN処理 | Supabase | 失敗時: エラー通知 |

---

## 3.9.2 LLM管理フロー（UC 5-2〜5-5, 5-7, 5-8）

### 概要

LLM管理機能は、OpenRouter経由でLLMモデルを管理する。
以下のサブ機能で構成される：

| サブ機能 | UC | 説明 |
|---------|:--:|------|
| モデル登録 | 5-2 | OpenRouterモデルをシステムに登録 |
| モデル切替 | 5-3 | 機能別にアクティブモデルを変更 |
| プロンプト管理 | 5-4 | プロンプトテンプレートのCRUD |
| パラメータ設定 | 5-5 | temperature, max_tokens等の設定 |
| 使用量監視 | 5-7 | コスト・トークン数の監視 |
| フォールバック設定 | 5-8 | 障害時の代替モデル設定 |

### LLM管理概要図

```plantuml
@startuml business_flow_llm_management_overview
skinparam ActivityFontSize 12
skinparam ConditionEndStyle hline

title 業務フロー図 - LLM管理（概要）

|開発者|
start
:LLM管理画面へ遷移;

|Frontend Service|
:LLM管理ダッシュボード表示;
note right
  **表示内容**
  - 登録モデル一覧
  - 機能別割当状況
  - 使用量サマリ
  - フォールバック状態
end note

|開発者|
switch (操作を選択)
case (モデル登録\nUC 5-2)
  #lightblue:モデル登録画面へ;
  note right: 3.9.2.1 参照
  detach
case (モデル切替\nUC 5-3)
  #palegreen:モデル割当画面へ;
  note right: 3.9.2.2 参照
  detach
case (プロンプト管理\nUC 5-4)
  #lightyellow:プロンプト一覧へ;
  note right: 3.9.2.3 参照
  detach
case (パラメータ設定\nUC 5-5)
  #AntiqueWhite:パラメータ設定へ;
  note right: 3.9.2.4 参照
  detach
case (使用量監視\nUC 5-7)
  #LightCyan:使用量ダッシュボードへ;
  note right: 3.9.2.5 参照
  detach
case (フォールバック設定\nUC 5-8)
  #MistyRose:フォールバック設定へ;
  note right: 3.9.2.6 参照
  detach
case (戻る)
  :管理ダッシュボードへ;
  stop
endswitch

@enduml
```

---

### 3.9.2.1 LLMモデル登録フロー（UC 5-2）

OpenRouterで利用可能なモデルをシステムに登録する。

```plantuml
@startuml business_flow_llm_model_register
skinparam ActivityFontSize 12
skinparam ConditionEndStyle hline

title 業務フロー図 - LLMモデル登録（UC 5-2）

|開発者|
start
:「モデル登録」をクリック;

|Frontend Service|
:モデル登録画面表示;
:OpenRouterモデル一覧取得;

|OpenRouter API|
:/api/v1/models 呼び出し;
:利用可能モデル一覧返却;
note right
  300+モデル
  Claude, GPT-4o, Gemini,
  Llama, Mistral 等
end note

|Frontend Service|
:モデル選択UI表示;
note right
  **フィルタオプション**
  - プロバイダー別
  - 機能別（Vision対応等）
  - コスト順
end note

|開発者|
:モデルを選択;
:デフォルトパラメータを設定;
note right
  - temperature: 0.7
  - max_tokens: 4096
  - top_p: 1.0
end note
:「登録」をクリック;

|Frontend Service|
:登録リクエスト送信;

|Supabase|
:llm_models テーブルに挿入;
note right
  model_id, display_name,
  provider, default_*,
  cost情報
end note

|Frontend Service|
if (登録成功?) then (はい)
  :モデル一覧更新;
  #palegreen:完了通知;
else (エラー)
  #mistyrose:エラー通知;
  note right
    重複登録等
  end note
endif
stop

@enduml
```

### 3.9.2.2 LLMモデル切替フロー（UC 5-3）

機能別にアクティブなモデルを変更する。

```plantuml
@startuml business_flow_llm_model_switch
skinparam ActivityFontSize 12
skinparam ConditionEndStyle hline

title 業務フロー図 - LLMモデル切替（UC 5-3）

|開発者|
start
:「モデル割当」をクリック;

|Frontend Service|
:機能別割当一覧表示;
note right
  **機能キー**
  - ai_chat: AIチャット
  - syntax_check: 構文チェック
  - question_start: Question-Start
  - terminology_check: 用語一貫性
end note

|開発者|
:変更する機能を選択;
:新しいモデルを選択;
note right
  登録済みモデルから選択
  オーバーライドパラメータ
  も設定可能
end note
:「適用」をクリック;

|Frontend Service|
#lightyellow:確認ダイアログ表示;
note right
  「ai_chat のモデルを
  　Claude 3.5 Sonnet に
  　変更しますか？」
end note

|開発者|
if (確認?) then (はい)
  |Frontend Service|
  :割当更新リクエスト;

  |Supabase|
  :llm_model_assignments 更新;

  |Frontend Service|
  if (更新成功?) then (はい)
    :割当一覧更新;
    #palegreen:完了通知;
  else (エラー)
    #mistyrose:エラー通知;
  endif
else (キャンセル)
  |Frontend Service|
  :ダイアログを閉じる;
endif
stop

@enduml
```

### 3.9.2.3 LLMプロンプト管理フロー（UC 5-4）

プロンプトテンプレートのCRUD操作を行う。

```plantuml
@startuml business_flow_llm_prompt_management
skinparam ActivityFontSize 12
skinparam ConditionEndStyle hline

title 業務フロー図 - LLMプロンプト管理（UC 5-4）

|開発者|
start
:「プロンプト管理」をクリック;

|Frontend Service|
:プロンプト一覧取得;

|Supabase|
:llm_prompt_templates 取得;

|Frontend Service|
:プロンプト一覧表示;
note right
  **表示項目**
  - 名前・slug
  - カテゴリ（system/user/assistant）
  - 機能キー
  - バージョン
  - ステータス（有効/無効）
end note

|開発者|
switch (操作を選択)
case (新規作成)
  :「新規作成」をクリック;
  |Frontend Service|
  :プロンプトエディタ表示;
  |開発者|
  :プロンプト内容を入力;
  note right
    - 名前・slug
    - カテゴリ
    - 機能キー
    - テンプレート本体
    - 変数定義（JSON Schema）
  end note
  :「保存」をクリック;
  |Supabase|
  :テンプレート挿入;
  detach
case (編集)
  :プロンプトをクリック;
  |Frontend Service|
  :編集エディタ表示;
  |開発者|
  :内容を修正;
  :「保存」をクリック;
  |Supabase|
  :テンプレート更新\n（バージョン+1）;
  :履歴テーブルに旧版保存;
  detach
case (削除/無効化)
  :「無効化」をクリック;
  |Frontend Service|
  #lightyellow:確認ダイアログ;
  |Supabase|
  :is_active = false 更新;
  detach
case (戻る)
  :LLM管理画面へ;
  stop
endswitch

@enduml
```

### 3.9.2.4 LLMパラメータ設定フロー（UC 5-5）

サンプリングパラメータを設定する。

```plantuml
@startuml business_flow_llm_parameter_setting
skinparam ActivityFontSize 12
skinparam ConditionEndStyle hline

title 業務フロー図 - LLMパラメータ設定（UC 5-5）

|開発者|
start
:「パラメータ設定」をクリック;

|Frontend Service|
:パラメータ設定画面表示;
note right
  **設定可能パラメータ**
  - temperature (0.0-2.0)
  - max_tokens (1-∞)
  - top_p (0.0-1.0)
  - top_k (0-∞)
  - frequency_penalty (-2.0-2.0)
  - presence_penalty (-2.0-2.0)
  - stop (停止トークン)
  - seed (再現性シード)
end note

|開発者|
:設定レベルを選択;
note right
  **設定レベル**
  1. システムデフォルト
  2. モデルデフォルト
  3. 機能別オーバーライド
end note

if (設定レベル?) then (モデルデフォルト)
  :モデルを選択;
  :パラメータを調整;
  |Supabase|
  :llm_models.default_* 更新;
else (機能別オーバーライド)
  |開発者|
  :機能を選択;
  :パラメータを調整;
  |Supabase|
  :llm_model_assignments.override_* 更新;
endif

|Frontend Service|
if (更新成功?) then (はい)
  #palegreen:完了通知;
  note right
    「パラメータを更新しました」
  end note
else (エラー)
  #mistyrose:エラー通知;
endif
stop

@enduml
```

### 3.9.2.5 LLM使用量監視フロー（UC 5-7）

コスト・トークン数を監視する。

```plantuml
@startuml business_flow_llm_usage_monitoring
skinparam ActivityFontSize 12
skinparam ConditionEndStyle hline

title 業務フロー図 - LLM使用量監視（UC 5-7）

|開発者|
start
:「使用量監視」をクリック;

|Frontend Service|
fork
  :内部ログ取得;
  |Supabase|
  :llm_usage_logs 集計;
  note right
    日次/週次/月次
    モデル別/機能別
  end note
fork again
  :OpenRouter残高取得;
  |OpenRouter API|
  :/api/v1/key 呼び出し;
  :クレジット残高返却;
end fork

|Frontend Service|
:使用量ダッシュボード表示;
note right
  **表示項目**
  - クレジット残高
  - 期間別使用量グラフ
  - モデル別コスト内訳
  - 機能別トークン数
  - 平均レイテンシ
end note

|開発者|
if (詳細確認?) then (はい)
  :期間・フィルタを選択;
  |Frontend Service|
  :詳細データ取得・表示;
  |開発者|
  :レポートをエクスポート;
  note right
    CSV/JSON形式
  end note
else (いいえ)
endif
:画面を閉じる;
stop

@enduml
```

### 3.9.2.6 LLMフォールバック設定フロー（UC 5-8）

障害時の代替モデルを設定する。

```plantuml
@startuml business_flow_llm_fallback_setting
skinparam ActivityFontSize 12
skinparam ConditionEndStyle hline

title 業務フロー図 - LLMフォールバック設定（UC 5-8）

|開発者|
start
:「フォールバック設定」をクリック;

|Frontend Service|
:フォールバックチェーン一覧表示;
note right
  **チェーン例**
  1. Claude 3.5 Sonnet（プライマリ）
  2. GPT-4o（フォールバック1）
  3. Llama 3.1 70B（フォールバック2）
end note

|開発者|
switch (操作を選択)
case (チェーン作成)
  :「新規チェーン」をクリック;
  |Frontend Service|
  :チェーン設定画面表示;
  |開発者|
  :チェーン名を入力;
  :モデルを優先順に追加;
  note right
    ドラッグ&ドロップで
    順序変更可能
  end note
  :プロバイダー設定;
  note right
    - allow_fallbacks: true
    - require_parameters: false
    - data_collection: deny
  end note
  :「保存」をクリック;
  |Supabase|
  :llm_fallback_chains 挿入;
  detach
case (チェーン編集)
  :チェーンをクリック;
  |Frontend Service|
  :編集画面表示;
  |開発者|
  :設定を変更;
  :「保存」をクリック;
  |Supabase|
  :llm_fallback_chains 更新;
  detach
case (機能に割当)
  :機能を選択;
  :チェーンを選択;
  |Supabase|
  :llm_fallback_assignments 更新;
  detach
case (戻る)
  :LLM管理画面へ;
  stop
endswitch

@enduml
```

### LLM管理フローテーブル（サマリ）

| UC | 操作 | 主な処理 | 外部システム |
|:--:|------|---------|-------------|
| 5-2 | モデル登録 | OpenRouterモデル選択 → DB保存 | OpenRouter API |
| 5-3 | モデル切替 | 機能別割当変更 | Supabase |
| 5-4 | プロンプト管理 | テンプレートCRUD、バージョン管理 | Supabase |
| 5-5 | パラメータ設定 | サンプリングパラメータ調整 | Supabase |
| 5-7 | 使用量監視 | ログ集計 + OpenRouter残高確認 | OpenRouter API, Supabase |
| 5-8 | フォールバック設定 | フォールバックチェーン定義 | Supabase |

---

## 3.9.3 システム設定フロー詳細（UC 5-13）

### 概要

アプリケーション全体の設定を変更する。
機能フラグ、表示設定、制限値などを管理。

### システム設定フロー

```plantuml
@startuml business_flow_system_settings
skinparam ActivityFontSize 12
skinparam ConditionEndStyle hline

title 業務フロー図 - システム設定（UC 5-13）

|開発者|
start
:「システム設定」をクリック;

|Frontend Service|
:現在の設定を取得;

|Supabase|
:system_settings テーブル取得;

|Frontend Service|
:システム設定画面表示;
note right
  **設定カテゴリ**
  - 機能フラグ
  - 表示設定
  - 制限値
  - 外部連携
end note

|開発者|
switch (設定カテゴリを選択)
case (機能フラグ)
  :機能フラグ設定画面;
  note right
    - AI機能有効/無効
    - Excalidraw有効/無効
    - バージョン管理有効/無効
    - 新機能ベータフラグ
  end note
case (表示設定)
  :表示設定画面;
  note right
    - デフォルトテーマ
    - エディタ設定
    - プレビュー設定
  end note
case (制限値)
  :制限値設定画面;
  note right
    - 最大プロジェクト数
    - 最大図表数/プロジェクト
    - 最大ファイルサイズ
    - API レート制限
  end note
case (外部連携)
  :外部連携設定画面;
  note right
    - OpenRouter APIキー
    - OpenAI APIキー
    - Webhook URL
  end note
endswitch

|開発者|
:設定値を変更;
:「保存」をクリック;

|Frontend Service|
#lightyellow:確認ダイアログ表示;
note right
  「システム設定を変更しますか？」
  「変更は即座に反映されます」
end note

|開発者|
if (確認?) then (はい)
  |Frontend Service|
  :設定更新リクエスト;

  |Supabase|
  :system_settings 更新;

  |Frontend Service|
  if (更新成功?) then (はい)
    #palegreen:完了通知;
    :アプリケーション設定リロード;
  else (エラー)
    #mistyrose:エラー通知;
  endif
else (キャンセル)
  |Frontend Service|
  :ダイアログを閉じる;
endif
stop

@enduml
```

### システム設定項目一覧

| カテゴリ | 設定項目 | 型 | デフォルト値 | 説明 |
|---------|---------|-----|-------------|------|
| **機能フラグ** | ai_enabled | boolean | true | AI機能の有効/無効 |
| | excalidraw_enabled | boolean | true | Excalidraw機能の有効/無効 |
| | version_history_enabled | boolean | false | バージョン管理（v3） |
| | beta_features_enabled | boolean | false | ベータ機能フラグ |
| **表示設定** | default_theme | string | "light" | デフォルトテーマ |
| | editor_font_size | integer | 14 | エディタフォントサイズ |
| | preview_auto_refresh | boolean | true | プレビュー自動更新 |
| **制限値** | max_projects_per_user | integer | 50 | ユーザーあたり最大プロジェクト数 |
| | max_diagrams_per_project | integer | 100 | プロジェクトあたり最大図表数 |
| | max_file_size_mb | integer | 10 | 最大ファイルサイズ（MB） |
| | api_rate_limit_per_minute | integer | 60 | API呼び出し制限/分 |
| **外部連携** | openrouter_api_key | string | - | OpenRouter APIキー（暗号化） |
| | openai_api_key | string | - | OpenAI APIキー（暗号化） |
| | webhook_url | string | - | 通知用Webhook URL |

### システム設定フローテーブル

| ステップ | 処理内容 | 担当 | エラー処理 |
|:-------:|---------|------|-----------|
| 1 | 「システム設定」をクリック | 開発者 | - |
| 2 | 現在の設定を取得 | Supabase | 失敗時: エラー通知 |
| 3 | 設定画面表示 | Frontend Service | - |
| 4 | カテゴリ選択・設定値変更 | 開発者 | - |
| 5 | 確認ダイアログ表示 | Frontend Service | - |
| 6 | 確認 or キャンセル | 開発者 | キャンセル時: 閉じる |
| 7 | 設定更新 | Supabase | 失敗時: エラー通知 |
| 8 | 完了通知・設定リロード | Frontend Service | - |

---

## エラーハンドリング

| エラー種別 | 原因 | 対応 |
|-----------|------|------|
| 認証エラー | セッション期限切れ | ログイン画面にリダイレクト |
| 権限エラー | 開発者権限なし | 「アクセス権限がありません」 |
| ネットワークエラー | 通信障害 | 「接続に失敗しました。再試行してください。」 |
| API制限エラー | OpenRouter制限超過 | 「API制限に達しました。しばらく待ってください。」 |
| バリデーションエラー | 入力値不正 | リアルタイムでエラー表示 |
| 重複エラー | 同名登録 | 「同名のモデル/プロンプトが存在します」 |

---

## 技術仕様

| 項目 | 仕様 |
|------|------|
| **LLMプロバイダー** | OpenRouter（統一API） |
| **Embeddingプロバイダー** | OpenAI（直接接続）※Phase 2 |
| **設定保存先** | Supabase PostgreSQL |
| **APIキー保存** | 暗号化保存（環境変数参照） |
| **使用量ログ** | llm_usage_logs テーブル |
| **プロンプトバージョン管理** | llm_prompt_template_history テーブル |

---

## 関連ドキュメント

- [LLM管理機能設計書](../evidence/20251206_openrouter_research/llm_management_feature_design.md) - LM-01〜LM-07詳細設計
- [OpenRouter LLM制御仕様調査](../evidence/20251206_openrouter_research/openrouter_llm_control_specification.md) - API仕様
- [PlantUML_Studio_ユースケース図](./PlantUML_Studio_ユースケース図_20251130.md) - UC 5-1〜5-13定義
- [PlantUML_Studio_コンテキスト図](./PlantUML_Studio_コンテキスト図_20251130.md) - システム境界

---

## レビュー観点

1. **ユースケース図との整合性**: UC 5-1, 5-2〜5-5, 5-7, 5-8, 5-13が正しくカバーされているか？
2. **LLM設計書との整合性**: LM-01〜LM-07と対応しているか？
3. **TD-007との整合性**: OpenRouter/OpenAI分離が反映されているか？
4. **アクセス制御**: 開発者権限のみが操作できることが明示されているか？
5. **フローの網羅性**: CRUD操作が網羅されているか？
6. **エラーハンドリング**: 適切なエラー処理が定義されているか？
