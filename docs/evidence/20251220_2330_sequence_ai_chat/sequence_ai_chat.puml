@startuml UC 4-2 AIチャット
!pragma teoz true

skinparam backgroundColor #FEFEFE
skinparam participant {
  BackgroundColor #E8F4FD
  BorderColor #1976D2
}
skinparam sequence {
  ArrowColor #1976D2
  LifeLineBorderColor #1976D2
  BoxBackgroundColor #F5F5F5
  BoxBorderColor #BDBDBD
  GroupBackgroundColor #FFFDE7
  GroupBorderColor #FBC02D
}
skinparam note {
  BackgroundColor #FFF9C4
  BorderColor #FBC02D
}

title UC 4-2 AIチャット シーケンス図

actor "User" as User
participant "Browser\n(AIチャットパネル)" as Browser
participant "APIRoutes\n(/api/ai/chat)" as APIRoutes
participant "AIService" as AIService
participant "PromptService" as PromptService
participant "OpenRouterClient" as OpenRouterClient
participant "OpenRouter\nAPI" as OpenRouter

== AIチャットパネル開始 ==

User -> Browser : AIチャットパネルを開く
activate Browser

Browser -> Browser : 既存会話履歴を読み込み\n(localStorage)

note right of Browser
  context_code: 現在の図表コード（必須）
  conversation_id: 継続時に使用
  messages: 会話履歴配列
end note

Browser --> User : パネル表示
deactivate Browser

== メッセージ送信 ==

User -> Browser : メッセージ入力・送信
activate Browser

Browser -> APIRoutes : POST /api/ai/chat\n{message, context_code,\nchat_mode, conversation_id,\nmessages[]}
activate APIRoutes

' エラーハンドリング（バリデーション・認証）
alt 入力検証エラー 400

  APIRoutes --> Browser : 400 VALIDATION_ERROR
  deactivate APIRoutes
  Browser --> User : エラー表示
  deactivate Browser

else context_code未指定 400

  APIRoutes --> Browser : 400 CONTEXT_REQUIRED
  deactivate APIRoutes
  Browser --> User : エラー表示
  deactivate Browser

else 未認証 401

  APIRoutes --> Browser : 401 UNAUTHORIZED
  deactivate APIRoutes
  Browser --> User : ログイン画面へリダイレクト
  deactivate Browser

else AI機能無効 403

  APIRoutes --> Browser : 403 AI_FEATURE_DISABLED
  deactivate APIRoutes
  Browser --> User : エラー表示
  deactivate Browser

else 正常処理

  APIRoutes -> AIService : chat(message, context_code,\nchat_mode, messages[])
  activate AIService

  AIService -> PromptService : getPrompt("ai_chat_{mode}",\n{context_code, messages[]})
  activate PromptService

  note right of PromptService
    chat_mode別プロンプト:
    - ai_chat_review: コードレビュー
    - ai_chat_improve: 改善提案
    - ai_chat_explain: コード説明
    - ai_chat_error: エラー対応
  end note

  PromptService --> AIService : システムプロンプト
  deactivate PromptService

  AIService -> OpenRouterClient : streamChat(prompt, messages[])
  activate OpenRouterClient

  OpenRouterClient -> OpenRouter : POST /chat/completions\n(stream: true)
  activate OpenRouter

  ' OpenRouterエラーハンドリング
  alt レート制限 429

    OpenRouter --> OpenRouterClient : 429 Too Many Requests
    deactivate OpenRouter
    OpenRouterClient --> AIService : RateLimitError
    deactivate OpenRouterClient
    AIService --> APIRoutes : 429 RATE_LIMITED
    deactivate AIService
    APIRoutes --> Browser : エラー表示
    deactivate APIRoutes
    Browser --> User : 再試行を促す
    deactivate Browser

  else プロバイダーエラー 500

    OpenRouter --> OpenRouterClient : 500 Internal Server Error
    deactivate OpenRouter
    OpenRouterClient --> AIService : ProviderError
    deactivate OpenRouterClient
    AIService --> APIRoutes : 500 AI_PROVIDER_ERROR
    deactivate AIService
    APIRoutes --> Browser : エラー表示
    deactivate APIRoutes
    Browser --> User : エラー表示
    deactivate Browser

  else サービス利用不可 503

    OpenRouter --> OpenRouterClient : 503 Service Unavailable
    deactivate OpenRouter
    OpenRouterClient --> AIService : ServiceUnavailableError
    deactivate OpenRouterClient
    AIService --> APIRoutes : 503 AI_SERVICE_UNAVAILABLE
    deactivate AIService
    APIRoutes --> Browser : エラー表示
    deactivate APIRoutes
    Browser --> User : エラー表示
    deactivate Browser

  else SSEストリーミング成功

    loop SSEチャンク送信
      OpenRouter --> OpenRouterClient : data: {delta}
      OpenRouterClient --> AIService : chunk
      AIService --> APIRoutes : chunk
      APIRoutes --> Browser : SSE: data: {chunk}
      Browser -> Browser : 回答を逐次表示
    end

    OpenRouter --> OpenRouterClient : data: [DONE]
    deactivate OpenRouter
    OpenRouterClient --> AIService : streamComplete
    deactivate OpenRouterClient
    AIService --> APIRoutes : AIResponse {content, usage}
    deactivate AIService
    APIRoutes --> Browser : SSE: event: complete
    deactivate APIRoutes

    Browser -> Browser : 会話履歴を更新\n(localStorage保存)

    note right of Browser
      レスポンスにコード提案が含まれる場合
      「適用」ボタンを表示
    end note

    Browser --> User : 回答表示完了
    deactivate Browser

  end

end

== 会話継続（オプション） ==

User -> Browser : 追加の質問を入力
activate Browser

note right of Browser
  conversation_id を維持して
  messages[] に履歴を追加
end note

Browser -> APIRoutes : POST /api/ai/chat\n{継続リクエスト}
activate APIRoutes

note over Browser, OpenRouter : （上記と同様のフロー）

APIRoutes --> Browser : SSE: complete
deactivate APIRoutes

Browser --> User : 継続回答表示
deactivate Browser

@enduml
