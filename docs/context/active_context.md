# 現在の作業コンテキスト（Active Context）

**最終更新**: 2025-12-08（03:30更新）

---

## 現在の状況

### 現在のフェーズ

**Phase**: PRD作成（図表正式版作成中）
**ステータス**: In Progress
**進捗率**: 65%

### 図表作成進捗

| 図表 | 状況 | 備考 |
|------|:----:|------|
| ① コンテキスト図 | ✅ | 完了 |
| ② ユースケース図 | ✅ | 32UC定義済み |
| ③ 業務フロー図 | 🟡 | 9/11完了（82%） |
| ④ データフロー図（DFD） | ✅ | 完了（レベル0・レベル1） |
| ⑤ 機能一覧表（業務フロー・DFD対比含む） | 🔴 | 要作成 |
| ⑥ クラス図 | 🔴 | 要作成 |
| ⑦ CRUD表 | 🔴 | 要作成 |
| ⑧ シーケンス図 | 🟡 | 1/5完了（ログインのみ） |
| ⑨ 画面遷移図 | 🔴 | 要作成 |
| ⑩ ワイヤーフレーム | 🔴 | 要作成 |
| ⑪ コンポーネント図 | 🔴 | 要作成 |
| ⑫ 外部インターフェース一覧 | 🔴 | 要作成 |
| ⑬ 非機能要件一覧表 | 🔴 | 要作成 |
| ⑭ アクター権限マトリクス | 🔴 | 要作成 |

**全体進捗: 4/14 完了（29%）** ※業務フロー図は一部完了のためカウント外

### 業務フロー図 詳細進捗

| # | フロー名 | 対応UC | 優先度 | 状況 |
|---|---------|--------|:------:|:----:|
| 3.1 | PlantUML図表作成フロー | 3-1〜3-4 | MVP | ✅ |
| 3.2 | PlantUML AI支援フロー | 4-1, 4-2 | MVP | ✅ |
| 3.3 | Excalidrawワイヤーフレーム作成フロー | 3-1, 3-3 | MVP | ✅ |
| 3.4 | 認証フロー | 1-1, 1-2 | MVP | ✅ |
| 3.5 | プロジェクト管理フロー | 2-1〜2-4 | MVP | ✅ |
| 3.6 | 保存・エクスポートフロー | 3-5, 3-6 | MVP | ✅ |
| 3.7 | バージョン管理フロー | 3-7, 3-8 | MVP | ✅ |
| 3.8 | 図表削除フロー | 3-9 | MVP | ✅ |
| 3.9 | 管理機能フロー（MVP） | 5-1, 5-2〜5-5, 5-7, 5-8, 5-13 | **MVP** | ✅ |
| 3.10 | 学習コンテンツフロー | 3-10, 3-11 | Phase 2 | 🔴 |
| 3.11 | 管理機能フロー（Phase 2） | 5-6, 5-9〜5-12 | Phase 2 | 🔴 |

**業務フロー図 進捗: 9/11 完了（82%）** ※MVP必須: 9/9完了（100%）

### 管理機能一覧（UC 5-1〜5-13）

| UC | 機能名 | カテゴリ | 優先度 |
|:--:|--------|----------|:------:|
| 5-1 | ユーザーを管理する | 5-A. ユーザー管理 | MVP |
| 5-2 | LLMモデルを登録する | 5-B. LLM管理 | MVP |
| 5-3 | LLMモデルを切り替える | 5-B. LLM管理 | MVP |
| 5-4 | LLMプロンプトを管理する | 5-B. LLM管理 | MVP |
| 5-5 | LLMパラメータを設定する | 5-B. LLM管理 | MVP |
| 5-6 | LLMワークフローを定義する | 5-B. LLM管理 | Phase 2 |
| 5-7 | LLM使用量を監視する | 5-B. LLM管理 | MVP |
| 5-8 | LLMフォールバックを設定する | 5-B. LLM管理 | MVP |
| 5-9 | Embeddingモデルを設定する | 5-C. Embedding管理 | Phase 2 |
| 5-10 | Embedding使用量を監視する | 5-C. Embedding管理 | Phase 2 |
| 5-11 | 学習コンテンツを登録する | 5-D. 学習コンテンツ管理 | Phase 2 |
| 5-12 | 学習コンテンツを管理する | 5-D. 学習コンテンツ管理 | Phase 2 |
| 5-13 | システム設定を変更する | 5-E. システム設定 | MVP |

**管理機能サマリ**: MVP 8件 / Phase 2 5件

### ユースケースカバレッジ

| パッケージ | 総UC数 | カバー済み | 未カバー(MVP) | 未カバー(Phase 2) |
|-----------|:------:|:----------:|:-------------:|:-----------------:|
| 1. 認証 | 2 | 2 | 0 | 0 |
| 2. プロジェクト管理 | 4 | 4 | 0 | 0 |
| 3. 図表操作 | 11 | 9 | 0 | 2 (3-10, 3-11) |
| 4. AI機能 | 2 | 2 | 0 | 0 |
| 5. 管理機能 | 13 | 8 | 0 | 5 (5-6, 5-9〜5-12) |
| **合計** | **32** | **25** | **0** | **7** |

**UCサマリ（優先度別）:**
| 優先度 | 総数 | カバー済み | 未カバー |
|:------:|:----:|:----------:|:--------:|
| MVP | 23 | 23 | **0** |
| Phase 2 | 7 | 0 | 7 |
| v3 | 2 | 2 | 0 |

---

## 最近の変更

### 2025-12-08

- **④ データフロー図（DFD）v3.1 100点完全版** ✅
  - **評価・改善サイクル実施**: 75点（v2.1）→ 99点（v3.0）→ **100点（v3.1）**
  - **v3.0追加内容**:
    - データディクショナリ詳細化（型・制約・バリデーション）
    - DFDレベル2追加（P3.0/P5.0/P6.0サブプロセス分解）
    - P6.0管理機能DF採番（DF-17〜DF-22、DF-22E）
    - UC 3-2テンプレート選択フロー追加（DF-23、DF-24）
    - データストア記法注記（PlantUML制約説明）
    - バランシング検証表（Level 0 ↔ Level 1）
    - エラーリカバリ手順表（18種のエラー対応）
    - データ量・頻度・セキュリティ分類
    - 用語統一表（日英対応10用語）
  - **v3.1追加内容**:
    - D1バリデーションエラーメッセージ（14種）
    - D2バリデーションエラーメッセージ（8種）
    - 実装チームが迷わない詳細レベルに到達
  - 正式版: `docs/proposals/PlantUML_Studio_データフロー図_20251208.md`（v3.1）
  - SVG: `docs/proposals/diagrams/dfd/dfd_level0.svg`, `dfd_level1.svg`
  - Evidence: `docs/evidence/20251208_0128_dfd/`, `20251208_0157_dfd_improvement/`
- **④ データフロー図（DFD）初版作成**
  - DFDレベル0（コンテキスト図）: 外部エンティティ、プロセス、データストア定義
  - DFDレベル1（主要プロセス）: P1.0〜P7.0、D1〜D2、データフロー一覧
- **3.9 管理機能フロー（MVP）作成完了** ✅
  - 全10フローのPNG生成・4パスレビュー完了
  - 7/10フロー（70%）で修正実施（if/fork/switch内スイムレーン遷移問題）
  - Evidence: `docs/evidence/20251208_0007_admin_flow_mvp/`
  - 業務フロー図への.puml反映完了（全10ファイル一致確認済み）
- **PlantUML憲法v3.4更新**
  - § 2 禁止事項: 4項目→8項目に拡張
  - § 3 既知の制限: switch/case内スイムレーン遷移問題を追加
  - 問題発見統計追加（10フロー中7フローで修正必要）
- **CLAUDE.md更新**
  - PlantUML構文注意セクション: 既知の制限テーブル追加
  - 絶対禁止セクション: 8項目に拡張、最重要注意書き追加
- **Git push**: 管理機能フロー（MVP）+ PlantUML憲法v3.4

### 2025-12-07

- **validate_plantuml.ps1 issuesテンプレート追加（v3.1）**
  - レビューログにissuesテンプレート（pass/symptom/cause構造）を自動生成
  - Claudeの操作手順をガイドドキュメントに追記
  - PSCustomObject使用、UTF-8 BOM対応
  - 関連ドキュメント更新: PlantUML_SVG_Generation_Guide.md v3.1、CLAUDE.md
  - Evidence: `docs/evidence/20251207_1530_issues_template_implementation/`
- **validate_plantuml.ps1 機能拡張（v3.0）**
  - 2段階ワークフロー導入（-Review / -Publish）
  - レビューログ機能追加（.review.json）
    - 問題2対策: ハッシュ検証（レビュー時と同一ファイルか確認）
    - 問題3対策: status=completed必須（レビュー完了なしでPublish不可）
  - 履歴保持機能（historyに過去のレビュー結果を保持）
  - ガイドドキュメント更新（PlantUML_SVG_Generation_Guide.md v3.0）
  - Evidence: `docs/evidence/20251207_1310_validate_plantuml_enhancement/`
- **3.9 管理機能フロー（MVP）作成完了**（UC 5-1, 5-2〜5-5, 5-7, 5-8, 5-13）
  - 3.9.1 ユーザー管理フロー（詳細確認、権限変更、無効化）
  - 3.9.2 LLM管理フロー（モデル登録/切替/プロンプト/パラメータ/使用量/フォールバック）
  - 3.9.3 システム設定フロー（機能フラグ、表示設定、制限値、外部連携）
  - TD-007（OpenRouter/OpenAI分離）との整合性確認済み
  - LLM管理機能設計書（LM-01〜LM-07）との対応確認済み
- **業務フロー図MVP完了**: 9/9フロー完了（100%）
- **UCカバレッジMVP完了**: 23/23 UC完了（100%）
- **ユースケース図 UC番号再整理**（UC 5-1〜5-5 → 5-1〜5-13）
  - **5-A. ユーザー管理**: 5-1（既存）
  - **5-B. LLM管理**: 5-2〜5-8（7件追加、OpenRouter経由）
  - **5-C. Embedding管理**: 5-9〜5-10（2件追加、OpenAI直接）
  - **5-D. 学習コンテンツ管理**: 5-11〜5-12（番号変更）
  - **5-E. システム設定**: 5-13（番号変更）
  - **UC総数**: 24件 → **32件**
- **OpenRouter LLM制御仕様調査完了**
  - `docs/evidence/20251206_openrouter_research/`に調査結果を保存
  - OpenRouter API仕様（Chat/Completion、フォールバック、プロバイダールーティング）
  - OpenAI Embedding API仕様（接続仕様、レート制限、ベストプラクティス）
- **TD-007: AI機能プロバイダー構成決定**
  - **LLM**: OpenRouter経由（統一API、300+モデル対応）
  - **Embedding**: OpenAI直接接続（text-embedding-3-small）
  - プロバイダー分離によるコスト最適化と信頼性向上
- **LLM管理機能設計書作成**
  - `llm_management_feature_design.md`
  - LLM管理機能（LM-01〜LM-07）: OpenRouter経由
  - Embedding管理機能（EM-01〜EM-02）: OpenAI直接
  - 学習コンテンツ管理機能（LC-01〜LC-02）: OpenAI Embedding使用
  - データモデル、API設計、実装ロードマップを定義
- **PlantUML SVG生成・視覚的レビュー環境構築**
  - `scripts/validate_plantuml.ps1`: 検証・SVG生成スクリプト作成
  - `docs/guides/PlantUML_SVG_Generation_Guide.md`: 詳細ガイド作成
  - `docs/proposals/diagrams/`: 正式版SVG保存ディレクトリ構造作成
  - ローカルJAR使用（`C:\temp\vscode\.plantuml\plantuml-mit-1.2025.2.jar`）
- **管理機能フローSVG生成・視覚的レビュー完了**（10件）
  - `docs/proposals/diagrams/business_flow/`に正式版SVG保存
  - 3.9.1 ユーザー管理、3.9.2 LLM管理（6件）、3.9.3 システム設定
  - Playwrightでブラウザ表示確認済み
- **CLAUDE.md更新**: ガイドへの参照追加、ディレクトリ構造更新
- **PlantUML SVG生成ガイド v1.1更新**
  - 禁止事項セクション追加（Context7確認なし、バリデーション未実施、エラー無視）
  - イテレーティブ改善セクション追加（問題発生時のループフロー）
  - 既知の制限と回避策を詳細化（3件の既知問題、回避策パターン例）

### 2025-12-06

- **project_brief.md 大幅更新**（正式版ドキュメント + Evidence反映）
  - サービスアーキテクチャ追加（コンテキスト図から）
  - 内部サービス構成（5サービス）・外部システム連携（5システム）
  - データフロー概要図
  - UX設計思想追加（業務フロー図から）
  - 想定ユーザーペルソナ（5タイプ）・UX設計ポイント（5項目）
  - **検証済み技術仕様**（Context7検証: Supabase SSR, Excalidraw, PlantUML構文）
  - **PlantUML/Excalidraw機能分類**（3専用 + 8共通）
  - **MVP Storage構成**（ファイル構造、Repository Pattern）
  - **作業履歴（Evidence）**（7エビデンスセットから抽出）
- **CLAUDE.mdに「作業完了時の更新ルール」追加**
  - 必須更新ファイル（3件）、状況別更新ファイル（4件）
  - 更新の流れ（フローチャート）、active_context.md更新チェックリスト
- **自動保存機能を削除**（TD-006対応）
  - Storage Only構成では30秒自動保存が実現困難（上書きでデータ損失リスク）
  - MVPは**手動保存のみ**（Ctrl+S/保存ボタン）に変更
  - 修正ファイル: 業務フロー図(8箇所)、ユースケース図(2箇所)、開発計画(1箇所)、active_context(2箇所)
  - 「復元前自動保存」→「復元前保存」に表現変更（紛らわしさ解消）
- **TD-006: MVPデータ保存設計決定**
  - **Storage Only構成**: DBテーブルなし（auth.usersのみ）
  - **構造**: `/{user_id}/{project_name}/{diagram_name}.puml`
  - **ファイル形式**: B案（.puml + コメント内Markdown）
  - **v3ロードマップ**: 検索・バージョン管理は取込み機能で対応
- **docs/proposals整合性チェック完了**（Excalidrawバージョン管理対応後）
  - コンテキスト図: Excalidraw Serviceにバージョン管理追加（修正）
  - ユースケース図: UC 3-7, 3-8を「共通」に変更済み
  - シーケンス図: 認証のみのため変更不要
  - 業務フロー図: 3.7を両タイプ対応済み
  - 開発ステップ詳細化計画: 図表タイプ非依存のため変更不要
- **3.7 バージョン管理フロー作成完了**（UC 3-7, 3-8）
  - **PlantUML/Excalidraw両方対応**（設計修正）
  - SHA-256ハッシュでバージョン識別
  - 復元前に現在の内容をバージョンとして保存（データ損失防止）
  - 履歴確認 → プレビュー表示 → 復元のフロー
- **バージョン管理をExcalidrawにも適用**（設計変更）
  - ユースケース図: 3-7, 3-8を「共通」に変更
  - パッケージ構成: 3-B. 出力・管理（共通）にUC_HISTORY, UC_RESTOREを移動
  - 技術的制約なし、両図表タイプで同等のバージョン管理を提供
- **3.8 図表削除フロー作成完了**（UC 3-9）
  - PlantUML/Excalidraw両方対応
  - 確認ダイアログで誤操作防止
  - カスケード削除（メタデータ + Storage + バージョン履歴）
- **MVP必須業務フロー完了**: 8/10フロー完了（残りはPhase 2）
- **3.6 保存・エクスポートフロー作成完了**（UC 3-5, 3-6）
  - 手動保存（Ctrl+S）のみ ※自動保存はStorage Only構成では未実装（TD-006）
  - PNG/SVG/PDFエクスポート
  - 用語一貫性チェック（自動実行）
  - **Storage設計統一**: PlantUML/Excalidraw両方で source + preview_N.svg を保存
  - **Frontend Serviceオーケストレーション**: 処理依頼→結果受信→保存リクエストの明示化
  - PlantUML: 複数@startumlブロック対応（複数プレビューSVG生成）
- **整合性チェック実施**: 全図表間で整合確認、コンテキスト図更新（node-plantuml明記）
- **API Gatewayの扱い明記**: 業務フロー図で「暗黙的に介在」と明記
- **機能一覧表の導入決定**: 業務フロー・DFD対比表を機能一覧表に統合（選択肢C）
  - 作成タイミング: 業務フロー図・DFD完了後
  - 役割: 機能網羅性確認 + フロー不備発見 → フロー修正 → クラス図へ
- UC 2-4「プロジェクトを編集する」追加（CRUD完備）
- UC採番・業務フロー図をCRUD順に整理
- UX設計思想ドキュメント化（業務フロー図内）
- TD-005: プロジェクト選択状態のSupabase保存
- CLAUDE.md現状反映・不要ファイル削除
- **Git push**: `46ae4f7` master → origin/master

### 2025-12-02

- 3.4 認証フロー作成
- 3.5 プロジェクト管理フロー作成
- ユースケース図からEmail/Password削除（OAuth専用化）

### 2025-12-01

- 3.1〜3.3 業務フロー図作成

### 2025-11-30

- コンテキスト図、ユースケース図、シーケンス図（ログイン）完成
- AI駆動開発環境セットアップ完了

---

## 技術決定（最新）

| TD | 内容 | 日付 |
|:--:|------|------|
| TD-001 | AI駆動開発標準の採用 | 2025-11-30 |
| TD-002 | PlantUML Validator MCP採用 | 2025-11-30 |
| TD-003 | Google Cloud Run採用 | 2025-11-08 |
| TD-004 | Serena MCP採用 | 2025-11-30 |
| TD-005 | プロジェクト選択状態のSupabase保存 | 2025-12-06 |
| TD-006 | MVPデータ保存設計（Storage Only）+ 自動保存削除 | 2025-12-06 |
| TD-007 | AI機能プロバイダー構成（LLM: OpenRouter, Embedding: OpenAI直接） | 2025-12-07 |

詳細: `docs/context/technical_decisions.md`

---

## 次のステップ

### 即座に必要なアクション（MVP）

1. [x] **3.6 保存・エクスポートフロー**（UC 3-5, 3-6）✅ 完了
2. [x] **3.7 バージョン管理フロー**（UC 3-7, 3-8）✅ 完了
3. [x] **3.8 図表削除フロー**（UC 3-9）✅ 完了
4. [x] **3.9 管理機能フロー（MVP）**（UC 5-1, 5-2〜5-5, 5-7, 5-8, 5-13）✅ 完了
5. [x] **データフロー図（DFD）** ✅ 完了
6. [ ] **機能一覧表**（業務フロー・DFD対比含む） ← **次の作業**
7. [ ] 【レビュー・修正】業務フロー・DFDの不備を修正

### Phase 2 残作業（業務フロー）

1. [ ] **3.10 学習コンテンツフロー**（UC 3-10, 3-11）
2. [ ] **3.11 管理機能フロー（Phase 2）**（UC 5-6, 5-9〜5-12）

### 今後の検討事項

- [ ] Phase 3: データ・構造定義（クラス図、CRUD表）
- [ ] Phase 4: 振る舞い詳細化（シーケンス図残り4件、画面遷移図、ワイヤーフレーム）
- [ ] Phase 5: アーキテクチャ（コンポーネント図、外部インターフェース一覧）
- [ ] Phase 6: 品質・権限定義（非機能要件、アクター権限マトリクス）

---

## 重要なドキュメント

| ドキュメント | 内容 |
|-------------|------|
| `CLAUDE.md` | プロジェクトガイド（最新） |
| `docs/proposals/PlantUML_Studio_業務フロー図_20251201.md` | 業務フロー図 + UX設計思想 |
| `docs/proposals/PlantUML_Studio_ユースケース図_20251130.md` | ユースケース図（32UC） |
| `docs/context/technical_decisions.md` | 技術決定記録（TD-001〜007） |

---

**次のレビュー予定**: 2025-12-08
