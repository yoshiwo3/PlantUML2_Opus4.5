# 現在の作業コンテキスト（Active Context）

**最終更新**: 2025-12-06

---

## 現在の状況

### 現在のフェーズ

**Phase**: PRD作成（図表正式版作成中）
**ステータス**: In Progress
**進捗率**: 60%

### 図表作成進捗

| 図表 | 状況 | 備考 |
|------|:----:|------|
| ① コンテキスト図 | ✅ | 完了 |
| ② ユースケース図 | ✅ | 24UC定義済み |
| ③ 業務フロー図 | 🟡 | 8/10完了（80%） |
| ④ データフロー図（DFD） | 🔴 | 要作成 |
| ⑤ 機能一覧表（業務フロー・DFD対比含む） | 🔴 | 要作成 |
| ⑥ クラス図 | 🔴 | 要作成 |
| ⑦ CRUD表 | 🔴 | 要作成 |
| ⑧ シーケンス図 | 🟡 | 1/5完了（ログインのみ） |
| ⑨ 画面遷移図 | 🔴 | 要作成 |
| ⑩ ワイヤーフレーム | 🔴 | 要作成 |
| ⑪ コンポーネント図 | 🔴 | 要作成 |
| ⑫ 外部インターフェース一覧 | 🔴 | 要作成 |
| ⑬ 非機能要件一覧表 | 🔴 | 要作成 |
| ⑭ アクター権限マトリクス | 🔴 | 要作成 |

**全体進捗: 3/14 完了（21%）** ※業務フロー図は一部完了のためカウント外

### 業務フロー図 詳細進捗

| # | フロー名 | 対応UC | 状況 |
|---|---------|--------|:----:|
| 3.1 | PlantUML図表作成フロー | 3-1〜3-4 | ✅ |
| 3.2 | PlantUML AI支援フロー | 4-1, 4-2 | ✅ |
| 3.3 | Excalidrawワイヤーフレーム作成フロー | 3-1, 3-3 | ✅ |
| 3.4 | 認証フロー | 1-1, 1-2 | ✅ |
| 3.5 | プロジェクト管理フロー | 2-1〜2-4 | ✅ |
| 3.6 | 保存・エクスポートフロー | 3-5, 3-6 | ✅ |
| 3.7 | バージョン管理フロー | 3-7, 3-8 | ✅ |
| 3.8 | 図表削除フロー | 3-9 | ✅ |
| 3.9 | 学習コンテンツフロー | 3-10, 3-11 | 🔴 (Phase 2) |
| 3.10 | 管理機能フロー | 5-1〜5-5 | 🔴 (Phase 2) |

**業務フロー図 進捗: 8/10 完了（80%）** ※MVP必須フロー完了

### ユースケースカバレッジ

| パッケージ | 総UC数 | カバー済み | 未カバー |
|-----------|:------:|:----------:|:--------:|
| 1. 認証 | 2 | 2 | 0 |
| 2. プロジェクト管理 | 4 | 4 | 0 |
| 3. 図表操作 | 11 | 9 | 2 (3-10, 3-11: Phase 2) |
| 4. AI機能 | 2 | 2 | 0 |
| 5. 管理機能 | 5 | 0 | 5 (Phase 2) |
| **合計** | **24** | **17** | **7** |

---

## 最近の変更

### 2025-12-06

- **TD-006: MVPデータ保存設計決定**
  - **Storage Only構成**: DBテーブルなし（auth.usersのみ）
  - **構造**: `/{user_id}/{project_name}/{diagram_name}.puml`
  - **ファイル形式**: B案（.puml + コメント内Markdown）
  - **v3ロードマップ**: 検索・バージョン管理は取込み機能で対応
- **docs/proposals整合性チェック完了**（Excalidrawバージョン管理対応後）
  - コンテキスト図: Excalidraw Serviceにバージョン管理追加（修正）
  - ユースケース図: UC 3-7, 3-8を「共通」に変更済み
  - シーケンス図: 認証のみのため変更不要
  - 業務フロー図: 3.7を両タイプ対応済み
  - 開発ステップ詳細化計画: 図表タイプ非依存のため変更不要
- **3.7 バージョン管理フロー作成完了**（UC 3-7, 3-8）
  - **PlantUML/Excalidraw両方対応**（設計修正）
  - SHA-256ハッシュでバージョン識別
  - 復元前に現在の内容を自動保存（データ損失防止）
  - 履歴確認 → プレビュー表示 → 復元のフロー
- **バージョン管理をExcalidrawにも適用**（設計変更）
  - ユースケース図: 3-7, 3-8を「共通」に変更
  - パッケージ構成: 3-B. 出力・管理（共通）にUC_HISTORY, UC_RESTOREを移動
  - 技術的制約なし、両図表タイプで同等のバージョン管理を提供
- **3.8 図表削除フロー作成完了**（UC 3-9）
  - PlantUML/Excalidraw両方対応
  - 確認ダイアログで誤操作防止
  - カスケード削除（メタデータ + Storage + バージョン履歴）
- **MVP必須業務フロー完了**: 8/10フロー完了（残りはPhase 2）
- **3.6 保存・エクスポートフロー作成完了**（UC 3-5, 3-6）
  - 手動保存（Ctrl+S）/自動保存（30秒）
  - PNG/SVG/PDFエクスポート
  - 用語一貫性チェック（自動実行）
  - **Storage設計統一**: PlantUML/Excalidraw両方で source + preview_N.svg を保存
  - **Frontend Serviceオーケストレーション**: 処理依頼→結果受信→保存リクエストの明示化
  - PlantUML: 複数@startumlブロック対応（複数プレビューSVG生成）
- **整合性チェック実施**: 全図表間で整合確認、コンテキスト図更新（node-plantuml明記）
- **API Gatewayの扱い明記**: 業務フロー図で「暗黙的に介在」と明記
- **機能一覧表の導入決定**: 業務フロー・DFD対比表を機能一覧表に統合（選択肢C）
  - 作成タイミング: 業務フロー図・DFD完了後
  - 役割: 機能網羅性確認 + フロー不備発見 → フロー修正 → クラス図へ
- UC 2-4「プロジェクトを編集する」追加（CRUD完備）
- UC採番・業務フロー図をCRUD順に整理
- UX設計思想ドキュメント化（業務フロー図内）
- TD-005: プロジェクト選択状態のSupabase保存
- CLAUDE.md現状反映・不要ファイル削除
- **Git push**: `46ae4f7` master → origin/master

### 2025-12-02

- 3.4 認証フロー作成
- 3.5 プロジェクト管理フロー作成
- ユースケース図からEmail/Password削除（OAuth専用化）

### 2025-12-01

- 3.1〜3.3 業務フロー図作成

### 2025-11-30

- コンテキスト図、ユースケース図、シーケンス図（ログイン）完成
- AI駆動開発環境セットアップ完了

---

## 技術決定（最新）

| TD | 内容 | 日付 |
|:--:|------|------|
| TD-001 | AI駆動開発標準の採用 | 2025-11-30 |
| TD-002 | PlantUML Validator MCP採用 | 2025-11-30 |
| TD-003 | Google Cloud Run採用 | 2025-11-08 |
| TD-004 | Serena MCP採用 | 2025-11-30 |
| TD-005 | プロジェクト選択状態のSupabase保存 | 2025-12-06 |
| TD-006 | MVPデータ保存設計（Storage Only） | 2025-12-06 |

詳細: `docs/context/technical_decisions.md`

---

## 次のステップ

### 即座に必要なアクション（MVP）

1. [x] **3.6 保存・エクスポートフロー**（UC 3-5, 3-6）✅ 完了
2. [x] **3.7 バージョン管理フロー**（UC 3-7, 3-8）✅ 完了
3. [x] **3.8 図表削除フロー**（UC 3-9）✅ 完了
4. [ ] **データフロー図（DFD）**
5. [ ] **機能一覧表**（業務フロー・DFD対比含む）
6. [ ] 【レビュー・修正】業務フロー・DFDの不備を修正

### Phase 2 残作業（業務フロー）

1. [ ] **3.9 学習コンテンツフロー**（UC 3-10, 3-11）
2. [ ] **3.10 管理機能フロー**（UC 5-1〜5-5）

### 今後の検討事項

- [ ] Phase 3: データ・構造定義（クラス図、CRUD表）
- [ ] Phase 4: 振る舞い詳細化（シーケンス図残り4件、画面遷移図、ワイヤーフレーム）
- [ ] Phase 5: アーキテクチャ（コンポーネント図、外部インターフェース一覧）
- [ ] Phase 6: 品質・権限定義（非機能要件、アクター権限マトリクス）

---

## 重要なドキュメント

| ドキュメント | 内容 |
|-------------|------|
| `CLAUDE.md` | プロジェクトガイド（最新） |
| `docs/proposals/PlantUML_Studio_業務フロー図_20251201.md` | 業務フロー図 + UX設計思想 |
| `docs/proposals/PlantUML_Studio_ユースケース図_20251130.md` | ユースケース図（24UC） |
| `docs/context/technical_decisions.md` | 技術決定記録（TD-001〜005） |

---

**次のレビュー予定**: 2025-12-07
