# Session 2026-01-01: TD-038 コンテキスト位置追加

## 概要

シーケンス図仕様書v3.16で「コンテキスト位置追加（Context-aware Position Addition）」を実装。
**インライン展開方式のみに適用**。モーダル方式（group/アクティブバー）は適用外。

## 背景

- 新規要素追加フォームは常にS2末尾に展開
- 長いシーケンスの中間に要素を追加する際、末尾追加→D&D移動が必要で非効率

## 決定内容（TD-038）

### インライン展開方式（TD-038適用）
| 状態 | 展開位置 | 追加後の位置 |
|------|---------|-------------|
| 要素未選択 | S2末尾 | リストの最後 |
| 要素選択中 | 選択要素の直後 | 選択要素の次の位置 |

適用対象: メッセージ、参加者、フラグメント、ノート

### モーダル方式（group/アクティブバー）- TD-038適用外

| 項目 | 仕様 |
|------|------|
| 挿入位置 | モーダルで選択した範囲の位置（ラップ） |
| 追加ボタンクリック時のカード選択状況 | **影響しない** |

> **重要**: group/アクティブバーは「既存メッセージをラップする」という性質上、S2表示位置はモーダルで選択した範囲によって決まる。追加ボタンクリック時のカード選択状況は無関係。

## 更新セクション

| セクション | 変更内容 |
|-----------|---------|
| §5.5 参加者追加フォーム | 展開位置ルール追加 |
| §8.1 メッセージ追加フォーム | 展開位置ルール追加 |
| §9.2 フラグメント追加 | 展開位置ルール追加 |
| §10.3 ノート追加 | 展開位置ルール追加 |
| §11.1 Group/アクティブバー | 挿入位置ルール追加（モーダル対応） |
| §12.5 入力画面遷移マトリクス | 「挿入位置（TD-038）」列追加 |

## 設計決定ID

| ID | 内容 |
|----|------|
| D-71 | インライン展開: 選択要素の直後に展開、未選択時は末尾 |
| D-72 | ~~モーダル: 選択要素をデフォルト範囲開始点~~ → **削除**（モーダルは選択範囲に依存） |
| D-73 | インライン展開: 追加後のカード位置は展開位置と同一（コンテキスト維持） |

## メリット

- 中間位置への追加時にD&D不要
- 関連要素の近くで作業可能
- 選択メッセージの送信先を新規メッセージの送信元デフォルトに
- インライン/モーダル問わず同じ位置ルールを適用

## Git

- コミット: eb3d8e1
- バージョン: v3.15 → v3.16

## 関連

- TD-037: D&D楽観的検証方式（同日実装）
- 仕様書: `docs/evidence/20251224_1955_ui_design_login/wireframes/04_editor/05_sequence_diagram_spec.md`
- 技術決定: `docs/context/technical_decisions.md`
