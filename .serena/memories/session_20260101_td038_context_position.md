# Session 2026-01-01: TD-038 コンテキスト位置追加

## 概要

シーケンス図仕様書v3.16で「コンテキスト位置追加（Context-aware Position Addition）」を実装。

## 背景

- 新規要素追加フォームは常にS2末尾に展開
- 長いシーケンスの中間に要素を追加する際、末尾追加→D&D移動が必要で非効率
- ユーザー指摘: group/アクティブバー（モーダル方式）も同様の挙動を適用すべき

## 決定内容（TD-038）

### インライン展開方式
| 状態 | 展開位置 | 追加後の位置 |
|------|---------|-------------|
| 要素未選択 | S2末尾 | リストの最後 |
| 要素選択中 | 選択要素の直後 | 選択要素の次の位置 |

### モーダル方式（group/アクティブバー）
| 状態 | モーダル初期状態 | 作成後の挿入位置 |
|------|-----------------|-----------------|
| 要素未選択 | 範囲未選択 | S2末尾 |
| 要素選択中 | 選択要素をデフォルト範囲開始点 | 選択範囲の位置（ラップ） |

## 更新セクション

| セクション | 変更内容 |
|-----------|---------|
| §5.5 参加者追加フォーム | 展開位置ルール追加 |
| §8.1 メッセージ追加フォーム | 展開位置ルール追加 |
| §9.2 フラグメント追加 | 展開位置ルール追加 |
| §10.3 ノート追加 | 展開位置ルール追加 |
| §11.1 Group/アクティブバー | 挿入位置ルール追加（モーダル対応） |
| §12.5 入力画面遷移マトリクス | 「挿入位置（TD-038）」列追加 |

## 設計決定ID

| ID | 内容 |
|----|------|
| D-71 | インライン展開: 選択要素の直後に展開、未選択時は末尾 |
| D-72 | モーダル: 選択要素をデフォルト範囲開始点として使用 |
| D-73 | 追加後のカード位置: 展開位置と同一（コンテキスト維持） |

## メリット

- 中間位置への追加時にD&D不要
- 関連要素の近くで作業可能
- 選択メッセージの送信先を新規メッセージの送信元デフォルトに
- インライン/モーダル問わず同じ位置ルールを適用

## Git

- コミット: eb3d8e1
- バージョン: v3.15 → v3.16

## 関連

- TD-037: D&D楽観的検証方式（同日実装）
- 仕様書: `docs/evidence/20251224_1955_ui_design_login/wireframes/04_editor/05_sequence_diagram_spec.md`
- 技術決定: `docs/context/technical_decisions.md`
