# セッション記録: シーケンス図 最終分析（UC番号修正版）

## 作業日時
2025-12-14

## 背景
- 15本の分析結果は正しいが、一部UC番号に誤りがあった
- Ultrathink再分析により32UC全件を検証

## 最終結論: 15本（漏れなし）

### MVP必須（8本）

| # | シーケンス図名 | 対応UC | 外部システム | 状況 |
|:-:|---------------|--------|-------------|:----:|
| 1 | ログイン | UC 1-1, 1-2 | Supabase Auth (OAuth PKCE) | ✅ 完了 |
| 2 | プロジェクトCRUD | UC 2-1〜2-4 | Supabase Storage | 🔴 要作成 |
| 3 | 図表作成 | UC 3-1 | Storage + node-plantuml | 🔴 要作成 |
| 4 | 編集プレビュー | UC 3-3, 3-4 | OpenRouter + node-plantuml | 🔴 要作成 |
| 5 | 保存 | UC 3-5 | Storage + OpenRouter | 🔴 要作成 |
| 6 | エクスポート | UC 3-6 | node-plantuml | 🔴 要作成 |
| 7 | 図表削除 | UC 3-9 | Supabase Storage | 🔴 要作成 |
| 8 | AI Question-Start | UC 4-1 | OpenRouter (streaming) | 🔴 要作成 |

### Phase 2（6本）

| # | シーケンス図名 | 対応UC | 外部システム | 状況 |
|:-:|---------------|--------|-------------|:----:|
| 9 | AIチャット | UC 4-2 | OpenRouter | 🔴 要作成 |
| 10 | 学習コンテンツ検索 | UC 3-10 | pgvector + OpenRouter | 🔴 要作成 |
| 11 | ユーザー管理 | UC 5-1 | Supabase Auth Admin | 🔴 要作成 |
| 12 | LLMモデル登録 | **UC 5-2** | OpenRouter Models API | 🔴 要作成 |
| 13 | LLM使用量監視 | **UC 5-7** | OpenRouter API | 🔴 要作成 |
| 14 | 学習コンテンツ登録 | **UC 5-11** | OpenAI Embedding + pgvector | 🔴 要作成 |

### v3（1本）

| # | シーケンス図名 | 対応UC | 外部システム | 状況 |
|:-:|---------------|--------|-------------|:----:|
| 15 | バージョン管理 | UC 3-7, 3-8 | Supabase DB | 🔴 要作成 |

## スキップするUC（11件）

| UC | UC名 | スキップ理由 |
|:--:|------|-------------|
| 3-2 | テンプレート選択 | 3-1「図表作成」に含む |
| 3-3 | 図表編集 | 3-4「編集プレビュー」に含む |
| 3-11 | 学習コンテンツ確認 | 3-10「学習コンテンツ検索」に含む |
| 5-3 | LLMモデル切り替え | 単純なDB更新 |
| 5-4 | LLMプロンプト管理 | 単純なCRUD |
| 5-5 | LLMパラメータ設定 | 単純な設定変更 |
| 5-6 | LLMワークフロー定義 | 設定のみ |
| 5-8 | LLMフォールバック設定 | 設定のみ |
| 5-9 | Embeddingモデル設定 | 設定のみ |
| 5-10 | Embedding使用量監視 | 5-7と同パターン |
| 5-12 | 学習コンテンツ管理 | 単純なCRUD |
| 5-13 | システム設定変更 | 単純な設定変更 |

## 修正履歴

### UC番号の誤り修正（CLAUDE.md 次のアクションセクション）

| 修正前 | 修正後 |
|--------|--------|
| LLMモデル登録（UC 5-7） | LLMモデル登録（**UC 5-2**） |
| LLM使用量監視（UC 5-11） | LLM使用量監視（**UC 5-7**） |
| 学習コンテンツ登録（UC 5-14） | 学習コンテンツ登録（**UC 5-11**） |

## 補足情報

1. **Excalidrawの扱い**: PlantUML版シーケンス図がExcalidrawにも適用可能
2. **UC 5-10 vs UC 5-7**: 両方「使用量取得」パターンだが、5-7のみ作成（5-10は参照で十分）
3. **シーケンス図の判断基準**:
   - 外部API呼び出しがある
   - 複数サービス間の複雑な相互作用
   - 非同期/ストリーミング処理
   - 複雑なエラーリカバリフロー

## 関連ドキュメント
- `docs/context/active_context.md`: シーケンス図進捗（1/15）
- `CLAUDE.md`: 次のアクションセクション（14本作成予定）
- `docs/proposals/PlantUML_Studio_ユースケース図_20251130.md`: UC定義・外部システム接続
