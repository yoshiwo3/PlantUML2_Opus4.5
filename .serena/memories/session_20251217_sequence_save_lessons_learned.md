# PlantUML シーケンス図 知見集 (LL-001〜LL-024, NL-001〜NL-007)

**作成日**: 2025-12-17
**更新日**: 2025-12-17（NL-001〜NL-007追加）
**対象**: UC 3-5 保存シーケンス図
**Evidence**: `docs/evidence/20251215_2345_sequence_save/`
**詳細版**: `docs/evidence/20251215_2345_sequence_save/work_sheet.md`

## 知見分類
- **LL-001〜LL-024**: アクティブバー関連（24項目）
- **NL-001〜NL-007**: 非アクティブバー関連（7項目）

---

## 基本原則

### LL-001: else分岐のactivation継承
- else分岐は**ALT開始時点**の状態を継承（first branch終了時点ではない）
- alt開始時点でactiveな参加者は、else分岐で再度activateするとエラー

### LL-002: 選択的activate
- else分岐では、first branchで非活性化された参加者のみactivate可能

### LL-011: PlantUML並列世界モデル
- alt/elseの各分岐は「並列世界」として独立した状態遷移を持つ
- first branchでのdeactivateはelse branchに影響しない

---

## 構文・パターン

### LL-004: ショートカット構文（++/--）
| 従来の書き方 | ショートカット | 効果 |
|-------------|---------------|------|
| `A -> B` + `activate B` | `A -> B ++` | Bをactivate |
| `A -> B` + `deactivate A` | `A -> B --` | Aをdeactivate |
| 複数行 | `A -> B --++` | A deactivate + B activate |

### LL-005: 矢印タイプの選択
- return arrow (`-->`) よりも regular arrow (`->`) の方がアクティブバーが明確

### LL-006: `--++`ハンドオフパターン
- 「送信者の仕事が終わり、受信者が後続処理を担う」場合に使用
- 例: `APIRoutes -> Browser --++ : 200 OK`

### LL-007: Self-Messageアンカー（可視）
- else分岐で単一メッセージのみの場合、アクティブバーが視覚的に表示されない
- Self-messageを追加してアクティブバーを視覚化
- 欠点: 余計なメッセージが表示される

### LL-008: Hidden Arrowアンカー（推奨解）
```plantuml
else 用語一貫性OK
    Browser -[hidden]-> Browser  ' 不可視アンカー
    Browser -> User -- : 「保存完了」
```
- `[hidden]`で不可視の矢印を作成
- **重要**: `Browser -[hidden]-> Browser ++`は**NG**（LL-001によりactivateエラー）

---

## 制限・原則

### LL-009: noteはアンカーにならない
- noteはメッセージではなく注釈であり、参加者の状態遷移を引き起こさない

### LL-010: deactivateのタイミング原則
- alt/else分岐の「前」でdeactivateすると、分岐内でアクティブバーが描画されない
- 原則: deactivateは各分岐の**終端**で行う

### LL-012: アクティブバー描画の必要条件
```
アクティブバー描画 = 内部状態active ∧ 視覚的トリガー
```
- 視覚的トリガーにならないもの: note、空行、コメント

---

## PNG視覚確認の検知失敗原因分析

### LL-013: 「状態」と「描画」の乖離
- 「内部状態がactive」と「アクティブバーが視覚的に描画される」は**別物**
- 視覚的トリガーがないと、状態がactiveでも描画されない

### LL-014: メッセージチェック表方式の適用限界
- 「内部状態がactive」=「アクティブバーが見える」と暗黙的に仮定していた
- チェック表では「状態はactiveのはず」と誤認

### LL-015: 意味論的確証バイアス
- first branchでアクティブバーが表示されていると、else branchも「同様にあるはず」と思い込む
- ソースの構文ではなく、PlantUMLの状態遷移モデルの理解に基づく確証バイアス

### LL-016: 検知改善策
```
特にalt/else分岐内の最初のメッセージについて:
Q: この分岐の直前に、始点participantへのメッセージ（視覚的トリガー）があるか？
- YES → アクティブバー描画される
- NO  → 隠し矢印アンカーが必要
```

---

## 適用チェックリスト（技術面）

- [ ] alt/else分岐内の最初のメッセージで、始点participantへの直前メッセージがあるか？
- [ ] なければ、隠し矢印アンカー `participant -[hidden]-> participant` を追加したか？
- [ ] deactivateはalt前ではなく各分岐終端で行っているか？

---

## PNG視覚レビュー方法論の失敗（LL-017〜LL-020）

### LL-017: 大域的確認バイアス

```
❌ 失敗パターン: PNG全体を俯瞰して「バーがある」と認識
✅ 正しい方法: 各メッセージの始点を1つずつ確認
```

**発生メカニズム**:
- 図全体を見て「アクティブバーが複数ある」と認識
- 個別メッセージの始点を追跡せず「全部ある」と錯覚
- 結果: 終端部や分岐内の欠落を見落とす

### LL-018: 終端部確認不足

```
❌ 失敗パターン: 図の上部から順に確認し、下部で注意力低下
✅ 正しい方法: 最終メッセージから逆順に確認開始
```

**理由**:
- アクティブバーの欠落は**図の終端部**で発生しやすい
- deactivateの累積効果で消える
- 分岐合流後に継続されていない
- 人間の注意力は後半で低下する

### LL-019: 否定的証拠の探索不足

```
❌ 失敗パターン: 「バーがある」ことを確認（肯定的証拠探索）
✅ 正しい方法: 「バーがないメッセージ」を能動的に探す（否定的証拠探索）
```

**認知バイアス対策**:
- 確認質問を反転させる
- 「どのメッセージにバーがないか？」と自問
- 「全部ある」ではなく「どこにないか」を探す

### LL-020: 分岐両側の独立確認欠如

```
❌ 失敗パターン: if側を確認し、else側を「同様だろう」と推測
✅ 正しい方法: if側とelse側を完全に別々に全メッセージ確認
```

**発生メカニズム**:
- if側で正常にバーが表示されていると、else側も「同じコードパターンだから大丈夫」と思い込む
- 実際はPlantUML状態遷移モデルにより、両側は独立した状態を持つ

---

## 改善版チェックリスト（方法論面）

**PNG視覚レビュー時:**
- [ ] 最終メッセージから逆順に始点のバーを確認したか？
- [ ] 各分岐（if/else）を独立して全メッセージ確認したか？
- [ ] 「バーがないメッセージ」を能動的に探したか？
- [ ] メッセージ単位で始点participantのバーを追跡したか？

---

## claude opsから発見した追加知見（LL-021〜LL-024）

### LL-021: ネストされたalt内のelse分岐でのactivateエラー
- ネストされたalt構造では、親のalt分岐でactivateした参加者を子のelse分岐で再activateするとエラー
- 解決策: ショートカット構文（`--`）でdeactivate

### LL-022: User参加者の初期activate漏れ
- シーケンス図の開始点となるアクター（User等）は、最初のメッセージ送信**前**にactivateが必要
- `activate User` を最初のメッセージの前に追加

### LL-023: リファクタリングの段階的進化パターン
- 大規模なリファクタリングは一度に行わず、段階的に適用し、各段階でPNG確認を行う
- 本セッション: 従来構文 → ショートカット → return arrow修正 → hidden arrow → 完成（6段階）

### LL-024: 失敗パターンの知識の組み合わせ爆発
- 複数の知見の組み合わせが必要な問題が多い
- 例: hidden arrow ++ エラー = LL-001 + LL-008 の組み合わせ
- 個々の知見を暗記するだけでは不十分、**組み合わせパターン**を理解する

---

## 非アクティブバー知見（NL-001〜NL-007）

claude opsから抽出した、アクティブバー以外のシーケンス図作成知見。

### NL-001: skinparam設定パターン
- `skinparam sequenceArrowThickness 2` - 矢印の太さ
- `skinparam roundcorner 10` - 角丸
- `skinparam maxmessagesize 200` - メッセージ最大幅
- `skinparam participant/note` - 色・枠線設定

### NL-002: participant宣言パターン
- エイリアス: `actor User as "エンドユーザー"`
- 改行含む: `participant Browser as "ブラウザ\n(Monaco Editor)"`
- 型: `actor`（人）、`participant`（コンポーネント）、`database`（DB）

### NL-003: フェーズ区切り線
- `== フェーズ名 ==` で処理フェーズを分割
- 長いシーケンス図の可読性向上

### NL-004: note配置パターン
- `note right of P` - 短い注釈
- `note over P ... end note` - 複数行の詳細説明

### NL-005: Self-messageとnoteの使い分け
- Self-message (`A -> A`) - 視覚的トリガーになる
- note - 影響なし、状態説明向け

### NL-006: ヘッダーコメント構造
- UC番号、基準ドキュメント、参照TD、検証方法を記載

### NL-007: 矢印タイプの選択
- `->` (regular) - アクティブバー明確
- `-->` (return) - アクティブバー薄い
- **推奨**: regular arrow

---

## 成果物

- SVG: `docs/proposals/diagrams/08_sequence/PlantUML_Studio_Sequence_Save.svg`
- Evidence: `docs/evidence/20251215_2345_sequence_save/`
- **詳細版work_sheet.md**: 各LL/NL項目に具体的なコード例、claude ops参照、失敗パターン分析を含む完全版
